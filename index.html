                                                                                                                                                            <!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Mant√©n tus estad√≠sticas de vida equilibradas">
    <meta name="theme-color" content="#ff6b9d">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Mi Vida">
    <title>Mi Vida Virtual - Estad√≠sticas</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            min-height: 100%;
            overflow-x: hidden;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffb6d9;
            display: block;
            padding: 20px 10px;
            position: relative;
        }
        
        /* Fondo para computadora */
        @media (min-width: 768px) {
            body::before {
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-image: url('fondo-kawaii.jpg');
                background-size: cover;
                background-position: center;
                background-repeat: no-repeat;
                background-attachment: fixed;
                opacity: 0.3;
                z-index: -1;
            }
        }

        /* Pantalla de inicio */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-image: url('fondo-kawaii.jpg');
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            image-rendering: auto;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.8s ease, transform 0.8s ease;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        
        /* Overlay muy sutil para m√≥vil */
        @media (max-width: 767px) {
            .splash-screen::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.05);
                z-index: 0;
            }
            
            .splash-title,
            .play-button {
                position: relative;
                z-index: 1;
            }
        }

        .splash-screen.hide {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
        }

        .splash-title {
            font-size: 3em;
            font-weight: 700;
            text-align: center;
            margin-bottom: 40px;
            color: #ffffff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            letter-spacing: 0.05em;
            position: relative;
            z-index: 1;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.4;
            width: 100%;
            padding: 0 20px;
            max-width: 90%;
            display: none;
        }
        
        /* Mostrar t√≠tulo solo en computadoras */
        @media (min-width: 768px) {
            .splash-title {
                display: block;
                font-size: 7em;
                font-weight: 900;
                color: #ffffff;
                text-shadow: 
                    /* Sombras negras fuertes para contraste */
                    6px 6px 0px rgba(0, 0, 0, 0.8),
                    8px 8px 0px rgba(0, 0, 0, 0.7),
                    10px 10px 15px rgba(0, 0, 0, 0.6),
                    12px 12px 25px rgba(0, 0, 0, 0.5),
                    0 15px 40px rgba(0, 0, 0, 0.7);
                letter-spacing: 0.15em;
                font-family: 'Comic Sans MS', 'Arial Rounded MT Bold', cursive, sans-serif;
                text-transform: uppercase;
                padding: 30px 20px;
                transform: scale(1, 1.5);
                font-stretch: ultra-expanded;
                filter: drop-shadow(0 15px 30px rgba(0, 0, 0, 0.8));
            }
            
            /* Mejorar calidad de imagen en computadoras */
            .splash-screen {
                background-size: cover;
                image-rendering: -webkit-optimize-contrast;
                image-rendering: crisp-edges;
            }
        }

        .splash-subtitle {
            display: none;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-20px);
            }
        }

        .play-button {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b9d 0%, #ffa8c5 40%, #ffb6d9 60%, #c084fc 100%);
            border: 6px solid rgba(255, 255, 255, 0.9);
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3em;
            color: white;
            box-shadow: 0 4px 20px rgba(255, 107, 157, 0.4);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        
        .play-button::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.4), transparent 50%);
            border-radius: 50%;
            z-index: 0;
        }

        .play-button::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transform: rotate(45deg);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% {
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
            }
            100% {
                transform: translateX(100%) translateY(100%) rotate(45deg);
            }
        }

        .play-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(255, 107, 157, 0.6);
        }

        .play-button:active {
            transform: scale(1.05);
        }

        .play-icon {
            position: relative;
            z-index: 10;
            margin-left: 10px;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }

        /* Decoraciones kawaii */
        .splash-screen .splash-deco-1,
        .splash-screen .splash-deco-2 {
            display: none;
        }

        @keyframes twinkle {
            0%, 100% {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.2) rotate(180deg);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: translateX(-50%) scale(1);
            }
            50% {
                transform: translateX(-50%) scale(1.05);
            }
        }
        
        @keyframes bounce {
            0%, 100% {
                transform: translateX(-50%) translateY(0);
            }
            50% {
                transform: translateX(-50%) translateY(-10px);
            }
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            padding: 40px;
            width: 100%;
            max-width: 600px;
            backdrop-filter: blur(10px);
            margin: 0 auto;
        }
        
        .main-content {
            display: block;
        }
        
        /* Pantallas grandes - dise√±o m√°s ancho */
        @media (min-width: 1024px) {
            .container {
                max-width: 900px;
                padding: 50px;
            }
            
            .buttons-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        h1 {
            text-align: center;
            color: #ff6b9d;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: none;
        }

        .subtitle {
            text-align: center;
            color: #a78bfa;
            font-size: 1.1em;
            margin-bottom: 30px;
            font-weight: 500;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 40px;
        }

        .stat-item {
            background: linear-gradient(135deg, #fef3ff 0%, #ffe5f3 100%);
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(255, 107, 157, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .stat-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(255, 107, 157, 0.15);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-name {
            font-size: 0.9em;
            font-weight: 600;
            color: #6b4c9a;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-icon {
            font-size: 1.15em;
            filter: drop-shadow(2px 2px 3px rgba(0, 0, 0, 0.1));
        }

        .stat-value {
            font-size: 1.05em;
            font-weight: bold;
            color: #ff6b9d;
            text-shadow: 1px 1px 2px rgba(255, 107, 157, 0.2);
        }

        .stat-bar-container {
            width: 100%;
            height: 20px;
            background: linear-gradient(135deg, #e5e5e5 0%, #f0f0f0 100%);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .stat-bar-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 1s ease-in-out, background 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.75em;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        /* Efecto de brillo animado */
        .stat-bar-fill::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { left: -100%; }
            50%, 100% { left: 100%; }
        }

        /* Colores degradados para cada barra seg√∫n nivel */
        .stat-bar-high {
            background: linear-gradient(135deg, #a8e063 0%, #56ab2f 100%);
        }

        .stat-bar-medium {
            background: linear-gradient(135deg, #ffd89b 0%, #f093fb 100%);
        }

        .stat-bar-low {
            background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%);
        }

        .buttons-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 30px;
        }

        .action-button {
            background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%);
            border: none;
            border-radius: 20px;
            padding: 20px;
            font-size: 1.1em;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(167, 139, 250, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .action-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .action-button:hover::before {
            width: 300px;
            height: 300px;
        }

        .action-button:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 8px 25px rgba(167, 139, 250, 0.5);
        }

        .action-button:active {
            transform: translateY(-2px) scale(1.02);
        }

        .button-icon {
            font-size: 2em;
            filter: drop-shadow(2px 2px 3px rgba(0, 0, 0, 0.2));
        }

        .button-text {
            position: relative;
            z-index: 1;
        }

        /* Colores espec√≠ficos para cada bot√≥n */
        .btn-eat {
            background: linear-gradient(135deg, #fbc2eb 0%, #f093fb 100%);
        }

        .btn-drink {
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
        }

        .btn-sleep {
            background: linear-gradient(135deg, #d299c2 0%, #c084fc 100%);
        }

        .btn-exercise {
            background: linear-gradient(135deg, #fdcbf1 0%, #e6dee9 100%);
        }

        .btn-selfcare {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }

        .btn-social {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        }

        .reset-button {
            width: 100%;
            background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%);
            border: none;
            border-radius: 20px;
            padding: 15px;
            font-size: 1em;
            font-weight: 600;
            color: white;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 157, 0.3);
        }

        .reset-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 107, 157, 0.5);
        }

        .info-text {
            text-align: center;
            color: #a78bfa;
            font-size: 0.9em;
            margin-top: 20px;
            font-style: italic;
        }

        /* Animaci√≥n de pulso para valores bajos */
        @keyframes pulse-warning {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .warning {
            animation: pulse-warning 2s infinite;
        }

        /* Sistema de Tabs */
        .tabs-container {
            display: flex;
            justify-content: space-around;
            gap: 8px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.5);
            padding: 10px;
            border-radius: 20px;
            flex-wrap: wrap;
        }
        
        .tab {
            flex: 1;
            min-width: 80px;
            background: linear-gradient(135deg, #e0e7ff 0%, #fef3ff 100%);
            border: none;
            border-radius: 15px;
            padding: 12px 8px;
            font-size: 0.9em;
            font-weight: 600;
            color: #6b4c9a;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(167, 139, 250, 0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .tab-icon {
            font-size: 1.5em;
        }
        
        .tab-label {
            font-size: 0.85em;
        }
        
        .tab:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(167, 139, 250, 0.4);
        }
        
        .tab.active {
            background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(167, 139, 250, 0.5);
            transform: translateY(-2px);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @media (max-width: 600px) {
            .tabs-container {
                gap: 5px;
                padding: 8px;
            }
            
            .tab {
                padding: 10px 6px;
                min-width: 70px;
            }
            
            .tab-icon {
                font-size: 1.3em;
            }
            
            .tab-label {
                font-size: 0.75em;
            }
        }

        /* Reloj en tiempo real */
        .clock-container {
            text-align: center;
            margin-bottom: 25px;
            padding: 15px;
            background: linear-gradient(135deg, #fef3ff 0%, #ffe5f3 100%);
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(255, 107, 157, 0.1);
            position: relative;
        }
        
        .life-stats-icons {
            position: absolute;
            bottom: 12px;
            left: 12px;
            display: flex;
            gap: 8px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 240, 245, 0.9) 100%);
            padding: 6px 10px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(255, 107, 157, 0.15);
            z-index: 5;
        }
        
        .life-icon {
            cursor: pointer;
            font-size: 1.2em;
            transition: transform 0.3s ease, filter 0.3s ease;
            filter: drop-shadow(1px 1px 2px rgba(0, 0, 0, 0.15));
        }
        
        .life-icon:hover {
            transform: scale(1.25);
            filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.3));
        }
        
        .life-stat-display {
            position: absolute;
            bottom: 55px;
            left: 15px;
            background: linear-gradient(135deg, #fff0f5 0%, #ffe5ec 100%);
            padding: 10px 15px;
            border-radius: 12px;
            font-size: 0.9em;
            color: #6b4c9a;
            font-weight: 600;
            box-shadow: 0 6px 15px rgba(255, 107, 157, 0.25);
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
            transform: translateY(5px);
            z-index: 15;
            border: 2px solid rgba(255, 255, 255, 0.8);
        }
        
        .life-stat-display.show {
            opacity: 1;
            transform: translateY(0);
        }

        .date-display {
            font-size: 1.2em;
            color: #6b4c9a;
            font-weight: 600;
            margin-bottom: 5px;
            position: relative;
            z-index: 1;
        }

        .time-display {
            font-size: 2em;
            color: #ff6b9d;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(255, 107, 157, 0.2);
            font-family: 'Courier New', monospace;
            position: relative;
            z-index: 1;
        }

        /* Modal para submen√∫ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: linear-gradient(135deg, #ffffff 0%, #fef3ff 100%);
            padding: 30px;
            border-radius: 25px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px;
            animation: slideUp 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        @media (min-width: 768px) {
            .modal-content {
                max-width: 500px;
                padding: 40px;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .modal-title {
            font-size: 1.8em;
            color: #ff6b9d;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .modal-subtitle {
            color: #a78bfa;
            font-size: 1em;
        }
        
        @media (max-width: 600px) {
            .modal-title {
                font-size: 1.5em;
            }
            
            .modal-subtitle {
                font-size: 0.9em;
            }
        }

        .modal-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .option-button {
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
            border: none;
            border-radius: 15px;
            padding: 18px 25px;
            font-size: 1.1em;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(161, 196, 253, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .option-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(161, 196, 253, 0.5);
        }

        .option-button:active {
            transform: translateY(-1px);
        }

        .option-ml {
            font-size: 1.3em;
            font-weight: bold;
        }

        .option-percentage {
            background: rgba(255, 255, 255, 0.3);
            padding: 5px 12px;
            border-radius: 10px;
            font-size: 0.95em;
        }
        
        /* Inputs responsive */
        input[type="number"],
        input[type="time"],
        select {
            font-size: 16px !important; /* Previene zoom en iOS */
            -webkit-appearance: none;
            appearance: none;
        }
        
        @media (max-width: 600px) {
            .option-button {
                padding: 15px 20px;
                font-size: 1em;
            }
            
            .option-ml {
                font-size: 1.1em;
            }
            
            .option-percentage {
                font-size: 0.85em;
                padding: 4px 10px;
            }
        }

        .modal-close {
            width: 100%;
            background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%);
            border: none;
            border-radius: 15px;
            padding: 15px;
            font-size: 1em;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 157, 0.3);
            margin-top: 20px;
        }

        .modal-close:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 107, 157, 0.5);
        }

        /* Responsive */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 20px;
                max-width: 100%;
                border-radius: 20px;
            }

            h1 {
                font-size: 1.8em;
            }

            .subtitle {
                font-size: 0.95em;
            }

            .buttons-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .stats-container {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }

            .time-display {
                font-size: 1.5em;
            }

            .date-display {
                font-size: 0.95em;
            }
            
            .splash-screen {
                background-size: cover;
                background-position: center;
                padding: 20px;
            }
            
            .splash-title {
                font-size: 2em;
                letter-spacing: 0.03em;
                margin-bottom: 30px;
                line-height: 1.3;
                max-width: 95%;
            }
            
            .play-button {
                width: 100px;
                height: 100px;
                font-size: 2.5em;
                border-width: 5px;
            }

            .stat-name {
                font-size: 1em;
            }

            .stat-value {
                font-size: 1.1em;
            }

            .action-button {
                padding: 15px;
                font-size: 1em;
            }

            .button-icon {
                font-size: 1.5em;
            }
            
            .modal-content {
                width: 95%;
                padding: 25px;
                max-height: 85vh;
                overflow-y: auto;
            }
            
            .stat-item {
                padding: 10px;
            }
            
            .stat-name {
                font-size: 0.85em;
            }
            
            .stat-value {
                font-size: 1em;
            }
            
            .stat-bar-container {
                height: 18px;
            }
            
            .clock-container {
                padding: 12px;
            }
            
            .life-stats-icons {
                bottom: 8px;
                left: 8px;
                gap: 6px;
                padding: 4px 8px;
            }
            
            .life-icon {
                font-size: 0.95em;
            }
            
            .life-stat-display {
                bottom: 45px;
                left: 10px;
                font-size: 0.8em;
                padding: 8px 12px;
            }
        }
        
        @media (max-width: 400px) {
            .life-stats-icons {
                bottom: 5px;
                left: 5px;
                gap: 4px;
                padding: 3px 6px;
            }
            
            .life-icon {
                font-size: 0.85em;
            }
            
            .life-stat-display {
                bottom: 38px;
                left: 8px;
                font-size: 0.75em;
                padding: 6px 10px;
            }
            
            .splash-title {
                font-size: 1.6em;
                margin-bottom: 25px;
            }
            
            .play-button {
                width: 90px;
                height: 90px;
                font-size: 2.2em;
                border-width: 4px;
            }

            h1 {
                font-size: 1.5em;
            }

            .container {
                padding: 15px;
            }
            
            .stats-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .stat-item {
                padding: 8px;
            }
            
            .stat-name {
                font-size: 0.8em;
            }
            
            .stat-icon {
                font-size: 1em;
            }
            
            .stat-value {
                font-size: 0.9em;
            }
            
            .stat-bar-container {
                height: 16px;
            }
            
            .stat-bar-fill {
                font-size: 0.7em;
            }
            
            .stat-header {
                font-size: 0.7em;
            }
            
            .stat-header {
                min-width: 100px;
            }
            
            .stat-name {
                font-size: 0.85em;
                gap: 6px;
            }
            
            .stat-icon {
                font-size: 1.1em;
            }
            
            .stat-value {
                font-size: 1em;
                min-width: 45px;
            }
            
            .stat-bar-container {
                height: 20px;
            }
            
            .action-button {
                padding: 12px;
                font-size: 0.95em;
            }
        }
        
        /* Tablet y pantallas medianas */
        @media (min-width: 601px) and (max-width: 1023px) {
            .container {
                max-width: 700px;
                padding: 35px;
            }
            
            .buttons-container {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .splash-screen {
                background-size: cover;
            }
        }
        
        /* Pantallas grandes - dise√±o expandido */
        @media (min-width: 1024px) {
            .splash-screen {
                background-size: cover;
                background-position: center;
            }
            
            .splash-title {
                font-size: 4em;
            }
            
            .play-button {
                width: 150px;
                height: 150px;
                font-size: 3.5em;
            }
            
            h1 {
                font-size: 3em;
            }
            
            .subtitle {
                font-size: 1.3em;
            }
            
            .action-button {
                flex-direction: row;
                justify-content: flex-start;
                padding: 20px 25px;
                gap: 15px;
            }
            
            .button-icon {
                font-size: 2em;
            }
            
            .button-text {
                font-size: 1.2em;
            }
            
            .stat-item {
                padding: 18px 22px;
                grid-template-columns: auto 1fr auto;
                gap: 15px;
            }
            
            .stat-header {
                min-width: 160px;
            }
            
            .stat-name {
                font-size: 1.1em;
            }
            
            .stat-value {
                font-size: 1.3em;
                min-width: 60px;
            }
            
            .stat-bar-container {
                height: 26px;
            }
            
            .time-display {
                font-size: 2.5em;
            }
            
            .date-display {
                font-size: 1.3em;
            }
        }
    </style>
</head>
<body>
    <!-- Pantalla de Inicio -->
    <div class="splash-screen" id="splashScreen">
        <h1 class="splash-title">‚ú® Mi Vida Virtual ‚ú®</h1>
        <button class="play-button" onclick="startGame()">
            <span class="play-icon">‚ñ∂</span>
        </button>
    </div>

    <div class="container" style="display: none;" id="mainContainer">
        <h1>‚ú® Mi Vida Virtual ‚ú®</h1>
        <p class="subtitle">Mant√©n tus estad√≠sticas equilibradas</p>

        <!-- Reloj en tiempo real -->
        <div class="clock-container">
            <div class="life-stats-icons">
                <span class="life-icon" onclick="toggleBirthday()" title="D√≠as hasta tu cumplea√±os">üéÇ</span>
                <span class="life-icon" onclick="toggleLifeDays()" title="D√≠as vividos">‚ù§Ô∏è</span>
                <span class="life-icon" onclick="toggleDeathDays()" title="D√≠as estimados restantes">üíÄ</span>
            </div>
            <div class="life-stat-display" id="birthdayDisplay" style="bottom: 110px;"></div>
            <div class="life-stat-display" id="lifeDaysDisplay"></div>
            <div class="life-stat-display" id="deathDaysDisplay" style="bottom: 80px;"></div>
            <div class="date-display" id="dateDisplay">üóìÔ∏è Cargando fecha...</div>
            <div class="time-display" id="timeDisplay">‚è∞ --:--:--</div>
        </div>

        <!-- Sistema de Tabs -->
        <div class="tabs-container">
            <button class="tab active" onclick="switchTab('existir')">
                <span class="tab-icon">‚ù§Ô∏è</span>
                <span class="tab-label">Existir</span>
            </button>
            <button class="tab" onclick="switchTab('cuidarme')">
                <span class="tab-icon">üå±</span>
                <span class="tab-label">Cuidarme</span>
            </button>
            <button class="tab" onclick="switchTab('ejercicio')">
                <span class="tab-icon">üèÉ</span>
                <span class="tab-label">Ejercicio</span>
            </button>
            <button class="tab" onclick="switchTab('crecer')">
                <span class="tab-icon">üß†</span>
                <span class="tab-label">Crecer</span>
            </button>
            <button class="tab" onclick="switchTab('biblioteca')">
                <span class="tab-icon">üìö</span>
                <span class="tab-label">Biblioteca</span>
            </button>
            <button class="tab" onclick="switchTab('ideas')">
                <span class="tab-icon">üí°</span>
                <span class="tab-label">Ideas</span>
            </button>
            <button class="tab" onclick="switchTab('calendario')">
                <span class="tab-icon">üìÖ</span>
                <span class="tab-label">Calendario</span>
            </button>
            <button class="tab" onclick="switchTab('resumen')">
                <span class="tab-icon">üìä</span>
                <span class="tab-label">Resumen</span>
            </button>
        </div>

        <!-- Tab: Existir -->
        <div class="tab-content active" id="tab-existir">
            <div class="stats-container" id="statsExistir"></div>
            <div class="buttons-container">
                <button class="action-button btn-eat" id="btnEat">
                    <span class="button-icon">üçΩÔ∏è</span>
                    <span class="button-text">Comer</span>
                </button>
                <button class="action-button btn-drink" id="btnDrink">
                    <span class="button-icon">üíß</span>
                    <span class="button-text">Beber Agua</span>
                </button>
                <button class="action-button btn-sleep" id="btnSleep">
                    <span class="button-icon">üò¥</span>
                    <span class="button-text">Dormir</span>
                </button>
            </div>
        </div>

        <!-- Tab: Cuidarme -->
        <div class="tab-content" id="tab-cuidarme">
            <div class="stats-container" id="statsCuidarme"></div>
            <div class="buttons-container">
                <button class="action-button btn-selfcare" id="btnSelfcare">
                    <span class="button-icon">üíñ</span>
                    <span class="button-text">Autoestima</span>
                </button>
                <button class="action-button btn-social" id="btnSocial">
                    <span class="button-icon">üí¨</span>
                    <span class="button-text">Vida Social</span>
                </button>
            </div>
        </div>

        <!-- Tab: Ejercicio -->
        <div class="tab-content" id="tab-ejercicio">
            <!-- Stats y bot√≥n en proporci√≥n 1:2 HASTA ARRIBA -->
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 15px; margin-bottom: 20px;">
                <div class="stats-container" id="statsEjercicio" style="margin: 0;"></div>
                <button class="action-button btn-exercise" id="btnExercise" style="height: 100%; margin: 0;">
                    <span class="button-icon">üèÉ</span>
                    <span class="button-text">Ejercicio</span>
                </button>
            </div>
            
            <!-- Ejercicio del d√≠a -->
            <div id="todayExercise" style="background: linear-gradient(135deg, #ff6b9d 0%, #ffa8c5 100%); padding: 20px; border-radius: 20px; margin-bottom: 20px; text-align: center; color: white; box-shadow: 0 8px 20px rgba(255, 107, 157, 0.3);">
                <div style="font-size: 2.5em; margin-bottom: 10px;">üí™</div>
                <h2 style="margin-bottom: 10px; font-size: 1.5em;">Hoy te toca:</h2>
                <div id="todayMuscle" style="font-size: 2em; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">Gl√∫teo üçë</div>
            </div>
            
            <!-- Calendario semanal de ejercicio -->
            <div id="exerciseCalendar" style="background: white; border-radius: 20px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
        </div>

        <!-- Tab: Crecer -->
        <div class="tab-content" id="tab-crecer">
            <div class="stats-container" id="statsCrecer"></div>
            <div class="buttons-container">
                <button class="action-button" id="btnIdiomas" style="background: linear-gradient(135deg, #ffd89b 0%, #f093fb 100%);">
                    <span class="button-icon">üåç</span>
                    <span class="button-text">Idiomas</span>
                </button>
                <button class="action-button" id="btnAprendizaje" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                    <span class="button-icon">üìö</span>
                    <span class="button-text">Aprendizaje</span>
                </button>
                <button class="action-button" id="btnProfesion" style="background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);">
                    <span class="button-icon">üë©‚Äç‚öïÔ∏è</span>
                    <span class="button-text">Profesi√≥n</span>
                </button>
            </div>
        </div>

        <!-- Tab: Biblioteca -->
        <div class="tab-content" id="tab-biblioteca">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 style="color: #6b4c9a; margin-bottom: 15px;">üìö Mi Biblioteca</h2>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button onclick="openLibraryCategory('libros')" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 15px; font-size: 1em; cursor: pointer;">üìñ Libros</button>
                    <button onclick="openLibraryCategory('peliculas')" style="padding: 10px 20px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 15px; font-size: 1em; cursor: pointer;">üé¨ Pel√≠culas</button>
                    <button onclick="openLibraryCategory('series')" style="padding: 10px 20px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; border-radius: 15px; font-size: 1em; cursor: pointer;">üì∫ Series</button>
                    <button onclick="openLibraryCategory('flashcards')" style="padding: 10px 20px; background: linear-gradient(135deg, #ff6b9d 0%, #ffa8c5 100%); color: white; border: none; border-radius: 15px; font-size: 1em; cursor: pointer; font-weight: 600;">üß† Flashcards</button>
                </div>
            </div>
            <div id="libraryContent" style="padding: 15px;"></div>
        </div>

        <!-- Tab: Ideas/Contenido -->
        <div class="tab-content" id="tab-ideas">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 style="color: #ff6b9d; margin-bottom: 10px;">üí° Mis Ideas de Contenido</h2>
                <p style="color: #a78bfa; font-size: 0.95em;">Cada etapa te acerca m√°s a tu meta</p>
            </div>
            
            <!-- Barra de progreso de Contenido -->
            <div style="background: linear-gradient(135deg, #fef3ff 0%, #ffe5f3 100%); padding: 20px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(255, 107, 157, 0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 1.5em;">üé¨</span>
                        <span style="font-weight: 600; color: #6b4c9a; font-size: 1.1em;">Contenido</span>
                    </div>
                    <span id="contenidoValue" style="font-size: 1.2em; font-weight: bold; color: #ff6b9d;">100%</span>
                </div>
                <div class="stat-bar-container">
                    <div id="contenidoBar" class="stat-bar-fill stat-bar-high" style="width: 100%;"></div>
                </div>
                <p style="text-align: center; color: #a78bfa; font-size: 0.85em; margin-top: 10px;">‚ú® Cada idea y transici√≥n suma al progreso</p>
            </div>
            
            <!-- Agregar nueva idea -->
            <div style="background: linear-gradient(135deg, #fef3ff 0%, #ffe5f3 100%); padding: 20px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(255, 107, 157, 0.1);">
                <h3 style="color: #6b4c9a; margin-bottom: 15px;">‚ú® Nueva Idea</h3>
                <input type="text" id="newIdeaInput" placeholder="Escribe tu idea aqu√≠..." style="width: 100%; padding: 12px; border: 2px solid #e0e7ff; border-radius: 12px; font-size: 1em; margin-bottom: 10px;">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <select id="ideaPercentage" style="padding: 12px; border: 2px solid #e0e7ff; border-radius: 12px; font-size: 1em;">
                        <option value="2">Idea b√°sica (+2%)</option>
                        <option value="3">Idea desarrollada (+3%)</option>
                        <option value="5">Idea completa (+5%)</option>
                    </select>
                    <button onclick="addNewIdea()" style="flex: 1; background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%); border: none; border-radius: 12px; padding: 12px 20px; font-size: 1em; font-weight: 600; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(167, 139, 250, 0.3);">‚ûï Agregar Idea</button>
                </div>
            </div>
            
            <!-- Pesta√±as de estados de ideas -->
            <div style="display: flex; gap: 8px; margin-bottom: 20px; background: rgba(255, 255, 255, 0.5); padding: 10px; border-radius: 20px; flex-wrap: wrap;">
                <button class="idea-state-tab active" onclick="switchIdeaState('pendientes')" style="flex: 1; min-width: 100px; background: linear-gradient(135deg, #ffd89b 0%, #f093fb 100%); border: none; border-radius: 15px; padding: 12px; font-size: 0.85em; font-weight: 600; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(255, 107, 157, 0.2); transition: all 0.3s ease;">
                    üí≠ Pendientes
                </button>
                <button class="idea-state-tab" onclick="switchIdeaState('guionada')" style="flex: 1; min-width: 100px; background: linear-gradient(135deg, #e0e7ff 0%, #fef3ff 100%); border: none; border-radius: 15px; padding: 12px; font-size: 0.85em; font-weight: 600; color: #6b4c9a; cursor: pointer; box-shadow: 0 2px 8px rgba(167, 139, 250, 0.2); transition: all 0.3s ease;">
                    üìù Guion
                </button>
                <button class="idea-state-tab" onclick="switchIdeaState('grabadas')" style="flex: 1; min-width: 100px; background: linear-gradient(135deg, #e0e7ff 0%, #fef3ff 100%); border: none; border-radius: 15px; padding: 12px; font-size: 0.85em; font-weight: 600; color: #6b4c9a; cursor: pointer; box-shadow: 0 2px 8px rgba(167, 139, 250, 0.2); transition: all 0.3s ease;">
                    üé• Grabadas
                </button>
                <button class="idea-state-tab" onclick="switchIdeaState('editadas')" style="flex: 1; min-width: 100px; background: linear-gradient(135deg, #e0e7ff 0%, #fef3ff 100%); border: none; border-radius: 15px; padding: 12px; font-size: 0.85em; font-weight: 600; color: #6b4c9a; cursor: pointer; box-shadow: 0 2px 8px rgba(167, 139, 250, 0.2); transition: all 0.3s ease;">
                    ‚úÇÔ∏è Editadas
                </button>
                <button class="idea-state-tab" onclick="switchIdeaState('publicadas')" style="flex: 1; min-width: 100px; background: linear-gradient(135deg, #e0e7ff 0%, #fef3ff 100%); border: none; border-radius: 15px; padding: 12px; font-size: 0.85em; font-weight: 600; color: #6b4c9a; cursor: pointer; box-shadow: 0 2px 8px rgba(167, 139, 250, 0.2); transition: all 0.3s ease;">
                    üì§ Publicadas
                </button>
            </div>
            
            <!-- Contenedor de ideas (cambia seg√∫n la pesta√±a seleccionada) -->
            <div id="ideasContainer" style="display: flex; flex-direction: column; gap: 10px; min-height: 200px;"></div>
            
            <!-- Calendario de Videos Programados -->
            <div style="margin-top: 30px; background: linear-gradient(135deg, #fef3ff 0%, #ffe5f3 100%); padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(255, 107, 157, 0.1);">
                <h3 style="color: #ff6b9d; margin-bottom: 15px; text-align: center;">üé¨ Calendario de Videos</h3>
                <p style="text-align: center; color: #a78bfa; font-size: 0.9em; margin-bottom: 15px;">Videos programados para publicar</p>
                <div id="scheduledVideos" style="display: flex; flex-direction: column; gap: 10px;"></div>
            </div>
        </div>

        <!-- Tab: Calendario -->
        <div class="tab-content" id="tab-calendario">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 style="color: #ff6b9d; margin-bottom: 10px;">üìÖ Actividades del D√≠a</h2>
                <p style="color: #a78bfa; font-size: 0.95em;">Calendario general - Todas tus actividades</p>
            </div>
            
            <!-- Vista de Actividades -->
            <div id="calendar-actividades" class="calendar-view" style="display: block;">
                <!-- Lista de actividades pendientes (Arriba) -->
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #ff6b9d; margin-bottom: 12px;">ÔøΩ Actividades de Hoy</h3>
                    <div id="activitiesPending" style="display: flex; flex-direction: column; gap: 10px;"></div>
                </div>
                
                <!-- Agregar nueva actividad -->
                <div style="background: linear-gradient(135deg, #fef3ff 0%, #ffe5f3 100%); padding: 20px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(255, 107, 157, 0.1);">
                    <h3 style="color: #6b4c9a; margin-bottom: 15px;">‚ú® Nueva Actividad</h3>
                    <input type="text" id="newActivityInput" placeholder="¬øQu√© vas a hacer?" style="width: 100%; padding: 12px; border: 2px solid #e0e7ff; border-radius: 12px; font-size: 1em; margin-bottom: 10px;">
                    <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
                        <input type="date" id="activityDate" style="flex: 1; min-width: 140px; padding: 12px; border: 2px solid #e0e7ff; border-radius: 12px; font-size: 1em;">
                        <input type="time" id="activityTime" style="flex: 1; min-width: 120px; padding: 12px; border: 2px solid #e0e7ff; border-radius: 12px; font-size: 1em;">
                    </div>
                    <select id="activityCategory" style="width: 100%; padding: 12px; border: 2px solid #e0e7ff; border-radius: 12px; font-size: 1em; margin-bottom: 10px;">
                        <option value="personal">üå∏ Personal</option>
                        <option value="escuela">üìö Escuela</option>
                        <option value="trabajo">üíº Trabajo</option>
                        <option value="ejercicio">üí™ Ejercicio</option>
                        <option value="salud">‚ù§Ô∏è Salud</option>
                        <option value="social">üë• Social</option>
                    </select>
                    <select id="activityRecurrence" style="width: 100%; padding: 12px; border: 2px solid #e0e7ff; border-radius: 12px; font-size: 1em; margin-bottom: 10px;">
                        <option value="none">No se repite</option>
                        <option value="daily">Diariamente</option>
                        <option value="weekly">Semanalmente</option>
                        <option value="monthly">Mensualmente</option>
                        <option value="yearly">Anualmente</option>
                    </select>
                    
                    <!-- Nivel de importancia -->
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; color: #6b4c9a; font-weight: 600;">‚≠ê Nivel de importancia:</label>
                        <select id="activityImportance" style="width: 100%; padding: 12px; border: 2px solid #e0e7ff; border-radius: 12px; font-size: 1em;">
                            <option value="3">‚≠ê‚≠ê‚≠ê Importante</option>
                            <option value="2" selected>‚≠ê‚≠ê Normal</option>
                            <option value="1">‚≠ê Opcional</option>
                        </select>
                    </div>
                    
                    <!-- Impacto en estad√≠sticas -->
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; color: #6b4c9a; font-weight: 600;">üìä Afecta a:</label>
                        <select id="activityStatEffect" onchange="toggleStatPercentage(this.value)" style="width: 100%; padding: 12px; border: 2px solid #e0e7ff; border-radius: 12px; font-size: 1em; margin-bottom: 8px;">
                            <option value="none">Ninguna estad√≠stica</option>
                            <option value="ejercicio">üèãÔ∏è Salud F√≠sica</option>
                            <option value="autoestima">üíñ Autoestima</option>
                            <option value="vidaSocial">üí¨ Vida Social</option>
                            <option value="idiomas">üåç Idiomas</option>
                            <option value="aprendizaje">üìö Aprendizaje</option>
                            <option value="contenido">üé¨ Contenido</option>
                        </select>
                        <div id="statPercentageContainer" style="display: none;">
                            <label style="display: block; margin-bottom: 5px; color: #667eea; font-weight: 600; font-size: 0.9em;">Porcentaje de aumento:</label>
                            <input type="number" id="activityStatPercentage" value="15" min="1" max="100" style="width: 100%; padding: 10px; border: 2px solid #e0e7ff; border-radius: 10px; font-size: 0.95em; text-align: center;">
                        </div>
                    </div>
                    
                    <button onclick="addActivity()" style="width: 100%; background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%); border: none; border-radius: 12px; padding: 12px 20px; font-size: 1em; font-weight: 600; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(167, 139, 250, 0.3);">‚ûï Agregar Actividad</button>
                </div>
                
                <!-- Navegador de mes -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #ff6b9d 0%, #ffa8c5 100%); border-radius: 15px; box-shadow: 0 4px 15px rgba(255, 107, 157, 0.3);">
                    <button onclick="changeMonth(-1)" style="background: rgba(255,255,255,0.3); border: none; border-radius: 50%; width: 40px; height: 40px; color: white; font-size: 1.2em; cursor: pointer; font-weight: bold;">‚Äπ</button>
                    <h3 id="currentMonthLabel" style="color: white; margin: 0; font-size: 1.2em;"></h3>
                    <button onclick="changeMonth(1)" style="background: rgba(255,255,255,0.3); border: none; border-radius: 50%; width: 40px; height: 40px; color: white; font-size: 1.2em; cursor: pointer; font-weight: bold;">‚Ä∫</button>
                </div>
                
                <!-- Vista de calendario mensual -->
                <div id="monthlyCalendar" style="background: white; padding: 10px; border-radius: 15px; box-shadow: 0 4px 15px rgba(255, 107, 157, 0.1); overflow-x: auto;"></div>
                
                <!-- Secci√≥n de correcci√≥n de actividades mal clasificadas -->
                <div style="margin-top: 30px; padding: 15px; background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%); border-radius: 15px; border: 2px dashed #ffa726;">
                    <h4 style="color: #f57c00; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                        <span>‚ö†Ô∏è</span> Actividades mal clasificadas
                        <span style="font-size: 0.75em; color: #ff6f00; background: rgba(255,255,255,0.5); padding: 3px 8px; border-radius: 12px; margin-left: auto;">Se borra cada d√≠a</span>
                    </h4>
                    <p style="font-size: 0.85em; color: #e65100; margin-bottom: 10px;">Si marcaste mal alguna actividad, puedes corregirla aqu√≠:</p>
                    <div id="wrongActivitiesList" style="display: flex; flex-direction: column; gap: 8px;"></div>
                </div>
                
            </div>
        </div>

        <!-- Tab: Resumen -->
        <div class="tab-content" id="tab-resumen">
            <!-- Bloque 1: Rutina sugerida -->
            <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 18px; border-radius: 20px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(66, 165, 245, 0.2);">
                <h4 style="color: #1976d2; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;"><span>üß≠</span> Rutina sugerida (Hoy)</h4>
                <div id="suggestedRoutineContainer" style="display: flex; flex-direction: column; gap: 8px;"></div>
            </div>
            
            <!-- Bloque 3: Prioridades personalizadas -->
            <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 18px; border-radius: 20px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(255, 152, 0, 0.2);">
                <h4 style="color: #f57c00; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between;">
                    <span style="display: flex; align-items: center; gap: 8px;"><span>‚ú®</span> Hoy quiero priorizar</span>
                    <button onclick="openFavoritesSelector()" style="background: linear-gradient(135deg, #ff9800 0%, #fb8c00 100%); border: none; border-radius: 12px; padding: 8px 15px; color: white; font-size: 0.85em; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3);">+ Elegir</button>
                </h4>
                <div id="favoritesContainer" style="display: flex; flex-direction: column; gap: 8px;"></div>
            </div>
            
            <!-- Estad√≠sticas resumidas -->
            <div style="background: linear-gradient(135deg, #fef3ff 0%, #ffe5f3 100%); padding: 20px; border-radius: 20px; margin-bottom: 20px;">
                <h3 style="color: #ff6b9d; margin-bottom: 15px; text-align: center;">üìä Todas las Estad√≠sticas</h3>
            </div>
            <div class="stats-container" id="statsResumen"></div>
        </div>

        <p class="info-text">üí° Las estad√≠sticas disminuyen 4.2% por hora y se guardan autom√°ticamente</p>
        
        <!-- Bot√≥n de backup accesible -->
        <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
            <button onclick="exportBackup()" style="flex: 1; min-width: 140px; background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%); border: none; border-radius: 15px; padding: 12px; font-size: 0.9em; font-weight: 600; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(66, 165, 245, 0.3);">
                üì• Descargar Backup
            </button>
            <button onclick="importBackup()" style="flex: 1; min-width: 140px; background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%); border: none; border-radius: 15px; padding: 12px; font-size: 0.9em; font-weight: 600; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);">
                üì§ Restaurar Backup
            </button>
            <button onclick="recoverFromAutoBackup()" style="flex: 1; min-width: 140px; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); border: none; border-radius: 15px; padding: 12px; font-size: 0.9em; font-weight: 600; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);">
                üîÑ Recuperar √öltimos Datos
            </button>
        </div>
        
        <!-- Herramienta de diagn√≥stico -->
        <div style="margin-top: 15px;">
            <button onclick="showDiagnostics()" style="width: 100%; background: linear-gradient(135deg, #9c27b0 0%, #673ab7 100%); border: none; border-radius: 15px; padding: 12px; font-size: 0.9em; font-weight: 600; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(156, 39, 176, 0.3);">
                üîç Ver Todos Mis Datos Guardados
            </button>
        </div>
    </div>

    <!-- Modal para beber agua -->
    <div id="waterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üíß Registrar Bebida</div>
                <div class="modal-subtitle">Ingresa cantidad y tipo</div>
            </div>
            
            <!-- Input manual de ml -->
            <div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #e0e7ff 0%, #fef3ff 100%); border-radius: 15px;">
                <label style="display: block; font-weight: 600; color: #6b4c9a; margin-bottom: 10px; font-size: 1.05em;">üìè Cantidad en ml:</label>
                <input type="number" id="drinkAmount" placeholder="Ej: 250" min="1" max="2000" style="width: 100%; padding: 12px; border: 2px solid #c084fc; border-radius: 10px; font-size: 1.1em; text-align: center;">
            </div>
            
            <!-- Selector de tipo de bebida -->
            <div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #e0e7ff 0%, #fef3ff 100%); border-radius: 15px;">
                <label style="display: block; font-weight: 600; color: #6b4c9a; margin-bottom: 10px; font-size: 1.05em;">ü•§ Tipo de bebida:</label>
                <select id="drinkType" style="width: 100%; padding: 12px; border: 2px solid #c084fc; border-radius: 10px; font-size: 1.05em; background: white;">
                    <option value="agua">üíß Agua natural</option>
                    <option value="azucarada">üßÉ Bebida azucarada</option>
                    <option value="refresco">ü•§ Refresco</option>
                    <option value="cafe">‚òï Caf√© / t√© con leche</option>
                </select>
            </div>
            
            <button onclick="registerDrink()" style="width: 100%; background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%); border: none; border-radius: 15px; padding: 18px; font-size: 1.1em; font-weight: 600; color: white; cursor: pointer; margin-bottom: 10px; box-shadow: 0 4px 15px rgba(167, 139, 250, 0.3);" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
                ‚úì Registrar
            </button>
            
            <button class="modal-close" onclick="closeWaterModal()">‚úï Cerrar</button>
        </div>
    </div>

    <!-- Modal para comer -->
    <div id="eatModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üçΩÔ∏è Comer</div>
                <div class="modal-subtitle">Ingresa las calor√≠as consumidas</div>
            </div>
            
            <div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #e0e7ff 0%, #fef3ff 100%); border-radius: 15px;">
                <div style="text-align: center; color: #6b4c9a; font-weight: 600; margin-bottom: 15px; font-size: 1.1em;">üç¥ Calor√≠as Consumidas</div>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <label style="color: #6b4c9a; font-weight: 600; font-size: 0.95em;">Calor√≠as (kcal):</label>
                    <input type="number" id="caloriesInput" placeholder="Ej: 500" min="1" max="5000" style="padding: 12px; border: 2px solid #e0e7ff; border-radius: 10px; font-size: 1.1em; text-align: center; font-weight: 600; color: #6b4c9a; outline: none; transition: all 0.3s ease;" onfocus="this.style.borderColor='#a78bfa'" onblur="this.style.borderColor='#e0e7ff'">
                </div>
                <div id="caloriesInfo" style="margin-top: 15px; padding: 12px; background: linear-gradient(135deg, #e0f7fa 0%, #e1f5fe 100%); border-radius: 10px; text-align: center; display: none;">
                    <div style="color: #6b4c9a; font-size: 0.9em; margin-bottom: 5px;">üìä Tu metabolismo basal: <strong id="bmrDisplay">0</strong> kcal/d√≠a</div>
                    <div style="color: #ff6b9d; font-weight: bold; font-size: 1.1em;">Hambre +<span id="hungerIncrease">0</span>%</div>
                </div>
                <button onclick="calculateEatEffects()" style="width: 100%; margin-top: 12px; background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%); border: none; border-radius: 10px; padding: 12px; color: white; font-weight: 600; cursor: pointer; font-size: 1em; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    üçΩÔ∏è Calcular y Comer
                </button>
            </div>
            
            <button class="modal-close" onclick="closeEatModal()">‚úï Cerrar</button>
        </div>
    </div>

    <!-- Modal para dormir -->
    <div id="sleepModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üò¥ Dormir</div>
                <div class="modal-subtitle">Calcula tus horas de sue√±o</div>
            </div>
            
            <!-- Calculadora de horas -->
            <div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #e0e7ff 0%, #fef3ff 100%); border-radius: 15px;">
                <div style="text-align: center; color: #6b4c9a; font-weight: 600; margin-bottom: 15px; font-size: 1.1em;">‚è∞ Calculadora de Sue√±o</div>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div>
                        <label style="color: #6b4c9a; font-weight: 500; display: block; margin-bottom: 5px;">üåô Hora de dormir:</label>
                        <input type="time" id="sleepTime" style="width: 100%; padding: 10px; border-radius: 10px; border: 2px solid #a78bfa; font-size: 1em;">
                    </div>
                    <div>
                        <label style="color: #6b4c9a; font-weight: 500; display: block; margin-bottom: 5px;">‚òÄÔ∏è Hora de despertar:</label>
                        <input type="time" id="wakeTime" style="width: 100%; padding: 10px; border-radius: 10px; border: 2px solid #a78bfa; font-size: 1em;">
                    </div>
                    <button onclick="calculateSleep()" style="background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%); border: none; border-radius: 10px; padding: 12px; color: white; font-weight: 600; cursor: pointer; font-size: 1em; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        ‚ú® Calcular y Aplicar
                    </button>
                </div>
            </div>
            
            <button class="modal-close" onclick="closeSleepModal()">‚úï Cerrar</button>
        </div>
    </div>

    <!-- Modal para seleccionar actividad de ejercicio -->
    <div id="exerciseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üèÉ Ejercicio</div>
                <div class="modal-subtitle">Selecciona la actividad</div>
            </div>
            <div class="modal-options">
                <button class="option-button" onclick="selectActivity('ü•ã Taekwondo')">
                    <span class="option-ml">ü•ã Taekwondo</span>
                </button>
                <button class="option-button" onclick="selectActivity('üö∂ Caminar')">
                    <span class="option-ml">üö∂ Caminar</span>
                </button>
                <button class="option-button" onclick="selectActivity('üèÉ Correr')">
                    <span class="option-ml">üèÉ Correr</span>
                </button>
                <button class="option-button" onclick="selectActivity('‚õ∏Ô∏è Patinar')">
                    <span class="option-ml">‚õ∏Ô∏è Patinar</span>
                </button>
                <button class="option-button" onclick="selectActivity('üèãÔ∏è Pesas')">
                    <span class="option-ml">üèãÔ∏è Pesas</span>
                </button>
            </div>
            <button class="modal-close" onclick="closeExerciseModal()">‚úï Cerrar</button>
        </div>
    </div>

    <!-- Modal para seleccionar intensidad de ejercicio -->
    <div id="intensityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="intensityTitle">üèÉ Ejercicio</div>
                <div class="modal-subtitle">Ingresa la duraci√≥n y selecciona la intensidad</div>
            </div>
            
            <!-- Input de duraci√≥n -->
            <div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #e0e7ff 0%, #fef3ff 100%); border-radius: 15px;">
                <div style="text-align: center; color: #6b4c9a; font-weight: 600; margin-bottom: 15px; font-size: 1.1em;">‚è±Ô∏è Duraci√≥n del Entrenamiento</div>
                <div>
                    <label style="color: #6b4c9a; font-weight: 500; display: block; margin-bottom: 5px;">Minutos:</label>
                    <input type="number" id="taekwondoDuration" min="1" max="300" placeholder="Ej: 60" style="width: 100%; padding: 10px; border-radius: 10px; border: 2px solid #a78bfa; font-size: 1em;">
                </div>
                <button onclick="calculateIntensityEffects()" style="width: 100%; margin-top: 12px; background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%); border: none; border-radius: 10px; padding: 12px; color: white; font-weight: 600; cursor: pointer; font-size: 1em; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    ‚ú® Calcular Efectos
                </button>
            </div>

            <div id="intensityOptions" style="display: none;">
                <div class="modal-options">
                    <!-- Los botones se generan din√°micamente -->
                </div>
                <div style="margin: 15px 0; padding: 15px; background: linear-gradient(135deg, #e0f7fa 0%, #e1f5fe 100%); border-radius: 15px; text-align: center;">
                    <div style="color: #00796b; font-weight: 600; margin-bottom: 5px;">‚ú® Beneficios</div>
                    <div style="color: #00897b; font-size: 0.95em;">Salud F√≠sica +50% | Autoestima +25%</div>
                </div>
            </div>
            
            <button class="modal-close" onclick="closeIntensityModal()">‚úï Cerrar</button>
        </div>
    </div>

    <!-- Modal para caminar -->
    <div id="walkModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üö∂ Caminar</div>
                <div class="modal-subtitle">Ingresa tu actividad</div>
            </div>
            
            <!-- Input de duraci√≥n -->
            <div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #e0e7ff 0%, #fef3ff 100%); border-radius: 15px;">
                <div style="text-align: center; color: #6b4c9a; font-weight: 600; margin-bottom: 15px; font-size: 1.1em;">‚è±Ô∏è Tu Caminata</div>
                
                <!-- Selector de unidad -->
                <div style="margin-bottom: 15px;">
                    <label style="color: #6b4c9a; font-weight: 500; display: block; margin-bottom: 5px;">Medido en:</label>
                    <select id="walkUnit" onchange="updateWalkInputLabel()" style="width: 100%; padding: 10px; border-radius: 10px; border: 2px solid #a78bfa; font-size: 1em; background: white; cursor: pointer;">
                        <option value="minutos">‚è±Ô∏è Minutos</option>
                        <option value="pasos">üë£ Pasos</option>
                    </select>
                </div>
                
                <div>
                    <label id="walkInputLabel" style="color: #6b4c9a; font-weight: 500; display: block; margin-bottom: 5px;">Minutos caminados:</label>
                    <input type="number" id="walkDuration" min="1" placeholder="Ej: 30" style="width: 100%; padding: 10px; border-radius: 10px; border: 2px solid #a78bfa; font-size: 1em;">
                </div>
                <button onclick="calculateWalkEffects()" style="width: 100%; margin-top: 12px; background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%); border: none; border-radius: 10px; padding: 12px; color: white; font-weight: 600; cursor: pointer; font-size: 1em; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    ‚ú® Calcular Efectos
                </button>
            </div>

            <div id="walkOptions" style="display: none;">
                <div class="modal-options">
                    <!-- Los botones se generan din√°micamente -->
                </div>
                <div style="margin: 15px 0; padding: 15px; background: linear-gradient(135deg, #e0f7fa 0%, #e1f5fe 100%); border-radius: 15px; text-align: center;">
                    <div style="color: #00796b; font-weight: 600; margin-bottom: 5px;">‚ú® Beneficios</div>
                    <div style="color: #00897b; font-size: 0.95em;">Salud F√≠sica +10% | Autoestima +5%</div>
                </div>
            </div>
            
            <button class="modal-close" onclick="closeWalkModal()">‚úï Cerrar</button>
        </div>
    </div>

    <!-- Modal para correr -->
    <div id="runModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üèÉ Correr</div>
                <div class="modal-subtitle">Ingresa los detalles de tu carrera</div>
            </div>
            
            <div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #e0e7ff 0%, #fef3ff 100%); border-radius: 15px;">
                <div style="text-align: center; color: #6b4c9a; font-weight: 600; margin-bottom: 15px; font-size: 1.1em;">‚è±Ô∏è Tu Carrera</div>
                
                <!-- Selector de unidad -->
                <div style="margin-bottom: 15px;">
                    <label style="color: #6b4c9a; font-weight: 500; display: block; margin-bottom: 5px;">Medido en:</label>
                    <select id="runUnit" onchange="updateRunInputLabel()" style="width: 100%; padding: 10px; border-radius: 10px; border: 2px solid #a78bfa; font-size: 1em; background: white; cursor: pointer;">
                        <option value="minutos">‚è±Ô∏è Minutos</option>
                        <option value="kilometros">üìè Kil√≥metros</option>
                    </select>
                </div>
                
                <div>
                    <label id="runInputLabel" style="color: #6b4c9a; font-weight: 500; display: block; margin-bottom: 5px;">Minutos:</label>
                    <input type="number" id="runDuration" min="1" step="0.1" placeholder="Ej: 20" style="width: 100%; padding: 10px; border-radius: 10px; border: 2px solid #a78bfa; font-size: 1em;">
                </div>
                <button onclick="calculateRunEffects()" style="width: 100%; margin-top: 12px; background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%); border: none; border-radius: 10px; padding: 12px; color: white; font-weight: 600; cursor: pointer; font-size: 1em; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    ‚ú® Calcular Efectos
                </button>
            </div>

            <div id="runOptions" style="display: none;">
                <div class="modal-options">
                    <!-- Los botones se generan din√°micamente -->
                </div>
                <div style="margin: 15px 0; padding: 15px; background: linear-gradient(135deg, #e0f7fa 0%, #e1f5fe 100%); border-radius: 15px; text-align: center;">
                    <div style="color: #00796b; font-weight: 600; margin-bottom: 5px;">‚ú® Beneficios</div>
                    <div style="color: #00897b; font-size: 0.95em;">Salud F√≠sica +40% | Autoestima +20%</div>
                </div>
            </div>
            
            <button class="modal-close" onclick="closeRunModal()">‚úï Cerrar</button>
        </div>
    </div>

    <!-- Modal para patinar -->
    <div id="skateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">‚õ∏Ô∏è Patinar</div>
                <div class="modal-subtitle">Ingresa la duraci√≥n y nivel</div>
            </div>
            
            <div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #e0e7ff 0%, #fef3ff 100%); border-radius: 15px;">
                <div style="text-align: center; color: #6b4c9a; font-weight: 600; margin-bottom: 15px; font-size: 1.1em;">‚è±Ô∏è Sesi√≥n de Patinaje</div>
                <div>
                    <label style="color: #6b4c9a; font-weight: 500; display: block; margin-bottom: 5px;">Minutos:</label>
                    <input type="number" id="skateDuration" min="1" max="300" placeholder="Ej: 45" style="width: 100%; padding: 10px; border-radius: 10px; border: 2px solid #a78bfa; font-size: 1em;">
                </div>
                <button onclick="calculateSkateEffects()" style="width: 100%; margin-top: 12px; background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%); border: none; border-radius: 10px; padding: 12px; color: white; font-weight: 600; cursor: pointer; font-size: 1em; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    ‚ú® Calcular Efectos
                </button>
            </div>

            <div id="skateOptions" style="display: none;">
                <div class="modal-options">
                    <!-- Los botones se generan din√°micamente -->
                </div>
                <div style="margin: 15px 0; padding: 15px; background: linear-gradient(135deg, #e0f7fa 0%, #e1f5fe 100%); border-radius: 15px; text-align: center;">
                    <div style="color: #00796b; font-weight: 600; margin-bottom: 5px;">‚ú® Beneficios</div>
                    <div style="color: #00897b; font-size: 0.95em;">Salud F√≠sica +35% | Autoestima +15%</div>
                </div>
            </div>
            
            <button class="modal-close" onclick="closeSkateModal()">‚úï Cerrar</button>
        </div>
    </div>

    <!-- Modal para pesas -->
    <div id="weightsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üèãÔ∏è Pesas</div>
                <div class="modal-subtitle">Ingresa duraci√≥n y grupo muscular</div>
            </div>
            
            <div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #e0e7ff 0%, #fef3ff 100%); border-radius: 15px;">
                <div style="text-align: center; color: #6b4c9a; font-weight: 600; margin-bottom: 15px; font-size: 1.1em;">‚è±Ô∏è Entrenamiento de Fuerza</div>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div>
                        <label style="color: #6b4c9a; font-weight: 500; display: block; margin-bottom: 5px;">Minutos:</label>
                        <input type="number" id="weightsDuration" min="1" max="300" placeholder="Ej: 60" style="width: 100%; padding: 10px; border-radius: 10px; border: 2px solid #a78bfa; font-size: 1em;">
                    </div>
                    <div>
                        <label style="color: #6b4c9a; font-weight: 500; display: block; margin-bottom: 5px;">Grupo muscular principal:</label>
                        <select id="muscleGroup" style="width: 100%; padding: 10px; border-radius: 10px; border: 2px solid #a78bfa; font-size: 1em;">
                            <option value="piernas">Piernas/Gl√∫teos (mayor gasto)</option>
                            <option value="espalda">Espalda/Pecho (gasto moderado)</option>
                            <option value="brazos">Brazos/Hombros (menor gasto)</option>
                        </select>
                    </div>
                </div>
                <button onclick="calculateWeightsEffects()" style="width: 100%; margin-top: 12px; background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%); border: none; border-radius: 10px; padding: 12px; color: white; font-weight: 600; cursor: pointer; font-size: 1em; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    ‚ú® Aplicar
                </button>
            </div>
            
            <button class="modal-close" onclick="closeWeightsModal()">‚úï Cerrar</button>
        </div>
    </div>

    <!-- Modal de Perfil de Usuario -->
    <div id="profileModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <div class="modal-title">üë§ Tu Perfil Personal</div>
                <div class="modal-subtitle">Personaliza tu experiencia</div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px;">
                <div>
                    <label style="color: #6b4c9a; font-weight: 600; display: block; margin-bottom: 8px;">üéÇ Fecha de Nacimiento</label>
                    <input type="date" id="userBirthdate" max="" style="width: 100%; padding: 6px 8px; border-radius: 10px; border: 2px solid #a78bfa; font-size: 0.85em; font-family: inherit; color: #6b4c9a; background: white; box-sizing: border-box; line-height: 1.1;">
                    <div id="ageDisplay" style="margin-top: 6px; color: #ff6b9d; font-weight: 600; font-size: 0.85em; text-align: center; min-height: 18px;"></div>
                </div>
                <div>
                    <label style="color: #6b4c9a; font-weight: 600; display: block; margin-bottom: 8px;">‚ößÔ∏è G√©nero</label>
                    <select id="userGender" style="width: 100%; padding: 10px 12px; border-radius: 10px; border: 2px solid #a78bfa; font-size: 0.95em; font-family: inherit; color: #6b4c9a; background: white;">
                        <option value="femenino">Femenino</option>
                        <option value="masculino">Masculino</option>
                        <option value="otro">Otro</option>
                    </select>
                </div>
                <div>
                    <label style="color: #6b4c9a; font-weight: 600; display: block; margin-bottom: 8px;">üìè Altura (cm)</label>
                    <input type="number" id="userHeight" min="100" max="200" placeholder="Ej: 160" style="width: 100%; padding: 10px 12px; border-radius: 10px; border: 2px solid #a78bfa; font-size: 0.95em; font-family: inherit; color: #6b4c9a;">
                </div>
                <div>
                    <label style="color: #6b4c9a; font-weight: 600; display: block; margin-bottom: 8px;">‚öñÔ∏è Peso (kg)</label>
                    <input type="number" id="userWeight" min="30" max="180" step="0.1" placeholder="Ej: 56" style="width: 100%; padding: 10px 12px; border-radius: 10px; border: 2px solid #a78bfa; font-size: 0.95em; font-family: inherit; color: #6b4c9a;">
                </div>
            </div>
            <button onclick="saveProfile()" style="width: 100%; background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%); border: none; border-radius: 15px; padding: 18px; font-size: 1.1em; font-weight: 600; color: white; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(167, 139, 250, 0.3);" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
                ‚ú® Comenzar Mi Jornada
            </button>
        </div>
    </div>

    <!-- Modal de Autoestima -->
    <div id="selfcareModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <div class="modal-title">üíñ Autoestima & Bienestar</div>
                <div class="modal-subtitle">Elige una categor√≠a</div>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <button onclick="openSelfcareCategory('microcuidados')" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%); border: none; border-radius: 12px; font-size: 1.05em; font-weight: 600; color: #6b4c9a; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(253, 203, 110, 0.3);">
                    ‚ú® Microcuidados
                </button>
                <button onclick="openSelfcareCategory('regulacion')" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%); border: none; border-radius: 12px; font-size: 1.05em; font-weight: 600; color: white; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(108, 92, 231, 0.3);">
                    üßò‚Äç‚ôÄÔ∏è Regulaci√≥n Emocional
                </button>
                <button onclick="openSelfcareCategory('impacto')" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%); border: none; border-radius: 12px; font-size: 1.05em; font-weight: 600; color: white; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(255, 107, 157, 0.3);">
                    üí™ Acciones de Impacto Fuerte
                </button>
            </div>
            
            <button class="modal-close" onclick="closeSelfcareModal()">‚úï Cerrar</button>
        </div>
    </div>

    <!-- Modal de Microcuidados -->
    <div id="microcuidadosModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <div class="modal-title">‚ú® Microcuidados</div>
                <div class="modal-subtitle">Peque√±as acciones, gran impacto</div>
            </div>
            <div id="microcuidadosOptions" style="display: flex; flex-direction: column; gap: 10px; max-height: 60vh; overflow-y: auto; padding-right: 5px;">
                <!-- Se generan din√°micamente -->
            </div>
            <button class="modal-close" onclick="closeMicrocuidadosModal()">‚Üê Volver</button>
        </div>
    </div>

    <!-- Modal de Regulaci√≥n Emocional -->
    <div id="regulacionModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <div class="modal-title">üßò‚Äç‚ôÄÔ∏è Regulaci√≥n Emocional</div>
                <div class="modal-subtitle">Conecta con tus emociones</div>
            </div>
            <div id="regulacionOptions" style="display: flex; flex-direction: column; gap: 10px; max-height: 60vh; overflow-y: auto; padding-right: 5px;">
                <!-- Se generan din√°micamente -->
            </div>
            <button class="modal-close" onclick="closeRegulacionModal()">‚Üê Volver</button>
        </div>
    </div>

    <!-- Modal de Acciones de Impacto -->
    <div id="impactoModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <div class="modal-title">üí™ Acciones de Impacto Fuerte</div>
                <div class="modal-subtitle">Grandes decisiones para tu bienestar</div>
            </div>
            <div id="impactoOptions" style="display: flex; flex-direction: column; gap: 10px; max-height: 60vh; overflow-y: auto; padding-right: 5px;">
                <!-- Se generan din√°micamente -->
            </div>
            <button class="modal-close" onclick="closeImpactoModal()">‚Üê Volver</button>
        </div>
    </div>

    <!-- Modal de Vida Social -->
    <div id="socialModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <div class="modal-title">üë• Vida Social</div>
                <div class="modal-subtitle">Elige una categor√≠a</div>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <button onclick="openSocialCategory('familia')" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%); border: none; border-radius: 12px; font-size: 1.05em; font-weight: 600; color: #6b4c9a; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(253, 203, 110, 0.3);">
                    üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familia
                </button>
                <button onclick="openSocialCategory('vinculos')" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%); border: none; border-radius: 12px; font-size: 1.05em; font-weight: 600; color: white; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(108, 92, 231, 0.3);">
                    üíû V√≠nculos Seguros
                </button>
                <button onclick="openSocialCategory('facil')" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #55efc4 0%, #00b894 100%); border: none; border-radius: 12px; font-size: 1.05em; font-weight: 600; color: white; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0, 184, 148, 0.3);">
                    üòä Social F√°cil
                </button>
            </div>
            
            <button class="modal-close" onclick="closeSocialModal()">‚úï Cerrar</button>
        </div>
    </div>

    <!-- Modal de Familia -->
    <div id="familiaModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <div class="modal-title">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familia</div>
                <div class="modal-subtitle">Tiempo de calidad con tu familia</div>
            </div>
            <div id="familiaOptions" style="display: flex; flex-direction: column; gap: 10px; max-height: 60vh; overflow-y: auto; padding-right: 5px;">
                <!-- Se generan din√°micamente -->
            </div>
            <button class="modal-close" onclick="closeFamiliaModal()">‚Üê Volver</button>
        </div>
    </div>

    <!-- Modal de V√≠nculos Seguros -->
    <div id="vinculosModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <div class="modal-title">üíû V√≠nculos Seguros</div>
                <div class="modal-subtitle">Conexiones profundas</div>
            </div>
            <div id="vinculosOptions" style="display: flex; flex-direction: column; gap: 10px; max-height: 60vh; overflow-y: auto; padding-right: 5px;">
                <!-- Se generan din√°micamente -->
            </div>
            <button class="modal-close" onclick="closeVinculosModal()">‚Üê Volver</button>
        </div>
    </div>

    <!-- Modal de Social F√°cil -->
    <div id="facilModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <div class="modal-title">üòä Social F√°cil</div>
                <div class="modal-subtitle">Interacciones cotidianas</div>
            </div>
            <div id="facilOptions" style="display: flex; flex-direction: column; gap: 10px; max-height: 60vh; overflow-y: auto; padding-right: 5px;">
                <!-- Se generan din√°micamente -->
            </div>
            <button class="modal-close" onclick="closeFacilModal()">‚Üê Volver</button>
        </div>
    </div>

    <!-- Modales de Crecimiento -->
    <!-- Modal de Idiomas -->
    <div id="idiomasModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <div class="modal-title">üåç Idiomas</div>
                <div class="modal-subtitle">Practica y mejora tus habilidades</div>
            </div>
            <div id="idiomasOptions" style="display: flex; flex-direction: column; gap: 10px; max-height: 60vh; overflow-y: auto; padding-right: 5px;">
                <!-- Se generan din√°micamente -->
            </div>
            <button class="modal-close" onclick="closeIdiomasModal()">‚úï Cerrar</button>
        </div>
    </div>

    <!-- Modal de Aprendizaje -->
    <div id="aprendizajeModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <div class="modal-title">üìö Aprendizaje</div>
                <div class="modal-subtitle">Expande tu conocimiento</div>
            </div>
            <div id="aprendizajeOptions" style="display: flex; flex-direction: column; gap: 10px; max-height: 60vh; overflow-y: auto; padding-right: 5px;">
                <!-- Se generan din√°micamente -->
            </div>
            <button class="modal-close" onclick="closeAprendizajeModal()">‚úï Cerrar</button>
        </div>
    </div>

    <!-- Modal de Profesi√≥n -->
    <div id="profesionModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <div class="modal-title">üë©‚Äç‚öïÔ∏è Profesi√≥n</div>
                <div class="modal-subtitle">Elige tu √°rea de estudio</div>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <button onclick="openProfesionCategory('enfermeria')" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); border: none; border-radius: 12px; font-size: 1.05em; font-weight: 600; color: #6b4c9a; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(168, 237, 234, 0.3);">
                    üíâ Enfermer√≠a
                </button>
                <button onclick="openProfesionCategory('farmacologia')" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%); border: none; border-radius: 12px; font-size: 1.05em; font-weight: 600; color: #6b4c9a; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(253, 203, 110, 0.3);">
                    üíä Farmacolog√≠a
                </button>
            </div>
            
            <button class="modal-close" onclick="closeProfesionModal()">‚úï Cerrar</button>
        </div>
    </div>

    <!-- Modal de Enfermer√≠a -->
    <div id="enfermeriaModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <div class="modal-title">üíâ Enfermer√≠a</div>
                <div class="modal-subtitle">Estudia y refuerza conceptos</div>
            </div>
            <div id="enfermeriaOptions" style="display: flex; flex-direction: column; gap: 10px; max-height: 60vh; overflow-y: auto; padding-right: 5px;">
                <!-- Se generan din√°micamente -->
            </div>
            <button class="modal-close" onclick="closeEnfermeriaModal()">‚Üê Volver</button>
        </div>
    </div>

    <!-- Modal de Farmacolog√≠a -->
    <div id="farmacologiaModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <div class="modal-title">üíä Farmacolog√≠a</div>
                <div class="modal-subtitle">Domina los f√°rmacos</div>
            </div>
            <div id="farmacologiaOptions" style="display: flex; flex-direction: column; gap: 10px; max-height: 60vh; overflow-y: auto; padding-right: 5px;">
                <!-- Se generan din√°micamente -->
            </div>
            <button class="modal-close" onclick="closeFarmacologiaModal()">‚Üê Volver</button>
        </div>
    </div>

    <script>
        // Verificar si localStorage est√° disponible (detectar modo privado Safari)
        function checkLocalStorageAvailable() {
            try {
                const test = '__storage_test__';
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                return true;
            } catch (e) {
                console.warn('‚ö†Ô∏è localStorage no disponible - posible modo privado');
                // Mostrar advertencia al usuario
                const warning = document.createElement('div');
                warning.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; background: #ff6b9d; color: white; padding: 12px; text-align: center; z-index: 99999; font-size: 0.9em; font-weight: 600;';
                warning.innerHTML = '‚ö†Ô∏è IMPORTANTE: Activa "Permitir cookies" en Safari para que se guarden tus datos';
                document.body.prepend(warning);
                return false;
            }
        }
        
        // Funci√≥n para iniciar el juego desde la pantalla de inicio
        function startGame() {
            console.log('üéÆ Iniciando juego...');
            
            // Verificar localStorage primero
            checkLocalStorageAvailable();
            
            // Verificar si ya existe perfil guardado
            const savedProfile = localStorage.getItem('userProfile');
            const splash = document.getElementById('splashScreen');
            const mainContainer = document.getElementById('mainContainer');
            
            console.log('üë§ Perfil guardado:', savedProfile ? 'S√≠' : 'No');
            
            if (savedProfile) {
                // Si hay perfil, saltar directamente sin animaciones
                splash.style.display = 'none';
                mainContainer.style.display = 'block';
                console.log('üì¶ Contenedor principal mostrado');
                init();
            } else {
                // Si no hay perfil, mostrar animaci√≥n y modal
                splash.classList.add('hide');
                
                setTimeout(() => {
                    splash.style.display = 'none';
                    mainContainer.style.display = 'block';
                    document.getElementById('profileModal').classList.add('show');
                    console.log('üìù Modal de perfil mostrado');
                    
                    // Iniciar el reloj aunque no haya perfil
                    updateClock();
                    setInterval(updateClock, 1000);
                }, 800);
            }
        }

        // Perfil del usuario
        let userProfile = {
            birthdate: null, // Fecha de nacimiento
            age: null, // Se calcula autom√°ticamente
            gender: null,
            height: null, // cm
            weight: null, // kg
            bmr: 0, // Tasa Metab√≥lica Basal
            dailyWater: 0, // ml diarios necesarios
            dailyCalories: 0
        };
        
        // Acciones de autocuidado y su cooldown
        const SELFCARE_ACTIONS = {
            microcuidados: [
                { id: 'cabello', name: 'Arreglarse el cabello', emoji: 'üíá‚Äç‚ôÄÔ∏è', boost: 5, cooldown: 'daily' },
                { id: 'skincare', name: 'Skin care', emoji: 'üß¥', boost: 5, cooldown: 'daily' },
                { id: 'dientes', name: 'Cepillarse los dientes', emoji: 'ü™•', boost: 5, cooldown: 'none' },
                { id: 'crema', name: 'Crema en todo el cuerpo', emoji: 'üß¥', boost: 15, cooldown: 'daily' },
                { id: 'foto', name: 'Tomarse una foto', emoji: 'üì∏', boost: 15, cooldown: 'none' },
                { id: 'limpiar', name: 'Limpiar el espacio', emoji: 'üßπ', boost: 15, cooldown: 'none' },
                { id: 'cejas', name: 'Depilarse las cejas', emoji: '‚ú®', boost: 10, cooldown: 'weekly' },
                { id: 'depilar', name: 'Depilarse el cuerpo', emoji: '‚ú®', boost: 15, cooldown: 'weekly' },
                { id: 'limpieza', name: 'Limpieza profunda del cuarto', emoji: 'üßΩ', boost: 20, cooldown: 'weekly' }
            ],
            regulacion: [
                { id: 'emociones', name: 'Escribir las emociones', emoji: 'üìù', boost: 10, cooldown: 'none' },
                { id: 'duele', name: 'Escribir lo que te duele', emoji: 'üíî', boost: 10, cooldown: 'none' },
                { id: 'agradecer', name: 'Escribir lo que agradeces', emoji: 'üôè', boost: 10, cooldown: 'none' },
                { id: 'bonito', name: 'Decirte algo bonito', emoji: 'üíù', boost: 10, cooldown: 'none' },
                { id: 'respirar', name: 'Respirar profundo 6 veces', emoji: 'üå¨Ô∏è', boost: 2, cooldown: 'none' }
            ],
            impacto: [
                { id: 'decision', name: 'Mantener tu decisi√≥n firme', emoji: 'üíé', boost: 10, cooldown: 'none' },
                { id: 'opinion', name: 'Defender tu opini√≥n', emoji: 'üó£Ô∏è', boost: 10, cooldown: 'none' },
                { id: 'gusto', name: 'Hacer algo solo porque te gusta', emoji: 'üé®', boost: 10, cooldown: 'none' },
                { id: 'sol', name: 'Tomar el sol 10 min (10am)', emoji: '‚òÄÔ∏è', boost: 10, cooldown: 'daily' },
                { id: 'ejercicio_auto', name: 'Hacer ejercicio', emoji: 'üí™', boost: 25, cooldown: 'daily' }
            ]
        };
        
        // Estado de cooldowns
        let selfcareCooldowns = {
            daily: {},
            weekly: {},
            lastReset: { daily: Date.now(), weekly: Date.now() }
        };
        
        // Acciones sociales
        const SOCIAL_ACTIONS = {
            familia: [
                { id: 'comer-familia', name: 'Comer con tu familia', emoji: 'üçΩÔ∏è', boost: 10, cooldown: 'daily' },
                { id: 'platicar-sin-celular', name: 'Platicar sin celular', emoji: 'üí¨', boost: 12, cooldown: 'daily' },
                { id: 'ayudar-casa', name: 'Ayudar en algo en casa', emoji: 'üè†', boost: 15, cooldown: 'daily' },
                { id: 'reir-familia', name: 'Re√≠r con ellos', emoji: 'üòÇ', boost: 12, cooldown: 'none' },
                { id: 'pelicula-juntos', name: 'Ver una pel√≠cula juntos', emoji: 'üé¨', boost: 20, cooldown: 'weekly' },
                { id: 'llamar-familiar', name: 'Llamar a un familiar', emoji: 'üìû', boost: 8, cooldown: 'none' },
                { id: 'abrazar', name: 'Abrazar', emoji: 'ü§ó', boost: 5, cooldown: 'none' },
                { id: 'beso-buenas-noches', name: 'Beso de buenas noches', emoji: 'üòò', boost: 5, cooldown: 'daily' }
            ],
            vinculos: [
                { id: 'platica-honesta', name: 'Pl√°tica honesta', emoji: 'üí≠', boost: 10, cooldown: 'none' },
                { id: 'reir-amigo', name: 'Re√≠rte', emoji: 'üòÑ', boost: 8, cooldown: 'none' },
                { id: 'tema-dificil', name: 'Platica de un tema dif√≠cil', emoji: 'üó£Ô∏è', boost: 50, cooldown: 'weekly' }
            ],
            facil: [
                { id: 'mensaje-casual', name: 'Mensaje casual', emoji: 'üí¨', boost: 3, cooldown: 'none' },
                { id: 'conversacion-breve', name: 'Conversaci√≥n breve', emoji: 'üëã', boost: 5, cooldown: 'none' },
                { id: 'saludar', name: 'Saludar', emoji: 'üòä', boost: 2, cooldown: 'none' }
            ]
        };
        
        // Acciones de crecimiento
        const GROWTH_ACTIONS = {
            aprendizaje: [
                { id: 'leer-libros', name: 'Leer libros', emoji: 'üìñ', boost: 2, cooldown: 'none' },
                { id: 'videos-educativos', name: 'Ver videos educativos', emoji: 'üé•', boost: 1, cooldown: 'none' },
                { id: 'investigar', name: 'Investigar temas', emoji: 'üîç', boost: 3, cooldown: 'none' },
                { id: 'apuntes', name: 'Tomar apuntes', emoji: 'üìù', boost: 4, cooldown: 'none' },
                { id: 'aprender-nuevo', name: 'Aprender algo nuevo', emoji: '‚ú®', boost: 4, cooldown: 'none' }
            ],
            enfermeria: [
                { id: 'repasar-temas', name: 'Repasar temas', emoji: 'üìñ', boost: 2, cooldown: 'none' },
                { id: 'revisar-apuntes', name: 'Revisar apuntes', emoji: 'üìù', boost: 2, cooldown: 'none' },
                { id: 'casos-clinicos', name: 'Pensar casos cl√≠nicos', emoji: 'üß†', boost: 2, cooldown: 'none' },
                { id: 'ordenar-material', name: 'Ordenar material', emoji: 'üìÑ', boost: 1, cooldown: 'none' },
                { id: 'investigar-dudas', name: 'Investigar dudas', emoji: 'üîç', boost: 2, cooldown: 'none' }
            ],
            farmacologia: [
                { id: 'repasar-farmacos', name: 'Repasar f√°rmacos', emoji: 'üíä', boost: 3, cooldown: 'none' },
                { id: 'estudiar-farmacos', name: 'Estudiar f√°rmacos', emoji: 'üìä', boost: 5, cooldown: 'none' },
                { id: 'ver-explicacion', name: 'Ver explicaci√≥n sencilla', emoji: 'üé•', boost: 2, cooldown: 'none' },
                { id: 'apuntes-farma', name: 'Apuntes', emoji: 'üß†', boost: 3, cooldown: 'none' }
            ],
            idiomas: [
                { id: 'leer-ingles', name: 'Leer en ingl√©s', emoji: 'üìñ', boost: 2, cooldown: 'none' },
                { id: 'escuchar-audio', name: 'Escuchar audio', emoji: 'üéß', boost: 2, cooldown: 'none' },
                { id: 'practicar-palabras', name: 'Practicar palabras', emoji: 'üó£Ô∏è', boost: 2, cooldown: 'none' },
                { id: 'escribir-frases', name: 'Escribir frases', emoji: 'üìù', boost: 3, cooldown: 'none' },
                { id: 'ver-series', name: 'Ver series', emoji: 'üé•', boost: 3, cooldown: 'none' },
                { id: 'app-idiomas', name: 'Usar app de idiomas (10 min)', emoji: 'üì±', boost: 2, cooldown: 'none' }
            ]
        };

        // Configuraci√≥n de estad√≠sticas
        const STATS_CONFIG = {
            hambre: {
                name: 'Hambre',
                icon: 'üçΩÔ∏è',
                decayRate: 4.2, // % por hora
                value: 100,
                maxDaily: 0 // Se calcular√° con BMR
            },
            sue√±o: {
                name: 'Sue√±o',
                icon: 'üò¥',
                decayRate: 4.2,
                value: 100,
                maxDaily: 8 // 8 horas recomendadas
            },
            hidratacion: {
                name: 'Hidrataci√≥n',
                icon: 'üíß',
                decayRate: 4.2,
                value: 100,
                maxDaily: 0 // Se calcular√° con peso
            },
            ejercicio: {
                name: 'Salud F√≠sica',
                icon: 'üèÉ',
                decayRate: 4.2,
                value: 100,
                maxDaily: 100
            },
            autoestima: {
                name: 'Autoestima',
                icon: 'üíñ',
                decayRate: 4.2,
                value: 100,
                maxDaily: 100
            },
            vidaSocial: {
                name: 'Vida Social',
                icon: 'üí¨',
                decayRate: 4.2,
                value: 100,
                maxDaily: 100
            },
            idiomas: {
                name: 'Idiomas',
                icon: 'üåç',
                decayRate: 0, // No decae
                value: 0,
                maxDaily: 100
            },
            aprendizaje: {
                name: 'Aprendizaje',
                icon: 'üìö',
                decayRate: 0, // No decae
                value: 0,
                maxDaily: 100
            },
            contenido: {
                name: 'Contenido',
                icon: 'üé¨',
                decayRate: 0, // No decae
                value: 0,
                maxDaily: 100
            },
            profesion: {
                name: 'Profesi√≥n',
                icon: 'üë©‚Äç‚öïÔ∏è',
                decayRate: 0, // No decae
                value: 0,
                maxDaily: 100
            }
        };

        // MET (Metabolic Equivalent of Task) para cada actividad
        const MET_VALUES = {
            taekwondo: { leve: 6.0, moderado: 8.0, intenso: 10.0 },
            caminar: { lento: 3.0, moderado: 3.5, rapido: 4.5 },
            correr: { leve: 6.5, moderado: 9.0, intenso: 12.5 },
            patinar: { recreativo: 6.0, moderado: 7.0, intenso: 9.0 },
            pesas: { brazos: 5.0, espalda: 6.0, piernas: 7.0 }
        };

        // Calcular TMB (Tasa Metab√≥lica Basal) - F√≥rmula Mifflin-St Jeor
        function calculateBMR() {
            const { age, gender, height, weight } = userProfile;
            
            if (!age || !height || !weight) return 0;
            
            // BMR = (10 √ó peso en kg) + (6.25 √ó altura en cm) - (5 √ó edad en a√±os) + s
            // s = +5 para hombres, -161 para mujeres
            const s = gender === 'masculino' ? 5 : (gender === 'femenino' ? -161 : -78);
            const bmr = (10 * weight) + (6.25 * height) - (5 * age) + s;
            
            return Math.round(bmr);
        }

        // Calcular hidrataci√≥n diaria necesaria
        function calculateDailyWater() {
            // 30-35 ml por kg de peso corporal
            return Math.round(userProfile.weight * 32.5);
        }

        // Calcular calor√≠as quemadas por actividad
        function calculateCaloriesBurned(met, durationMinutes) {
            // Calor√≠as = MET √ó peso (kg) √ó duraci√≥n (horas)
            const hours = durationMinutes / 60;
            return Math.round(met * userProfile.weight * hours);
        }

        // Convertir calor√≠as a porcentaje de hambre
        function caloriesToHungerPercent(calories) {
            // Porcentaje basado en BMR
            return (calories / userProfile.bmr) * 100;
        }

        // Convertir ml a porcentaje de hidrataci√≥n
        function mlToHydrationPercent(ml) {
            return (ml / userProfile.dailyWater) * 100;
        }

        // Guardar perfil y calcular valores
        function saveProfile() {
            const birthdate = document.getElementById('userBirthdate').value;
            userProfile.gender = document.getElementById('userGender').value;
            userProfile.height = parseInt(document.getElementById('userHeight').value);
            userProfile.weight = parseFloat(document.getElementById('userWeight').value);
            
            if (!birthdate || !userProfile.height || !userProfile.weight) {
                alert('‚ö†Ô∏è Por favor completa todos los campos');
                return;
            }
            
            // Guardar fecha de nacimiento y calcular edad
            userProfile.birthdate = birthdate;
            userProfile.age = calculateAge(birthdate);
            
            // Validar l√≠mites
            if (userProfile.age < 10) {
                alert('‚ö†Ô∏è Debes tener al menos 10 a√±os para usar la app');
                return;
            }
            if (userProfile.age > 120) {
                alert('‚ö†Ô∏è Verifica tu fecha de nacimiento');
                return;
            }
            if (userProfile.height > 200) {
                alert('‚ö†Ô∏è La altura m√°xima es 200 cm (2 metros)');
                return;
            }
            if (userProfile.weight > 180) {
                alert('‚ö†Ô∏è El peso m√°ximo es 180 kg');
                return;
            }
            
            // Calcular valores personalizados
            userProfile.bmr = calculateBMR();
            userProfile.dailyWater = calculateDailyWater();
            userProfile.dailyCalories = Math.round(userProfile.bmr * 1.2); // Factor de actividad ligera
            
            STATS_CONFIG.hambre.maxDaily = userProfile.bmr;
            STATS_CONFIG.hidratacion.maxDaily = userProfile.dailyWater;
            
            // Guardar perfil
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            
            // Cerrar modal
            document.getElementById('profileModal').classList.remove('show');
            
            // Mostrar el contenedor principal si estaba oculto
            document.getElementById('mainContainer').style.display = 'block';
            
            // Inicializar juego
            init();
            
            console.log('üìä Perfil guardado:', userProfile);
            console.log(`TMB: ${userProfile.bmr} kcal/d√≠a | Agua: ${userProfile.dailyWater}ml/d√≠a`);
        }
        
        // Calcular edad desde fecha de nacimiento
        function calculateAge(birthdate) {
            const birth = new Date(birthdate);
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            // Ajustar si a√∫n no ha cumplido a√±os este a√±o
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            
            return age;
        }
        
        // Mostrar edad calculada cuando se selecciona fecha
        document.addEventListener('DOMContentLoaded', () => {
            const birthdateInput = document.getElementById('userBirthdate');
            const ageDisplay = document.getElementById('ageDisplay');
            
            // Establecer fecha m√°xima (hoy)
            const today = new Date().toISOString().split('T')[0];
            birthdateInput.setAttribute('max', today);
            
            birthdateInput.addEventListener('change', function() {
                if (this.value) {
                    const age = calculateAge(this.value);
                    ageDisplay.textContent = `‚ú® Tu edad: ${age} a√±os`;
                } else {
                    ageDisplay.textContent = '';
                }
            });
        });
        
        // Funci√≥n para resetear perfil y volver al cuestionario
        function resetProfile() {
            if (confirm('‚ö†Ô∏è ¬øEst√°s seguro? Esto borrar√° tu perfil y podr√°s volver a hacer el cuestionario.')) {
                // Borrar perfil de localStorage
                localStorage.removeItem('userProfile');
                localStorage.removeItem('gameState');
                
                // Recargar la p√°gina para volver al inicio
                location.reload();
            }
        }

        // Estado del juego
        let gameState = {
            stats: {},
            lastUpdate: Date.now(),
            hydrationBreakdown: {
                agua: 0,
                azucarada: 0,
                refresco: 0,
                cafe: 0
            },
            dailyChecks: {
                ba√±arme: { done: false, boost: 5, emoji: 'üöø', name: 'Ba√±arme' },
                tenderCama: { done: false, boost: 5, emoji: 'üõèÔ∏è', name: 'Tender la cama' },
                ropaLinda: { done: false, boost: 20, emoji: 'üëó', name: 'Ropa linda' },
                perfume: { done: false, boost: 3, emoji: 'üíê', name: 'Perfume' },
                maquillarse: { done: false, boost: 10, emoji: 'üíÑ', name: 'Maquillarse' },
                lastReset: new Date().toDateString()
            },
            completedSuggestions: [],
            favorites: [],
            ideas: {
                pendientes: [],
                grabadas: [],
                editadas: [],
                publicadas: []
            },
            wrongActivities: {
                list: [],
                lastReset: new Date().toDateString()
            }
        };

        // Inicializar estad√≠sticas
        function initStats() {
            // Cargar perfil
            const savedProfile = localStorage.getItem('userProfile');
            if (savedProfile) {
                userProfile = JSON.parse(savedProfile);
                STATS_CONFIG.hambre.maxDaily = userProfile.bmr;
                STATS_CONFIG.hidratacion.maxDaily = userProfile.dailyWater;
            }
            
            // Cargar desde localStorage si existe
            const saved = localStorage.getItem('gameState');
            if (saved) {
                gameState = JSON.parse(saved);
                
                // Migrar datos antiguos sin desglose
                if (!gameState.hydrationBreakdown) {
                    gameState.hydrationBreakdown = {
                        agua: 0,
                        azucarada: 0,
                        refresco: 0,
                        cafe: 0
                    };
                }
                
                // Migrar estructura de balance general
                if (!gameState.dailyChecks) {
                    gameState.dailyChecks = {
                        hygiene: false,
                        grooming: false,
                        tidiness: false,
                        lastReset: new Date().toDateString()
                    };
                }
                
                if (!gameState.completedSuggestions) {
                    gameState.completedSuggestions = [];
                }
                
                if (!gameState.favorites) {
                    gameState.favorites = [];
                }
                
                // Migrar estructura de wrongActivities
                if (!gameState.wrongActivities) {
                    gameState.wrongActivities = {
                        list: [],
                        lastReset: new Date().toDateString()
                    };
                }
                
                // Asegurar que todas las estad√≠sticas existen (incluyendo nuevas)
                Object.keys(STATS_CONFIG).forEach(key => {
                    if (!gameState.stats[key]) {
                        gameState.stats[key] = { ...STATS_CONFIG[key] };
                    }
                });
                
                // Calcular tiempo transcurrido y aplicar decaimiento
                const now = Date.now();
                const hoursElapsed = (now - gameState.lastUpdate) / (1000 * 60 * 60);
                
                Object.keys(gameState.stats).forEach(key => {
                    const decayAmount = STATS_CONFIG[key].decayRate * hoursElapsed;
                    gameState.stats[key].value = Math.max(0, gameState.stats[key].value - decayAmount);
                });
                
                gameState.lastUpdate = now;
            } else {
                // Inicializar nuevo juego
                Object.keys(STATS_CONFIG).forEach(key => {
                    gameState.stats[key] = { ...STATS_CONFIG[key] };
                });
            }
            
            saveState();
        }

        // Guardar estado (mejorado para Safari)
        function saveState() {
            try {
                localStorage.setItem('gameState', JSON.stringify(gameState));
                // Guardar timestamp de √∫ltima actualizaci√≥n
                localStorage.setItem('lastSave', new Date().toISOString());
                console.log('üíæ Estado guardado');
            } catch (e) {
                console.error('‚ö†Ô∏è Error guardando estado:', e);
                // Si falla, intentar limpiar datos antiguos
                if (e.name === 'QuotaExceededError') {
                    console.log('üßπ Limpiando datos antiguos...');
                    localStorage.removeItem('oldData');
                    localStorage.setItem('gameState', JSON.stringify(gameState));
                }
            }
        }

        // Renderizar estad√≠sticas
        function renderStats() {
            // Renderizar estad√≠sticas de Existir (hambre, sue√±o, hidrataci√≥n)
            const existirContainer = document.getElementById('statsExistir');
            existirContainer.innerHTML = '';
            ['hambre', 'sue√±o', 'hidratacion'].forEach(key => {
                if (gameState.stats[key]) {
                    existirContainer.appendChild(createStatElement(key, gameState.stats[key]));
                }
            });

            // Renderizar estad√≠sticas de Cuidarme (autoestima, vida social)
            const cuidarmeContainer = document.getElementById('statsCuidarme');
            cuidarmeContainer.innerHTML = '';
            ['autoestima', 'vidaSocial'].forEach(key => {
                if (gameState.stats[key]) {
                    cuidarmeContainer.appendChild(createStatElement(key, gameState.stats[key]));
                }
            });

            // Renderizar estad√≠sticas de Ejercicio
            const ejercicioContainer = document.getElementById('statsEjercicio');
            if (ejercicioContainer) {
                ejercicioContainer.innerHTML = '';
                if (gameState.stats.ejercicio) {
                    ejercicioContainer.appendChild(createStatElement('ejercicio', gameState.stats.ejercicio));
                }
            }

            // Renderizar estad√≠sticas de Crecer (idiomas, aprendizaje, profesi√≥n)
            const crecerContainer = document.getElementById('statsCrecer');
            crecerContainer.innerHTML = '';
            ['idiomas', 'aprendizaje', 'profesion'].forEach(key => {
                if (gameState.stats[key]) {
                    crecerContainer.appendChild(createStatElement(key, gameState.stats[key]));
                }
            });

            // Renderizar todas las estad√≠sticas en Resumen
            const resumenContainer = document.getElementById('statsResumen');
            resumenContainer.innerHTML = '';
            Object.keys(gameState.stats).forEach(key => {
                resumenContainer.appendChild(createStatElement(key, gameState.stats[key]));
            });

            // Actualizar balance general
            updateBalanceGeneral();
        }

        // Crear elemento de estad√≠stica
        function createStatElement(key, stat) {
            const percentage = isNaN(stat.value) ? 0 : Math.round(stat.value);
            const isGrowthStat = ['idiomas', 'aprendizaje', 'contenido', 'profesion'].includes(key);
            
            // Determinar clase de color seg√∫n porcentaje
            let barClass = 'stat-bar-high';
            if (percentage < 70 && percentage >= 40) {
                barClass = 'stat-bar-medium';
            } else if (percentage < 40) {
                barClass = 'stat-bar-low';
            }
            
            // Para estad√≠sticas de crecimiento, usar siempre verde
            if (isGrowthStat) {
                barClass = 'stat-bar-high';
            }
            
            // Para hambre que excede 100%, usar color rojo de advertencia
            if (key === 'hambre' && percentage > 100) {
                barClass = 'stat-bar-low';
            }

            // Informaci√≥n personalizada para hambre e hidrataci√≥n
            let personalInfo = '';
            if (key === 'hambre' && userProfile.bmr > 0) {
                if (percentage > 100) {
                    const exceso = Math.round(percentage - 100);
                    personalInfo = `<div style="font-size: 0.85em; color: #ef4444; margin-top: 5px; font-weight: bold;">‚ö†Ô∏è ¬°Exceso de ${exceso}%! Est√°s superando la cantidad m√°xima necesaria</div>`;
                } else {
                    personalInfo = `<div style="font-size: 0.85em; color: #a78bfa; margin-top: 5px;">Meta diaria: ${userProfile.bmr} kcal</div>`;
                }
            } else if (key === 'hidratacion' && userProfile.dailyWater > 0) {
                const breakdown = gameState.hydrationBreakdown;
                const total = breakdown.agua + breakdown.azucarada + breakdown.refresco + breakdown.cafe;
                const feedback = getHydrationFeedback();
                
                personalInfo = `
                    <div style="font-size: 0.85em; color: #a78bfa; margin-top: 5px;">Meta diaria: ${userProfile.dailyWater} ml</div>
                    ${total > 0 ? `
                        <div style="font-size: 0.8em; margin-top: 8px; line-height: 1.4;">
                            <div style="color: #3b82f6;">üíß Agua natural: ${breakdown.agua} ml</div>
                            <div style="color: #f97316;">üßÉ Bebidas azucaradas: ${breakdown.azucarada} ml</div>
                            <div style="color: #ef4444;">ü•§ Refresco: ${breakdown.refresco} ml</div>
                            <div style="color: #8b5cf6;">‚òï Caf√©/t√©: ${breakdown.cafe} ml</div>
                        </div>
                        ${feedback ? `<div style="font-size: 0.85em; color: #6b4c9a; margin-top: 8px; font-weight: 600; background: rgba(167, 139, 250, 0.1); padding: 8px; border-radius: 8px;">${feedback}</div>` : ''}
                    ` : ''}`;
            }
            
            // Para estad√≠sticas de crecimiento, mostrar que no tienen l√≠mite
            if (isGrowthStat) {
                personalInfo = `<div style="font-size: 0.75em; color: #56ab2f; margin-top: 5px;">‚ú® Progreso sin l√≠mite</div>`;
            }

            const statDiv = document.createElement('div');
            statDiv.className = `stat-item ${(!isGrowthStat && percentage < 20) || (key === 'hambre' && percentage > 100) ? 'warning' : ''}`;
            
            // Para stats de crecimiento y hambre que pueden pasar del 100%, ajustar el ancho de la barra
            const barWidth = (isGrowthStat || key === 'hambre') ? Math.min(percentage, 100) : percentage;
            
            // Crear barra especial para hidrataci√≥n con desglose por colores
            let barHTML = '';
            if (key === 'hidratacion' && userProfile.dailyWater > 0) {
                const breakdown = gameState.hydrationBreakdown;
                const total = breakdown.agua + breakdown.azucarada + breakdown.refresco + breakdown.cafe;
                
                if (total > 0) {
                    const aguaPct = (breakdown.agua / userProfile.dailyWater) * 100;
                    const azucaradaPct = (breakdown.azucarada / userProfile.dailyWater) * 100;
                    const refrescoPct = (breakdown.refresco / userProfile.dailyWater) * 100;
                    const cafePct = (breakdown.cafe / userProfile.dailyWater) * 100;
                    
                    barHTML = `
                        <div class="stat-bar-container">
                            <div style="width: ${Math.min(aguaPct, 100)}%; height: 100%; background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); position: absolute; left: 0; border-radius: 10px 0 0 10px;"></div>
                            <div style="width: ${Math.min(azucaradaPct, 100 - aguaPct)}%; height: 100%; background: linear-gradient(135deg, #f97316 0%, #fb923c 100%); position: absolute; left: ${Math.min(aguaPct, 100)}%; border-radius: ${aguaPct >= 100 ? '10px' : '0'};"></div>
                            <div style="width: ${Math.min(refrescoPct, 100 - aguaPct - azucaradaPct)}%; height: 100%; background: linear-gradient(135deg, #ef4444 0%, #f87171 100%); position: absolute; left: ${Math.min(aguaPct + azucaradaPct, 100)}%; border-radius: ${(aguaPct + azucaradaPct) >= 100 ? '10px' : '0'};"></div>
                            <div style="width: ${Math.min(cafePct, 100 - aguaPct - azucaradaPct - refrescoPct)}%; height: 100%; background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%); position: absolute; left: ${Math.min(aguaPct + azucaradaPct + refrescoPct, 100)}%; border-radius: ${(aguaPct + azucaradaPct + refrescoPct) >= 100 ? '10px' : '0 10px 10px 0'};"></div>
                        </div>
                    `;
                } else {
                    barHTML = `<div class="stat-bar-container"><div class="stat-bar-fill ${barClass}" style="width: ${barWidth}%"></div></div>`;
                }
            } else {
                barHTML = `<div class="stat-bar-container"><div class="stat-bar-fill ${barClass}" style="width: ${barWidth}%"></div></div>`;
            }
            
            statDiv.innerHTML = `
                <div class="stat-header">
                    <div class="stat-name">
                        <span class="stat-icon">${stat.icon}</span>
                        ${stat.name}
                    </div>
                    <div class="stat-value">${percentage}%</div>
                </div>
                ${barHTML}
            `;
            
            // Agregar informaci√≥n personalizada si existe
            if (personalInfo) {
                const infoDiv = document.createElement('div');
                infoDiv.style.fontSize = '0.75em';
                // Color din√°mico seg√∫n el tipo de mensaje
                if (key === 'hambre' && percentage > 100) {
                    infoDiv.style.color = '#ef4444'; // Rojo para advertencia
                } else {
                    infoDiv.style.color = isGrowthStat ? '#56ab2f' : '#a78bfa';
                }
                infoDiv.style.marginTop = '-5px';
                infoDiv.style.textAlign = 'center';
                infoDiv.innerHTML = personalInfo.replace(/<div[^>]*>|<\/div>/g, '');
                statDiv.appendChild(infoDiv);
            }
            
            return statDiv;
        }

        // ===== SISTEMA DE BALANCE GENERAL =====
        
        // Resetear checks diarios si cambi√≥ el d√≠a
        function resetDailyChecksIfNeeded() {
            const today = new Date().toDateString();
            if (gameState.dailyChecks.lastReset !== today) {
                gameState.dailyChecks = {
                    ba√±arme: { done: false, boost: 5, emoji: 'üöø', name: 'Ba√±arme' },
                    tenderCama: { done: false, boost: 5, emoji: 'üõèÔ∏è', name: 'Tender la cama' },
                    ropaLinda: { done: false, boost: 20, emoji: 'üëó', name: 'Ropa linda' },
                    perfume: { done: false, boost: 3, emoji: 'üíê', name: 'Perfume' },
                    maquillarse: { done: false, boost: 10, emoji: 'üíÑ', name: 'Maquillarse' },
                    lastReset: today
                };
                gameState.completedSuggestions = [];
                saveState();
                console.log('üîÑ Checks diarios reseteados (nuevo d√≠a)');
            }
        }
        
        // Renderizar checks diarios
        function renderDailyChecks() {
            resetDailyChecksIfNeeded();
            const container = document.getElementById('dailyChecksContainer');
            if (!container) return;
            
            const checksOrder = ['ba√±arme', 'tenderCama', 'ropaLinda', 'perfume', 'maquillarse'];
            
            container.innerHTML = checksOrder.map(checkId => {
                const check = gameState.dailyChecks[checkId];
                if (!check) return '';
                
                const isChecked = check.done;
                return `
                    <div onclick="toggleDailyCheck('${checkId}')" style="
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        padding: 12px;
                        background: ${isChecked ? 'linear-gradient(135deg, #a8e063 0%, #56ab2f 100%)' : 'rgba(255, 255, 255, 0.7)'};
                        border-radius: 12px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        border: 2px solid ${isChecked ? '#56ab2f' : '#e0e0e0'};
                        box-shadow: ${isChecked ? '0 4px 12px rgba(168, 224, 99, 0.4)' : '0 2px 6px rgba(0,0,0,0.05)'};
                    ">
                        <div style="
                            width: 24px;
                            height: 24px;
                            border-radius: 50%;
                            background: ${isChecked ? '#fff' : 'transparent'};
                            border: 2px solid ${isChecked ? '#56ab2f' : '#9e9e9e'};
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 0.9em;
                            flex-shrink: 0;
                        ">
                            ${isChecked ? '‚úì' : ''}
                        </div>
                        <div style="font-size: 1.3em; flex-shrink: 0;">${check.emoji}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: ${isChecked ? '#fff' : '#388e3c'}; font-size: 0.95em;">${check.name}</div>
                            <div style="font-size: 0.75em; color: ${isChecked ? 'rgba(255,255,255,0.9)' : '#757575'}; margin-top: 2px;">+${check.boost}% autoestima</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Toggle check diario
        function toggleDailyCheck(checkId) {
            const check = gameState.dailyChecks[checkId];
            if (!check) return;
            
            const wasChecked = check.done;
            check.done = !wasChecked;
            
            if (!wasChecked) {
                // Completado: aumentar autoestima
                gameState.stats.autoestima.value = Math.min(100, gameState.stats.autoestima.value + check.boost);
                console.log(`‚úì Check completado: ${check.name} (+${check.boost}% autoestima)`);
            } else {
                // Desmarcado: quitar autoestima
                gameState.stats.autoestima.value = Math.max(0, gameState.stats.autoestima.value - check.boost);
                console.log(`‚úó Check desmarcado: ${check.name} (-${check.boost}% autoestima)`);
            }
            
            saveState();
            renderDailyChecks();
            renderStats();
        }
        
        // Mapa de acciones disponibles
        const ACTION_MAP = {
            hambre: { label: 'Comer', icon: 'üçΩÔ∏è', action: 'openEatModal()' },
            hidratacion: { label: 'Beber', icon: 'üíß', action: 'openWaterModal()' },
            sue√±o: { label: 'Dormir', icon: 'üò¥', action: 'openSleepModal()' },
            ejercicio: { label: 'Ejercicio', icon: 'üèÉ', action: 'openExerciseModal()' },
            autoestima: { label: 'Autocuidado', icon: 'üíù', action: 'openSelfcareModal()' },
            vidaSocial: { label: 'Socializar', icon: 'üë•', action: 'openSocialModal()' },
            aprendizaje: { label: 'Aprender', icon: 'üìö', action: 'openAprendizajeModal()' },
            idiomas: { label: 'Idiomas', icon: 'üåç', action: 'openIdiomasModal()' },
            profesion: { label: 'Profesi√≥n', icon: 'üë©‚Äç‚öïÔ∏è', action: 'openProfesionModal()' }
        };
        
        // Generar sugerencias inteligentes
        function generateSmartSuggestions() {
            const stats = gameState.stats;
            const suggestions = [];
            
            // Obtener stats ordenadas por prioridad (m√°s bajas primero)
            const sortedStats = Object.keys(stats)
                .filter(key => !['hambre'].includes(key)) // Excluir hambre de sugerencias
                .map(key => ({ key, value: stats[key].current, name: stats[key].name }))
                .sort((a, b) => a.value - b.value);
            
            // Generar 2-4 sugerencias basadas en stats m√°s bajas
            let count = 0;
            for (const stat of sortedStats) {
                if (count >= 4) break;
                
                // Solo sugerir si est√° por debajo de 60% y no fue completada hoy
                if (stat.value < 60 && !gameState.completedSuggestions.includes(stat.key)) {
                    const action = ACTION_MAP[stat.key];
                    if (action) {
                        suggestions.push({
                            key: stat.key,
                            label: action.label,
                            icon: action.icon,
                            action: action.action,
                            stat: stat.name,
                            value: Math.round(stat.value)
                        });
                        count++;
                    }
                }
            }
            
            // Si no hay sugerencias cr√≠ticas, agregar mantenimiento
            if (suggestions.length === 0) {
                const maintenanceActions = ['hidratacion', 'ejercicio', 'autoestima', 'aprendizaje']
                    .filter(key => !gameState.completedSuggestions.includes(key))
                    .slice(0, 2);
                
                maintenanceActions.forEach(key => {
                    const action = ACTION_MAP[key];
                    if (action) {
                        suggestions.push({
                            key,
                            label: action.label,
                            icon: action.icon,
                            action: action.action,
                            stat: stats[key].name,
                            value: Math.round(stats[key].value)
                        });
                    }
                });
            }
            
            return suggestions;
        }
        
        // Renderizar rutina sugerida
        function renderSuggestedRoutine() {
            const container = document.getElementById('suggestedRoutineContainer');
            if (!container) return;
            
            const suggestions = generateSmartSuggestions();
            
            if (suggestions.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #42a5f5; font-size: 0.9em; padding: 10px;">‚ú® ¬°Todo en orden! Sigue as√≠</div>';
                return;
            }
            
            container.innerHTML = suggestions.map(sugg => `
                <div onclick="executeSuggestion('${sugg.key}', '${sugg.action}')" style="
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    padding: 12px 15px;
                    background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
                    border-radius: 12px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    border: 2px solid #90caf9;
                    box-shadow: 0 2px 8px rgba(66, 165, 245, 0.2);
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(66, 165, 245, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(66, 165, 245, 0.2)'">
                    <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                        <div style="font-size: 1.5em;">${sugg.icon}</div>
                        <div>
                            <div style="font-weight: 600; color: #1565c0; font-size: 0.95em;">${sugg.label}</div>
                            <div style="font-size: 0.75em; color: #616161; margin-top: 2px;">Afecta: ${sugg.stat} (${sugg.value}%)</div>
                        </div>
                    </div>
                    <div style="background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%); color: white; padding: 6px 12px; border-radius: 8px; font-size: 0.8em; font-weight: 600;">Hacer</div>
                </div>
            `).join('');
        }
        
        // Ejecutar sugerencia
        function executeSuggestion(key, actionFn) {
            // Marcar como completada
            if (!gameState.completedSuggestions.includes(key)) {
                gameState.completedSuggestions.push(key);
                saveState();
            }
            
            // Ejecutar acci√≥n
            eval(actionFn);
            
            // Re-renderizar despu√©s de un momento
            setTimeout(() => {
                renderSuggestedRoutine();
            }, 500);
        }
        
        // Renderizar favoritos
        function renderFavorites() {
            const container = document.getElementById('favoritesContainer');
            if (!container) return;
            
            if (!gameState.favorites || gameState.favorites.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #f57c00; font-size: 0.9em; padding: 10px;">Toca "+ Elegir" para seleccionar tus acciones favoritas</div>';
                return;
            }
            
            container.innerHTML = gameState.favorites.map(key => {
                const action = ACTION_MAP[key];
                if (!action) return '';
                
                const stat = gameState.stats[key];
                const value = stat ? Math.round(stat.value) : 0;
                
                return `
                    <div onclick="${action.action}" style="
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        padding: 12px 15px;
                        background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
                        border-radius: 12px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        border: 2px solid #ffb74d;
                        box-shadow: 0 2px 8px rgba(255, 152, 0, 0.2);
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(255, 152, 0, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(255, 152, 0, 0.2)'">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="font-size: 1.5em;">${action.icon}</div>
                            <div>
                                <div style="font-weight: 600; color: #e65100; font-size: 0.95em;">${action.label}</div>
                                ${stat ? `<div style="font-size: 0.75em; color: #616161; margin-top: 2px;">${stat.name}: ${value}%</div>` : ''}
                            </div>
                        </div>
                        <div style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; padding: 6px 12px; border-radius: 8px; font-size: 0.8em; font-weight: 600;">‚Üí</div>
                    </div>
                `;
            }).join('');
        }
        
        // Abrir selector de favoritos
        function openFavoritesSelector() {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 450px;">
                    <div class="modal-header">
                        <div class="modal-title">‚ú® Elegir Favoritos</div>
                        <div class="modal-subtitle">Selecciona hasta 6 acciones (${gameState.favorites.length}/6)</div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 10px; max-height: 50vh; overflow-y: auto; padding: 10px 5px;">
                        ${Object.keys(ACTION_MAP).map(key => {
                            const action = ACTION_MAP[key];
                            const isSelected = gameState.favorites.includes(key);
                            return `
                                <div onclick="toggleFavorite('${key}')" id="fav-${key}" style="
                                    display: flex;
                                    align-items: center;
                                    gap: 12px;
                                    padding: 12px;
                                    background: ${isSelected ? 'linear-gradient(135deg, #ff9800 0%, #f57c00 100%)' : 'linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%)'};
                                    border-radius: 12px;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    border: 2px solid ${isSelected ? '#f57c00' : '#e0e0e0'};
                                ">
                                    <div style="
                                        width: 24px;
                                        height: 24px;
                                        border-radius: 50%;
                                        background: ${isSelected ? '#fff' : 'transparent'};
                                        border: 2px solid ${isSelected ? '#f57c00' : '#9e9e9e'};
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        font-size: 0.9em;
                                        flex-shrink: 0;
                                    ">
                                        ${isSelected ? '‚úì' : ''}
                                    </div>
                                    <div style="font-size: 1.3em;">${action.icon}</div>
                                    <div style="font-weight: 600; color: ${isSelected ? '#fff' : '#424242'}; flex: 1;">${action.label}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <button class="modal-close" onclick="closeFavoritesSelector()">‚úì Guardar</button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Toggle favorito
        function toggleFavorite(key) {
            const index = gameState.favorites.indexOf(key);
            
            if (index > -1) {
                // Remover
                gameState.favorites.splice(index, 1);
            } else {
                // Agregar si no excede el l√≠mite
                if (gameState.favorites.length < 6) {
                    gameState.favorites.push(key);
                } else {
                    alert('‚ö†Ô∏è M√°ximo 6 favoritos. Deselecciona uno primero.');
                    return;
                }
            }
            
            saveState();
            
            // Actualizar visual del modal
            const action = ACTION_MAP[key];
            const isSelected = gameState.favorites.includes(key);
            const elem = document.getElementById(`fav-${key}`);
            if (elem) {
                elem.style.background = isSelected ? 'linear-gradient(135deg, #ff9800 0%, #f57c00 100%)' : 'linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%)';
                elem.style.borderColor = isSelected ? '#f57c00' : '#e0e0e0';
                elem.querySelector('div:nth-child(1)').style.background = isSelected ? '#fff' : 'transparent';
                elem.querySelector('div:nth-child(1)').style.borderColor = isSelected ? '#f57c00' : '#9e9e9e';
                elem.querySelector('div:nth-child(1)').textContent = isSelected ? '‚úì' : '';
                elem.querySelector('div:nth-child(3)').style.color = isSelected ? '#fff' : '#424242';
            }
            
            // Actualizar contador
            const subtitle = document.querySelector('.modal-subtitle');
            if (subtitle) {
                subtitle.textContent = `Selecciona hasta 6 acciones (${gameState.favorites.length}/6)`;
            }
        }
        
        // Cerrar selector de favoritos
        function closeFavoritesSelector() {
            const modal = document.querySelector('.modal.show');
            if (modal) {
                modal.remove();
                renderFavorites();
            }
        }
        
        // Actualizar todos los bloques del balance general
        function updateBalanceGeneral() {
            renderDailyChecks();
            renderSuggestedRoutine();
            renderFavorites();
        }

        // Funci√≥n para cambiar de tab
        function switchTab(tabName) {
            // Remover clase active de todos los tabs y contenidos
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Agregar clase active al tab clickeado
            const tabs = document.querySelectorAll('.tab');
            const tabNames = ['existir', 'cuidarme', 'ejercicio', 'crecer', 'biblioteca', 'ideas', 'calendario', 'resumen'];
            const index = tabNames.indexOf(tabName);
            if (index !== -1) {
                tabs[index].classList.add('active');
            }
            
            // Mostrar contenido correspondiente
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Si es biblioteca, renderizar contenido
            if (tabName === 'biblioteca') {
                renderLibraryContent();
            }
            
            // Si es ejercicio, renderizar calendario
            if (tabName === 'ejercicio') {
                renderExerciseCalendar();
            }
            
            // Si es ideas, renderizar ideas
            if (tabName === 'ideas') {
                renderIdeas();
                updateContenidoBar();
                renderScheduledVideos();
            }
            
            // Si es calendario, renderizar calendario
            if (tabName === 'calendario') {
                renderMonthlyCalendar();
                renderActivities();
            }
        }

        // Actualizar estad√≠sticas continuamente
        function updateStats() {
            const now = Date.now();
            const hoursElapsed = (now - gameState.lastUpdate) / (1000 * 60 * 60);
            
            if (hoursElapsed > 0) {
                Object.keys(gameState.stats).forEach(key => {
                    const decayAmount = STATS_CONFIG[key].decayRate * hoursElapsed;
                    gameState.stats[key].value = Math.max(0, gameState.stats[key].value - decayAmount);
                });
                
                // Resetear desglose de hidrataci√≥n si cambi√≥ el d√≠a
                const lastUpdateDate = new Date(gameState.lastUpdate).toDateString();
                const currentDate = new Date(now).toDateString();
                if (lastUpdateDate !== currentDate) {
                    gameState.hydrationBreakdown = {
                        agua: 0,
                        azucarada: 0,
                        refresco: 0,
                        cafe: 0
                    };
                    console.log('üîÑ Desglose de hidrataci√≥n reseteado (nuevo d√≠a)');
                }
                
                gameState.lastUpdate = now;
                saveState();
                renderStats();
                
                console.log(`‚è±Ô∏è Estad√≠sticas actualizadas. Horas transcurridas: ${hoursElapsed.toFixed(2)}`);
            }
        }

        // Resetear estad√≠sticas
        function resetStats() {
            if (confirm('¬øEst√°s seguro de que quieres resetear todas las estad√≠sticas a 100%?')) {
                Object.keys(STATS_CONFIG).forEach(key => {
                    gameState.stats[key] = { ...STATS_CONFIG[key] };
                });
                gameState.lastUpdate = Date.now();
                saveState();
                renderStats();
            }
        }

        // Actualizar reloj en tiempo real
        function updateClock() {
            const now = new Date();
            const days = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            const dayName = days[now.getDay()];
            const day = now.getDate();
            const month = months[now.getMonth()];
            const year = now.getFullYear();
            
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            const dateElement = document.getElementById('dateDisplay');
            const timeElement = document.getElementById('timeDisplay');
            
            if (dateElement) dateElement.textContent = `üìÖ ${dayName}, ${day} de ${month} de ${year}`;
            if (timeElement) timeElement.textContent = `‚è∞ ${hours}:${minutes}:${seconds}`;
        }
        
        // Funciones para calcular d√≠as vividos y d√≠as restantes
        function calculateDaysLived() {
            if (!userProfile.birthdate) return 0;
            const birth = new Date(userProfile.birthdate);
            const today = new Date();
            const diffTime = Math.abs(today - birth);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }
        
        function calculateEstimatedDaysLeft() {
            if (!userProfile.birthdate) return 0;
            const birth = new Date(userProfile.birthdate);
            const today = new Date();
            const age = calculateAge(userProfile.birthdate);
            const estimatedDeathAge = 72; // Media de esperanza de vida
            const yearsLeft = Math.max(0, estimatedDeathAge - age);
            const daysLeft = Math.floor(yearsLeft * 365.25);
            return daysLeft;
        }
        
        function toggleLifeDays() {
            const display = document.getElementById('lifeDaysDisplay');
            const deathDisplay = document.getElementById('deathDaysDisplay');
            
            if (display.classList.contains('show')) {
                display.classList.remove('show');
            } else {
                deathDisplay.classList.remove('show');
                const days = calculateDaysLived();
                display.textContent = `‚ù§Ô∏è ${days.toLocaleString()} d√≠as vividos`;
                display.classList.add('show');
                
                // Ocultar despu√©s de 3 segundos
                setTimeout(() => display.classList.remove('show'), 3000);
            }
        }
        
        function toggleDeathDays() {
            const display = document.getElementById('deathDaysDisplay');
            const lifeDisplay = document.getElementById('lifeDaysDisplay');
            
            if (display.classList.contains('show')) {
                display.classList.remove('show');
            } else {
                lifeDisplay.classList.remove('show');
                const days = calculateEstimatedDaysLeft();
                const years = Math.floor(days / 365.25);
                display.textContent = `üíÄ ~${days.toLocaleString()} d√≠as (~${years} a√±os)`;
                display.classList.add('show');
                
                // Ocultar despu√©s de 3 segundos
                setTimeout(() => display.classList.remove('show'), 3000);
            }
        }
        
        function calculateDaysUntilBirthday() {
            if (!userProfile.birthdate) return 0;
            const birth = new Date(userProfile.birthdate);
            const today = new Date();
            
            // Pr√≥ximo cumplea√±os
            const nextBirthday = new Date(today.getFullYear(), birth.getMonth(), birth.getDate());
            
            // Si ya pas√≥ este a√±o, calcular para el pr√≥ximo
            if (nextBirthday < today) {
                nextBirthday.setFullYear(today.getFullYear() + 1);
            }
            
            const diffTime = nextBirthday - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }
        
        function toggleBirthday() {
            const display = document.getElementById('birthdayDisplay');
            const lifeDisplay = document.getElementById('lifeDaysDisplay');
            const deathDisplay = document.getElementById('deathDaysDisplay');
            
            if (display.classList.contains('show')) {
                display.classList.remove('show');
            } else {
                lifeDisplay.classList.remove('show');
                deathDisplay.classList.remove('show');
                const days = calculateDaysUntilBirthday();
                display.textContent = days === 0 ? 'üéÇ ¬°Hoy es tu cumplea√±os!' : `üéÇ Faltan ${days} d√≠as para tu cumplea√±os`;
                display.classList.add('show');
                
                // Ocultar despu√©s de 3 segundos
                setTimeout(() => display.classList.remove('show'), 3000);
            }
        }

        // Funciones del modal de comida
        function openEatModal() {
            document.getElementById('caloriesInput').value = '';
            document.getElementById('caloriesInfo').style.display = 'none';
            document.getElementById('bmrDisplay').textContent = userProfile.bmr;
            document.getElementById('eatModal').classList.add('show');
            
            // Agregar listener para actualizar en tiempo real
            document.getElementById('caloriesInput').addEventListener('input', function() {
                const calories = parseFloat(this.value);
                if (calories && calories > 0) {
                    const hungerPercent = caloriesToHungerPercent(calories);
                    document.getElementById('hungerIncrease').textContent = hungerPercent.toFixed(1);
                    document.getElementById('caloriesInfo').style.display = 'block';
                } else {
                    document.getElementById('caloriesInfo').style.display = 'none';
                }
            });
        }

        function closeEatModal() {
            document.getElementById('eatModal').classList.remove('show');
        }

        function calculateEatEffects() {
            const calories = parseFloat(document.getElementById('caloriesInput').value);
            
            if (!calories || calories < 1) {
                alert('‚ö†Ô∏è Por favor ingresa las calor√≠as consumidas');
                return;
            }
            
            // Calcular porcentaje de hambre basado en BMR
            const hungerPercent = caloriesToHungerPercent(calories);
            
            // Aplicar los cambios (limitar entre 0 y 100)
            gameState.stats.hambre.value = Math.min(100, Math.max(0, gameState.stats.hambre.value + hungerPercent));
            
            // Tambi√©n se reduce un poco la hidrataci√≥n (al comer necesitas agua)
            const hydrationDecrease = hungerPercent * 0.15; // 15% de las calor√≠as afecta hidrataci√≥n
            gameState.stats.hidratacion.value = Math.max(0, gameState.stats.hidratacion.value - hydrationDecrease);
            
            gameState.lastUpdate = Date.now();
            saveState();
            renderStats();
            closeEatModal();
            
            console.log(`¬°Comiste ${calories} kcal! +${hungerPercent.toFixed(1)}% de hambre`);
        }

        // Funciones del modal de agua
        function openWaterModal() {
            document.getElementById('waterModal').classList.add('show');
            // Limpiar inputs
            document.getElementById('drinkAmount').value = '';
            document.getElementById('drinkType').value = 'agua';
        }

        function closeWaterModal() {
            document.getElementById('waterModal').classList.remove('show');
        }

        function registerDrink() {
            const ml = parseInt(document.getElementById('drinkAmount').value);
            const type = document.getElementById('drinkType').value;
            
            if (!ml || ml <= 0) {
                alert('‚ö†Ô∏è Por favor ingresa una cantidad v√°lida');
                return;
            }
            
            if (ml > 2000) {
                alert('‚ö†Ô∏è Cantidad muy alta. M√°ximo 2000 ml por registro');
                return;
            }
            
            // Calcular porcentaje basado en necesidad diaria personalizada
            const percentage = mlToHydrationPercent(ml);
            
            // Aumentar hidrataci√≥n total
            gameState.stats.hidratacion.value = Math.min(100, gameState.stats.hidratacion.value + percentage);
            
            // Registrar en desglose por tipo
            gameState.hydrationBreakdown[type] = (gameState.hydrationBreakdown[type] || 0) + ml;
            
            gameState.lastUpdate = Date.now();
            saveState();
            renderStats();
            closeWaterModal();
            
            // Obtener nombre del tipo
            const typeNames = {
                agua: 'agua natural',
                azucarada: 'bebida azucarada',
                refresco: 'refresco',
                cafe: 'caf√©/t√© con leche'
            };
            
            console.log(`‚úì Registrado: ${ml}ml de ${typeNames[type]} (+${percentage.toFixed(1)}%)`);
        }
        
        // Obtener mensaje de feedback seg√∫n proporciones
        function getHydrationFeedback() {
            const breakdown = gameState.hydrationBreakdown;
            const total = breakdown.agua + breakdown.azucarada + breakdown.refresco + breakdown.cafe;
            
            if (total === 0) return '';
            
            const aguaPct = (breakdown.agua / total) * 100;
            const azucarPct = ((breakdown.azucarada + breakdown.refresco) / total) * 100;
            const refrescoPct = (breakdown.refresco / total) * 100;
            
            // Mensajes seg√∫n proporciones
            if (aguaPct >= 80) {
                return 'üíô ¬°Excelente! Priorizaste agua natural';
            } else if (aguaPct >= 60) {
                return 'üëç Buen equilibrio, priorizaste agua';
            } else if (refrescoPct >= 40) {
                return '‚ö†Ô∏è Mucho refresco hoy, intenta reducir ma√±ana';
            } else if (azucarPct >= 50) {
                return '‚ö° Llegaste a la meta, pero con alto consumo de az√∫car';
            } else if (aguaPct >= 40) {
                return 'üíß Vas bien, pero podr√≠as tomar m√°s agua natural';
            } else {
                return 'ü•§ Intenta aumentar el agua natural gradualmente';
            }
        }

        // Funciones del modal de dormir
        function openSleepModal() {
            document.getElementById('sleepModal').classList.add('show');
        }

        function closeSleepModal() {
            document.getElementById('sleepModal').classList.remove('show');
        }

        function sleep(percentage) {
            // Aumentar sue√±o
            gameState.stats.sue√±o.value = Math.min(100, gameState.stats.sue√±o.value + percentage);
            gameState.lastUpdate = Date.now();
            saveState();
            renderStats();
            closeSleepModal();
            
            console.log(`¬°Dormiste! +${percentage}% de sue√±o`);
        }

        function calculateSleep() {
            const sleepTime = document.getElementById('sleepTime').value;
            const wakeTime = document.getElementById('wakeTime').value;
            
            if (!sleepTime || !wakeTime) {
                alert('‚ö†Ô∏è Por favor ingresa ambas horas (dormir y despertar)');
                return;
            }
            
            // Convertir las horas a minutos desde medianoche
            const [sleepHour, sleepMin] = sleepTime.split(':').map(Number);
            const [wakeHour, wakeMin] = wakeTime.split(':').map(Number);
            
            let sleepMinutes = sleepHour * 60 + sleepMin;
            let wakeMinutes = wakeHour * 60 + wakeMin;
            
            // Si la hora de despertar es menor, significa que es al d√≠a siguiente
            if (wakeMinutes <= sleepMinutes) {
                wakeMinutes += 24 * 60; // A√±adir 24 horas en minutos
            }
            
            // Calcular diferencia en minutos y convertir a horas
            const totalMinutes = wakeMinutes - sleepMinutes;
            const hours = totalMinutes / 60;
            
            // Calcular porcentaje (cada hora = 11.11%)
            const percentage = hours * 11.11;
            
            // Mostrar mensaje confirmando las horas
            const hoursText = hours.toFixed(1);
            const percentageText = percentage.toFixed(2);
            
            if (confirm(`¬øDormiste ${hoursText} horas?\n\nEsto a√±adir√° +${percentageText}% a tu sue√±o.`)) {
                sleep(percentage);
            }
        }

        // Variable para almacenar la actividad seleccionada
        let selectedActivity = '';

        // Funciones del modal de ejercicio
        function openExerciseModal() {
            document.getElementById('exerciseModal').classList.add('show');
        }

        function closeExerciseModal() {
            document.getElementById('exerciseModal').classList.remove('show');
        }

        function selectActivity(activity) {
            selectedActivity = activity;
            closeExerciseModal();
            
            if (activity === 'ü•ã Taekwondo') {
                openIntensityModal();
            } 
            else if (activity === 'üö∂ Caminar') {
                openWalkModal();
            }
            else if (activity === 'üèÉ Correr') {
                openRunModal();
            }
            else if (activity === '‚õ∏Ô∏è Patinar') {
                openSkateModal();
            }
            else if (activity === 'üèãÔ∏è Pesas') {
                openWeightsModal();
            }
        }

        function openIntensityModal() {
            document.getElementById('intensityTitle').textContent = selectedActivity;
            document.getElementById('taekwondoDuration').value = '';
            document.getElementById('intensityOptions').style.display = 'none';
            document.getElementById('intensityModal').classList.add('show');
        }

        function closeIntensityModal() {
            document.getElementById('intensityModal').classList.remove('show');
        }

        function calculateIntensityEffects() {
            const duration = parseInt(document.getElementById('taekwondoDuration').value);
            
            if (!duration || duration < 1) {
                alert('‚ö†Ô∏è Por favor ingresa la duraci√≥n del entrenamiento en minutos');
                return;
            }
            
            // Generar botones con efectos calculados
            const intensityOptions = document.querySelector('#intensityOptions .modal-options');
            intensityOptions.innerHTML = '';
            
            const intensities = [
                { key: 'leve', icon: 'üòå', name: 'Leve', color: 'linear-gradient(135deg, #a8e063 0%, #56ab2f 100%)' },
                { key: 'moderado', icon: 'üí™', name: 'Moderado', color: 'linear-gradient(135deg, #ffd89b 0%, #f093fb 100%)' },
                { key: 'intenso', icon: 'üî•', name: 'Intenso', color: 'linear-gradient(135deg, #ff6b9d 0%, #c44569 100%)' }
            ];
            
            intensities.forEach(intensity => {
                const met = MET_VALUES.taekwondo[intensity.key];
                const caloriesBurned = calculateCaloriesBurned(met, duration);
                const hungerPercent = caloriesToHungerPercent(caloriesBurned);
                const waterNeeded = caloriesBurned * 1.75;
                const hydrationPercent = mlToHydrationPercent(waterNeeded);
                
                const button = document.createElement('button');
                button.className = 'option-button';
                button.style.background = intensity.color;
                button.onclick = () => applyExercise(intensity.key, duration);
                button.innerHTML = `
                    <span style="display: flex; flex-direction: column; align-items: flex-start; gap: 5px;">
                        <span class="option-ml">${intensity.icon} ${intensity.name}</span>
                        <span style="font-size: 0.85em; opacity: 0.9;">Hambre -${hungerPercent.toFixed(1)}% | Hidrataci√≥n -${hydrationPercent.toFixed(1)}%</span>
                    </span>
                `;
                intensityOptions.appendChild(button);
            });
            
            // Mostrar opciones
            document.getElementById('intensityOptions').style.display = 'block';
        }

        function applyExercise(intensity, duration) {
            const met = MET_VALUES.taekwondo[intensity];
            
            // Calcular calor√≠as quemadas
            const caloriesBurned = calculateCaloriesBurned(met, duration);
            const hungerPercent = caloriesToHungerPercent(caloriesBurned);
            
            // Calcular hidrataci√≥n necesaria (aproximadamente 150-200ml por cada 100 kcal)
            const waterNeeded = caloriesBurned * 1.75;
            const hydrationPercent = mlToHydrationPercent(waterNeeded);
            
            const effect = {
                hambre: -hungerPercent,
                hidratacion: -hydrationPercent,
                ejercicio: 50,
                autoestima: 25
            };
            
            // Aplicar los cambios a las estad√≠sticas
            gameState.stats.hambre.value = Math.max(0, gameState.stats.hambre.value + effect.hambre);
            gameState.stats.hidratacion.value = Math.max(0, gameState.stats.hidratacion.value + effect.hidratacion);
            gameState.stats.ejercicio.value = Math.min(100, gameState.stats.ejercicio.value + effect.ejercicio);
            gameState.stats.autoestima.value = Math.min(100, gameState.stats.autoestima.value + effect.autoestima);
            
            gameState.lastUpdate = Date.now();
            saveState();
            renderStats();
            closeIntensityModal();
            
            // Mostrar mensaje de confirmaci√≥n
            const intensityName = intensity.charAt(0).toUpperCase() + intensity.slice(1);
            console.log(`¬°${selectedActivity} - ${intensityName} (${duration} min)! ${caloriesBurned} kcal | ${Math.round(waterNeeded)}ml`);
        }

        // Funciones del modal de caminar
        function openWalkModal() {
            document.getElementById('walkDuration').value = '';
            document.getElementById('walkUnit').value = 'minutos';
            document.getElementById('walkOptions').style.display = 'none';
            updateWalkInputLabel();
            document.getElementById('walkModal').classList.add('show');
        }

        function closeWalkModal() {
            document.getElementById('walkModal').classList.remove('show');
        }

        function updateWalkInputLabel() {
            const unit = document.getElementById('walkUnit').value;
            const label = document.getElementById('walkInputLabel');
            const input = document.getElementById('walkDuration');
            
            if (unit === 'minutos') {
                label.textContent = 'Minutos caminados:';
                input.placeholder = 'Ej: 30';
                input.max = '300';
            } else {
                label.textContent = 'N√∫mero de pasos:';
                input.placeholder = 'Ej: 5000';
                input.max = '50000';
            }
        }

        function calculateWalkEffects() {
            const unit = document.getElementById('walkUnit').value;
            const value = parseFloat(document.getElementById('walkDuration').value);
            
            if (!value || value < 1) {
                const message = unit === 'minutos' 
                    ? '‚ö†Ô∏è Por favor ingresa la duraci√≥n de tu caminata en minutos'
                    : '‚ö†Ô∏è Por favor ingresa el n√∫mero de pasos';
                alert(message);
                return;
            }
            
            // Convertir pasos a minutos si es necesario
            // Promedio: 100 pasos por minuto (ritmo moderado)
            let duration = value;
            if (unit === 'pasos') {
                duration = value / 100; // Convertir pasos a minutos
            }
            
            // Generar botones con efectos calculados seg√∫n ritmo
            const walkOptions = document.querySelector('#walkOptions .modal-options');
            walkOptions.innerHTML = '';
            
            const paces = [
                { key: 'lento', icon: 'üö∂', name: 'Lento (paseo)', color: 'linear-gradient(135deg, #a8e063 0%, #56ab2f 100%)' },
                { key: 'moderado', icon: 'üö∂‚Äç‚ôÇÔ∏è', name: 'Moderado (caminata)', color: 'linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%)' },
                { key: 'rapido', icon: 'üö∂‚Äç‚ôÄÔ∏è', name: 'R√°pido (power walk)', color: 'linear-gradient(135deg, #ffd89b 0%, #f093fb 100%)' }
            ];
            
            paces.forEach(pace => {
                const met = MET_VALUES.caminar[pace.key];
                const caloriesBurned = calculateCaloriesBurned(met, duration);
                const hungerPercent = caloriesToHungerPercent(caloriesBurned);
                const waterNeeded = caloriesBurned * 1.5;
                const hydrationPercent = mlToHydrationPercent(waterNeeded);
                
                const button = document.createElement('button');
                button.className = 'option-button';
                button.style.background = pace.color;
                button.onclick = () => applyWalk(pace.key, duration);
                button.innerHTML = `
                    <span style="display: flex; flex-direction: column; align-items: flex-start; gap: 5px;">
                        <span class="option-ml">${pace.icon} ${pace.name}</span>
                        <span style="font-size: 0.85em; opacity: 0.9;">Hambre -${hungerPercent.toFixed(1)}% | Hidrataci√≥n -${hydrationPercent.toFixed(1)}%</span>
                    </span>
                `;
                walkOptions.appendChild(button);
            });
            
            document.getElementById('walkOptions').style.display = 'block';
        }

        function applyWalk(pace, duration) {
            const met = MET_VALUES.caminar[pace];
            const caloriesBurned = calculateCaloriesBurned(met, duration);
            const hungerPercent = caloriesToHungerPercent(caloriesBurned);
            const waterNeeded = caloriesBurned * 1.5;
            const hydrationPercent = mlToHydrationPercent(waterNeeded);
            
            gameState.stats.hambre.value = Math.max(0, gameState.stats.hambre.value - hungerPercent);
            gameState.stats.hidratacion.value = Math.max(0, gameState.stats.hidratacion.value - hydrationPercent);
            gameState.stats.ejercicio.value = Math.min(100, gameState.stats.ejercicio.value + 10);
            gameState.stats.autoestima.value = Math.min(100, gameState.stats.autoestima.value + 5);
            
            gameState.lastUpdate = Date.now();
            saveState();
            renderStats();
            closeWalkModal();
            
            console.log(`¬°Caminaste ${duration} min (${pace})! ${caloriesBurned} kcal | ${Math.round(waterNeeded)}ml`);
        }

        // Funciones del modal de correr
        function openRunModal() {
            document.getElementById('runDuration').value = '';
            document.getElementById('runUnit').value = 'minutos';
            document.getElementById('runOptions').style.display = 'none';
            updateRunInputLabel();
            document.getElementById('runModal').classList.add('show');
        }

        function closeRunModal() {
            document.getElementById('runModal').classList.remove('show');
        }

        function updateRunInputLabel() {
            const unit = document.getElementById('runUnit').value;
            const label = document.getElementById('runInputLabel');
            const input = document.getElementById('runDuration');
            
            if (unit === 'minutos') {
                label.textContent = 'Minutos:';
                input.placeholder = 'Ej: 20';
                input.max = '300';
            } else {
                label.textContent = 'Kil√≥metros:';
                input.placeholder = 'Ej: 5';
                input.max = '50';
            }
        }

        function calculateRunEffects() {
            const unit = document.getElementById('runUnit').value;
            const value = parseFloat(document.getElementById('runDuration').value);
            
            if (!value || value < 0.1) {
                const message = unit === 'minutos' 
                    ? '‚ö†Ô∏è Por favor ingresa la duraci√≥n de tu carrera en minutos'
                    : '‚ö†Ô∏è Por favor ingresa la distancia en kil√≥metros';
                alert(message);
                return;
            }
            
            // Convertir kil√≥metros a minutos si es necesario
            // Promedio: 1 km = 6 minutos (pace moderado ~10 km/h)
            let duration = value;
            if (unit === 'kilometros') {
                duration = value * 6; // Convertir km a minutos aproximados
            }
            
            // Generar botones con efectos calculados seg√∫n intensidad
            const runOptions = document.querySelector('#runOptions .modal-options');
            runOptions.innerHTML = '';
            
            const intensities = [
                { key: 'leve', icon: 'üèÉ', name: 'Leve (trote)', color: 'linear-gradient(135deg, #a8e063 0%, #56ab2f 100%)' },
                { key: 'moderado', icon: 'üèÉ‚Äç‚ôÇÔ∏è', name: 'Moderado (ritmo constante)', color: 'linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%)' },
                { key: 'intenso', icon: 'üî•', name: 'Intenso (sprint/HIIT)', color: 'linear-gradient(135deg, #ff6b9d 0%, #c44569 100%)' }
            ];
            
            intensities.forEach(intensity => {
                const met = MET_VALUES.correr[intensity.key];
                const caloriesBurned = calculateCaloriesBurned(met, duration);
                const hungerPercent = caloriesToHungerPercent(caloriesBurned);
                const waterNeeded = caloriesBurned * 2.0;
                const hydrationPercent = mlToHydrationPercent(waterNeeded);
                
                const button = document.createElement('button');
                button.className = 'option-button';
                button.style.background = intensity.color;
                button.onclick = () => applyRun(intensity.key, duration);
                button.innerHTML = `
                    <span style="display: flex; flex-direction: column; align-items: flex-start; gap: 5px;">
                        <span class="option-ml">${intensity.icon} ${intensity.name}</span>
                        <span style="font-size: 0.85em; opacity: 0.9;">Hambre -${hungerPercent.toFixed(1)}% | Hidrataci√≥n -${hydrationPercent.toFixed(1)}%</span>
                    </span>
                `;
                runOptions.appendChild(button);
            });
            
            document.getElementById('runOptions').style.display = 'block';
        }

        function applyRun(intensity, duration) {
            const met = MET_VALUES.correr[intensity];
            const caloriesBurned = calculateCaloriesBurned(met, duration);
            const hungerPercent = caloriesToHungerPercent(caloriesBurned);
            const waterNeeded = caloriesBurned * 2.0;
            const hydrationPercent = mlToHydrationPercent(waterNeeded);
            
            gameState.stats.hambre.value = Math.max(0, gameState.stats.hambre.value - hungerPercent);
            gameState.stats.hidratacion.value = Math.max(0, gameState.stats.hidratacion.value - hydrationPercent);
            gameState.stats.ejercicio.value = Math.min(100, gameState.stats.ejercicio.value + 40);
            gameState.stats.autoestima.value = Math.min(100, gameState.stats.autoestima.value + 20);
            
            gameState.lastUpdate = Date.now();
            saveState();
            renderStats();
            closeRunModal();
            
            console.log(`¬°Corriste ${duration.toFixed(1)} min (${intensity})! ${caloriesBurned} kcal | ${Math.round(waterNeeded)}ml`);
        }

        // Funciones del modal de patinar
        function openSkateModal() {
            document.getElementById('skateDuration').value = '';
            document.getElementById('skateOptions').style.display = 'none';
            document.getElementById('skateModal').classList.add('show');
        }

        function closeSkateModal() {
            document.getElementById('skateModal').classList.remove('show');
        }

        function calculateSkateEffects() {
            const duration = parseInt(document.getElementById('skateDuration').value);
            
            if (!duration || duration < 1) {
                alert('‚ö†Ô∏è Por favor ingresa la duraci√≥n de tu sesi√≥n de patinaje en minutos');
                return;
            }
            
            const skateOptions = document.querySelector('#skateOptions .modal-options');
            skateOptions.innerHTML = '';
            
            const intensities = [
                { key: 'recreativo', icon: '‚õ∏Ô∏è', name: 'Recreativo', color: 'linear-gradient(135deg, #a8e063 0%, #56ab2f 100%)' },
                { key: 'moderado', icon: '‚õ∏Ô∏è', name: 'Moderado', color: 'linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%)' },
                { key: 'intenso', icon: '‚õ∏Ô∏è', name: 'Intenso', color: 'linear-gradient(135deg, #ff6b9d 0%, #c44569 100%)' }
            ];
            
            intensities.forEach(intensity => {
                const met = MET_VALUES.patinar[intensity.key];
                const caloriesBurned = calculateCaloriesBurned(met, duration);
                const hungerPercent = caloriesToHungerPercent(caloriesBurned);
                const waterNeeded = caloriesBurned * 1.6;
                const hydrationPercent = mlToHydrationPercent(waterNeeded);
                
                const button = document.createElement('button');
                button.className = 'option-button';
                button.style.background = intensity.color;
                button.onclick = () => applySkating(intensity.key, duration);
                button.innerHTML = `
                    <span style="display: flex; flex-direction: column; align-items: flex-start; gap: 5px;">
                        <span class="option-ml">${intensity.icon} ${intensity.name}</span>
                        <span style="font-size: 0.85em; opacity: 0.9;">Hambre -${hungerPercent.toFixed(1)}% | Hidrataci√≥n -${hydrationPercent.toFixed(1)}%</span>
                    </span>
                `;
                skateOptions.appendChild(button);
            });
            
            document.getElementById('skateOptions').style.display = 'block';
        }

        function applySkating(intensity, duration) {
            const met = MET_VALUES.patinar[intensity];
            const caloriesBurned = calculateCaloriesBurned(met, duration);
            const hungerPercent = caloriesToHungerPercent(caloriesBurned);
            const waterNeeded = caloriesBurned * 1.6;
            const hydrationPercent = mlToHydrationPercent(waterNeeded);
            
            gameState.stats.hambre.value = Math.max(0, gameState.stats.hambre.value - hungerPercent);
            gameState.stats.hidratacion.value = Math.max(0, gameState.stats.hidratacion.value - hydrationPercent);
            gameState.stats.ejercicio.value = Math.min(100, gameState.stats.ejercicio.value + 35);
            gameState.stats.autoestima.value = Math.min(100, gameState.stats.autoestima.value + 15);
            
            gameState.lastUpdate = Date.now();
            saveState();
            renderStats();
            closeSkateModal();
            
            console.log(`¬°Patinaste ${duration} min (${intensity})! ${caloriesBurned} kcal | ${Math.round(waterNeeded)}ml`);
        }

        // Funciones del modal de pesas
        function openWeightsModal() {
            document.getElementById('weightsDuration').value = '';
            document.getElementById('muscleGroup').value = 'piernas';
            document.getElementById('weightsModal').classList.add('show');
        }

        function closeWeightsModal() {
            document.getElementById('weightsModal').classList.remove('show');
        }

        function calculateWeightsEffects() {
            const duration = parseInt(document.getElementById('weightsDuration').value);
            const muscleGroup = document.getElementById('muscleGroup').value;
            
            if (!duration || duration < 1) {
                alert('‚ö†Ô∏è Por favor ingresa la duraci√≥n de tu entrenamiento en minutos');
                return;
            }
            
            const met = MET_VALUES.pesas[muscleGroup];
            const caloriesBurned = calculateCaloriesBurned(met, duration);
            const hungerPercent = caloriesToHungerPercent(caloriesBurned);
            const waterNeeded = caloriesBurned * 1.8;
            const hydrationPercent = mlToHydrationPercent(waterNeeded);
            
            const muscleNames = {
                piernas: 'Piernas/Gl√∫teos',
                espalda: 'Espalda/Pecho',
                brazos: 'Brazos/Hombros'
            };
            
            if (confirm(`üèãÔ∏è Pesas - ${muscleNames[muscleGroup]} - ${duration} minutos\n\nEfectos:\n- Hambre: -${hungerPercent.toFixed(1)}%\n- Hidrataci√≥n: -${hydrationPercent.toFixed(1)}%\n- Salud F√≠sica: +45%\n- Autoestima: +25%\n\n¬øAplicar?`)) {
                gameState.stats.hambre.value = Math.max(0, gameState.stats.hambre.value - hungerPercent);
                gameState.stats.hidratacion.value = Math.max(0, gameState.stats.hidratacion.value - hydrationPercent);
                gameState.stats.ejercicio.value = Math.min(100, gameState.stats.ejercicio.value + 45);
                gameState.stats.autoestima.value = Math.min(100, gameState.stats.autoestima.value + 25);
                
                gameState.lastUpdate = Date.now();
                saveState();
                renderStats();
                closeWeightsModal();
                
                console.log(`¬°Hiciste pesas ${duration} min (${muscleNames[muscleGroup]})! ${caloriesBurned} kcal | ${Math.round(waterNeeded)}ml`);
            }
        }
        
        // Funciones de autoestima
        function loadSelfcareCooldowns() {
            const saved = localStorage.getItem('selfcareCooldowns');
            if (saved) {
                selfcareCooldowns = JSON.parse(saved);
            }
            resetCooldownsIfNeeded();
        }
        
        function saveSelfcareCooldowns() {
            localStorage.setItem('selfcareCooldowns', JSON.stringify(selfcareCooldowns));
        }
        
        function resetCooldownsIfNeeded() {
            const now = Date.now();
            const oneDayMs = 24 * 60 * 60 * 1000;
            const oneWeekMs = 7 * oneDayMs;
            
            // Reset diarios
            if (now - selfcareCooldowns.lastReset.daily > oneDayMs) {
                selfcareCooldowns.daily = {};
                selfcareCooldowns.lastReset.daily = now;
                saveSelfcareCooldowns();
            }
            
            // Reset semanales
            if (now - selfcareCooldowns.lastReset.weekly > oneWeekMs) {
                selfcareCooldowns.weekly = {};
                selfcareCooldowns.lastReset.weekly = now;
                saveSelfcareCooldowns();
            }
        }
        
        function isActionAvailable(actionId, cooldown) {
            if (cooldown === 'none') return true;
            if (cooldown === 'daily') return !selfcareCooldowns.daily[actionId];
            if (cooldown === 'weekly') return !selfcareCooldowns.weekly[actionId];
            return true;
        }
        
        function markActionUsed(actionId, cooldown) {
            if (cooldown === 'daily') {
                selfcareCooldowns.daily[actionId] = Date.now();
            } else if (cooldown === 'weekly') {
                selfcareCooldowns.weekly[actionId] = Date.now();
            }
            saveSelfcareCooldowns();
        }
        
        function openSelfcareModal() {
            loadSelfcareCooldowns();
            document.getElementById('selfcareModal').classList.add('show');
        }
        
        function closeSelfcareModal() {
            document.getElementById('selfcareModal').classList.remove('show');
        }
        
        function openSelfcareCategory(category) {
            closeSelfcareModal();
            const actions = SELFCARE_ACTIONS[category];
            let container, modal;
            
            if (category === 'microcuidados') {
                container = document.getElementById('microcuidadosOptions');
                modal = document.getElementById('microcuidadosModal');
            } else if (category === 'regulacion') {
                container = document.getElementById('regulacionOptions');
                modal = document.getElementById('regulacionModal');
            } else {
                container = document.getElementById('impactoOptions');
                modal = document.getElementById('impactoModal');
            }
            
            container.innerHTML = '';
            
            actions.forEach(action => {
                const available = isActionAvailable(action.id, action.cooldown);
                
                // Ocultar botones que ya se usaron (no est√°n disponibles)
                if (!available) {
                    return; // No mostrar el bot√≥n
                }
                
                const button = document.createElement('button');
                button.className = 'option-button';
                button.style.opacity = '1';
                button.style.cursor = 'pointer';
                button.style.background = 'linear-gradient(135deg, #a78bfa 0%, #c084fc 100%)';
                
                let cooldownText = '';
                if (action.cooldown === 'daily') cooldownText = ' (1x d√≠a)';
                else if (action.cooldown === 'weekly') cooldownText = ' (1x semana)';
                
                button.innerHTML = `
                    <span style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <span style="font-size: 1.05em;">${action.emoji} ${action.name}${cooldownText}</span>
                        <span style="font-size: 1.1em; font-weight: bold; color: #10b981;">+${action.boost}%</span>
                    </span>
                `;
                
                button.onclick = () => applySelfcareAction(action);
                
                container.appendChild(button);
            });
            
            modal.classList.add('show');
        }
        
        function applySelfcareAction(action) {
            gameState.stats.autoestima.value = Math.min(100, gameState.stats.autoestima.value + action.boost);
            markActionUsed(action.id, action.cooldown);
            saveState();
            renderStats();
            
            // Cerrar el modal correspondiente
            document.getElementById('microcuidadosModal').classList.remove('show');
            document.getElementById('regulacionModal').classList.remove('show');
            document.getElementById('impactoModal').classList.remove('show');
            
            console.log(`${action.emoji} ${action.name}: Autoestima +${action.boost}%`);
        }
        
        function closeMicrocuidadosModal() {
            document.getElementById('microcuidadosModal').classList.remove('show');
            openSelfcareModal();
        }
        
        function closeRegulacionModal() {
            document.getElementById('regulacionModal').classList.remove('show');
            openSelfcareModal();
        }
        
        function closeImpactoModal() {
            document.getElementById('impactoModal').classList.remove('show');
            openSelfcareModal();
        }
        
        // Funciones de Vida Social
        function openSocialModal() {
            document.getElementById('socialModal').classList.add('show');
        }
        
        function closeSocialModal() {
            document.getElementById('socialModal').classList.remove('show');
        }
        
        function openSocialCategory(category) {
            closeSocialModal();
            
            const actions = SOCIAL_ACTIONS[category];
            let modalId, optionsId;
            
            if (category === 'familia') {
                modalId = 'familiaModal';
                optionsId = 'familiaOptions';
            } else if (category === 'vinculos') {
                modalId = 'vinculosModal';
                optionsId = 'vinculosOptions';
            } else if (category === 'facil') {
                modalId = 'facilModal';
                optionsId = 'facilOptions';
            }
            
            const container = document.getElementById(optionsId);
            container.innerHTML = '';
            
            actions.forEach(action => {
                const button = document.createElement('button');
                button.style.cssText = 'width: 100%; padding: 12px 15px; background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%); border: none; border-radius: 12px; font-size: 1em; font-weight: 600; color: white; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(161, 196, 253, 0.3); display: flex; justify-content: space-between; align-items: center;';
                
                button.innerHTML = `
                    <span style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.3em;">${action.emoji}</span>
                        <span>${action.name}</span>
                    </span>
                    <span style="background: rgba(255, 255, 255, 0.3); padding: 5px 12px; border-radius: 10px; font-size: 0.9em;">+${action.boost}%</span>
                `;
                
                button.onclick = () => applySocialAction(action);
                container.appendChild(button);
            });
            
            document.getElementById(modalId).classList.add('show');
        }
        
        function applySocialAction(action) {
            // Aumentar vida social
            gameState.stats.vidaSocial.value = Math.min(100, gameState.stats.vidaSocial.value + action.boost);
            
            gameState.lastUpdate = Date.now();
            saveState();
            renderStats();
            
            // Cerrar todos los modales sociales
            document.getElementById('familiaModal').classList.remove('show');
            document.getElementById('vinculosModal').classList.remove('show');
            document.getElementById('facilModal').classList.remove('show');
            
            console.log(`${action.emoji} ${action.name}: +${action.boost}% vida social`);
        }
        
        function closeFamiliaModal() {
            document.getElementById('familiaModal').classList.remove('show');
            openSocialModal();
        }
        
        function closeVinculosModal() {
            document.getElementById('vinculosModal').classList.remove('show');
            openSocialModal();
        }
        
        function closeFacilModal() {
            document.getElementById('facilModal').classList.remove('show');
            openSocialModal();
        }
        
        // Funciones de Crecimiento
        function openIdiomasModal() {
            const actions = GROWTH_ACTIONS.idiomas;
            const container = document.getElementById('idiomasOptions');
            container.innerHTML = '';
            
            actions.forEach(action => {
                const button = createGrowthButton(action, 'idiomas');
                container.appendChild(button);
            });
            
            document.getElementById('idiomasModal').classList.add('show');
        }
        
        function closeIdiomasModal() {
            document.getElementById('idiomasModal').classList.remove('show');
        }
        
        function openAprendizajeModal() {
            const actions = GROWTH_ACTIONS.aprendizaje;
            const container = document.getElementById('aprendizajeOptions');
            container.innerHTML = '';
            
            actions.forEach(action => {
                const button = createGrowthButton(action, 'aprendizaje');
                container.appendChild(button);
            });
            
            document.getElementById('aprendizajeModal').classList.add('show');
        }
        
        function closeAprendizajeModal() {
            document.getElementById('aprendizajeModal').classList.remove('show');
        }
        
        function openProfesionModal() {
            document.getElementById('profesionModal').classList.add('show');
        }
        
        function closeProfesionModal() {
            document.getElementById('profesionModal').classList.remove('show');
        }
        
        function openProfesionCategory(category) {
            closeProfesionModal();
            
            const actions = GROWTH_ACTIONS[category];
            let modalId, optionsId;
            
            if (category === 'enfermeria') {
                modalId = 'enfermeriaModal';
                optionsId = 'enfermeriaOptions';
            } else if (category === 'farmacologia') {
                modalId = 'farmacologiaModal';
                optionsId = 'farmacologiaOptions';
            }
            
            const container = document.getElementById(optionsId);
            container.innerHTML = '';
            
            actions.forEach(action => {
                const button = createGrowthButton(action, 'profesion');
                container.appendChild(button);
            });
            
            document.getElementById(modalId).classList.add('show');
        }
        
        function closeEnfermeriaModal() {
            document.getElementById('enfermeriaModal').classList.remove('show');
            openProfesionModal();
        }
        
        function closeFarmacologiaModal() {
            document.getElementById('farmacologiaModal').classList.remove('show');
            openProfesionModal();
        }
        
        function createGrowthButton(action, statKey) {
            const button = document.createElement('button');
            button.style.cssText = 'width: 100%; padding: 12px 15px; background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%); border: none; border-radius: 12px; font-size: 1em; font-weight: 600; color: white; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(161, 196, 253, 0.3); display: flex; justify-content: space-between; align-items: center;';
            
            button.innerHTML = `
                <span style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.3em;">${action.emoji}</span>
                    <span>${action.name}</span>
                </span>
                <span style="background: rgba(255, 255, 255, 0.3); padding: 5px 12px; border-radius: 10px; font-size: 0.9em;">+${action.boost}%</span>
            `;
            
            button.onclick = () => applyGrowthAction(action, statKey);
            return button;
        }
        
        function applyGrowthAction(action, statKey) {
            // Aumentar estad√≠stica de crecimiento (sin l√≠mite de 100%)
            if (!gameState.stats[statKey]) {
                gameState.stats[statKey] = { ...STATS_CONFIG[statKey] };
            }
            // Sin l√≠mite m√°ximo para estad√≠sticas de crecimiento, pero s√≠ m√≠nimo de 0
            gameState.stats[statKey].value = Math.max(0, gameState.stats[statKey].value + action.boost);
            
            gameState.lastUpdate = Date.now();
            saveState();
            renderStats();
            
            // Cerrar todos los modales de crecimiento
            document.getElementById('idiomasModal').classList.remove('show');
            document.getElementById('aprendizajeModal').classList.remove('show');
            document.getElementById('contenidoModal').classList.remove('show');
            document.getElementById('enfermeriaModal').classList.remove('show');
            document.getElementById('farmacologiaModal').classList.remove('show');
            
            console.log(`${action.emoji} ${action.name}: ${STATS_CONFIG[statKey].name} +${action.boost}% (Total: ${Math.round(gameState.stats[statKey].value)}%)`);
        }

        // Efectos de botones (preparados para futuras funciones)
        function setupButtons() {
            document.getElementById('btnEat').addEventListener('click', () => {
                openEatModal();
            });

            document.getElementById('btnDrink').addEventListener('click', () => {
                openWaterModal();
            });

            document.getElementById('btnSleep').addEventListener('click', () => {
                openSleepModal();
            });

            document.getElementById('btnExercise').addEventListener('click', () => {
                openExerciseModal();
            });

            document.getElementById('btnSelfcare').addEventListener('click', () => {
                openSelfcareModal();
            });

            document.getElementById('btnSocial').addEventListener('click', () => {
                openSocialModal();
            });
            
            // Botones de Crecer
            document.getElementById('btnIdiomas').addEventListener('click', () => {
                openIdiomasModal();
            });
            
            document.getElementById('btnAprendizaje').addEventListener('click', () => {
                openAprendizajeModal();
            });
            
            document.getElementById('btnProfesion').addEventListener('click', () => {
                openProfesionModal();
            });

            document.getElementById('btnReset').addEventListener('click', resetStats);
        }

        // Inicializar aplicaci√≥n
        function init() {
            // Verificar si existe perfil
            const savedProfile = localStorage.getItem('userProfile');
            if (!savedProfile) {
                // Mostrar modal de perfil
                document.getElementById('profileModal').classList.add('show');
                return;
            }
            
            initStats();
            renderStats();
            setupButtons();
            loadSelfcareCooldowns();
            resetDailyChecksIfNeeded();
            renderDailyChecks();
            
            // Cargar y renderizar ideas
            loadIdeas();
            renderIdeas();
            
            // Renderizar actividades del calendario
            renderActivities();
            renderMonthlyCalendar();
            renderWrongActivities();
            
            // Pre-llenar fecha de hoy en el input de actividad
            const activityDateInput = document.getElementById('activityDate');
            if (activityDateInput) {
                const today = new Date().toISOString().split('T')[0];
                activityDateInput.value = today;
                console.log('üìÖ Fecha de hoy pre-llenada:', today);
            }
            
            // Inicializar y actualizar reloj cada segundo
            updateClock();
            setInterval(updateClock, 1000);
            
            // Actualizar estad√≠sticas cada 10 segundos
            setInterval(updateStats, 10000);
            
            // Verificar medianoche cada minuto para resetear checks
            setInterval(() => {
                resetDailyChecksIfNeeded();
                renderDailyChecks();
            }, 60000);
            
            // Actualizar balance general
            updateBalanceGeneral();
            
            // Actualizar tambi√©n cuando la p√°gina recupera el foco
            window.addEventListener('focus', () => {
                updateStats();
                resetDailyChecksIfNeeded();
                renderDailyChecks();
            });
            
            console.log('‚úÖ Juego inicializado correctamente');
            console.log('‚è∞ Reloj activado');
        }

        // ===== SISTEMA DE BIBLIOTECA =====
        
        // IMPORTANTE: NO inicializar library aqu√≠, se carga desde localStorage
        let library = null;
        
        let currentLibraryCategory = 'libros';
        let libraryFilters = {
            search: '',
            letter: '',
            rating: 0,
            folder: ''
        };
        
        // Obtener todas las carpetas √∫nicas de flashcards (incluyendo carpetas vac√≠as)
        function getFlashcardFolders() {
            if (!library || !library.flashcards) return ['General'];
            const folders = [...new Set(library.flashcards.map(f => f.folder || 'General'))];
            // Agregar carpetas creadas manualmente desde localStorage
            const manualFolders = JSON.parse(localStorage.getItem('flashcardFolders') || '[]');
            const allFolders = [...new Set([...folders, ...manualFolders])];
            return allFolders.sort();
        }
        
        // Filtrar por carpeta
        function filterByFolder(folder) {
            libraryFilters.folder = folder;
            renderLibraryContent();
        }
        
        // Abrir modal para crear carpeta
        function openCreateFolderModal() {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3>‚ûï Nueva Carpeta</h3>
                    </div>
                    <div class="modal-body">
                        <label style="display: block; margin-bottom: 8px; color: #667eea; font-weight: bold;">Nombre de la carpeta:</label>
                        <input type="text" id="newFolderName" placeholder="Ej: Matem√°ticas, Historia..." style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 0.95em;">
                        <p style="color: #9ca3af; font-size: 0.85em; margin-top: 10px;">üí° Puedes crear carpetas para organizar tus flashcards por temas</p>
                    </div>
                    <div style="display: flex; gap: 10px; padding: 20px;">
                        <button onclick="createFolder()" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 15px; font-size: 1.1em; font-weight: bold; cursor: pointer;">Crear</button>
                        <button onclick="closeFolderModal()" style="padding: 15px 20px; background: #e5e7eb; color: #6b7280; border: none; border-radius: 15px; cursor: pointer;">Cancelar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            setTimeout(() => document.getElementById('newFolderName').focus(), 100);
        }
        
        // Crear carpeta y guardarla en localStorage
        function createFolder() {
            const folderName = document.getElementById('newFolderName').value.trim();
            if (!folderName) {
                alert('‚ö†Ô∏è Por favor ingresa un nombre para la carpeta');
                return;
            }
            
            // Verificar si ya existe
            const existingFolders = getFlashcardFolders();
            if (existingFolders.includes(folderName)) {
                alert('‚ö†Ô∏è Esta carpeta ya existe');
                return;
            }
            
            // Guardar carpeta en localStorage
            const manualFolders = JSON.parse(localStorage.getItem('flashcardFolders') || '[]');
            manualFolders.push(folderName);
            localStorage.setItem('flashcardFolders', JSON.stringify(manualFolders));
            
            // Filtrar por la nueva carpeta
            libraryFilters.folder = folderName;
            closeFolderModal();
            renderLibraryContent();
            
            // Mostrar mensaje
            setTimeout(() => {
                alert(`‚úÖ Carpeta "${folderName}" creada. Ahora puedes agregar flashcards a esta carpeta.`);
            }, 100);
        }
        
        // Cerrar modal de carpeta
        function closeFolderModal() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (modal.querySelector('#newFolderName')) {
                    modal.remove();
                }
            });
        }
        
        // Cargar biblioteca desde localStorage
        function loadLibrary() {
            const saved = localStorage.getItem('library');
            if (saved) {
                try {
                    const loadedLibrary = JSON.parse(saved);
                    // Solo cargar si hay datos v√°lidos
                    if (loadedLibrary && typeof loadedLibrary === 'object') {
                        library = loadedLibrary;
                        console.log('üìö Biblioteca cargada:', library);
                        return;
                    }
                } catch (error) {
                    console.error('‚ùå Error al cargar biblioteca:', error);
                    // Intentar recuperar del backup
                    const backup = localStorage.getItem('library_backup');
                    if (backup) {
                        try {
                            library = JSON.parse(backup);
                            console.log('‚ö†Ô∏è Biblioteca recuperada del backup');
                            // Guardar el backup como versi√≥n actual
                            saveLibrary();
                            return;
                        } catch (backupError) {
                            console.error('‚ùå Error al recuperar backup:', backupError);
                        }
                    }
                }
            }
            
            // Solo si no hay datos guardados, inicializar vac√≠o
            if (!library) {
                library = {
                    libros: [],
                    peliculas: [],
                    series: [],
                    flashcards: []
                };
                console.log('üÜï Biblioteca inicializada vac√≠a');
            }
            
            // Asegurar que flashcards exista en bibliotecas antiguas
            if (!library.flashcards) {
                library.flashcards = [];
            }
        }
        
        // Guardar biblioteca en localStorage
        function saveLibrary() {
            try {
                // Crear backup antes de guardar
                const currentLibrary = localStorage.getItem('library');
                if (currentLibrary) {
                    localStorage.setItem('library_backup', currentLibrary);
                }
                
                // Guardar nueva versi√≥n
                localStorage.setItem('library', JSON.stringify(library));
                console.log('üíæ Biblioteca guardada correctamente');
                
                // Mostrar indicador visual
                showSaveIndicator('Biblioteca guardada ‚úì');
            } catch (error) {
                console.error('‚ùå Error al guardar biblioteca:', error);
                alert('‚ö†Ô∏è Error al guardar. Tus cambios pueden no haberse guardado.');
            }
        }
        
        // Abrir categor√≠a de biblioteca
        function openLibraryCategory(category) {
            currentLibraryCategory = category;
            libraryFilters = { search: '', letter: '', rating: 0 };
            renderLibraryContent();
        }
        
        // Renderizar contenido de biblioteca
        function renderLibraryContent() {
            const container = document.getElementById('libraryContent');
            const items = library[currentLibraryCategory] || [];
            
            // Calcular totales y horas
            const totalMovies = library.peliculas?.length || 0;
            const totalSeries = library.series?.length || 0;
            const totalBooks = library.libros?.length || 0;
            const totalFlashcards = library.flashcards?.length || 0;
            
            const totalMovieHours = library.peliculas?.reduce((sum, movie) => {
                const duration = movie.duration || 0;
                const times = movie.timesWatched || 1;
                return sum + (duration * times / 60);
            }, 0) || 0;
            
            const totalSeriesHours = library.series?.reduce((sum, series) => {
                const duration = series.duration || 0;
                const times = series.timesWatched || 1;
                return sum + (duration * times / 60);
            }, 0) || 0;
            
            // Filtrar items
            let filteredItems = items.filter(item => {
                let matchSearch = true;
                let matchLetter = true;
                let matchRating = true;
                let matchFolder = true;
                
                if (libraryFilters.search) {
                    const search = libraryFilters.search.toLowerCase();
                    matchSearch = item.title.toLowerCase().includes(search) || 
                                 (item.author && item.author.toLowerCase().includes(search));
                }
                
                if (libraryFilters.letter) {
                    matchLetter = item.title.toLowerCase().startsWith(libraryFilters.letter.toLowerCase());
                }
                
                if (libraryFilters.rating > 0) {
                    matchRating = item.rating === libraryFilters.rating;
                }
                
                if (currentLibraryCategory === 'flashcards' && libraryFilters.folder) {
                    matchFolder = (item.folder || 'General') === libraryFilters.folder;
                }
                
                return matchSearch && matchLetter && matchRating && matchFolder;
            });
            
            // Ordenar por t√≠tulo
            filteredItems.sort((a, b) => a.title.localeCompare(b.title));
            
            const categoryNames = {
                libros: 'Libros',
                peliculas: 'Pel√≠culas',
                series: 'Series',
                flashcards: 'Flashcards'
            };
            
            let html = `
                <!-- Contador de totales - Versi√≥n mini -->
                <div style="background: linear-gradient(135deg, #fef3ff 0%, #ffe5f3 100%); padding: 8px 12px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(255, 107, 157, 0.1); display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <span style="font-size: 0.9em;">üé¨</span>
                        <span style="font-weight: bold; color: #667eea; font-size: 0.85em;">${totalMovies}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <span style="font-size: 0.9em;">üì∫</span>
                        <span style="font-weight: bold; color: #667eea; font-size: 0.85em;">${totalSeries}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <span style="font-size: 0.9em;">üìö</span>
                        <span style="font-weight: bold; color: #667eea; font-size: 0.85em;">${totalBooks}</span>
                    </div>
                    ${(totalMovieHours + totalSeriesHours) > 0 ? `
                        <div style="border-left: 2px solid rgba(102, 126, 234, 0.3); padding-left: 12px; display: flex; align-items: center; gap: 4px;">
                            <span style="font-size: 0.8em;">‚è±Ô∏è</span>
                            <span style="color: #667eea; font-weight: 600; font-size: 0.75em;">${(totalMovieHours + totalSeriesHours).toFixed(1)}h</span>
                        </div>
                    ` : ''}
                </div>
                
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 20px; margin-bottom: 20px; color: white;">
                    <h3 style="margin-bottom: 15px;">üìö ${categoryNames[currentLibraryCategory]}</h3>
                    
                    ${currentLibraryCategory === 'flashcards' ? `
                        <!-- Selector de carpetas para flashcards -->
                        <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
                            <select id="folderFilter" onchange="filterByFolder(this.value)" style="flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 0.95em;">
                                <option value="">üìÇ Todas las carpetas</option>
                                ${getFlashcardFolders().map(folder => 
                                    `<option value="${folder}" ${libraryFilters.folder === folder ? 'selected' : ''}>üìÅ ${folder}</option>`
                                ).join('')}
                            </select>
                            <button onclick="openCreateFolderModal()" style="padding: 12px 20px; background: rgba(255,255,255,0.3); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; white-space: nowrap;">‚ûï Carpeta</button>
                        </div>
                    ` : ''}
                    
                    <!-- Barra de b√∫squeda -->
                    <input type="text" id="librarySearch" placeholder="üîç Buscar por t√≠tulo o autor..." 
                           style="width: 100%; padding: 12px; border: none; border-radius: 10px; font-size: 0.95em; margin-bottom: 15px;"
                           value="${libraryFilters.search}" oninput="updateLibrarySearch(this.value)">
                    
                    <!-- Filtros alfab√©ticos -->
                    ${currentLibraryCategory !== 'flashcards' ? `<div style="margin-bottom: 15px; overflow-x: auto; white-space: nowrap; padding: 10px 0;">
                        <button onclick="filterByLetter('')" style="padding: 8px 12px; margin: 0 5px; background: ${libraryFilters.letter === '' ? 'white' : 'rgba(255,255,255,0.3)'}; color: ${libraryFilters.letter === '' ? '#667eea' : 'white'}; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">Todas</button>
                        ${'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').map(letter => 
                            `<button onclick="filterByLetter('${letter}')" style="padding: 8px 12px; margin: 0 3px; background: ${libraryFilters.letter === letter ? 'white' : 'rgba(255,255,255,0.3)'}; color: ${libraryFilters.letter === letter ? '#667eea' : 'white'}; border: none; border-radius: 8px; cursor: pointer;">${letter}</button>`
                        ).join('')}
                    </div>` : ''}
                    
                    <!-- Filtros por rating -->
                    ${currentLibraryCategory !== 'flashcards' ? `<div style="margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;">
                        <button onclick="filterByRating(0)" style="padding: 10px 15px; background: ${libraryFilters.rating === 0 ? 'white' : 'rgba(255,255,255,0.3)'}; color: ${libraryFilters.rating === 0 ? '#667eea' : 'white'}; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; min-width: 90px;">Todas ‚≠ê</button>
                        ${[5,4,3,2,1].map(rating => 
                            `<button onclick="filterByRating(${rating})" style="padding: 10px 15px; background: ${libraryFilters.rating === rating ? 'white' : 'rgba(255,255,255,0.3)'}; color: ${libraryFilters.rating === rating ? '#667eea' : 'white'}; border: none; border-radius: 8px; cursor: pointer; min-width: 80px;">${'‚≠ê'.repeat(rating)}</button>`
                        ).join('')}
                    </div>` : ''}
                </div>
                
                <!-- Bot√≥n de agregar abajo -->
                <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                    <button onclick="openAddItemModal()" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 15px; font-size: 1.1em; font-weight: bold; cursor: pointer; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">
                        ‚ûï Agregar ${currentLibraryCategory === 'libros' ? 'Libro' : currentLibraryCategory === 'peliculas' ? 'Pel√≠cula' : currentLibraryCategory === 'series' ? 'Serie' : 'Flashcard'}
                    </button>
                    ${currentLibraryCategory === 'flashcards' ? `<button onclick="startFlashcardReview()" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #ff6b9d 0%, #ffa8c5 100%); color: white; border: none; border-radius: 15px; font-size: 1.1em; font-weight: bold; cursor: pointer; box-shadow: 0 4px 12px rgba(255, 107, 157, 0.3);">üß† Repasar</button>` : ''}
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;">
            `;
            
            if (filteredItems.length === 0) {
                html += '<p style="text-align: center; color: #a78bfa; grid-column: 1/-1; padding: 40px;">No hay elementos que mostrar. ¬°Agrega uno!</p>';
            } else {
                filteredItems.forEach((item, index) => {
                    html += `
                        <div style="background: white; border-radius: 15px; padding: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            ${item.imageUrl ? `<img src="${item.imageUrl}" style="width: 100%; height: 200px; object-fit: cover; border-radius: 10px; margin-bottom: 10px;">` : ''}
                            <h4 style="color: #667eea; margin-bottom: 5px;">${item.title}</h4>
                            ${item.author ? `<p style="color: #a78bfa; font-size: 0.9em; margin-bottom: 10px;">por ${item.author}</p>` : ''}
                            ${currentLibraryCategory !== 'flashcards' ? `<div style="color: #fbbf24; margin-bottom: 10px;">${'‚≠ê'.repeat(item.rating || 0)}${'‚òÜ'.repeat(5 - (item.rating || 0))}</div>` : ''}
                            ${item.description ? `<p style="color: #6b7280; font-size: 0.85em; line-height: 1.4; margin-bottom: 10px;">${item.description.substring(0, 100)}${item.description.length > 100 ? '...' : ''}</p>` : ''}
                            ${currentLibraryCategory === 'peliculas' && item.duration ? `
                                <div style="background: linear-gradient(135deg, #fef3ff 0%, #ffe5f3 100%); padding: 8px; border-radius: 8px; margin-bottom: 10px; font-size: 0.85em;">
                                    <div style="color: #6b4c9a;">‚è±Ô∏è ${item.duration} min | üëÅÔ∏è ${item.timesWatched || 1}x</div>
                                    <div style="color: #ff6b9d; font-weight: 600;">Total: ${((item.duration || 0) * (item.timesWatched || 1))} min (${Math.floor(((item.duration || 0) * (item.timesWatched || 1)) / 60)}h ${((item.duration || 0) * (item.timesWatched || 1)) % 60}m)</div>
                                </div>
                            ` : ''}
                            ${currentLibraryCategory === 'flashcards' && item.folder ? `<p style="color: #ff6b9d; font-size: 0.85em; margin-bottom: 10px;">üìÅ ${item.folder}</p>` : ''}
                            <div style="display: flex; gap: 10px;">${currentLibraryCategory === 'flashcards' ? `
                                    <button onclick="reviewSingleFlashcard(${index})" style="flex: 1; padding: 8px; background: linear-gradient(135deg, #ff6b9d 0%, #ffa8c5 100%); color: white; border: none; border-radius: 8px; cursor: pointer;">üß† Repasar</button>
                                ` : `<button onclick="viewLibraryItem(${index})" style="flex: 1; padding: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer;">Ver</button>`}
                                <button onclick="editLibraryItem(${index})" style="padding: 8px 12px; background: #a78bfa; color: white; border: none; border-radius: 8px; cursor: pointer;">‚úèÔ∏è</button>
                                <button onclick="deleteLibraryItem(${index})" style="padding: 8px 12px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer;">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Actualizar b√∫squeda
        function updateLibrarySearch(value) {
            libraryFilters.search = value;
            renderLibraryContent();
        }
        
        // Filtrar por letra
        function filterByLetter(letter) {
            libraryFilters.letter = letter;
            renderLibraryContent();
        }
        
        // Filtrar por rating
        function filterByRating(rating) {
            libraryFilters.rating = rating;
            renderLibraryContent();
        }
        
        // Abrir modal para agregar item
        function openAddItemModal(editIndex = null) {
            const isEditing = editIndex !== null;
            const item = isEditing ? library[currentLibraryCategory][editIndex] : null;
            const categoryName = currentLibraryCategory === 'libros' ? 'Libro' : currentLibraryCategory === 'peliculas' ? 'Pel√≠cula' : currentLibraryCategory === 'series' ? 'Serie' : 'Flashcard';
            
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>${isEditing ? '‚úèÔ∏è Editar' : '‚ûï Agregar'} ${categoryName}</h3>
                    </div>
                    <div class="modal-body">
                        <input type="text" id="itemTitle" placeholder="${currentLibraryCategory === 'flashcards' ? 'Pregunta *' : 'T√≠tulo *'}" value="${isEditing ? item.title : ''}" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 15px; font-size: 0.95em;">
                        ${currentLibraryCategory === 'libros' ? `<input type="text" id="itemAuthor" placeholder="Autor *" value="${isEditing ? item.author || '' : ''}" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 15px; font-size: 0.95em;">` : ''}
                        ${currentLibraryCategory === 'flashcards' ? `<textarea id="flashcardAnswer" placeholder="Respuesta *" rows="3" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 15px; font-size: 0.95em; resize: vertical;">${isEditing ? item.answer || '' : ''}</textarea>` : ''}
                        ${currentLibraryCategory === 'flashcards' ? `
                            <select id="flashcardFolder" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 15px; font-size: 0.95em; background: white;">
                                ${getFlashcardFolders().length === 0 ? '<option value="General">General</option>' : getFlashcardFolders().map(folder => `<option value="${folder}" ${(isEditing ? (item.folder || 'General') : (libraryFilters.folder || 'General')) === folder ? 'selected' : ''}>${folder}</option>`).join('')}
                            </select>
                        ` : ''}
                        ${currentLibraryCategory === 'flashcards' ? `<input type="url" id="flashcardImage" placeholder="URL de imagen (opcional)" value="${isEditing ? item.imageUrl || '' : ''}" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 15px; font-size: 0.95em;">` : ''}
                        ${currentLibraryCategory === 'peliculas' || currentLibraryCategory === 'series' ? `<input type="url" id="itemImageUrl" placeholder="URL de imagen (opcional)" value="${isEditing ? item.imageUrl || '' : ''}" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 15px; font-size: 0.95em;">` : ''}
                        ${currentLibraryCategory === 'peliculas' ? `<input type="number" id="movieDuration" placeholder="Duraci√≥n en minutos" value="${isEditing ? item.duration || '' : ''}" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 15px; font-size: 0.95em;">` : ''}
                        ${currentLibraryCategory === 'peliculas' ? `<input type="number" id="movieTimesWatched" placeholder="Veces vista" value="${isEditing ? item.timesWatched || 1 : 1}" min="1" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 15px; font-size: 0.95em;">` : ''}
                        ${currentLibraryCategory === 'libros' ? `<input type="url" id="itemImageUrl" placeholder="URL de imagen (opcional)" value="${isEditing ? item.imageUrl || '' : ''}" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 15px; font-size: 0.95em;">` : ''}
                        ${currentLibraryCategory !== 'flashcards' ? `<textarea id="itemDescription" placeholder="Descripci√≥n breve" rows="4" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 15px; font-size: 0.95em; resize: vertical;">${isEditing ? item.description || '' : ''}</textarea>` : ''}
                        ${currentLibraryCategory !== 'flashcards' ? `<div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #667eea; font-weight: bold;">Rating:</label>
                            <div id="ratingSelector" style="font-size: 2em; cursor: pointer;">
                                ${'<span onclick="selectRating(1)">‚òÜ</span><span onclick="selectRating(2)">‚òÜ</span><span onclick="selectRating(3)">‚òÜ</span><span onclick="selectRating(4)">‚òÜ</span><span onclick="selectRating(5)">‚òÜ</span>'}
                            </div>
                        </div>` : ''}
                    </div>
                    <div style="display: flex; gap: 10px; padding: 20px;">
                        <button onclick="saveLibraryItem(${editIndex})" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 15px; font-size: 1.1em; font-weight: bold; cursor: pointer;">Guardar</button>
                        <button onclick="closeLibraryModal()" style="padding: 15px 20px; background: #e5e7eb; color: #6b7280; border: none; border-radius: 15px; cursor: pointer;">Cancelar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            window.currentItemRating = isEditing ? item.rating : 0;
            
            // Si estamos editando, mostrar las estrellas correctamente
            if (isEditing && item.rating) {
                setTimeout(() => selectRating(item.rating), 50);
            }
        }
        
        // Seleccionar rating
        function selectRating(rating) {
            window.currentItemRating = rating;
            const stars = document.querySelectorAll('#ratingSelector span');
            stars.forEach((star, index) => {
                star.textContent = index < rating ? '‚≠ê' : '‚òÜ';
            });
        }
        
        // Guardar item de biblioteca
        function saveLibraryItem(editIndex = null) {
            const title = document.getElementById('itemTitle').value.trim();
            const author = document.getElementById('itemAuthor')?.value.trim() || '';
            const imageUrl = document.getElementById('itemImageUrl')?.value.trim() || '';
            const description = document.getElementById('itemDescription')?.value.trim() || '';
            const answer = document.getElementById('flashcardAnswer')?.value.trim() || '';
            const folder = document.getElementById('flashcardFolder')?.value.trim() || 'General';
            const flashcardImage = document.getElementById('flashcardImage')?.value.trim() || '';
            const duration = document.getElementById('movieDuration')?.value || 0;
            const timesWatched = document.getElementById('movieTimesWatched')?.value || 1;
            const rating = window.currentItemRating || 0;
            
            console.log('üíæ Guardando item en categor√≠a:', currentLibraryCategory);
            console.log('üìù T√≠tulo:', title);
            console.log('üìù Respuesta:', answer);
            console.log('üìù Carpeta:', folder);
            
            if (!title) {
                alert('‚ö†Ô∏è Por favor ingresa ' + (currentLibraryCategory === 'flashcards' ? 'una pregunta' : 'un t√≠tulo'));
                return;
            }
            
            if (currentLibraryCategory === 'libros' && !author) {
                alert('‚ö†Ô∏è Por favor ingresa el autor del libro');
                return;
            }
            
            if (currentLibraryCategory === 'flashcards' && !answer) {
                alert('‚ö†Ô∏è Por favor ingresa la respuesta');
                return;
            }
            
            // Asegurar que la categor√≠a existe
            if (!library[currentLibraryCategory]) {
                library[currentLibraryCategory] = [];
                console.log('üÜï Creando categor√≠a:', currentLibraryCategory);
            }
            
            const item = {
                title,
                author,
                imageUrl: currentLibraryCategory === 'flashcards' ? flashcardImage : imageUrl,
                description,
                answer,
                folder,
                duration: parseInt(duration) || 0,
                timesWatched: parseInt(timesWatched) || 1,
                rating,
                dateAdded: editIndex !== null ? library[currentLibraryCategory][editIndex].dateAdded : new Date().toISOString(),
                // Sistema de repetici√≥n espaciada para flashcards
                nextReview: currentLibraryCategory === 'flashcards' ? (editIndex !== null ? library[currentLibraryCategory][editIndex].nextReview : new Date().toISOString()) : null,
                interval: currentLibraryCategory === 'flashcards' ? (editIndex !== null ? library[currentLibraryCategory][editIndex].interval : 0) : null,
                easeFactor: currentLibraryCategory === 'flashcards' ? (editIndex !== null ? library[currentLibraryCategory][editIndex].easeFactor : 2.5) : null
            };
            
            if (editIndex !== null) {
                // Editar item existente
                library[currentLibraryCategory][editIndex] = item;
                console.log('‚úèÔ∏è Item editado');
            } else {
                // Agregar nuevo item
                library[currentLibraryCategory].push(item);
                console.log('‚ûï Item agregado. Total:', library[currentLibraryCategory].length);
            }
            
            saveLibrary();
            closeLibraryModal();
            renderLibraryContent();
            console.log('‚úÖ Item guardado exitosamente');
        }
        
        // Editar item de biblioteca
        function editLibraryItem(index) {
            openAddItemModal(index);
        }
        
        // Ver detalle de item
        function viewLibraryItem(index) {
            const item = library[currentLibraryCategory][index];
            
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>${item.title}</h3>
                    </div>
                    <div class="modal-body">
                        ${item.imageUrl ? `<img src="${item.imageUrl}" style="width: 100%; max-height: 300px; object-fit: cover; border-radius: 10px; margin-bottom: 15px;">` : ''}
                        ${item.author ? `<p style="color: #a78bfa; font-size: 1.1em; margin-bottom: 10px;"><strong>Autor:</strong> ${item.author}</p>` : ''}
                        <div style="color: #fbbf24; font-size: 1.5em; margin-bottom: 15px;">${'‚≠ê'.repeat(item.rating || 0)}${'‚òÜ'.repeat(5 - (item.rating || 0))}</div>
                        ${item.description ? `<p style="color: #4b5563; line-height: 1.6; margin-bottom: 15px;">${item.description}</p>` : ''}
                        <p style="color: #9ca3af; font-size: 0.85em;">Agregado el ${new Date(item.dateAdded).toLocaleDateString()}</p>
                    </div>
                    <button onclick="closeLibraryModal()" class="modal-close">‚úï Cerrar</button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Eliminar item
        function deleteLibraryItem(index) {
            if (confirm('¬øEst√°s seguro de eliminar este elemento?')) {
                library[currentLibraryCategory].splice(index, 1);
                saveLibrary();
                renderLibraryContent();
            }
        }
        
        // Cerrar modal de biblioteca
        function closeLibraryModal() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (modal.querySelector('#itemTitle') || modal.querySelector('.modal-header h3')) {
                    modal.remove();
                }
            });
        }

        // ===== CALENDARIO DE EJERCICIO SEMANAL =====
        
        // Cargar plan de ejercicios desde localStorage
        let exercisePlan = JSON.parse(localStorage.getItem('exercisePlan')) || {
            0: { muscle: 'Gl√∫teo', icon: 'üçë', color: '#ff6b9d', exercises: [] },
            1: { muscle: 'Lunes', icon: 'üí™', color: '#667eea', exercises: [] },
            2: { muscle: 'Martes', icon: 'üí™', color: '#4facfe', exercises: [] },
            3: { muscle: 'Mi√©rcoles', icon: 'üí™', color: '#f093fb', exercises: [] },
            4: { muscle: 'Jueves', icon: 'üí™', color: '#ffd89b', exercises: [] },
            5: { muscle: 'Viernes', icon: 'üí™', color: '#a8edea', exercises: [] },
            6: { muscle: 'S√°bado', icon: 'üí™', color: '#ffeaa7', exercises: [] }
        };
        
        // Historial de entrenamientos
        let workoutHistory = JSON.parse(localStorage.getItem('workoutHistory')) || {};
        
        function saveExercisePlan() {
            localStorage.setItem('exercisePlan', JSON.stringify(exercisePlan));
            localStorage.setItem('workoutHistory', JSON.stringify(workoutHistory));
        }
        
        function renderExerciseCalendar() {
            const container = document.getElementById('exerciseCalendar');
            const todayMuscleDiv = document.getElementById('todayMuscle');
            const today = new Date().getDay(); // 0 = Domingo
            
            // Actualizar el texto de "Hoy te toca"
            if (todayMuscleDiv) {
                todayMuscleDiv.textContent = `${exercisePlan[today].muscle} ${exercisePlan[today].icon}`;
            }
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px;">';
            
            const days = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
            
            for (let i = 0; i < 7; i++) {
                const plan = exercisePlan[i];
                const isToday = i === today;
                const exerciseCount = plan.exercises?.length || 0;
                
                html += `
                    <div style="
                        background: ${isToday ? `linear-gradient(135deg, ${plan.color} 0%, ${plan.color}dd 100%)` : 'linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%)'};
                        padding: 15px;
                        border-radius: 15px;
                        text-align: center;
                        box-shadow: ${isToday ? '0 8px 20px rgba(0,0,0,0.2)' : '0 2px 5px rgba(0,0,0,0.1)'};
                        transform: ${isToday ? 'scale(1.05)' : 'scale(1)'};
                        transition: all 0.3s ease;
                        border: ${isToday ? '3px solid white' : 'none'};
                        cursor: pointer;
                    " onclick="openDayExercises(${i})">
                        <div style="font-size: 2em; margin-bottom: 8px;">${plan.icon}</div>
                        <div style="font-weight: bold; font-size: 1em; color: ${isToday ? 'white' : '#6b7280'}; margin-bottom: 5px;">${days[i]}</div>
                        <div style="font-size: 1.1em; font-weight: 700; color: ${isToday ? 'white' : plan.color}; margin-bottom: 8px;">${plan.muscle}</div>
                        <div style="font-size: 0.85em; color: ${isToday ? 'rgba(255,255,255,0.9)' : '#9ca3af'}; margin-bottom: 8px;">${exerciseCount} ejercicio${exerciseCount !== 1 ? 's' : ''}</div>
                        <button onclick="event.stopPropagation(); editDayMuscle(${i})" style="background: rgba(255,255,255,${isToday ? '0.3' : '0.5'}); border: none; border-radius: 8px; padding: 5px 10px; font-size: 0.8em; color: ${isToday ? 'white' : '#6b7280'}; cursor: pointer; font-weight: 600;">‚úèÔ∏è Editar</button>
                        ${isToday ? '<div style="margin-top: 8px; padding: 6px; background: rgba(255,255,255,0.3); border-radius: 8px; color: white; font-weight: 600; font-size: 0.85em;">¬°HOY!</div>' : ''}
                    </div>
                `;
            }
            
            html += '</div>';
            
            // Mensaje motivacional
            html += `
                <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #fef3ff 0%, #ffe5f3 100%); border-radius: 15px; text-align: center;">
                    <p style="color: #ff6b9d; font-weight: 600; margin: 0;">üí™ ${exercisePlan[today].muscle} hoy - ¬°T√∫ puedes!</p>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // Editar m√∫sculo del d√≠a
        function editDayMuscle(dayIndex) {
            const day = exercisePlan[dayIndex];
            const dayNames = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
            
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3>‚úèÔ∏è Editar ${dayNames[dayIndex]}</h3>
                    </div>
                    <div class="modal-body">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Grupo muscular:</label>
                        <input type="text" id="muscleName" value="${day.muscle}" placeholder="Ej: Gl√∫teo, Pierna, Pecho..." style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 15px; font-size: 1em;">
                        
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Icono:</label>
                        <select id="muscleIcon" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 15px; font-size: 1.5em; background: white;">
                            <option value="üçë" ${day.icon === 'üçë' ? 'selected' : ''}>üçë Gl√∫teo</option>
                            <option value="ü¶µ" ${day.icon === 'ü¶µ' ? 'selected' : ''}>ü¶µ Pierna</option>
                            <option value="üí™" ${day.icon === 'üí™' ? 'selected' : ''}>üí™ Brazo</option>
                            <option value="üèãÔ∏è" ${day.icon === 'üèãÔ∏è' ? 'selected' : ''}>üèãÔ∏è Pecho</option>
                            <option value="üîô" ${day.icon === 'üîô' ? 'selected' : ''}>üîô Espalda</option>
                            <option value="ü§∏" ${day.icon === 'ü§∏' ? 'selected' : ''}>ü§∏ Core</option>
                            <option value="üßò" ${day.icon === 'üßò' ? 'selected' : ''}>üßò Flexibilidad</option>
                            <option value="üèÉ" ${day.icon === 'üèÉ' ? 'selected' : ''}>üèÉ Cardio</option>
                            <option value="üö¥" ${day.icon === 'üö¥' ? 'selected' : ''}>üö¥ Ciclismo</option>
                            <option value="üèä" ${day.icon === 'üèä' ? 'selected' : ''}>üèä Nataci√≥n</option>
                        </select>
                        
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Color:</label>
                        <input type="color" id="muscleColor" value="${day.color}" style="width: 100%; height: 50px; border: 2px solid #e5e7eb; border-radius: 10px; cursor: pointer;">
                    </div>
                    <div style="display: flex; gap: 10px; padding: 20px;">
                        <button onclick="saveDayMuscle(${dayIndex})" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 15px; font-size: 1.1em; font-weight: bold; cursor: pointer;">Guardar</button>
                        <button onclick="closeDayMuscleModal()" style="padding: 15px 20px; background: #e5e7eb; color: #6b7280; border: none; border-radius: 15px; cursor: pointer;">Cancelar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function saveDayMuscle(dayIndex) {
            const muscle = document.getElementById('muscleName').value.trim();
            const icon = document.getElementById('muscleIcon').value;
            const color = document.getElementById('muscleColor').value;
            
            if (!muscle) {
                alert('‚ö†Ô∏è Por favor ingresa el grupo muscular');
                return;
            }
            
            exercisePlan[dayIndex].muscle = muscle;
            exercisePlan[dayIndex].icon = icon;
            exercisePlan[dayIndex].color = color;
            
            saveExercisePlan();
            renderExerciseCalendar();
            closeDayMuscleModal();
        }
        
        function closeDayMuscleModal() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (modal.querySelector('#muscleName')) {
                    modal.remove();
                }
            });
        }
        
        // Abrir vista de ejercicios del d√≠a
        function openDayExercises(dayIndex) {
            const day = exercisePlan[dayIndex];
            const dayNames = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
            const today = new Date().getDay();
            const isToday = dayIndex === today;
            
            if (!day.exercises) day.exercises = [];
            
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.style.zIndex = '10000';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 650px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header" style="background: linear-gradient(135deg, ${day.color} 0%, ${day.color}dd 100%); color: white;">
                        <h3>${day.icon} ${dayNames[dayIndex]} - ${day.muscle}</h3>
                        ${isToday ? '<div style="background: rgba(255,255,255,0.3); padding: 5px 12px; border-radius: 20px; font-size: 0.9em; margin-top: 8px;">üìÖ Hoy</div>' : ''}
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 20px;">
                            <button onclick="addExerciseToDay(${dayIndex})" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 15px; font-size: 1em; font-weight: bold; cursor: pointer;">‚ûï Agregar Ejercicio</button>
                        </div>
                        
                        <div id="exercisesList${dayIndex}"></div>
                        
                        ${day.exercises.length === 0 ? `
                            <div style="text-align: center; padding: 40px 20px; color: #9ca3af;">
                                <div style="font-size: 3em; margin-bottom: 10px;">üèãÔ∏è</div>
                                <p>No hay ejercicios programados</p>
                                <p style="font-size: 0.9em;">Agrega ejercicios para este d√≠a</p>
                            </div>
                        ` : ''}
                    </div>
                    <div style="padding: 20px;">
                        <button onclick="closeDayExercisesModal()" style="width: 100%; padding: 15px; background: #e5e7eb; color: #6b7280; border: none; border-radius: 15px; font-size: 1em; cursor: pointer;">Cerrar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            renderDayExercises(dayIndex);
        }
        
        function renderDayExercises(dayIndex) {
            const container = document.getElementById(`exercisesList${dayIndex}`);
            if (!container) return;
            
            const day = exercisePlan[dayIndex];
            const exercises = day.exercises || [];
            
            if (exercises.length === 0) return;
            
            let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';
            
            exercises.forEach((exercise, index) => {
                const history = workoutHistory[`${dayIndex}-${index}`] || [];
                const lastWorkout = history.length > 0 ? history[history.length - 1] : null;
                
                // Calcular si debe aumentar peso (3 semanas = 21 d√≠as)
                let shouldIncreaseWeight = false;
                if (lastWorkout) {
                    const daysSinceLastIncrease = Math.floor((Date.now() - (lastWorkout.lastWeightIncrease || lastWorkout.date)) / (1000 * 60 * 60 * 24));
                    shouldIncreaseWeight = daysSinceLastIncrease >= 21;
                }
                
                html += `
                    <div style="background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); padding: 15px; border-radius: 12px; border-left: 4px solid ${day.color};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <div style="font-weight: bold; font-size: 1.1em; color: #1f2937; margin-bottom: 5px;">${exercise.name}</div>
                                ${exercise.notes ? `<div style="font-size: 0.9em; color: #6b7280; margin-bottom: 8px;">üìù ${exercise.notes}</div>` : ''}
                                <div style="display: flex; gap: 15px; flex-wrap: wrap; font-size: 0.95em;">
                                    <span style="color: #667eea;">üî¢ ${exercise.sets} sets</span>
                                    <span style="color: #4facfe;">üîÅ ${exercise.reps} reps</span>
                                    <span style="color: #f093fb;">‚öñÔ∏è ${exercise.weight} kg</span>
                                </div>
                                ${lastWorkout ? `
                                    <div style="margin-top: 8px; padding: 8px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; font-size: 0.85em; color: #667eea;">
                                        üìÖ √öltima vez: ${new Date(lastWorkout.date).toLocaleDateString()} - ${lastWorkout.weight}kg
                                    </div>
                                ` : ''}
                                ${shouldIncreaseWeight ? `
                                    <div style="margin-top: 8px; padding: 8px; background: linear-gradient(135deg, #ffd89b 0%, #f093fb 100%); border-radius: 8px; font-size: 0.85em; color: white; font-weight: 600;">
                                        üî• ¬°Han pasado 3 semanas! Es hora de aumentar el peso
                                    </div>
                                ` : ''}
                            </div>
                            <div style="display: flex; gap: 5px; flex-shrink: 0;">
                                <button onclick="editExercise(${dayIndex}, ${index})" style="background: #f3f4f6; border: none; border-radius: 8px; padding: 8px 12px; cursor: pointer; font-size: 0.9em;">‚úèÔ∏è</button>
                                <button onclick="deleteExercise(${dayIndex}, ${index})" style="background: #fee2e2; border: none; border-radius: 8px; padding: 8px 12px; cursor: pointer; font-size: 0.9em;">üóëÔ∏è</button>
                            </div>
                        </div>
                        <button onclick="logWorkout(${dayIndex}, ${index})" style="width: 100%; padding: 10px; background: linear-gradient(135deg, ${day.color} 0%, ${day.color}dd 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 0.95em;">‚úÖ Registrar realizado hoy</button>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function closeDayExercisesModal() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (modal.querySelector('[id^="exercisesList"]')) {
                    modal.remove();
                }
            });
        }
        
        // Agregar ejercicio
        function addExerciseToDay(dayIndex) {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.style.zIndex = '10001';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 450px;">
                    <div class="modal-header">
                        <h3>‚ûï Nuevo Ejercicio</h3>
                    </div>
                    <div class="modal-body">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Nombre del ejercicio:</label>
                        <input type="text" id="exerciseName" placeholder="Ej: Sentadilla b√∫lgara" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 15px; font-size: 1em;">
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 0.9em;">Sets:</label>
                                <input type="number" id="exerciseSets" value="3" min="1" max="10" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1em; text-align: center;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 0.9em;">Reps:</label>
                                <input type="number" id="exerciseReps" value="12" min="1" max="50" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1em; text-align: center;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 0.9em;">Peso (kg):</label>
                                <input type="number" id="exerciseWeight" value="0" min="0" step="2.5" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1em; text-align: center;">
                            </div>
                        </div>
                        
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Notas (opcional):</label>
                        <textarea id="exerciseNotes" placeholder="T√©cnica, ajustes, recordatorios..." rows="3" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 0.95em; resize: vertical;"></textarea>
                    </div>
                    <div style="display: flex; gap: 10px; padding: 20px;">
                        <button onclick="saveExercise(${dayIndex}, null)" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 15px; font-size: 1.1em; font-weight: bold; cursor: pointer;">Guardar</button>
                        <button onclick="closeExerciseModal()" style="padding: 15px 20px; background: #e5e7eb; color: #6b7280; border: none; border-radius: 15px; cursor: pointer;">Cancelar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Editar ejercicio
        function editExercise(dayIndex, exerciseIndex) {
            const exercise = exercisePlan[dayIndex].exercises[exerciseIndex];
            
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.style.zIndex = '10001';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 450px;">
                    <div class="modal-header">
                        <h3>‚úèÔ∏è Editar Ejercicio</h3>
                    </div>
                    <div class="modal-body">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Nombre del ejercicio:</label>
                        <input type="text" id="exerciseName" value="${exercise.name}" placeholder="Ej: Sentadilla b√∫lgara" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 15px; font-size: 1em;">
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 0.9em;">Sets:</label>
                                <input type="number" id="exerciseSets" value="${exercise.sets}" min="1" max="10" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1em; text-align: center;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 0.9em;">Reps:</label>
                                <input type="number" id="exerciseReps" value="${exercise.reps}" min="1" max="50" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1em; text-align: center;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 0.9em;">Peso (kg):</label>
                                <input type="number" id="exerciseWeight" value="${exercise.weight}" min="0" step="2.5" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1em; text-align: center;">
                            </div>
                        </div>
                        
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Notas (opcional):</label>
                        <textarea id="exerciseNotes" placeholder="T√©cnica, ajustes, recordatorios..." rows="3" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 0.95em; resize: vertical;">${exercise.notes || ''}</textarea>
                    </div>
                    <div style="display: flex; gap: 10px; padding: 20px;">
                        <button onclick="saveExercise(${dayIndex}, ${exerciseIndex})" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 15px; font-size: 1.1em; font-weight: bold; cursor: pointer;">Guardar</button>
                        <button onclick="closeExerciseModal()" style="padding: 15px 20px; background: #e5e7eb; color: #6b7280; border: none; border-radius: 15px; cursor: pointer;">Cancelar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function saveExercise(dayIndex, exerciseIndex) {
            const name = document.getElementById('exerciseName').value.trim();
            const sets = parseInt(document.getElementById('exerciseSets').value);
            const reps = parseInt(document.getElementById('exerciseReps').value);
            const weight = parseFloat(document.getElementById('exerciseWeight').value);
            const notes = document.getElementById('exerciseNotes').value.trim();
            
            if (!name) {
                alert('‚ö†Ô∏è Por favor ingresa el nombre del ejercicio');
                return;
            }
            
            const exercise = { name, sets, reps, weight, notes };
            
            if (exerciseIndex === null) {
                // Nuevo ejercicio
                if (!exercisePlan[dayIndex].exercises) exercisePlan[dayIndex].exercises = [];
                exercisePlan[dayIndex].exercises.push(exercise);
            } else {
                // Editar ejercicio existente
                exercisePlan[dayIndex].exercises[exerciseIndex] = exercise;
            }
            
            saveExercisePlan();
            renderDayExercises(dayIndex);
            renderExerciseCalendar();
            closeExerciseModal();
        }
        
        function deleteExercise(dayIndex, exerciseIndex) {
            if (confirm('¬øEliminar este ejercicio?')) {
                exercisePlan[dayIndex].exercises.splice(exerciseIndex, 1);
                saveExercisePlan();
                renderDayExercises(dayIndex);
                renderExerciseCalendar();
            }
        }
        
        function closeExerciseModal() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (modal.querySelector('#exerciseName')) {
                    modal.remove();
                }
            });
        }
        
        // Registrar entrenamiento realizado
        function logWorkout(dayIndex, exerciseIndex) {
            const exercise = exercisePlan[dayIndex].exercises[exerciseIndex];
            const key = `${dayIndex}-${exerciseIndex}`;
            
            if (!workoutHistory[key]) workoutHistory[key] = [];
            
            const lastWorkout = workoutHistory[key].length > 0 ? workoutHistory[key][workoutHistory[key].length - 1] : null;
            
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.style.zIndex = '10002';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3>‚úÖ Registrar Entrenamiento</h3>
                        <div style="font-size: 0.9em; margin-top: 5px; opacity: 0.9;">${exercise.name}</div>
                    </div>
                    <div class="modal-body">
                        ${lastWorkout ? `
                            <div style="background: rgba(102, 126, 234, 0.1); padding: 12px; border-radius: 10px; margin-bottom: 15px;">
                                <div style="font-weight: 600; color: #667eea; margin-bottom: 5px;">üìä √öltima vez:</div>
                                <div style="font-size: 0.95em; color: #6b7280;">Peso: ${lastWorkout.weight}kg</div>
                            </div>
                        ` : ''}
                        
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">¬øQu√© peso usaste hoy?</label>
                        <input type="number" id="workoutWeight" value="${exercise.weight}" min="0" step="2.5" style="width: 100%; padding: 15px; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 15px; font-size: 1.2em; text-align: center;">
                        
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Notas de esta sesi√≥n (opcional):</label>
                        <textarea id="workoutNotes" placeholder="¬øC√≥mo te sentiste? ¬øAlg√∫n ajuste?" rows="3" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 0.95em; resize: vertical;"></textarea>
                    </div>
                    <div style="display: flex; gap: 10px; padding: 20px;">
                        <button onclick="saveWorkoutLog(${dayIndex}, ${exerciseIndex})" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%); color: white; border: none; border-radius: 15px; font-size: 1.1em; font-weight: bold; cursor: pointer;">üí™ Registrar</button>
                        <button onclick="closeWorkoutModal()" style="padding: 15px 20px; background: #e5e7eb; color: #6b7280; border: none; border-radius: 15px; cursor: pointer;">Cancelar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function saveWorkoutLog(dayIndex, exerciseIndex) {
            const weight = parseFloat(document.getElementById('workoutWeight').value);
            const notes = document.getElementById('workoutNotes').value.trim();
            const key = `${dayIndex}-${exerciseIndex}`;
            
            if (!workoutHistory[key]) workoutHistory[key] = [];
            
            const lastWorkout = workoutHistory[key].length > 0 ? workoutHistory[key][workoutHistory[key].length - 1] : null;
            
            // Si el peso aument√≥, actualizar fecha de √∫ltimo aumento
            let lastWeightIncrease = lastWorkout?.lastWeightIncrease || Date.now();
            if (!lastWorkout || weight > lastWorkout.weight) {
                lastWeightIncrease = Date.now();
            }
            
            workoutHistory[key].push({
                date: Date.now(),
                weight: weight,
                notes: notes,
                lastWeightIncrease: lastWeightIncrease
            });
            
            // Actualizar el peso del ejercicio con el √∫ltimo usado
            exercisePlan[dayIndex].exercises[exerciseIndex].weight = weight;
            
            saveExercisePlan();
            renderDayExercises(dayIndex);
            closeWorkoutModal();
            
            alert('‚úÖ ¬°Entrenamiento registrado! üí™');
        }
        
        function closeWorkoutModal() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (modal.querySelector('#workoutWeight')) {
                    modal.remove();
                }
            });
        }

        // ===== SISTEMA DE GESTI√ìN DE IDEAS =====
        
        // Estado actual de la vista de ideas
        let currentIdeaState = 'pendientes';
        
        // Cargar ideas
        function loadIdeas() {
            const saved = localStorage.getItem('ideas');
            if (saved) {
                try {
                    const loadedIdeas = JSON.parse(saved);
                    if (loadedIdeas && typeof loadedIdeas === 'object') {
                        gameState.ideas = loadedIdeas;
                        console.log('üí° Ideas cargadas:', gameState.ideas);
                    }
                } catch (error) {
                    console.error('‚ùå Error al cargar ideas:', error);
                }
            }
        }
        
        // Guardar ideas
        function saveIdeas() {
            try {
                // Backup antes de guardar
                const currentIdeas = localStorage.getItem('ideas');
                if (currentIdeas) {
                    localStorage.setItem('ideas_backup', currentIdeas);
                }
                
                localStorage.setItem('ideas', JSON.stringify(gameState.ideas));
                console.log('üíæ Ideas guardadas correctamente');
            } catch (error) {
                console.error('‚ùå Error al guardar ideas:', error);
            }
        }
        
        // Actualizar barra de contenido
        function updateContenidoBar() {
            // Asegurar que la estad√≠stica de contenido existe
            if (!gameState.stats.contenido) {
                gameState.stats.contenido = { ...STATS_CONFIG.contenido };
            }
            
            const contenidoValue = isNaN(gameState.stats.contenido.value) ? 0 : gameState.stats.contenido.value;
            const bar = document.getElementById('contenidoBar');
            const value = document.getElementById('contenidoValue');
            
            if (bar && value) {
                const displayValue = Math.round(contenidoValue);
                value.textContent = `${displayValue}%`;
                bar.style.width = `${Math.max(0, Math.min(100, contenidoValue))}%`;
                
                // Cambiar color seg√∫n nivel
                if (contenidoValue >= 70) {
                    bar.className = 'stat-bar-fill stat-bar-high';
                } else if (contenidoValue >= 40) {
                    bar.className = 'stat-bar-fill stat-bar-medium';
                } else {
                    bar.className = 'stat-bar-fill stat-bar-low';
                }
            }
        }
        
        // Cambiar entre estados de ideas
        function switchIdeaState(state) {
            currentIdeaState = state;
            
            // Actualizar estilos de las pesta√±as
            document.querySelectorAll('.idea-state-tab').forEach((tab, index) => {
                const states = ['pendientes', 'guionada', 'grabadas', 'editadas', 'publicadas'];
                if (states[index] === state) {
                    tab.style.background = 'linear-gradient(135deg, #ffd89b 0%, #f093fb 100%)';
                    tab.style.color = 'white';
                    tab.style.boxShadow = '0 4px 15px rgba(255, 107, 157, 0.3)';
                    tab.classList.add('active');
                } else {
                    tab.style.background = 'linear-gradient(135deg, #e0e7ff 0%, #fef3ff 100%)';
                    tab.style.color = '#6b4c9a';
                    tab.style.boxShadow = '0 2px 8px rgba(167, 139, 250, 0.2)';
                    tab.classList.remove('active');
                }
            });
            
            // Renderizar ideas del estado seleccionado
            renderCurrentIdeaState();
        }
        
        // Agregar nueva idea
        function addNewIdea() {
            const input = document.getElementById('newIdeaInput');
            const percentageSelect = document.getElementById('ideaPercentage');
            const text = input.value.trim();
            const percentage = parseInt(percentageSelect.value);
            
            if (text === '') {
                alert('‚úèÔ∏è Por favor escribe tu idea');
                return;
            }
            
            // Asegurar que gameState.ideas existe
            if (!gameState.ideas) {
                gameState.ideas = {
                    pendientes: [],
                    guionada: [],
                    grabadas: [],
                    editadas: [],
                    publicadas: []
                };
            }
            
            // Asegurar que guionada existe en estados antiguos
            if (!gameState.ideas.guionada) {
                gameState.ideas.guionada = [];
            }
            
            const idea = {
                id: Date.now(),
                text: text,
                percentage: percentage,
                createdAt: new Date().toISOString(),
                status: 'pendiente'
            };
            
            gameState.ideas.pendientes.push(idea);
            
            // Asegurar que la estad√≠stica de contenido existe
            if (!gameState.stats.contenido) {
                gameState.stats.contenido = { ...STATS_CONFIG.contenido };
            }
            
            // Sumar porcentaje a la barra de contenido
            gameState.stats.contenido.value = Math.min(100, (gameState.stats.contenido.value || 0) + percentage);
            
            input.value = '';
            saveIdeas();
            saveState();
            updateContenidoBar();
            renderIdeas();
            // No llamar renderStats aqu√≠ para evitar sobrescribir contenido
            
            // Feedback visual
            alert(`‚ú® Idea agregada! +${percentage}% a Contenido`);
        }
        
        // Renderizar todas las ideas (actualiza la vista actual)
        function renderIdeas() {
            updateContenidoBar();
            renderCurrentIdeaState();
        }
        
        // Renderizar el estado actual de ideas
        function renderCurrentIdeaState() {
            const container = document.getElementById('ideasContainer');
            if (!container) return;
            
            container.innerHTML = '';
            const ideas = gameState.ideas[currentIdeaState] || [];
            
            if (ideas.length === 0) {
                const emptyMessages = {
                    pendientes: 'üí≠ No hay ideas pendientes. ¬°Agrega una nueva arriba!',
                    guionada: 'üìù No hay ideas con guion escrito. Escribe el guion de tus ideas pendientes.',
                    grabadas: 'üé• No hay ideas grabadas a√∫n. Graba tus ideas con guion.',
                    editadas: '‚úÇÔ∏è No hay ideas editadas. Edita tus videos grabados.',
                    publicadas: 'üì§ No hay ideas publicadas. Programa tus videos editados.'
                };
                container.innerHTML = `<p style="color: #a78bfa; text-align: center; padding: 40px; font-style: italic; font-size: 1.1em;">${emptyMessages[currentIdeaState]}</p>`;
                return;
            }
            
            ideas.forEach((idea, index) => {
                const ideaCard = createIdeaCard(idea, currentIdeaState, index);
                container.appendChild(ideaCard);
            });
        }
        
        // Crear tarjeta de idea
        function createIdeaCard(idea, section, index) {
            const card = document.createElement('div');
            card.style.cssText = `
                background: linear-gradient(135deg, #ffffff 0%, #fef3ff 100%);
                padding: 15px;
                border-radius: 15px;
                box-shadow: 0 4px 15px rgba(255, 107, 157, 0.15);
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 15px;
                transition: transform 0.3s ease;
            `;
            
            card.addEventListener('mouseenter', () => card.style.transform = 'translateY(-2px)');
            card.addEventListener('mouseleave', () => card.style.transform = 'translateY(0)');
            
            // Contenido de la idea
            const content = document.createElement('div');
            content.style.cssText = 'flex: 1; min-width: 0;';
            
            const text = document.createElement('div');
            text.textContent = idea.text;
            text.style.cssText = 'color: #6b4c9a; font-weight: 600; margin-bottom: 5px; word-wrap: break-word;';
            
            const meta = document.createElement('div');
            meta.style.cssText = 'display: flex; gap: 10px; flex-wrap: wrap; font-size: 0.85em;';
            
            const percentage = document.createElement('span');
            percentage.textContent = `+${idea.percentage}%`;
            percentage.style.cssText = 'background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%); color: white; padding: 3px 8px; border-radius: 8px; font-weight: 600;';
            
            const date = document.createElement('span');
            date.textContent = new Date(idea.createdAt).toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
            date.style.cssText = 'color: #a78bfa;';
            
            meta.appendChild(percentage);
            meta.appendChild(date);
            
            // Si est√° editada, mostrar fecha de publicaci√≥n
            if (section === 'editadas' && idea.publishDate) {
                const publishInfo = document.createElement('span');
                const pDate = new Date(idea.publishDate);
                publishInfo.textContent = `üìÖ ${pDate.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' })} ${pDate.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}`;
                publishInfo.style.cssText = 'color: #ff6b9d; font-weight: 600;';
                meta.appendChild(publishInfo);
            }
            
            content.appendChild(text);
            content.appendChild(meta);
            
            // Botones de acci√≥n
            const actions = document.createElement('div');
            actions.style.cssText = 'display: flex; gap: 8px; flex-shrink: 0;';
            
            // Bot√≥n de acci√≥n principal seg√∫n estado
            if (section === 'pendientes') {
                const guionBtn = createActionButton('üìù', () => openGuionModal(section, index));
                actions.appendChild(guionBtn);
            } else if (section === 'guionada') {
                // Bot√≥n para VER el guion
                const viewGuionBtn = createActionButton('üëÅÔ∏è', () => viewGuion(section, index));
                viewGuionBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                actions.appendChild(viewGuionBtn);
                
                // Bot√≥n para EDITAR el guion
                const editGuionBtn = createActionButton('‚úèÔ∏è', () => openGuionModal(section, index));
                actions.appendChild(editGuionBtn);
                
                // Bot√≥n para mover a grabadas
                const recordBtn = createActionButton('üé•', () => moveIdea(section, index, 'grabadas', idea.percentage));
                actions.appendChild(recordBtn);
            } else if (section === 'grabadas') {
                const editBtn = createActionButton('‚úÇÔ∏è', () => moveIdea(section, index, 'editadas', idea.percentage));
                actions.appendChild(editBtn);
            } else if (section === 'editadas') {
                const scheduleBtn = createActionButton('üìÖ', () => scheduleIdea(section, index));
                actions.appendChild(scheduleBtn);
            }
            
            // Bot√≥n de eliminar
            const deleteBtn = createActionButton('üóëÔ∏è', () => deleteIdea(section, index, idea.percentage));
            deleteBtn.style.background = 'linear-gradient(135deg, #ff6b9d 0%, #c44569 100%)';
            actions.appendChild(deleteBtn);
            
            card.appendChild(content);
            card.appendChild(actions);
            
            return card;
        }
        
        // Crear bot√≥n de acci√≥n
        function createActionButton(emoji, onClick) {
            const btn = document.createElement('button');
            btn.textContent = emoji;
            btn.style.cssText = `
                background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%);
                border: none;
                border-radius: 10px;
                width: 40px;
                height: 40px;
                font-size: 1.2em;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(167, 139, 250, 0.3);
                transition: all 0.3s ease;
            `;
            
            btn.addEventListener('mouseenter', () => {
                btn.style.transform = 'scale(1.1)';
                btn.style.boxShadow = '0 6px 20px rgba(167, 139, 250, 0.5)';
            });
            
            btn.addEventListener('mouseleave', () => {
                btn.style.transform = 'scale(1)';
                btn.style.boxShadow = '0 4px 15px rgba(167, 139, 250, 0.3)';
            });
            
            btn.addEventListener('click', onClick);
            
            return btn;
        }
        
        // Abrir modal para escribir/editar guion
        function openGuionModal(section, index) {
            const idea = gameState.ideas[section][index];
            const isEditing = idea.guion !== undefined;
            
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>üìù ${isEditing ? 'Editar' : 'Escribir'} Guion e Investigaci√≥n</h3>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #667eea; font-weight: bold;">Idea:</label>
                            <p style="background: #f3f4f6; padding: 12px; border-radius: 10px; color: #6b7280;">${idea.text}</p>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #667eea; font-weight: bold;">Guion / Notas:</label>
                            <textarea id="guionText" rows="8" placeholder="Escribe tu guion aqu√≠..." style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 0.95em; resize: vertical; font-family: inherit;">${idea.guion?.text || ''}</textarea>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #667eea; font-weight: bold;">URLs de Investigaci√≥n (una por l√≠nea):</label>
                            <textarea id="guionUrls" rows="4" placeholder="https://ejemplo.com&#10;https://otro-sitio.com" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 0.95em; resize: vertical; font-family: monospace;">${idea.guion?.urls?.join('\n') || ''}</textarea>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #667eea; font-weight: bold;">URLs de Im√°genes (una por l√≠nea):</label>
                            <textarea id="guionImages" rows="3" placeholder="https://imagen1.jpg&#10;https://imagen2.png" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 0.95em; resize: vertical; font-family: monospace;">${idea.guion?.images?.join('\n') || ''}</textarea>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #fef3ff 0%, #ffe5f3 100%); padding: 15px; border-radius: 10px;">
                            <p style="color: #6b4c9a; font-size: 0.9em; margin: 0;">üí° <strong>Tip:</strong> Usa este espacio para escribir tu guion completo, agregar links de investigaci√≥n e im√°genes que vas a usar.</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; padding: 20px;">
                        <button onclick="saveGuion('${section}', ${index})" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 15px; font-size: 1.1em; font-weight: bold; cursor: pointer;">üíæ Guardar y Mover a Guionada</button>
                        <button onclick="closeGuionModal()" style="padding: 15px 20px; background: #e5e7eb; color: #6b7280; border: none; border-radius: 15px; cursor: pointer;">Cancelar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Guardar guion y mover a guionada
        function saveGuion(section, index) {
            const guionText = document.getElementById('guionText').value.trim();
            const guionUrls = document.getElementById('guionUrls').value.trim();
            const guionImages = document.getElementById('guionImages').value.trim();
            
            if (!guionText) {
                alert('‚ö†Ô∏è Por favor escribe al menos algo en el guion');
                return;
            }
            
            const idea = gameState.ideas[section][index];
            
            // Agregar informaci√≥n del guion
            idea.guion = {
                text: guionText,
                urls: guionUrls ? guionUrls.split('\n').filter(url => url.trim()) : [],
                images: guionImages ? guionImages.split('\n').filter(img => img.trim()) : [],
                updatedAt: new Date().toISOString()
            };
            
            // Si est√° en pendientes, moverla a guionada
            if (section === 'pendientes') {
                gameState.ideas[section].splice(index, 1);
                gameState.ideas.guionada.push(idea);
            }
            
            saveIdeas();
            closeGuionModal();
            renderCurrentIdeaState();
        }
        
        // Cerrar modal del guion
        function closeGuionModal() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (modal.querySelector('#guionText')) {
                    modal.remove();
                }
            });
        }
        
        // Ver guion como documento (estilo Word con im√°genes intercaladas)
        function viewGuion(section, index) {
            const idea = gameState.ideas[section][index];
            
            if (!idea.guion) {
                alert('‚ö†Ô∏è Esta idea no tiene guion a√∫n');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal show';
            
            // Procesar el texto y crear el documento
            let guionHTML = '';
            const textParts = idea.guion.text.split('\n');
            const images = idea.guion.images || [];
            
            // Crear documento con texto e im√°genes intercaladas
            // Distribuir im√°genes a lo largo del texto
            const imageInterval = Math.ceil(textParts.length / (images.length + 1));
            let imageIndex = 0;
            
            textParts.forEach((paragraph, i) => {
                if (paragraph.trim()) {
                    guionHTML += `<p style="margin-bottom: 15px; color: #374151; line-height: 1.8; text-align: justify;">${paragraph}</p>`;
                }
                
                // Insertar imagen cada cierto n√∫mero de p√°rrafos
                if (imageIndex < images.length && (i + 1) % imageInterval === 0) {
                    guionHTML += `
                        <div style="margin: 20px 0; text-align: center;">
                            <img src="${images[imageIndex]}" style="max-width: 100%; height: auto; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);" onerror="this.style.display='none'" />
                        </div>
                    `;
                    imageIndex++;
                }
            });
            
            // Agregar im√°genes restantes al final
            while (imageIndex < images.length) {
                guionHTML += `
                    <div style="margin: 20px 0; text-align: center;">
                        <img src="${images[imageIndex]}" style="max-width: 100%; height: auto; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);" onerror="this.style.display='none'" />
                    </div>
                `;
                imageIndex++;
            }
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; margin: -20px -20px 20px -20px; border-radius: 20px 20px 0 0;">
                        <h3 style="margin: 0; color: white;">üìù ${idea.text}</h3>
                        <p style="margin: 10px 0 0 0; opacity: 0.9; font-size: 0.9em;">√öltima actualizaci√≥n: ${new Date(idea.guion.updatedAt).toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>
                    </div>
                    
                    <div class="modal-body" style="padding: 20px; background: white; font-family: 'Georgia', 'Times New Roman', serif;">
                        ${guionHTML}
                        
                        ${idea.guion.urls && idea.guion.urls.length > 0 ? `
                            <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #fef3ff 0%, #ffe5f3 100%); border-radius: 15px; border-left: 4px solid #ff6b9d;">
                                <h4 style="color: #6b4c9a; margin-bottom: 15px; font-size: 1.1em;">üîó Enlaces de Investigaci√≥n</h4>
                                ${idea.guion.urls.map(url => `
                                    <div style="margin-bottom: 10px;">
                                        <a href="${url}" target="_blank" style="color: #667eea; text-decoration: none; word-break: break-all; display: block; padding: 8px; background: white; border-radius: 8px; transition: all 0.2s;" onmouseover="this.style.background='#e0e7ff'" onmouseout="this.style.background='white'">
                                            üåê ${url}
                                        </a>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div style="display: flex; gap: 10px; padding: 20px; background: #f9fafb; margin: 0 -20px -20px -20px; border-radius: 0 0 20px 20px;">
                        <button onclick="openGuionModal('${section}', ${index})" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;">‚úèÔ∏è Editar</button>
                        <button onclick="closeGuionViewModal()" style="padding: 12px 20px; background: #e5e7eb; color: #6b7280; border: none; border-radius: 12px; cursor: pointer; font-weight: 600;">Cerrar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Cerrar modal de vista del guion
        function closeGuionViewModal() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (modal.innerHTML.includes('Enlaces de Investigaci√≥n') || modal.innerHTML.includes('√öltima actualizaci√≥n')) {
                    modal.remove();
                }
            });
        }
        
        // Mover idea de una secci√≥n a otra
        function moveIdea(fromSection, index, toSection, percentage) {
            const idea = gameState.ideas[fromSection][index];
            gameState.ideas[fromSection].splice(index, 1);
            gameState.ideas[toSection].push(idea);
            
            // Asegurar que la estad√≠stica de contenido existe
            if (!gameState.stats.contenido) {
                gameState.stats.contenido = { ...STATS_CONFIG.contenido };
            }
            
            // Sumar porcentaje adicional a la barra
            gameState.stats.contenido.value = Math.min(100, (gameState.stats.contenido.value || 0) + percentage);
            
            saveIdeas();
            saveState();
            updateContenidoBar();
            renderIdeas();
            // No llamar renderStats aqu√≠ para evitar sobrescribir contenido
            
            // Feedback
            const messages = {
                grabadas: 'üé• Idea marcada como grabada!',
                editadas: '‚úÇÔ∏è Idea marcada como editada!',
                publicadas: 'üì§ Idea publicada!'
            };
            
            alert(`${messages[toSection]} +${percentage}% a Contenido`);
        }
        
        // Programar idea para publicaci√≥n
        function scheduleIdea(section, index) {
            const idea = gameState.ideas[section][index];
            
            // Crear modal para programar
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.style.cssText = 'display: flex; justify-content: center; align-items: center;';
            
            const content = document.createElement('div');
            content.className = 'modal-content';
            content.style.cssText = 'max-width: 400px;';
            
            content.innerHTML = `
                <div class="modal-header">
                    <h3 class="modal-title">üìÖ Programar Publicaci√≥n</h3>
                    <p class="modal-subtitle">${idea.text}</p>
                </div>
                <div style="margin: 20px 0;">
                    <label style="display: block; color: #6b4c9a; font-weight: 600; margin-bottom: 8px;">Fecha y hora de publicaci√≥n:</label>
                    <input type="datetime-local" id="publishDateTime" style="width: 100%; padding: 12px; border: 2px solid #e0e7ff; border-radius: 12px; font-size: 1em;">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="confirmSchedule(${index})" style="flex: 1; background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%); border: none; border-radius: 12px; padding: 15px; font-size: 1em; font-weight: 600; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(167, 139, 250, 0.3);">‚úîÔ∏è Programar</button>
                    <button onclick="cancelSchedule()" style="flex: 1; background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%); border: none; border-radius: 12px; padding: 15px; font-size: 1em; font-weight: 600; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(255, 107, 157, 0.3);">‚úñÔ∏è Cancelar</button>
                </div>
            `;
            
            // Establecer fecha m√≠nima (ahora)
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            const dateInput = content.querySelector('#publishDateTime');
            setTimeout(() => {
                const input = document.getElementById('publishDateTime');
                if (input) {
                    input.min = now.toISOString().slice(0, 16);
                    input.value = now.toISOString().slice(0, 16);
                }
            }, 100);
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Guardar referencia para las funciones globales
            window.currentSchedulingIndex = index;
        }
        
        // Confirmar programaci√≥n
        function confirmSchedule(index) {
            const dateInput = document.getElementById('publishDateTime');
            const publishDate = dateInput.value;
            
            if (!publishDate) {
                alert('‚ö†Ô∏è Por favor selecciona una fecha y hora');
                return;
            }
            
            const idea = gameState.ideas.editadas[index];
            idea.publishDate = new Date(publishDate).toISOString();
            
            // Mover a publicadas
            gameState.ideas.editadas.splice(index, 1);
            gameState.ideas.publicadas.push(idea);
            
            // Asegurar que la estad√≠stica de contenido existe
            if (!gameState.stats.contenido) {
                gameState.stats.contenido = { ...STATS_CONFIG.contenido };
            }
            
            // Sumar porcentaje
            gameState.stats.contenido.value = Math.min(100, (gameState.stats.contenido.value || 0) + idea.percentage);
            
            saveIdeas();
            saveState();
            updateContenidoBar();
            renderIdeas();
            // No llamar renderStats aqu√≠ para evitar sobrescribir contenido
            
            cancelSchedule();
            alert(`üéâ Idea programada para publicarse! +${idea.percentage}% a Contenido`);
        }
        
        // Cancelar programaci√≥n
        function cancelSchedule() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (modal.querySelector('#publishDateTime')) {
                    modal.remove();
                }
            });
        }
        
        // Eliminar idea
        function deleteIdea(section, index, percentage) {
            if (!confirm('‚ö†Ô∏è ¬øEst√°s seguro de eliminar esta idea?')) {
                return;
            }
            
            gameState.ideas[section].splice(index, 1);
            
            // Asegurar que la estad√≠stica de contenido existe
            if (!gameState.stats.contenido) {
                gameState.stats.contenido = { ...STATS_CONFIG.contenido };
            }
            
            // Restar porcentaje de la barra (solo si no est√° en 0)
            const currentValue = gameState.stats.contenido.value || 0;
            gameState.stats.contenido.value = Math.max(0, currentValue - percentage);
            
            saveIdeas();
            saveState();
            updateContenidoBar();
            renderIdeas();
            // No llamar renderStats aqu√≠ para evitar sobrescribir contenido
            
            alert(`üóëÔ∏è Idea eliminada. -${percentage}% de Contenido`);
        }

        // ===== SISTEMA DE BACKUP Y PERSISTENCIA =====
        
        // Exportar backup como archivo descargable
        function exportBackup() {
            const backup = {
                version: '1.0',
                date: new Date().toISOString(),
                userProfile: localStorage.getItem('userProfile'),
                gameState: localStorage.getItem('gameState'),
                selfcareCooldowns: localStorage.getItem('selfcareCooldowns'),
                library: localStorage.getItem('library')
            };
            
            const dataStr = JSON.stringify(backup, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `mi-vida-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Backup descargado exitosamente. Gu√°rdalo en un lugar seguro.');
            console.log('üì• Backup exportado');
        }
        
        // Importar backup desde archivo
        function importBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const backup = JSON.parse(event.target.result);
                        
                        if (!backup.version || !backup.userProfile) {
                            alert('‚ùå Archivo de backup inv√°lido');
                            return;
                        }
                        
                        if (!confirm('‚ö†Ô∏è ¬øEst√°s segura? Esto reemplazar√° todos tus datos actuales con el backup.')) {
                            return;
                        }
                        
                        // Restaurar datos
                        if (backup.userProfile) localStorage.setItem('userProfile', backup.userProfile);
                        if (backup.gameState) localStorage.setItem('gameState', backup.gameState);
                        if (backup.selfcareCooldowns) localStorage.setItem('selfcareCooldowns', backup.selfcareCooldowns);
                        if (backup.library) localStorage.setItem('library', backup.library);
                        
                        alert('‚úÖ Backup restaurado exitosamente. La p√°gina se recargar√°.');
                        location.reload();
                        
                    } catch (error) {
                        alert('‚ùå Error al leer el archivo de backup: ' + error.message);
                        console.error('Error al restaurar backup:', error);
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        // Recuperar desde backup autom√°tico
        function recoverFromAutoBackup() {
            const libraryBackup = localStorage.getItem('library_backup');
            const ideasBackup = localStorage.getItem('ideas_backup');
            
            if (!libraryBackup && !ideasBackup) {
                alert('‚ùå No hay backups autom√°ticos disponibles');
                return;
            }
            
            let message = 'üîÑ Backups disponibles:\n\n';
            if (libraryBackup) message += '‚úì Biblioteca\n';
            if (ideasBackup) message += '‚úì Ideas\n';
            message += '\n¬øQuieres recuperar estos datos? Esto reemplazar√° los datos actuales.';
            
            if (!confirm(message)) {
                return;
            }
            
            try {
                let recovered = false;
                
                // Recuperar biblioteca
                if (libraryBackup) {
                    localStorage.setItem('library', libraryBackup);
                    recovered = true;
                    console.log('‚úÖ Biblioteca recuperada del backup');
                }
                
                // Recuperar ideas
                if (ideasBackup) {
                    localStorage.setItem('ideas', ideasBackup);
                    recovered = true;
                    console.log('‚úÖ Ideas recuperadas del backup');
                }
                
                if (recovered) {
                    alert('‚úÖ Datos recuperados exitosamente. La p√°gina se recargar√°.');
                    location.reload();
                } else {
                    alert('‚ö†Ô∏è No se pudo recuperar ning√∫n dato');
                }
            } catch (error) {
                alert('‚ùå Error al recuperar datos: ' + error.message);
                console.error('Error en recuperaci√≥n:', error);
            }
        }
        
        // Mostrar diagn√≥stico de datos
        function showDiagnostics() {
            const library = localStorage.getItem('library');
            const libraryBackup = localStorage.getItem('library_backup');
            const ideas = localStorage.getItem('ideas');
            const gameState = localStorage.getItem('gameState');
            
            let html = `
                <div class="modal show" style="z-index: 10000;">
                    <div class="modal-content" style="max-width: 700px; max-height: 80vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h3>üîç Diagn√≥stico de Datos</h3>
                        </div>
                        <div class="modal-body" style="text-align: left;">
            `;
            
            // Biblioteca
            html += '<h4 style="color: #667eea; margin-top: 20px;">üìö Biblioteca</h4>';
            if (library) {
                const lib = JSON.parse(library);
                html += `<p><strong>Libros:</strong> ${lib.libros?.length || 0}</p>`;
                html += `<p><strong>Pel√≠culas:</strong> ${lib.peliculas?.length || 0}</p>`;
                html += `<p><strong>Series:</strong> ${lib.series?.length || 0}</p>`;
                
                if (lib.peliculas && lib.peliculas.length > 0) {
                    html += '<details style="margin-top: 10px;"><summary style="cursor: pointer; color: #667eea; font-weight: 600;">Ver pel√≠culas guardadas</summary>';
                    html += '<div style="margin-top: 10px; background: #f5f5f5; padding: 10px; border-radius: 8px; max-height: 200px; overflow-y: auto;">';
                    lib.peliculas.forEach((movie, i) => {
                        html += `<div style="margin-bottom: 10px; padding: 10px; background: white; border-radius: 5px;">
                            <strong>${i + 1}. ${movie.title}</strong><br>
                            <small>Rating: ${'‚≠ê'.repeat(movie.rating || 0)}</small><br>
                            ${movie.description ? `<small style="color: #666;">${movie.description.substring(0, 100)}${movie.description.length > 100 ? '...' : ''}</small>` : ''}
                        </div>`;
                    });
                    html += '</div></details>';
                }
            } else {
                html += '<p style="color: red;">‚ùå No hay datos de biblioteca</p>';
            }
            
            // Backup de biblioteca
            html += '<h4 style="color: #ff9800; margin-top: 20px;">üíæ Backup Autom√°tico de Biblioteca</h4>';
            if (libraryBackup) {
                const libBackup = JSON.parse(libraryBackup);
                html += `<p>‚úÖ Backup disponible</p>`;
                html += `<p><strong>Pel√≠culas en backup:</strong> ${libBackup.peliculas?.length || 0}</p>`;
                
                if (libBackup.peliculas && libBackup.peliculas.length > 0) {
                    html += '<details style="margin-top: 10px;"><summary style="cursor: pointer; color: #ff9800; font-weight: 600;">Ver pel√≠culas en backup</summary>';
                    html += '<div style="margin-top: 10px; background: #fff3e0; padding: 10px; border-radius: 8px; max-height: 200px; overflow-y: auto;">';
                    libBackup.peliculas.forEach((movie, i) => {
                        html += `<div style="margin-bottom: 10px; padding: 10px; background: white; border-radius: 5px;">
                            <strong>${i + 1}. ${movie.title}</strong><br>
                            <small>Rating: ${'‚≠ê'.repeat(movie.rating || 0)}</small><br>
                            ${movie.description ? `<small style="color: #666;">${movie.description.substring(0, 100)}${movie.description.length > 100 ? '...' : ''}</small>` : ''}
                        </div>`;
                    });
                    html += '</div></details>';
                }
            } else {
                html += '<p style="color: #999;">‚ö†Ô∏è No hay backup autom√°tico a√∫n</p>';
            }
            
            // Ideas
            html += '<h4 style="color: #ff6b9d; margin-top: 20px;">üí° Ideas</h4>';
            if (ideas) {
                const id = JSON.parse(ideas);
                const total = (id.pendientes?.length || 0) + (id.guionada?.length || 0) + (id.grabadas?.length || 0) + (id.editadas?.length || 0) + (id.publicadas?.length || 0);
                html += `<p>Total: ${total} ideas</p>`;
            } else {
                html += '<p style="color: #999;">Sin ideas guardadas</p>';
            }
            
            html += `
                        </div>
                        <button onclick="closeDiagnostics()" style="width: 100%; margin-top: 20px; padding: 15px; background: #667eea; color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600;">‚úï Cerrar</button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function closeDiagnostics() {
            const modal = document.querySelector('.modal.show');
            if (modal) modal.remove();
        }
        
        // ===================================
        // üìÖ CALENDARIO
        // ===================================
        
        // Inicializar actividades si no existen
        if (!gameState.activities) {
            gameState.activities = { pending: [], completed: [] };
        }
        
        function switchCalendarView(view) {
            // Actualizar botones
            document.querySelectorAll('.calendar-view-btn').forEach(btn => {
                btn.classList.remove('active');
                if (view === 'actividades' && btn.textContent.includes('Actividades')) {
                    btn.classList.add('active');
                    btn.style.background = 'linear-gradient(135deg, #ff6b9d 0%, #ffa8c5 100%)';
                    btn.style.color = 'white';
                    btn.style.boxShadow = '0 4px 15px rgba(255, 107, 157, 0.3)';
                } else if (view === 'videos' && btn.textContent.includes('Videos')) {
                    btn.classList.add('active');
                    btn.style.background = 'linear-gradient(135deg, #ff6b9d 0%, #ffa8c5 100%)';
                    btn.style.color = 'white';
                    btn.style.boxShadow = '0 4px 15px rgba(255, 107, 157, 0.3)';
                } else {
                    btn.style.background = 'linear-gradient(135deg, #e0e7ff 0%, #fef3ff 100%)';
                    btn.style.color = '#6b4c9a';
                    btn.style.boxShadow = '0 2px 8px rgba(167, 139, 250, 0.2)';
                }
            });
            
            // Mostrar vista correspondiente
            document.getElementById('calendar-actividades').style.display = view === 'actividades' ? 'block' : 'none';
            document.getElementById('calendar-videos').style.display = view === 'videos' ? 'block' : 'none';
        }
        
        function addActivity() {
            const input = document.getElementById('newActivityInput');
            const dateInput = document.getElementById('activityDate');
            const timeInput = document.getElementById('activityTime');
            const categoryInput = document.getElementById('activityCategory');
            const recurrenceInput = document.getElementById('activityRecurrence');
            const importanceInput = document.getElementById('activityImportance');
            const statEffectInput = document.getElementById('activityStatEffect');
            const statPercentageInput = document.getElementById('activityStatPercentage');
            const activity = input.value.trim();
            const date = dateInput.value;
            const time = timeInput.value;
            const category = categoryInput.value;
            const recurrence = recurrenceInput.value;
            const importance = parseInt(importanceInput.value);
            const statEffect = statEffectInput.value;
            const statPercentage = statEffect !== 'none' ? parseInt(statPercentageInput.value) : 0;
            
            if (activity === '') {
                alert('‚ö†Ô∏è Por favor escribe una actividad');
                return;
            }
            
            // Si no hay fecha, usar HOY
            let finalDate = date;
            if (finalDate === '') {
                const today = new Date();
                finalDate = today.toISOString().split('T')[0];
                console.log('üìÖ No se seleccion√≥ fecha, usando hoy:', finalDate);
            }
            
            const newActivity = {
                id: Date.now(),
                text: activity,
                date: finalDate,
                time: time || '20:00',
                category: category || 'personal',
                recurrence: recurrence,
                importance: importance,
                statEffect: statEffect !== 'none' ? `${statEffect},${statPercentage}` : 'none',
                completed: false
            };
            
            gameState.activities.pending.push(newActivity);
            saveState();
            
            console.log('‚úÖ Actividad agregada:', newActivity);
            console.log('üìä Total actividades ahora:', gameState.activities.pending.length);
            
            input.value = '';
            dateInput.value = '';
            timeInput.value = '';
            categoryInput.value = 'personal';
            recurrenceInput.value = 'none';
            importanceInput.value = '2';
            statEffectInput.value = 'none';
            statPercentageInput.value = '15';
            document.getElementById('statPercentageContainer').style.display = 'none';
            
            console.log('üîÑ Llamando a renderActivities()...');
            renderActivities();
            renderMonthlyCalendar();
            renderWrongActivities();
            
            // Confirmaci√≥n visual
            alert(`‚úÖ Actividad "${activity}" agregada exitosamente!\nüìÖ Fecha: ${finalDate}\n‚è∞ Hora: ${time || '20:00'}`);
            
            // Scroll al contenedor de actividades para que el usuario vea la actividad
            const container = document.getElementById('activitiesPending');
            if (container) {
                container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
        
        function toggleActivity(id) {
            const activity = gameState.activities.pending.find(a => a.id === id);
            if (activity) {
                gameState.activities.pending = gameState.activities.pending.filter(a => a.id !== id);
                activity.completed = true;
                gameState.activities.completed.push(activity);
                
                // Agregar a wrongActivities para poder corregir
                gameState.wrongActivities.list.push({...activity});
                
                // Aplicar efecto de estad√≠stica si existe
                if (activity.statEffect && activity.statEffect !== 'none') {
                    const [statName, statValue] = activity.statEffect.split(',');
                    const boost = parseInt(statValue);
                    
                    // Aplicar el boost a la estad√≠stica correspondiente
                    if (gameState.stats[statName]) {
                        gameState.stats[statName].value = Math.min(100, gameState.stats[statName].value + boost);
                        renderStats();
                        
                        // Mostrar notificaci√≥n
                        console.log(`‚úÖ Actividad completada! +${boost}% a ${statName}`);
                    }
                }
                
                saveState();
                renderActivities();
                renderWrongActivities();
            }
        }
        
        function markActivityNotDone(id) {
            const activity = gameState.activities.pending.find(a => a.id === id);
            if (activity) {
                // Confirmar acci√≥n
                if (!confirm('¬øConfirmas que NO hiciste esta actividad?')) {
                    return;
                }
                
                gameState.activities.pending = gameState.activities.pending.filter(a => a.id !== id);
                activity.completed = false;
                gameState.activities.completed.push(activity);
                
                // Agregar a wrongActivities para poder corregir
                gameState.wrongActivities.list.push({...activity});
                
                // Solo aplicar penalizaci√≥n si es IMPORTANTE (3 estrellas)
                if ((activity.importance || 2) === 3 && activity.statEffect && activity.statEffect !== 'none') {
                    const [statName, statValue] = activity.statEffect.split(',');
                    const penalty = parseInt(statValue);
                    
                    // Restar el porcentaje que hubiera sumado
                    if (gameState.stats[statName]) {
                        gameState.stats[statName].value = Math.max(0, gameState.stats[statName].value - penalty);
                        renderStats();
                        
                        // Mostrar notificaci√≥n
                        alert(`‚ùå Actividad importante no realizada: -${penalty}% a ${statName}`);
                        console.log(`‚ùå Actividad no realizada: -${penalty}% a ${statName}`);
                    }
                }
                
                saveState();
                renderActivities();
                renderWrongActivities();
            }
        }
        
        function renderWrongActivities() {
            const container = document.getElementById('wrongActivitiesList');
            if (!container) return;
            
            // Verificar si necesitamos resetear (cambio de d√≠a)
            const today = new Date().toDateString();
            if (gameState.wrongActivities.lastReset !== today) {
                gameState.wrongActivities.list = [];
                gameState.wrongActivities.lastReset = today;
                saveState();
            }
            
            // Obtener actividades marcadas hoy (tanto completadas como no completadas)
            const todayActivities = gameState.wrongActivities.list;
            
            if (todayActivities.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; font-size: 0.9em; margin: 10px 0;">No hay actividades marcadas hoy</p>';
                return;
            }
            
            const categories = {
                work: { icon: 'üíº', name: 'Trabajo', bg: '#fef3c7', text: '#92400e', border: '#fbbf24' },
                personal: { icon: 'üè†', name: 'Personal', bg: '#dbeafe', text: '#1e40af', border: '#3b82f6' },
                health: { icon: '‚ù§Ô∏è', name: 'Salud', bg: '#fecaca', text: '#991b1b', border: '#ef4444' },
                social: { icon: 'üë•', name: 'Social', bg: '#d1fae5', text: '#065f46', border: '#10b981' },
                learning: { icon: 'üìö', name: 'Aprendizaje', bg: '#e9d5ff', text: '#6b21a8', border: '#a855f7' }
            };
            
            container.innerHTML = todayActivities.map(activity => {
                const cat = categories[activity.category || 'personal'];
                const activityDate = new Date(activity.date);
                const formattedDate = activityDate.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
                const formattedTime = activity.time || '00:00';
                
                const stars = '‚≠ê'.repeat(activity.importance || 2);
                
                let statInfo = '';
                if (activity.statEffect && activity.statEffect !== 'none') {
                    const [statName, statValue] = activity.statEffect.split(',');
                    const statIcons = {
                        ejercicio: 'üí™',
                        autoestima: '‚ú®',
                        vidaSocial: 'üë•',
                        idiomas: 'üó£Ô∏è',
                        aprendizaje: 'üìö',
                        contenido: 'üé¨'
                    };
                    statInfo = `<p style="margin: 5px 0 0 0; font-size: 0.85em; color: #666;">${statIcons[statName]} ${activity.completed ? '+' : '-'}${statValue}%</p>`;
                }
                
                const statusBadge = activity.completed 
                    ? '<span style="background: #10b981; color: white; padding: 3px 8px; border-radius: 6px; font-size: 0.8em; font-weight: 600;">‚úÖ Hecha</span>'
                    : '<span style="background: #ef4444; color: white; padding: 3px 8px; border-radius: 6px; font-size: 0.8em; font-weight: 600;">‚ùå No hecha</span>';
                
                return `
                    <div style="background: ${cat.bg}; padding: 15px; border-radius: 12px; border-left: 4px solid ${cat.border}; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 5px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                    <p style="margin: 0; font-weight: 600; color: #333;"><span style="margin-right: 5px;">${cat.icon}</span>${activity.text}</p>
                                    ${statusBadge}
                                </div>
                                <p style="margin: 5px 0 0 0; font-size: 0.85em; color: ${cat.text};">üìÖ ${formattedDate} ${formattedTime !== '00:00' ? `‚è∞ ${formattedTime}` : ''} ${stars}</p>
                                ${statInfo}
                            </div>
                            <button onclick="restoreActivity(${activity.id})" style="padding: 8px 16px; background: linear-gradient(135deg, #f97316 0%, #fb923c 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; white-space: nowrap; margin-left: 10px;">‚Ü©Ô∏è Restaurar</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function restoreActivity(id) {
            // Buscar la actividad en la lista de actividades mal clasificadas
            const activityIndex = gameState.wrongActivities.list.findIndex(a => a.id === id);
            if (activityIndex === -1) return;
            
            const activity = gameState.wrongActivities.list[activityIndex];
            
            // Revertir el efecto de estad√≠stica si existe
            if (activity.statEffect && activity.statEffect !== 'none') {
                const [statName, statValue] = activity.statEffect.split(',');
                const value = parseInt(statValue);
                
                if (gameState.stats[statName]) {
                    if (activity.completed) {
                        // Si estaba marcada como hecha, restar el boost
                        gameState.stats[statName].value = Math.max(0, gameState.stats[statName].value - value);
                    } else {
                        // Si estaba marcada como no hecha (y era importante), devolver la penalizaci√≥n
                        if ((activity.importance || 2) === 3) {
                            gameState.stats[statName].value = Math.min(100, gameState.stats[statName].value + value);
                        }
                    }
                    renderStats();
                }
            }
            
            // Remover de completed y wrongActivities
            gameState.activities.completed = gameState.activities.completed.filter(a => a.id !== id);
            gameState.wrongActivities.list.splice(activityIndex, 1);
            
            // Restaurar a pending
            activity.completed = false;
            gameState.activities.pending.push(activity);
            
            saveState();
            renderActivities();
            renderWrongActivities();
        }
        
        function deleteActivity(id, completed = false) {
            if (completed) {
                gameState.activities.completed = gameState.activities.completed.filter(a => a.id !== id);
            } else {
                gameState.activities.pending = gameState.activities.pending.filter(a => a.id !== id);
            }
            saveState();
            renderActivities();
        }
        
        // Variable para el mes actual del calendario
        let currentCalendarMonth = new Date();
        
        // Mostrar/ocultar campo de porcentaje seg√∫n la estad√≠stica seleccionada
        function toggleStatPercentage(statValue) {
            const container = document.getElementById('statPercentageContainer');
            if (statValue && statValue !== 'none') {
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }
        
        function changeMonth(delta) {
            currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + delta);
            renderMonthlyCalendar();
            renderActivities();
        }
        
        // Colores por categor√≠a
        const categoryColors = {
            personal: { bg: '#fef3ff', border: '#ff6b9d', text: '#ff6b9d', icon: 'üå∏' },
            escuela: { bg: '#e0f2fe', border: '#3b82f6', text: '#3b82f6', icon: 'üìö' },
            trabajo: { bg: '#f0fdf4', border: '#10b981', text: '#10b981', icon: 'üíº' },
            ejercicio: { bg: '#fff7ed', border: '#f97316', text: '#f97316', icon: 'üí™' },
            salud: { bg: '#fef2f2', border: '#ef4444', text: '#ef4444', icon: '‚ù§Ô∏è' },
            social: { bg: '#faf5ff', border: '#a855f7', text: '#a855f7', icon: 'üë•' }
        };
        
        function renderMonthlyCalendar() {
            const container = document.getElementById('monthlyCalendar');
            if (!container) return;
            
            const year = currentCalendarMonth.getFullYear();
            const month = currentCalendarMonth.getMonth();
            
            // Actualizar label del mes
            const monthLabel = document.getElementById('currentMonthLabel');
            if (monthLabel) {
                const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                monthLabel.textContent = `${monthNames[month]} ${year}`;
            }
            
            // Obtener primer d√≠a del mes y total de d√≠as
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay(); // 0 = domingo
            
            // Crear HTML del calendario
            let html = '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; margin: 0 auto; max-width: 100%;">';
            
            // Encabezados de d√≠as
            const dayNames = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
            dayNames.forEach(day => {
                html += `<div style="text-align: center; font-weight: 600; color: #ff6b9d; padding: 5px; font-size: 0.75em;">${day}</div>`;
            });
            
            // Espacios vac√≠os antes del primer d√≠a
            for (let i = 0; i < startingDayOfWeek; i++) {
                html += '<div></div>';
            }
            
            // D√≠as del mes
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = isCurrentMonth && day === today.getDate();
                
                // Obtener actividades del d√≠a
                const dayActivities = gameState.activities.pending.filter(a => a.date === dateStr);
                
                // Obtener colores de las categor√≠as presentes
                const categoriesInDay = [...new Set(dayActivities.map(a => a.category || 'personal'))];
                const dayColor = categoriesInDay.length === 1 ? categoryColors[categoriesInDay[0]] : null;
                
                html += `
                    <div style="
                        min-height: 50px;
                        padding: 4px;
                        background: ${isToday ? 'linear-gradient(135deg, #ff6b9d 0%, #ffa8c5 100%)' : (dayColor ? dayColor.bg : '#fff')};
                        border: 2px solid ${isToday ? '#ff6b9d' : (dayColor ? dayColor.border : '#ffe5f3')};
                        border-radius: 8px;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        cursor: pointer;
                        transition: all 0.2s;
                        box-shadow: ${isToday ? '0 4px 15px rgba(255, 107, 157, 0.3)' : '0 2px 5px rgba(0,0,0,0.05)'};
                    " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        <div style="font-weight: 600; color: ${isToday ? 'white' : '#333'}; margin-bottom: 2px; font-size: 0.9em;">${day}</div>
                        ${dayActivities.length > 0 ? `
                            <div style="display: flex; gap: 2px; flex-wrap: wrap; justify-content: center;">
                                ${categoriesInDay.slice(0, 3).map(cat => `
                                    <div style="width: 8px; height: 8px; border-radius: 50%; background: ${categoryColors[cat].border};"></div>
                                `).join('')}
                                ${categoriesInDay.length > 3 ? `<div style="font-size: 0.6em; color: ${isToday ? 'white' : '#666'};">+${categoriesInDay.length - 3}</div>` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function renderActivities() {
            const pendingContainer = document.getElementById('activitiesPending');
            
            if (!pendingContainer) {
                console.error('‚ùå No se encontr√≥ el contenedor activitiesPending');
                return;
            }
            
            // Filtrar TODAS las actividades de HOY (sin importar la hora)
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            console.log('üìÖ Fecha de hoy:', todayStr);
            console.log('üìã Total actividades pendientes:', gameState.activities.pending.length);
            
            const todayActivities = gameState.activities.pending.filter(activity => {
                console.log('Comparando:', activity.date, '===', todayStr, '‚Üí', activity.date === todayStr);
                return activity.date === todayStr;
            });
            
            console.log('‚úÖ Actividades de hoy encontradas:', todayActivities.length);
            
            // Renderizar todas las actividades de hoy (ordenar por importancia primero, luego por fecha)
            const sortedPending = [...todayActivities].sort((a, b) => {
                // Primero por importancia (descendente)
                const importanceDiff = (b.importance || 3) - (a.importance || 3);
                if (importanceDiff !== 0) return importanceDiff;
                
                // Luego por fecha (ascendente)
                const dateA = new Date(`${a.date}T${a.time}`);
                const dateB = new Date(`${b.date}T${b.time}`);
                return dateA - dateB;
            });
            
            if (sortedPending.length === 0) {
                pendingContainer.innerHTML = '<p style="text-align: center; color: #a78bfa; padding: 20px;">No hay actividades para hoy üå∏</p>';
            } else {
                pendingContainer.innerHTML = sortedPending.map(activity => {
                    const activityDate = new Date(`${activity.date}T${activity.time}`);
                    const formattedDate = activityDate.toLocaleDateString('es-ES', { 
                        weekday: 'short', 
                        day: 'numeric', 
                        month: 'short' 
                    });
                    const formattedTime = activity.time;
                    const cat = categoryColors[activity.category || 'personal'];
                    const importance = activity.importance || 3;
                    const stars = '‚≠ê'.repeat(importance);
                    
                    // Parsear el efecto de estad√≠stica
                    let statInfo = '';
                    if (activity.statEffect && activity.statEffect !== 'none') {
                        const [statName, statValue] = activity.statEffect.split(',');
                        const statIcons = {
                            'autoestima': 'üíé',
                            'higiene': 'üöø',
                            'ejercicio': 'üí™',
                            'productividad': 'üìö',
                            'social': 'üë•',
                            'descanso': 'üò¥'
                        };
                        statInfo = `<div style="margin-top: 5px; padding: 5px 10px; background: rgba(167, 139, 250, 0.2); border-radius: 8px; font-size: 0.8em; color: #667eea;">${statIcons[statName] || 'üìä'} ${statName.charAt(0).toUpperCase() + statName.slice(1)} +${statValue}%</div>`;
                    }
                    
                    return `
                        <div style="background: ${cat.bg}; padding: 15px; border-radius: 12px; border-left: 4px solid ${cat.border}; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; gap: 10px; align-items: start;">
                            <div style="flex: 1;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 5px;">
                                    <p style="margin: 0; font-weight: 600; color: #333;"><span style="margin-right: 5px;">${cat.icon}</span>${activity.text}</p>
                                    <span style="font-size: 0.9em;">${stars}</span>
                                </div>
                                <p style="margin: 5px 0 0 0; font-size: 0.85em; color: ${cat.text};">üìÖ ${formattedDate} ${formattedTime !== '00:00' ? `‚è∞ ${formattedTime}` : ''}</p>
                                ${statInfo}
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <button onclick="toggleActivity(${activity.id})" style="padding: 8px 12px; background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; white-space: nowrap;">‚úÖ Hecha</button>
                                <button onclick="markActivityNotDone(${activity.id})" style="padding: 8px 12px; background: linear-gradient(135deg, #ff4d4f 0%, #ff7875 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; white-space: nowrap;">‚ùå No hecha</button>
                                <button onclick="deleteActivity(${activity.id})" style="padding: 6px 10px; background: #9ca3af; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.85em;">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }
        
        function renderScheduledVideos() {
            const container = document.getElementById('scheduledVideos');
            if (!container) return;
            
            // Obtener videos programados de las ideas
            const scheduledVideos = gameState.ideas.publicadas.filter(idea => idea.scheduledDate);
            
            if (scheduledVideos.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            const sortedVideos = [...scheduledVideos].sort((a, b) => {
                return new Date(a.scheduledDate) - new Date(b.scheduledDate);
            });
            
            container.innerHTML = sortedVideos.map(video => {
                const videoDate = new Date(video.scheduledDate);
                const formattedDate = videoDate.toLocaleDateString('es-ES', { 
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'long',
                    year: 'numeric'
                });
                
                return `
                    <div style="background: linear-gradient(135deg, #fef3ff 0%, #ffe5f3 100%); padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(255,107,157,0.15);">
                        <p style="margin: 0; font-weight: 600; color: #ff6b9d;">üé¨ ${video.text}</p>
                        <p style="margin: 5px 0 0 0; font-size: 0.85em; color: #a78bfa;">üìÖ ${formattedDate}</p>
                    </div>
                `;
            }).join('');
        }
        
        // ===================================
        // üß† SISTEMA DE REPETICI√ìN ESPACIADA (FLASHCARDS)
        // ===================================
        
        function startFlashcardReview() {
            const today = new Date();
            const flashcardsToReview = library.flashcards.filter(card => {
                if (!card.nextReview) return true; // Nueva flashcard
                return new Date(card.nextReview) <= today;
            });
            
            if (flashcardsToReview.length === 0) {
                alert('üéâ ¬°No hay flashcards para repasar hoy! Vuelve ma√±ana.');
                return;
            }
            
            // Iniciar sesi√≥n de repaso
            window.currentReviewSession = {
                cards: flashcardsToReview,
                currentIndex: 0,
                showingAnswer: false
            };
            
            showReviewModal();
        }
        
        function showReviewModal() {
            const session = window.currentReviewSession;
            const card = session.cards[session.currentIndex];
            
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.id = 'reviewModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>üß† Repaso de Flashcards</h3>
                        <p style="color: #a78bfa; font-size: 0.9em;">${session.currentIndex + 1} / ${session.cards.length}</p>
                    </div>
                    <div class="modal-body" style="min-height: 300px; display: flex; flex-direction: column; justify-content: center;">
                        ${card.folder ? `<div style="background: #fef3ff; padding: 8px 15px; border-radius: 8px; margin-bottom: 15px; text-align: center; color: #ff6b9d; font-weight: 600;">üìÅ ${card.folder}</div>` : ''}
                        
                        <div id="flashcardContent" style="text-align: center; padding: 20px;">
                            <h2 style="color: #667eea; margin-bottom: 20px; font-size: 1.5em;">${card.title}</h2>
                            ${card.imageUrl ? `<img src="${card.imageUrl}" style="max-width: 100%; max-height: 200px; border-radius: 10px; margin-bottom: 20px;">` : ''}
                            
                            ${!session.showingAnswer ? `
                                <button onclick="showAnswer()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%); color: white; border: none; border-radius: 15px; font-size: 1.1em; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(167, 139, 250, 0.3);">
                                    üëÅÔ∏è Ver Respuesta
                                </button>
                            ` : `
                                <div style="background: linear-gradient(135deg, #fef3ff 0%, #ffe5f3 100%); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                                    <p style="color: #6b4c9a; font-size: 1.2em; line-height: 1.6;">${card.answer}</p>
                                </div>
                                
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <button onclick="rateFlashcard('hard')" style="flex: 1; min-width: 120px; padding: 15px; background: #ef4444; color: white; border: none; border-radius: 15px; font-weight: 600; cursor: pointer;">
                                        ‚ùå Dif√≠cil<br><small>Repetir pronto</small>
                                    </button>
                                    <button onclick="rateFlashcard('good')" style="flex: 1; min-width: 120px; padding: 15px; background: #f59e0b; color: white; border: none; border-radius: 15px; font-weight: 600; cursor: pointer;">
                                        ü§î Regular<br><small>Necesito repaso</small>
                                    </button>
                                    <button onclick="rateFlashcard('easy')" style="flex: 1; min-width: 120px; padding: 15px; background: #10b981; color: white; border: none; border-radius: 15px; font-weight: 600; cursor: pointer;">
                                        ‚úÖ F√°cil<br><small>La record√© bien</small>
                                    </button>
                                </div>
                            `}
                        </div>
                    </div>
                    <button onclick="closeReviewModal()" style="width: 100%; margin-top: 15px; padding: 12px; background: #e5e7eb; color: #6b7280; border: none; border-radius: 12px; cursor: pointer;">Cerrar Sesi√≥n</button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function showAnswer() {
            window.currentReviewSession.showingAnswer = true;
            document.getElementById('reviewModal').remove();
            showReviewModal();
        }
        
        function rateFlashcard(difficulty) {
            const session = window.currentReviewSession;
            const card = session.cards[session.currentIndex];
            
            // Encontrar el √≠ndice de la card en la biblioteca
            const cardIndex = library.flashcards.findIndex(c => c.title === card.title && c.answer === card.answer);
            
            if (cardIndex !== -1) {
                const now = new Date();
                let interval = library.flashcards[cardIndex].interval || 0;
                
                // Algoritmo de repetici√≥n espaciada
                if (difficulty === 'hard') {
                    interval = 0; // Repetir hoy
                } else if (difficulty === 'good') {
                    if (interval === 0) interval = 1; // 1 d√≠a
                    else interval = Math.ceil(interval * 1.5); // Aumentar 50%
                } else if (difficulty === 'easy') {
                    if (interval === 0) interval = 1; // 1 d√≠a
                    else if (interval === 1) interval = 3; // 3 d√≠as
                    else if (interval === 3) interval = 7; // 1 semana
                    else if (interval === 7) interval = 14; // 2 semanas
                    else if (interval === 14) interval = 30; // 1 mes
                    else if (interval === 30) interval = 90; // 3 meses
                    else if (interval === 90) interval = 180; // 6 meses
                    else if (interval === 180) interval = 365; // 1 a√±o
                    else interval = Math.ceil(interval * 2); // Duplicar
                }
                
                const nextReview = new Date(now.getTime() + interval * 24 * 60 * 60 * 1000);
                library.flashcards[cardIndex].interval = interval;
                library.flashcards[cardIndex].nextReview = nextReview.toISOString();
                
                saveLibrary();
            }
            
            // Siguiente tarjeta
            session.currentIndex++;
            session.showingAnswer = false;
            
            if (session.currentIndex < session.cards.length) {
                document.getElementById('reviewModal').remove();
                showReviewModal();
            } else {
                document.getElementById('reviewModal').remove();
                alert(`üéâ ¬°Sesi√≥n completada! Repasaste ${session.cards.length} flashcard${session.cards.length > 1 ? 's' : ''}.`);
                renderLibraryContent();
            }
        }
        
        function closeReviewModal() {
            const modal = document.getElementById('reviewModal');
            if (modal) modal.remove();
            window.currentReviewSession = null;
        }
        
        function reviewSingleFlashcard(index) {
            window.currentReviewSession = {
                cards: [library.flashcards[index]],
                currentIndex: 0,
                showingAnswer: false
            };
            showReviewModal();
        }
        
        // Guardar todo antes de cerrar o cambiar de pesta√±a
        function saveBeforeExit() {
            saveState();
            saveSelfcareCooldowns();
            saveLibrary();
            console.log('üíæ Datos guardados autom√°ticamente');
        }
        
        // Indicador visual de guardado
        function showSaveIndicator(message = 'Guardado ‚úì') {
            // Remover indicador anterior si existe
            const oldIndicator = document.getElementById('saveIndicator');
            if (oldIndicator) oldIndicator.remove();
            
            const indicator = document.createElement('div');
            indicator.id = 'saveIndicator';
            indicator.textContent = message;
            indicator.style.cssText = `
                position: fixed;
                bottom: 80px;
                right: 20px;
                background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
                color: white;
                padding: 12px 20px;
                border-radius: 25px;
                font-weight: 600;
                font-size: 0.9em;
                box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
                z-index: 10000;
                animation: slideIn 0.3s ease-out, slideOut 0.3s ease-in 2.7s;
                pointer-events: none;
            `;
            
            document.body.appendChild(indicator);
            
            setTimeout(() => {
                indicator.remove();
            }, 3000);
        }
        
        // Agregar estilos de animaci√≥n si no existen
        if (!document.getElementById('saveIndicatorStyles')) {
            const style = document.createElement('style');
            style.id = 'saveIndicatorStyles';
            style.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateX(400px);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
                @keyframes slideOut {
                    from {
                        transform: translateX(0);
                        opacity: 1;
                    }
                    to {
                        transform: translateX(400px);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(style);
        }
        
        // Registrar service worker y detectar actualizaciones
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registrado');
                        
                        // Verificar actualizaciones cada 30 segundos (m√°s frecuente)
                        setInterval(() => {
                            registration.update();
                        }, 30 * 1000);
                        
                        // Detectar cuando hay actualizaci√≥n disponible
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // Hay actualizaci√≥n disponible
                                    mostrarBotonActualizar();
                                }
                            });
                        });
                        
                        // Recargar cuando se activa un nuevo service worker
                        let refreshing = false;
                        navigator.serviceWorker.addEventListener('controllerchange', () => {
                            if (!refreshing) {
                                refreshing = true;
                                console.log('üîÑ Recargando con nueva versi√≥n...');
                                window.location.reload();
                            }
                        });
                    })
                    .catch(err => {
                        console.log('‚ùå Error al registrar Service Worker:', err);
                    });
            });
        }
        
        // Mostrar bot√≥n de actualizaci√≥n
        function mostrarBotonActualizar() {
            const boton = document.createElement('div');
            boton.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.6); cursor: pointer; z-index: 99999; font-weight: 700; animation: pulse 2s infinite; max-width: 90%; text-align: center; font-size: 1.1em;';
            boton.innerHTML = 'üéâ ¬°NUEVA VERSI√ìN! Se agregaron Flashcards üß†<br><span style="font-size: 0.9em; opacity: 0.9;">Toca aqu√≠ para actualizar ahora</span>';
            boton.onclick = () => {
                // Forzar actualizaci√≥n
                if (navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({ type: 'SKIP_WAITING' });
                }
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            };
            document.body.appendChild(boton);
        }
        
        // Mostrar indicador de auto-guardado
        function showAutoSaveIndicator() {
            const indicator = document.createElement('div');
            indicator.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 10px 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); z-index: 9999; font-weight: 600; font-size: 0.9em; opacity: 0; transition: opacity 0.3s ease;';
            indicator.innerHTML = 'üíæ Guardado autom√°tico';
            document.body.appendChild(indicator);
            
            // Fade in
            setTimeout(() => {
                indicator.style.opacity = '1';
            }, 10);
            
            // Fade out despu√©s de 2 segundos
            setTimeout(() => {
                indicator.style.opacity = '0';
                setTimeout(() => {
                    indicator.remove();
                }, 300);
            }, 2000);
        }

        // Iniciar cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', () => {
            // PRIMERO: Cargar todos los datos guardados
            loadLibrary();
            loadIdeas();
            
            // Iniciar el reloj INMEDIATAMENTE
            updateClock();
            setInterval(updateClock, 1000);
            
            // Siempre iniciar el juego (startGame verifica si hay perfil)
            startGame();
            
            // ===== GUARDADO AUTOM√ÅTICO MEJORADO =====
            
            // Guardar antes de cerrar la pesta√±a
            window.addEventListener('beforeunload', (e) => {
                saveBeforeExit();
            });
            
            // Guardar cuando la pesta√±a pierde visibilidad (cambias de app en m√≥vil)
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    saveBeforeExit();
                }
            });
            
            // Guardar cuando la p√°gina pierde el foco
            window.addEventListener('blur', () => {
                saveBeforeExit();
            });
            
            // Guardar peri√≥dicamente cada 10 segundos (m√°s frecuente)
            setInterval(() => {
                saveBeforeExit();
                showAutoSaveIndicator();
            }, 10000);
            
            // Registrar Service Worker para funcionalidad offline
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registrado:', registration.scope);
                    })
                    .catch(error => {
                        console.log('‚ùå Error al registrar Service Worker:', error);
                    });
            }
        });
    </script>
</body>
</html>

