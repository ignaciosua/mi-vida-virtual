                                                                                                                                                            <!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Mantén tus estadísticas de vida equilibradas">
    <meta name="theme-color" content="#ff6b9d">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Mi Vida">
    <title>Mi Vida Virtual - Estadísticas</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            min-height: 100%;
            overflow-x: hidden;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffb6d9;
            display: block;
            padding: 20px 10px;
            position: relative;
        }
        
        /* Fondo para computadora */
        @media (min-width: 768px) {
            body::before {
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-image: url('fondo-kawaii.jpg');
                background-size: cover;
                background-position: center;
                background-repeat: no-repeat;
                background-attachment: fixed;
                opacity: 0.3;
                z-index: -1;
            }
        }

        /* Pantalla de inicio */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-image: url('fondo-kawaii.jpg');
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            image-rendering: auto;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.8s ease, transform 0.8s ease;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        
        /* Overlay muy sutil para móvil */
        @media (max-width: 767px) {
            .splash-screen::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.05);
                z-index: 0;
            }
            
            .splash-title,
            .play-button {
                position: relative;
                z-index: 1;
            }
        }

        .splash-screen.hide {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
        }

        .splash-title {
            font-size: 3em;
            font-weight: 700;
            text-align: center;
            margin-bottom: 40px;
            color: #ffffff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            letter-spacing: 0.05em;
            position: relative;
            z-index: 1;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.4;
            width: 100%;
            padding: 0 20px;
            max-width: 90%;
            display: none;
        }
        
        /* Mostrar título solo en computadoras */
        @media (min-width: 768px) {
            .splash-title {
                display: block;
                font-size: 7em;
                font-weight: 900;
                color: #ffffff;
                text-shadow: 
                    /* Sombras negras fuertes para contraste */
                    6px 6px 0px rgba(0, 0, 0, 0.8),
                    8px 8px 0px rgba(0, 0, 0, 0.7),
                    10px 10px 15px rgba(0, 0, 0, 0.6),
                    12px 12px 25px rgba(0, 0, 0, 0.5),
                    0 15px 40px rgba(0, 0, 0, 0.7);
                letter-spacing: 0.15em;
                font-family: 'Comic Sans MS', 'Arial Rounded MT Bold', cursive, sans-serif;
                text-transform: uppercase;
                padding: 30px 20px;
                transform: scale(1, 1.5);
                font-stretch: ultra-expanded;
                filter: drop-shadow(0 15px 30px rgba(0, 0, 0, 0.8));
            }
            
            /* Mejorar calidad de imagen en computadoras */
            .splash-screen {
                background-size: cover;
                image-rendering: -webkit-optimize-contrast;
                image-rendering: crisp-edges;
            }
        }

        .splash-subtitle {
            display: none;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-20px);
            }
        }

        .play-button {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b9d 0%, #ffa8c5 40%, #ffb6d9 60%, #c084fc 100%);
            border: 6px solid rgba(255, 255, 255, 0.9);
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3em;
            color: white;
            box-shadow: 0 4px 20px rgba(255, 107, 157, 0.4);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        
        .play-button::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.4), transparent 50%);
            border-radius: 50%;
            z-index: 0;
        }

        .play-button::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transform: rotate(45deg);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% {
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
            }
            100% {
                transform: translateX(100%) translateY(100%) rotate(45deg);
            }
        }

        .play-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(255, 107, 157, 0.6);
        }

        .play-button:active {
            transform: scale(1.05);
        }

        .play-icon {
            position: relative;
            z-index: 10;
            margin-left: 10px;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }

        /* Decoraciones kawaii */
        .splash-screen .splash-deco-1,
        .splash-screen .splash-deco-2 {
            display: none;
        }

        @keyframes twinkle {
            0%, 100% {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.2) rotate(180deg);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: translateX(-50%) scale(1);
            }
            50% {
                transform: translateX(-50%) scale(1.05);
            }
        }
        
        @keyframes bounce {
            0%, 100% {
                transform: translateX(-50%) translateY(0);
            }
            50% {
                transform: translateX(-50%) translateY(-10px);
            }
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            padding: 40px;
            width: 100%;
            max-width: 600px;
            backdrop-filter: blur(10px);
            margin: 0 auto;
        }
        
        .main-content {
            display: block;
        }
        
        /* Pantallas grandes - diseño más ancho */
        @media (min-width: 1024px) {
            .container {
                max-width: 900px;
                padding: 50px;
            }
            
            .buttons-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        h1 {
            text-align: center;
            color: #ff6b9d;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: none;
        }

        .subtitle {
            text-align: center;
            color: #a78bfa;
            font-size: 1.1em;
            margin-bottom: 30px;
            font-weight: 500;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 40px;
        }

        .stat-item {
            background: linear-gradient(135deg, #fef3ff 0%, #ffe5f3 100%);
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(255, 107, 157, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .stat-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(255, 107, 157, 0.15);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-name {
            font-size: 0.9em;
            font-weight: 600;
            color: #6b4c9a;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-icon {
            font-size: 1.15em;
            filter: drop-shadow(2px 2px 3px rgba(0, 0, 0, 0.1));
        }

        .stat-value {
            font-size: 1.05em;
            font-weight: bold;
            color: #ff6b9d;
            text-shadow: 1px 1px 2px rgba(255, 107, 157, 0.2);
        }

        .stat-bar-container {
            width: 100%;
            height: 20px;
            background: linear-gradient(135deg, #e5e5e5 0%, #f0f0f0 100%);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .stat-bar-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 1s ease-in-out, background 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.75em;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        /* Efecto de brillo animado */
        .stat-bar-fill::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { left: -100%; }
            50%, 100% { left: 100%; }
        }
        
        @keyframes loading {
            0% { width: 0%; }
            50% { width: 80%; }
            100% { width: 100%; }
        }

        /* Colores degradados para cada barra según nivel */
        .stat-bar-high {
            background: linear-gradient(135deg, #a8e063 0%, #56ab2f 100%);
        }

        .stat-bar-medium {
            background: linear-gradient(135deg, #ffd89b 0%, #f093fb 100%);
        }

        .stat-bar-low {
            background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%);
        }

        .buttons-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 30px;
        }

        .action-button {
            background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%);
            border: none;
            border-radius: 20px;
            padding: 20px;
            font-size: 1.1em;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(167, 139, 250, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .action-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .action-button:hover::before {
            width: 300px;
            height: 300px;
        }

        .action-button:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 8px 25px rgba(167, 139, 250, 0.5);
        }

        .action-button:active {
            transform: translateY(-2px) scale(1.02);
        }

        .button-icon {
            font-size: 2em;
            filter: drop-shadow(2px 2px 3px rgba(0, 0, 0, 0.2));
        }

        .button-text {
            position: relative;
            z-index: 1;
        }

        /* Colores específicos para cada botón */
        .btn-eat {
            background: linear-gradient(135deg, #fbc2eb 0%, #f093fb 100%);
        }

        .btn-drink {
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
        }

        .btn-sleep {
            background: linear-gradient(135deg, #d299c2 0%, #c084fc 100%);
        }

        .btn-exercise {
            background: linear-gradient(135deg, #fdcbf1 0%, #e6dee9 100%);
        }

        .btn-selfcare {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }

        .btn-social {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        }

        .reset-button {
            width: 100%;
            background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%);
            border: none;
            border-radius: 20px;
            padding: 15px;
            font-size: 1em;
            font-weight: 600;
            color: white;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 157, 0.3);
        }

        .reset-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 107, 157, 0.5);
        }

        .info-text {
            text-align: center;
            color: #a78bfa;
            font-size: 0.9em;
            margin-top: 20px;
            font-style: italic;
        }

        /* Animación de pulso para valores bajos */
        @keyframes pulse-warning {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .warning {
            animation: pulse-warning 2s infinite;
        }

        /* Sistema de Tabs */
        .tabs-container {
            display: flex;
            justify-content: space-around;
            gap: 8px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.5);
            padding: 10px;
            border-radius: 20px;
            flex-wrap: wrap;
        }
        
        .tab {
            flex: 1;
            min-width: 80px;
            background: linear-gradient(135deg, #e0e7ff 0%, #fef3ff 100%);
            border: none;
            border-radius: 15px;
            padding: 12px 8px;
            font-size: 0.9em;
            font-weight: 600;
            color: #6b4c9a;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(167, 139, 250, 0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .tab-icon {
            font-size: 1.5em;
        }
        
        .tab-label {
            font-size: 0.85em;
        }
        
        .tab:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(167, 139, 250, 0.4);
        }
        
        .tab.active {
            background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(167, 139, 250, 0.5);
            transform: translateY(-2px);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @media (max-width: 600px) {
            .tabs-container {
                gap: 5px;
                padding: 8px;
            }
            
            .tab {
                padding: 10px 6px;
                min-width: 70px;
            }
            
            .tab-icon {
                font-size: 1.3em;
            }
            
            .tab-label {
                font-size: 0.75em;
            }
        }

        /* Reloj en tiempo real */
        .clock-container {
            text-align: center;
            margin-bottom: 25px;
            padding: 15px;
            background: linear-gradient(135deg, #fef3ff 0%, #ffe5f3 100%);
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(255, 107, 157, 0.1);
            position: relative;
        }
        
        .life-stats-icons {
            position: absolute;
            bottom: 12px;
            left: 12px;
            display: flex;
            gap: 8px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 240, 245, 0.9) 100%);
            padding: 6px 10px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(255, 107, 157, 0.15);
            z-index: 5;
        }
        
        .life-icon {
            cursor: pointer;
            font-size: 1.2em;
            transition: transform 0.3s ease, filter 0.3s ease;
            filter: drop-shadow(1px 1px 2px rgba(0, 0, 0, 0.15));
        }
        
        .life-icon:hover {
            transform: scale(1.25);
            filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.3));
        }
        
        .life-stat-display {
            position: absolute;
            bottom: 55px;
            left: 15px;
            background: linear-gradient(135deg, #fff0f5 0%, #ffe5ec 100%);
            padding: 10px 15px;
            border-radius: 12px;
            font-size: 0.9em;
            color: #6b4c9a;
            font-weight: 600;
            box-shadow: 0 6px 15px rgba(255, 107, 157, 0.25);
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
            transform: translateY(5px);
            z-index: 15;
            border: 2px solid rgba(255, 255, 255, 0.8);
        }
        
        .life-stat-display.show {
            opacity: 1;
            transform: translateY(0);
        }

        .date-display {
            font-size: 1.2em;
            color: #6b4c9a;
            font-weight: 600;
            margin-bottom: 5px;
            position: relative;
            z-index: 1;
        }

        .time-display {
            font-size: 2em;
            color: #ff6b9d;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(255, 107, 157, 0.2);
            font-family: 'Courier New', monospace;
            position: relative;
            z-index: 1;
        }

        /* Modal para submenú */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: linear-gradient(135deg, #ffffff 0%, #fef3ff 100%);
            padding: 30px;
            border-radius: 25px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px;
            animation: slideUp 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        @media (min-width: 768px) {
            .modal-content {
                max-width: 500px;
                padding: 40px;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .modal-title {
            font-size: 1.8em;
            color: #ff6b9d;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .modal-subtitle {
            color: #a78bfa;
            font-size: 1em;
        }
        
        @media (max-width: 600px) {
            .modal-title {
                font-size: 1.5em;
            }
            
            .modal-subtitle {
                font-size: 0.9em;
            }
        }

        .modal-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .option-button {
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
            border: none;
            border-radius: 15px;
            padding: 18px 25px;
            font-size: 1.1em;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(161, 196, 253, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .option-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(161, 196, 253, 0.5);
        }

        .option-button:active {
            transform: translateY(-1px);
        }

        .option-ml {
            font-size: 1.3em;
            font-weight: bold;
        }

        .option-percentage {
            background: rgba(255, 255, 255, 0.3);
            padding: 5px 12px;
            border-radius: 10px;
            font-size: 0.95em;
        }
        
        /* Inputs responsive */
        input[type="number"],
        input[type="time"],
        select {
            font-size: 16px !important; /* Previene zoom en iOS */
            -webkit-appearance: none;
            appearance: none;
        }
        
        @media (max-width: 600px) {
            .option-button {
                padding: 15px 20px;
                font-size: 1em;
            }
            
            .option-ml {
                font-size: 1.1em;
            }
            
            .option-percentage {
                font-size: 0.85em;
                padding: 4px 10px;
            }
        }

        .modal-close {
            width: 100%;
            background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%);
            border: none;
            border-radius: 15px;
            padding: 15px;
            font-size: 1em;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 157, 0.3);
            margin-top: 20px;
        }

        .modal-close:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 107, 157, 0.5);
        }

        /* Responsive */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 20px;
                max-width: 100%;
                border-radius: 20px;
            }

            h1 {
                font-size: 1.8em;
            }

            .subtitle {
                font-size: 0.95em;
            }

            .buttons-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .stats-container {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }

            .time-display {
                font-size: 1.5em;
            }

            .date-display {
                font-size: 0.95em;
            }
            
            .splash-screen {
                background-size: cover;
                background-position: center;
                padding: 20px;
            }
            
            .splash-title {
                font-size: 2em;
                letter-spacing: 0.03em;
                margin-bottom: 30px;
                line-height: 1.3;
                max-width: 95%;
            }
            
            .play-button {
                width: 100px;
                height: 100px;
                font-size: 2.5em;
                border-width: 5px;
            }

            .stat-name {
                font-size: 1em;
            }

            .stat-value {
                font-size: 1.1em;
            }

            .action-button {
                padding: 15px;
                font-size: 1em;
            }

            .button-icon {
                font-size: 1.5em;
            }
            
            .modal-content {
                width: 95%;
                padding: 25px;
                max-height: 85vh;
                overflow-y: auto;
            }
            
            .stat-item {
                padding: 10px;
            }
            
            .stat-name {
                font-size: 0.85em;
            }
            
            .stat-value {
                font-size: 1em;
            }
            
            .stat-bar-container {
                height: 18px;
            }
            
            .clock-container {
                padding: 12px;
            }
            
            .life-stats-icons {
                bottom: 8px;
                left: 8px;
                gap: 6px;
                padding: 4px 8px;
            }
            
            .life-icon {
                font-size: 0.95em;
            }
            
            .life-stat-display {
                bottom: 45px;
                left: 10px;
                font-size: 0.8em;
                padding: 8px 12px;
            }
        }
        
        @media (max-width: 400px) {
            .life-stats-icons {
                bottom: 5px;
                left: 5px;
                gap: 4px;
                padding: 3px 6px;
            }
            
            .life-icon {
                font-size: 0.85em;
            }
            
            .life-stat-display {
                bottom: 38px;
                left: 8px;
                font-size: 0.75em;
                padding: 6px 10px;
            }
            
            .splash-title {
                font-size: 1.6em;
                margin-bottom: 25px;
            }
            
            .play-button {
                width: 90px;
                height: 90px;
                font-size: 2.2em;
                border-width: 4px;
            }

            h1 {
                font-size: 1.5em;
            }

            .container {
                padding: 15px;
            }
            
            .stats-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .stat-item {
                padding: 8px;
            }
            
            .stat-name {
                font-size: 0.8em;
            }
            
            .stat-icon {
                font-size: 1em;
            }
            
            .stat-value {
                font-size: 0.9em;
            }
            
            .stat-bar-container {
                height: 16px;
            }
            
            .stat-bar-fill {
                font-size: 0.7em;
            }
            
            .stat-header {
                font-size: 0.7em;
            }
            
            .stat-header {
                min-width: 100px;
            }
            
            .stat-name {
                font-size: 0.85em;
                gap: 6px;
            }
            
            .stat-icon {
                font-size: 1.1em;
            }
            
            .stat-value {
                font-size: 1em;
                min-width: 45px;
            }
            
            .stat-bar-container {
                height: 20px;
            }
            
            .action-button {
                padding: 12px;
                font-size: 0.95em;
            }
        }
        
        /* Tablet y pantallas medianas */
        @media (min-width: 601px) and (max-width: 1023px) {
            .container {
                max-width: 700px;
                padding: 35px;
            }
            
            .buttons-container {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .splash-screen {
                background-size: cover;
            }
        }
        
        /* Pantallas grandes - diseño expandido */
        @media (min-width: 1024px) {
            .splash-screen {
                background-size: cover;
                background-position: center;
            }
            
            .splash-title {
                font-size: 4em;
            }
            
            .play-button {
                width: 150px;
                height: 150px;
                font-size: 3.5em;
            }
            
            h1 {
                font-size: 3em;
            }
            
            .subtitle {
                font-size: 1.3em;
            }
            
            .action-button {
                flex-direction: row;
                justify-content: flex-start;
                padding: 20px 25px;
                gap: 15px;
            }
            
            .button-icon {
                font-size: 2em;
            }
            
            .button-text {
                font-size: 1.2em;
            }
            
            .stat-item {
                padding: 18px 22px;
                grid-template-columns: auto 1fr auto;
                gap: 15px;
            }
            
            .stat-header {
                min-width: 160px;
            }
            
            .stat-name {
                font-size: 1.1em;
            }
            
            .stat-value {
                font-size: 1.3em;
                min-width: 60px;
            }
            
            .stat-bar-container {
                height: 26px;
            }
            
            .time-display {
                font-size: 2.5em;
            }
            
            .date-display {
                font-size: 1.3em;
            }
        }
        
        /* Animación pulse para badge duplicada */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Pantalla de Inicio -->
    <div class="splash-screen" id="splashScreen">
        <h1 class="splash-title">✨ Mi Vida Virtual ✨</h1>
        <button class="play-button" onclick="startGame()">
            <span class="play-icon">▶</span>
        </button>
    </div>

    <div class="container" style="display: none;" id="mainContainer">
        <h1>✨ Mi Vida Virtual ✨</h1>
        <p class="subtitle">Mantén tus estadísticas equilibradas</p>

        <!-- Reloj en tiempo real -->
        <div class="clock-container">
            <div class="life-stats-icons">
                <span class="life-icon" onclick="toggleBirthday()" title="Días hasta tu cumpleaños">🎂</span>
                <span class="life-icon" onclick="toggleLifeDays()" title="Días vividos">❤️</span>
                <span class="life-icon" onclick="toggleDeathDays()" title="Días estimados restantes">💀</span>
            </div>
            <div class="life-stat-display" id="birthdayDisplay" style="bottom: 110px;"></div>
            <div class="life-stat-display" id="lifeDaysDisplay"></div>
            <div class="life-stat-display" id="deathDaysDisplay" style="bottom: 80px;"></div>
            <div class="date-display" id="dateDisplay">🗓️ Cargando fecha...</div>
            <div class="time-display" id="timeDisplay">⏰ --:--:--</div>
        </div>

        <!-- Sistema de Tabs -->
        <div class="tabs-container">
            <button class="tab active" onclick="switchTab('existir')">
                <span class="tab-icon">❤️</span>
                <span class="tab-label">Necesidades Básicas</span>
            </button>
            <button class="tab" onclick="switchTab('ejercicio')">
                <span class="tab-icon">🏃</span>
                <span class="tab-label">Ejercicio</span>
            </button>
            <button class="tab" onclick="switchTab('crecer')">
                <span class="tab-icon">🧠</span>
                <span class="tab-label">Crecer</span>
            </button>
            <button class="tab" onclick="switchTab('emocional')">
                <span class="tab-icon">🌸</span>
                <span class="tab-label">Emociones</span>
            </button>
            <button class="tab" onclick="switchTab('biblioteca')">
                <span class="tab-icon">📚</span>
                <span class="tab-label">Archivo</span>
            </button>
            <button class="tab" onclick="switchTab('ideas')">
                <span class="tab-icon">🎬</span>
                <span class="tab-label">Contenido</span>
            </button>
            <button class="tab" onclick="switchTab('calendario')">
                <span class="tab-icon">📅</span>
                <span class="tab-label">Calendario</span>
            </button>
            <button class="tab" onclick="switchTab('resumen')">
                <span class="tab-icon">📊</span>
                <span class="tab-label">Resumen</span>
            </button>
        </div>

        <!-- Tab: Existir (unificado con Cuidarme) -->
        <div class="tab-content active" id="tab-existir">
            <div class="stats-container" id="statsExistir"></div>
            <div class="buttons-container">
                <button class="action-button btn-eat" id="btnEat">
                    <span class="button-icon">🍽️</span>
                    <span class="button-text">Comer</span>
                </button>
                <button class="action-button btn-drink" id="btnDrink">
                    <span class="button-icon">💧</span>
                    <span class="button-text">Beber Agua</span>
                </button>
                <button class="action-button btn-sleep" id="btnSleep">
                    <span class="button-icon">😴</span>
                    <span class="button-text">Dormir</span>
                </button>
                <button class="action-button btn-selfcare" id="btnSelfcare">
                    <span class="button-icon">💖</span>
                    <span class="button-text">Autoestima</span>
                </button>
                <button class="action-button btn-social" id="btnSocial">
                    <span class="button-icon">💬</span>
                    <span class="button-text">Vida Social</span>
                </button>
            </div>
        </div>

        <!-- Tab: Ejercicio -->
        <div class="tab-content" id="tab-ejercicio">
            <!-- Stats y botón en proporción 1:2 HASTA ARRIBA -->
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 15px; margin-bottom: 20px;">
                <div class="stats-container" id="statsEjercicio" style="margin: 0;"></div>
                <button class="action-button btn-exercise" id="btnExercise" style="height: 100%; margin: 0;">
                    <span class="button-icon">🏃</span>
                    <span class="button-text">Ejercicio</span>
                </button>
            </div>
            
            <!-- Ejercicio del día -->
            <div id="todayExercise" style="background: linear-gradient(135deg, #ff6b9d 0%, #ffa8c5 100%); padding: 20px; border-radius: 20px; margin-bottom: 20px; text-align: center; color: white; box-shadow: 0 8px 20px rgba(255, 107, 157, 0.3);">
                <div style="font-size: 2.5em; margin-bottom: 10px;">💪</div>
                <h2 style="margin-bottom: 10px; font-size: 1.5em;">Hoy te toca:</h2>
                <div id="todayMuscle" style="font-size: 2em; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">Glúteo 🍑</div>
            </div>
            
            <!-- Calendario semanal de ejercicio -->
            <div id="exerciseCalendar" style="background: white; border-radius: 20px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
        </div>

        <!-- Tab: Crecer -->
        <div class="tab-content" id="tab-crecer">
            <div class="stats-container" id="statsCrecer"></div>
            <div class="buttons-container">
                <button class="action-button" id="btnIdiomas" style="background: linear-gradient(135deg, #ffd89b 0%, #f093fb 100%);">
                    <span class="button-icon">🌍</span>
                    <span class="button-text">Idiomas</span>
                </button>
                <button class="action-button" id="btnAprendizaje" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                    <span class="button-icon">📚</span>
                    <span class="button-text">Aprendizaje</span>
                </button>
                <button class="action-button" id="btnProfesion" style="background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);">
                    <span class="button-icon">👩‍⚕️</span>
                    <span class="button-text">Profesión</span>
                </button>
            </div>
        </div>

        <!-- Tab: Estilo Emocional (NUEVO) -->
        <div class="tab-content" id="tab-emocional">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 style="color: #ff6b9d; margin-bottom: 10px;">🌸 Mi Estado Emocional 2026</h2>
                <p style="color: #a78bfa; font-size: 0.95em;">Registra cómo te sientes cada día</p>
            </div>
            
            <!-- Selector de emoción actual -->
            <div style="background: linear-gradient(135deg, #fef3ff 0%, #ffe5f3 100%); padding: 20px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(255, 107, 157, 0.1);">
                <h3 style="color: #6b4c9a; margin-bottom: 15px; text-align: center;">✨ ¿Cómo te sientes hoy?</h3>
                <div id="emotionSelector" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 15px;">
                    <button onclick="selectEmotion('feliz')" style="padding: 15px 10px; background: linear-gradient(135deg, #ffeb99 0%, #fffacd 100%); border: 3px solid #ffd700; border-radius: 15px; font-size: 0.95em; font-weight: 600; color: #6b4c9a; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);">
                        😊 Feliz
                    </button>
                    <button onclick="selectEmotion('motivada')" style="padding: 15px 10px; background: linear-gradient(135deg, #c8e6c9 0%, #e8f5e9 100%); border: 3px solid #81c784; border-radius: 15px; font-size: 0.95em; font-weight: 600; color: #6b4c9a; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(129, 199, 132, 0.3);">
                        💪 Motivada
                    </button>
                    <button onclick="selectEmotion('triste')" style="padding: 15px 10px; background: linear-gradient(135deg, #b3d9ff 0%, #e6f2ff 100%); border: 3px solid #64b5f6; border-radius: 15px; font-size: 0.95em; font-weight: 600; color: #6b4c9a; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(100, 181, 246, 0.3);">
                        😢 Triste
                    </button>
                    <button onclick="selectEmotion('cansada')" style="padding: 15px 10px; background: linear-gradient(135deg, #d1c4e9 0%, #ede7f6 100%); border: 3px solid #9575cd; border-radius: 15px; font-size: 0.95em; font-weight: 600; color: #6b4c9a; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(149, 117, 205, 0.3);">
                        😴 Cansada
                    </button>
                    <button onclick="selectEmotion('enojada')" style="padding: 15px 10px; background: linear-gradient(135deg, #ffccbc 0%, #ffe0d1 100%); border: 3px solid #ff8a65; border-radius: 15px; font-size: 0.95em; font-weight: 600; color: #6b4c9a; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(255, 138, 101, 0.3);">
                        😠 Enojada
                    </button>
                    <button onclick="selectEmotion('estresada')" style="padding: 15px 10px; background: linear-gradient(135deg, #f8bbd0 0%, #fce4ec 100%); border: 3px solid #f48fb1; border-radius: 15px; font-size: 0.95em; font-weight: 600; color: #6b4c9a; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(244, 143, 177, 0.3);">
                        😰 Estresada
                    </button>
                    <button onclick="selectEmotion('enferma')" style="padding: 15px 10px; background: linear-gradient(135deg, #ffcccc 0%, #ffe6e6 100%); border: 3px solid #ef9a9a; border-radius: 15px; font-size: 0.95em; font-weight: 600; color: #6b4c9a; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(239, 154, 154, 0.3);">
                        🤒 Enferma
                    </button>
                    <button onclick="selectEmotion('normal')" style="padding: 15px 10px; background: linear-gradient(135deg, #e0e0e0 0%, #f5f5f5 100%); border: 3px solid #bdbdbd; border-radius: 15px; font-size: 0.95em; font-weight: 600; color: #6b4c9a; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(189, 189, 189, 0.3);">
                        😐 Normal
                    </button>
                </div>
                <p id="selectedEmotionText" style="text-align: center; color: #ff6b9d; font-weight: 600; min-height: 24px;">Selecciona una emoción para marcar días</p>
            </div>
            
            <!-- Calendario emocional 2026 -->
            <div style="background: white; padding: 15px; border-radius: 20px; box-shadow: 0 4px 15px rgba(255, 107, 157, 0.1); overflow-x: auto; margin-bottom: 20px;">
                <h3 style="color: #6b4c9a; margin-bottom: 15px; text-align: center;">📅 Calendario Emocional 2026</h3>
                <p style="text-align: center; color: #a78bfa; font-size: 0.85em; margin-bottom: 15px;">Haz clic en los días para marcar tus emociones. Puedes añadir varias por día.</p>
                <div id="emotionalCalendar2026" style="overflow-x: auto;"></div>
            </div>
            
            <!-- Resumen mensual de emociones -->
            <div id="monthlyEmotionSummary" style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(255, 152, 0, 0.1); border: 2px solid #ffb74d;">
                <h3 style="color: #e65100; margin-bottom: 15px; text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span style="font-size: 1.5em;">📊</span>
                    <span>Resumen del Mes</span>
                </h3>
                <div id="emotionStatsContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;"></div>
            </div>
        </div>

        <!-- Tab: Biblioteca -->
        <div class="tab-content" id="tab-biblioteca">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 style="color: #6b4c9a; margin-bottom: 15px;">📚 Mi Biblioteca</h2>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button onclick="openLibraryCategory('libros')" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 15px; font-size: 1em; cursor: pointer;">📖 Libros</button>
                    <button onclick="openLibraryCategory('peliculas')" style="padding: 10px 20px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 15px; font-size: 1em; cursor: pointer;">🎬 Películas</button>
                    <button onclick="openLibraryCategory('series')" style="padding: 10px 20px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; border-radius: 15px; font-size: 1em; cursor: pointer;">📺 Series</button>
                    <button onclick="openLibraryCategory('flashcards')" style="padding: 10px 20px; background: linear-gradient(135deg, #ff6b9d 0%, #ffa8c5 100%); color: white; border: none; border-radius: 15px; font-size: 1em; cursor: pointer; font-weight: 600;">🧠 Flashcards</button>
                    <button onclick="openLibraryCategory('apuntes')" style="padding: 10px 20px; background: linear-gradient(135deg, #ffa751 0%, #ffe259 100%); color: white; border: none; border-radius: 15px; font-size: 1em; cursor: pointer; font-weight: 600;">📝 Apuntes</button>
                </div>
            </div>
            <div id="libraryContent" style="padding: 15px;"></div>
        </div>

        <!-- Tab: Ideas/Contenido -->
        <div class="tab-content" id="tab-ideas">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 style="color: #ff6b9d; margin-bottom: 10px;">💡 Mis Ideas de Contenido</h2>
                <p style="color: #a78bfa; font-size: 0.95em;">Cada etapa te acerca más a tu meta</p>
            </div>
            
            <!-- Barra de progreso de Contenido -->
            <div style="background: linear-gradient(135deg, #fef3ff 0%, #ffe5f3 100%); padding: 20px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(255, 107, 157, 0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 1.5em;">🎬</span>
                        <span style="font-weight: 600; color: #6b4c9a; font-size: 1.1em;">Contenido</span>
                    </div>
                    <span id="contenidoValue" style="font-size: 1.2em; font-weight: bold; color: #ff6b9d;">100%</span>
                </div>
                <div class="stat-bar-container">
                    <div id="contenidoBar" class="stat-bar-fill stat-bar-high" style="width: 100%;"></div>
                </div>
                <p style="text-align: center; color: #a78bfa; font-size: 0.85em; margin-top: 10px;">✨ Cada idea y transición suma al progreso</p>
            </div>
            
            <!-- Agregar nueva idea -->
            <div style="background: linear-gradient(135deg, #fef3ff 0%, #ffe5f3 100%); padding: 20px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(255, 107, 157, 0.1);">
                <h3 style="color: #6b4c9a; margin-bottom: 15px;">✨ Nueva Idea</h3>
                <input type="text" id="newIdeaInput" placeholder="Escribe tu idea aquí..." style="width: 100%; padding: 12px; border: 2px solid #e0e7ff; border-radius: 12px; font-size: 1em; margin-bottom: 10px;">
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                    <select id="ideaPercentage" style="padding: 12px; border: 2px solid #e0e7ff; border-radius: 12px; font-size: 1em;">
                        <option value="2">Idea básica (+2%)</option>
                        <option value="3">Idea desarrollada (+3%)</option>
                        <option value="5">Idea completa (+5%)</option>
                    </select>
                    <button onclick="addNewIdea()" style="flex: 1; background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%); border: none; border-radius: 12px; padding: 12px 20px; font-size: 1em; font-weight: 600; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(167, 139, 250, 0.3);">➕ Agregar Idea</button>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="openGenerateIdeasModal()" style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 12px; padding: 12px 20px; font-size: 0.95em; font-weight: 600; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">🤖 Generar Ideas (IA)</button>
                    <button onclick="openExportMenu()" style="flex: 1; background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%); border: none; border-radius: 12px; padding: 12px 20px; font-size: 0.95em; font-weight: 600; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(255, 107, 157, 0.3);">📊 Exportar</button>
                </div>
            </div>
            
            <!-- Pestañas de estados de ideas -->
            <div style="display: flex; gap: 8px; margin-bottom: 20px; background: rgba(255, 255, 255, 0.5); padding: 10px; border-radius: 20px; flex-wrap: wrap;">
                <button class="idea-state-tab active" onclick="switchIdeaState('pendientes')" style="flex: 1; min-width: 100px; background: linear-gradient(135deg, #ffd89b 0%, #f093fb 100%); border: none; border-radius: 15px; padding: 12px; font-size: 0.85em; font-weight: 600; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(255, 107, 157, 0.2); transition: all 0.3s ease;">
                    💭 Pendientes
                </button>
                <button class="idea-state-tab" onclick="switchIdeaState('guionada')" style="flex: 1; min-width: 100px; background: linear-gradient(135deg, #e0e7ff 0%, #fef3ff 100%); border: none; border-radius: 15px; padding: 12px; font-size: 0.85em; font-weight: 600; color: #6b4c9a; cursor: pointer; box-shadow: 0 2px 8px rgba(167, 139, 250, 0.2); transition: all 0.3s ease;">
                    📝 Guion
                </button>
                <button class="idea-state-tab" onclick="switchIdeaState('grabadas')" style="flex: 1; min-width: 100px; background: linear-gradient(135deg, #e0e7ff 0%, #fef3ff 100%); border: none; border-radius: 15px; padding: 12px; font-size: 0.85em; font-weight: 600; color: #6b4c9a; cursor: pointer; box-shadow: 0 2px 8px rgba(167, 139, 250, 0.2); transition: all 0.3s ease;">
                    🎥 Grabadas
                </button>
                <button class="idea-state-tab" onclick="switchIdeaState('editadas')" style="flex: 1; min-width: 100px; background: linear-gradient(135deg, #e0e7ff 0%, #fef3ff 100%); border: none; border-radius: 15px; padding: 12px; font-size: 0.85em; font-weight: 600; color: #6b4c9a; cursor: pointer; box-shadow: 0 2px 8px rgba(167, 139, 250, 0.2); transition: all 0.3s ease;">
                    ✂️ Editadas
                </button>
                <button class="idea-state-tab" onclick="switchIdeaState('publicadas')" style="flex: 1; min-width: 100px; background: linear-gradient(135deg, #e0e7ff 0%, #fef3ff 100%); border: none; border-radius: 15px; padding: 12px; font-size: 0.85em; font-weight: 600; color: #6b4c9a; cursor: pointer; box-shadow: 0 2px 8px rgba(167, 139, 250, 0.2); transition: all 0.3s ease;">
                    📤 Publicadas
                </button>
            </div>
            
            <!-- Menú de ordenamiento -->
            <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center; background: linear-gradient(135deg, #e0e7ff 0%, #fef3ff 100%); padding: 12px; border-radius: 15px;">
                <span style="font-weight: 600; color: #6b4c9a; font-size: 0.9em;">🔄 Ordenar:</span>
                <select id="ideaSortOrder" onchange="renderIdeas()" style="flex: 1; padding: 8px 12px; border: 2px solid #a78bfa; border-radius: 10px; font-size: 0.9em; cursor: pointer; background: white; color: #6b4c9a; font-weight: 500;">
                    <option value="newest">Más recientes primero</option>
                    <option value="oldest">Más antiguas primero</option>
                </select>
            </div>
            
            <!-- Contenedor de ideas (cambia según la pestaña seleccionada) -->
            <div id="ideasContainer" style="display: flex; flex-direction: column; gap: 10px; min-height: 200px;"></div>
            
            <!-- Calendario de Videos Programados -->
            <div style="margin-top: 30px; background: linear-gradient(135deg, #fef3ff 0%, #ffe5f3 100%); padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(255, 107, 157, 0.1);">
                <h3 style="color: #ff6b9d; margin-bottom: 15px; text-align: center;">🎬 Calendario de Videos</h3>
                <p style="text-align: center; color: #a78bfa; font-size: 0.9em; margin-bottom: 15px;">Videos programados para publicar</p>
                <div id="scheduledVideos" style="display: flex; flex-direction: column; gap: 10px;"></div>
            </div>
        </div>

        <!-- Tab: Calendario -->
        <div class="tab-content" id="tab-calendario">
            
            <!-- Vista de Actividades -->
            <div id="calendar-actividades" class="calendar-view" style="display: block;">
                <!-- Lista de actividades pendientes (Arriba) -->
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h3 id="activitiesTitle" style="color: #ff6b9d; margin: 0;">📅 Actividades de Hoy</h3>
                        <select id="activitiesSortOrder" onchange="changeActivitiesSortOrder()" style="padding: 8px 12px; border: 2px solid #ffc4e1; border-radius: 10px; font-size: 0.85em; background: white; color: #ff6b9d; font-weight: 600; cursor: pointer;">
                            <option value="time">⏰ Por horario</option>
                            <option value="importance">⭐ Por importancia</option>
                        </select>
                    </div>
                    <div id="activitiesPending" style="display: flex; flex-direction: column; gap: 10px;"></div>
                </div>
                
                <!-- Agregar nueva actividad -->
                <div style="background: linear-gradient(135deg, #f0f4ff 0%, #e8f3ff 100%); padding: 20px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 6px 20px rgba(124, 58, 237, 0.12); border: 2px solid #ddd6fe;">
                    <h3 style="color: #7c3aed; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">✨ Nueva Actividad</h3>
                    <input type="text" id="newActivityInput" placeholder="📝 ¿Qué vas a hacer?" style="width: 100%; padding: 14px; border: 2px solid #c7d2fe; border-radius: 15px; font-size: 1em; margin-bottom: 12px; background: white;">
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                        <div>
                            <label style="font-size: 0.75em; color: #7c3aed; font-weight: 600; margin-bottom: 3px; display: block;">📅 Desde</label>
                            <input type="date" id="activityDateFrom" style="width: 100%; padding: 8px; border: 2px solid #c7d2fe; border-radius: 10px; font-size: 0.85em; background: white;">
                        </div>
                        <div>
                            <label style="font-size: 0.75em; color: #7c3aed; font-weight: 600; margin-bottom: 3px; display: block;">📅 Hasta</label>
                            <input type="date" id="activityDateTo" style="width: 100%; padding: 8px; border: 2px solid #c7d2fe; border-radius: 10px; font-size: 0.85em; background: white;">
                        </div>
                    </div>
                    <p style="font-size: 0.7em; color: #7c3aed; margin: -8px 0 12px 0; opacity: 0.8;">💡 Dejar "Hasta" vacío = se repite siempre</p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                        <div>
                            <label style="font-size: 0.85em; color: #7c3aed; font-weight: 600; margin-bottom: 5px; display: block;">⏰ Hora (HH:MM)</label>
                            <div style="display: flex; gap: 5px; align-items: center;">
                                <select id="activityHours" style="flex: 1; padding: 12px; border: 2px solid #c7d2fe; border-radius: 12px; font-size: 0.95em; background: white;">
                                    <option value="">HH</option>
                                    <option value="00">00</option>
                                    <option value="01">01</option>
                                    <option value="02">02</option>
                                    <option value="03">03</option>
                                    <option value="04">04</option>
                                    <option value="05">05</option>
                                    <option value="06">06</option>
                                    <option value="07">07</option>
                                    <option value="08">08</option>
                                    <option value="09">09</option>
                                    <option value="10">10</option>
                                    <option value="11">11</option>
                                    <option value="12">12</option>
                                    <option value="13">13</option>
                                    <option value="14">14</option>
                                    <option value="15">15</option>
                                    <option value="16">16</option>
                                    <option value="17">17</option>
                                    <option value="18">18</option>
                                    <option value="19">19</option>
                                    <option value="20">20</option>
                                    <option value="21">21</option>
                                    <option value="22">22</option>
                                    <option value="23">23</option>
                                </select>
                                <span style="color: #7c3aed; font-weight: bold; font-size: 1.2em;">:</span>
                                <select id="activityMinutes" style="flex: 1; padding: 12px; border: 2px solid #c7d2fe; border-radius: 12px; font-size: 0.95em; background: white;">
                                    <option value="">MM</option>
                                    <option value="00">00</option>
                                    <option value="05">05</option>
                                    <option value="10">10</option>
                                    <option value="15">15</option>
                                    <option value="20">20</option>
                                    <option value="25">25</option>
                                    <option value="30">30</option>
                                    <option value="35">35</option>
                                    <option value="40">40</option>
                                    <option value="45">45</option>
                                    <option value="50">50</option>
                                    <option value="55">55</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label style="font-size: 0.85em; color: #7c3aed; font-weight: 600; margin-bottom: 5px; display: block;">🎯 Categoría</label>
                            <select id="activityCategory" style="width: 100%; padding: 12px; border: 2px solid #c7d2fe; border-radius: 12px; font-size: 0.95em; background: white;">
                                <option value="personal">🌸 Personal</option>
                                <option value="escuela">📚 Escuela</option>
                                <option value="trabajo">💼 Trabajo</option>
                                <option value="ejercicio">💪 Ejercicio</option>
                                <option value="salud">❤️ Salud</option>
                                <option value="social">👥 Social</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Nivel de importancia -->
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; color: #6b4c9a; font-weight: 600;">⭐ Nivel de importancia:</label>
                        <select id="activityImportance" style="width: 100%; padding: 12px; border: 2px solid #e0e7ff; border-radius: 12px; font-size: 1em;">
                            <option value="3">⭐⭐⭐ Importante</option>
                            <option value="2" selected>⭐⭐ Normal</option>
                            <option value="1">⭐ Opcional</option>
                        </select>
                    </div>
                    
                    <!-- Impacto en estadísticas -->
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; color: #6b4c9a; font-weight: 600;">📊 Afecta a:</label>
                        <select id="activityStatEffect" onchange="toggleStatPercentage(this.value)" style="width: 100%; padding: 12px; border: 2px solid #e0e7ff; border-radius: 12px; font-size: 1em; margin-bottom: 8px;">
                            <option value="none">Ninguna estadística</option>
                            <option value="ejercicio">🏋️ Salud Física</option>
                            <option value="autoestima">💖 Autoestima</option>
                            <option value="vidaSocial">💬 Vida Social</option>
                            <option value="idiomas">🌍 Idiomas</option>
                            <option value="aprendizaje">📚 Aprendizaje</option>
                            <option value="contenido">🎬 Contenido</option>
                        </select>
                        <div id="statPercentageContainer" style="display: none;">
                            <label style="display: block; margin-bottom: 5px; color: #667eea; font-weight: 600; font-size: 0.9em;">Porcentaje de aumento:</label>
                            <input type="number" id="activityStatPercentage" value="15" min="1" max="100" style="width: 100%; padding: 10px; border: 2px solid #e0e7ff; border-radius: 10px; font-size: 0.95em; text-align: center;">
                        </div>
                    </div>
                    
                    <!-- Recurrencia (Opcional) -->
                    <div style="margin-bottom: 10px; padding: 12px; background: linear-gradient(135deg, #fef3ff 0%, #ffe5f3 100%); border-radius: 12px; border: 2px dashed #ffa8c5;">
                        <label style="display: block; margin-bottom: 8px; color: #ff6b9d; font-weight: 600; display: flex; align-items: center; gap: 5px;">🔄 Repetir actividad (opcional)</label>
                        <select id="activityRecurrence" onchange="toggleRecurrenceOptions(this.value)" style="width: 100%; padding: 12px; border: 2px solid #ffc4e1; border-radius: 12px; font-size: 1em; background: white; color: #6b4c9a; font-weight: 500;">
                            <option value="none">⭕ No repetir</option>
                            <option value="weekly">📅 Cada semana (mismo día)</option>
                            <option value="biweekly">🗓️ Cada 2 semanas (quincenal)</option>
                            <option value="monthly">📆 Cada mes (mismo día)</option>
                        </select>
                        <div id="recurrenceInfo" style="display: none; margin-top: 8px; padding: 10px; background: rgba(255, 255, 255, 0.8); border-radius: 8px; font-size: 0.85em; color: #6b4c9a;">
                            <p style="margin: 0;">✨ <strong>Ejemplo:</strong> Si la programas para un domingo, se creará automáticamente para todos los siguientes según la frecuencia elegida.</p>
                        </div>
                    </div>
                    
                    <button onclick="addActivity()" style="width: 100%; background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%); border: none; border-radius: 12px; padding: 12px 20px; font-size: 1em; font-weight: 600; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(167, 139, 250, 0.3);">➕ Agregar Actividad</button>
                </div>
                
                <!-- Navegador de mes -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #ff6b9d 0%, #ffa8c5 100%); border-radius: 15px; box-shadow: 0 4px 15px rgba(255, 107, 157, 0.3);">
                    <button onclick="changeMonth(-1)" style="background: rgba(255,255,255,0.3); border: none; border-radius: 50%; width: 40px; height: 40px; color: white; font-size: 1.2em; cursor: pointer; font-weight: bold;">‹</button>
                    <h3 id="currentMonthLabel" style="color: white; margin: 0; font-size: 1.2em;"></h3>
                    <button onclick="changeMonth(1)" style="background: rgba(255,255,255,0.3); border: none; border-radius: 50%; width: 40px; height: 40px; color: white; font-size: 1.2em; cursor: pointer; font-weight: bold;">›</button>
                </div>
                
                <!-- Vista de calendario mensual -->
                <div id="monthlyCalendar" style="background: white; padding: 10px; border-radius: 15px; box-shadow: 0 4px 15px rgba(255, 107, 157, 0.1); overflow-x: auto;"></div>
                
            </div>
        </div>

        <!-- Tab: Resumen -->
        <div class="tab-content" id="tab-resumen">
            <!-- Sincronización con Supabase -->
            <div style="background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%); padding: 15px; border-radius: 20px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(150, 230, 161, 0.3);">
                <div style="display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 10px;">
                    <div style="flex: 1; text-align: left;">
                        <h4 style="color: #2d5016; margin-bottom: 5px; display: flex; align-items: center; gap: 8px;">
                            <span id="syncIcon">🔄</span> Sincronización
                        </h4>
                        <p id="syncStatus" style="color: #4a7c59; font-size: 0.85em; margin: 0;">localStorage activo</p>
                        <p id="syncInfo" style="color: #6b8e23; font-size: 0.75em; margin: 5px 0 0 0; display: none;">Sincronizando cada 5 segundos</p>
                    </div>
                    <button onclick="toggleSupabaseSync()" style="background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%); border: none; border-radius: 12px; padding: 10px 20px; color: white; font-size: 0.9em; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(76, 175, 80, 0.4);">⚙️ Configurar</button>
                </div>
                <div id="syncButtons" style="display: none; gap: 8px;">
                    <button onclick="elegirDatos()" style="flex: 1; padding: 8px 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 0.85em; font-weight: 600; cursor: pointer;">🔄 Elegir Datos</button>
                    <button onclick="forzarSubida()" style="flex: 1; padding: 8px 15px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 10px; font-size: 0.85em; font-weight: 600; cursor: pointer;">☁️ Subir Todo</button>
                    <button onclick="forzarDescarga()" style="flex: 1; padding: 8px 15px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; border-radius: 10px; font-size: 0.85em; font-weight: 600; cursor: pointer;">📥 Descargar Todo</button>
                </div>
            </div>
            
            <!-- Bloque 1: Rutina sugerida -->
            <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 18px; border-radius: 20px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(66, 165, 245, 0.2);">
                <h4 style="color: #1976d2; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;"><span>🧭</span> Rutina sugerida (Hoy)</h4>
                <div id="suggestedRoutineContainer" style="display: flex; flex-direction: column; gap: 8px;"></div>
            </div>
            
            <!-- Bloque 3: Prioridades personalizadas -->
            <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 18px; border-radius: 20px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(255, 152, 0, 0.2);">
                <h4 style="color: #f57c00; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between;">
                    <span style="display: flex; align-items: center; gap: 8px;"><span>✨</span> Hoy quiero priorizar</span>
                    <button onclick="openFavoritesSelector()" style="background: linear-gradient(135deg, #ff9800 0%, #fb8c00 100%); border: none; border-radius: 12px; padding: 8px 15px; color: white; font-size: 0.85em; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3);">+ Elegir</button>
                </h4>
                <div id="favoritesContainer" style="display: flex; flex-direction: column; gap: 8px;"></div>
            </div>
            
            <!-- Estadísticas resumidas -->
            <div style="background: linear-gradient(135deg, #fef3ff 0%, #ffe5f3 100%); padding: 20px; border-radius: 20px; margin-bottom: 20px;">
                <h3 style="color: #ff6b9d; margin-bottom: 15px; text-align: center;">📊 Todas las Estadísticas</h3>
            </div>
            <div class="stats-container" id="statsResumen"></div>
        </div>

        <p class="info-text">💡 Las estadísticas disminuyen 4.2% por hora y se guardan automáticamente</p>
        
        <!-- Modal para editar actividad -->
        <div id="editActivityModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
            <div style="background: white; padding: 25px; border-radius: 20px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                <h3 style="color: #7c3aed; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">✏️ Editar Actividad</h3>
                
                <label style="font-size: 0.9em; color: #7c3aed; font-weight: 600; margin-bottom: 5px; display: block;">📝 Nombre</label>
                <input type="text" id="editActivityText" style="width: 100%; padding: 12px; border: 2px solid #c7d2fe; border-radius: 12px; font-size: 1em; margin-bottom: 12px;">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                    <div>
                        <label style="font-size: 0.85em; color: #7c3aed; font-weight: 600; margin-bottom: 5px; display: block;">📅 Desde</label>
                        <input type="date" id="editActivityDateFrom" style="width: 100%; padding: 10px; border: 2px solid #c7d2fe; border-radius: 10px; font-size: 0.9em;">
                    </div>
                    <div>
                        <label style="font-size: 0.85em; color: #7c3aed; font-weight: 600; margin-bottom: 5px; display: block;">📅 Hasta</label>
                        <input type="date" id="editActivityDateTo" style="width: 100%; padding: 10px; border: 2px solid #c7d2fe; border-radius: 10px; font-size: 0.9em;">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                    <div>
                        <label style="font-size: 0.85em; color: #7c3aed; font-weight: 600; margin-bottom: 5px; display: block;">⏰ Hora</label>
                        <input type="time" id="editActivityTime" style="width: 100%; padding: 10px; border: 2px solid #c7d2fe; border-radius: 10px; font-size: 0.9em;">
                    </div>
                    <div>
                        <label style="font-size: 0.85em; color: #7c3aed; font-weight: 600; margin-bottom: 5px; display: block;">🎯 Categoría</label>
                        <select id="editActivityCategory" style="width: 100%; padding: 10px; border: 2px solid #c7d2fe; border-radius: 10px; font-size: 0.9em;">
                            <option value="personal">🌸 Personal</option>
                            <option value="escuela">📚 Escuela</option>
                            <option value="trabajo">💼 Trabajo</option>
                            <option value="ejercicio">💪 Ejercicio</option>
                            <option value="salud">❤️ Salud</option>
                            <option value="social">👥 Social</option>
                        </select>
                    </div>
                </div>
                
                <div style="margin-bottom: 12px;">
                    <label style="font-size: 0.85em; color: #7c3aed; font-weight: 600; margin-bottom: 5px; display: block;">⭐ Importancia</label>
                    <select id="editActivityImportance" style="width: 100%; padding: 10px; border: 2px solid #c7d2fe; border-radius: 10px; font-size: 0.9em;">
                        <option value="3">⭐⭐⭐ Importante</option>
                        <option value="2">⭐⭐ Normal</option>
                        <option value="1">⭐ Opcional</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveActivityEdit()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;">✅ Guardar</button>
                    <button onclick="closeEditModal()" style="flex: 1; padding: 12px; background: #9ca3af; color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;">❌ Cancelar</button>
                </div>
            </div>
        </div>
        
        <!-- Botón de backup accesible -->
        <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
            <button onclick="exportBackup()" style="flex: 1; min-width: 140px; background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%); border: none; border-radius: 15px; padding: 12px; font-size: 0.9em; font-weight: 600; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(66, 165, 245, 0.3);">
                📥 Descargar Backup
            </button>
            <button onclick="importBackup()" style="flex: 1; min-width: 140px; background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%); border: none; border-radius: 15px; padding: 12px; font-size: 0.9em; font-weight: 600; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);">
                📤 Restaurar Backup
            </button>
            <button onclick="recoverFromAutoBackup()" style="flex: 1; min-width: 140px; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); border: none; border-radius: 15px; padding: 12px; font-size: 0.9em; font-weight: 600; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);">
                🔄 Recuperar Últimos Datos
            </button>
            <button onclick="resetStats()" style="flex: 1; min-width: 140px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border: none; border-radius: 15px; padding: 12px; font-size: 0.9em; font-weight: 600; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);">
                🔄 Reiniciar Stats a 0
            </button>
        </div>
        
        <!-- Herramienta de diagnóstico -->
        <div style="margin-top: 15px;">
            <button onclick="showDiagnostics()" style="width: 100%; background: linear-gradient(135deg, #9c27b0 0%, #673ab7 100%); border: none; border-radius: 15px; padding: 12px; font-size: 0.9em; font-weight: 600; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(156, 39, 176, 0.3);">
                🔍 Ver Todos Mis Datos Guardados
            </button>
        </div>
    </div>

    <!-- Modal para beber agua -->
    <div id="waterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">💧 Registrar Bebida</div>
                <div class="modal-subtitle">Ingresa cantidad y tipo</div>
            </div>
            
            <!-- Input manual de ml -->
            <div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #e0e7ff 0%, #fef3ff 100%); border-radius: 15px;">
                <label style="display: block; font-weight: 600; color: #6b4c9a; margin-bottom: 10px; font-size: 1.05em;">📏 Cantidad en ml:</label>
                <input type="number" id="drinkAmount" placeholder="Ej: 250" min="1" max="2000" style="width: 100%; padding: 12px; border: 2px solid #c084fc; border-radius: 10px; font-size: 1.1em; text-align: center;">
            </div>
            
            <!-- Selector de tipo de bebida -->
            <div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #e0e7ff 0%, #fef3ff 100%); border-radius: 15px;">
                <label style="display: block; font-weight: 600; color: #6b4c9a; margin-bottom: 10px; font-size: 1.05em;">🥤 Tipo de bebida:</label>
                <select id="drinkType" style="width: 100%; padding: 12px; border: 2px solid #c084fc; border-radius: 10px; font-size: 1.05em; background: white;">
                    <option value="agua">💧 Agua natural</option>
                    <option value="azucarada">🧃 Bebida azucarada</option>
                    <option value="refresco">🥤 Refresco</option>
                    <option value="cafe">☕ Café / té con leche</option>
                </select>
            </div>
            
            <button onclick="registerDrink()" style="width: 100%; background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%); border: none; border-radius: 15px; padding: 18px; font-size: 1.1em; font-weight: 600; color: white; cursor: pointer; margin-bottom: 10px; box-shadow: 0 4px 15px rgba(167, 139, 250, 0.3);" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
                ✓ Registrar
            </button>
            
            <button class="modal-close" onclick="closeWaterModal()">✕ Cerrar</button>
        </div>
    </div>

    <!-- Modal para comer -->
    <div id="eatModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">🍽️ Comer</div>
                <div class="modal-subtitle">Ingresa las calorías consumidas</div>
            </div>
            
            <div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #e0e7ff 0%, #fef3ff 100%); border-radius: 15px;">
                <div style="text-align: center; color: #6b4c9a; font-weight: 600; margin-bottom: 15px; font-size: 1.1em;">🍴 Calorías Consumidas</div>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <label style="color: #6b4c9a; font-weight: 600; font-size: 0.95em;">Calorías (kcal):</label>
                    <input type="number" id="caloriesInput" placeholder="Ej: 500" min="1" max="5000" style="padding: 12px; border: 2px solid #e0e7ff; border-radius: 10px; font-size: 1.1em; text-align: center; font-weight: 600; color: #6b4c9a; outline: none; transition: all 0.3s ease;" onfocus="this.style.borderColor='#a78bfa'" onblur="this.style.borderColor='#e0e7ff'">
                </div>
                <div id="caloriesInfo" style="margin-top: 15px; padding: 12px; background: linear-gradient(135deg, #e0f7fa 0%, #e1f5fe 100%); border-radius: 10px; text-align: center; display: none;">
                    <div style="color: #6b4c9a; font-size: 0.9em; margin-bottom: 5px;">📊 Tu metabolismo basal: <strong id="bmrDisplay">0</strong> kcal/día</div>
                    <div style="color: #ff6b9d; font-weight: bold; font-size: 1.1em;">Hambre +<span id="hungerIncrease">0</span>%</div>
                </div>
                <button onclick="calculateEatEffects()" style="width: 100%; margin-top: 12px; background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%); border: none; border-radius: 10px; padding: 12px; color: white; font-weight: 600; cursor: pointer; font-size: 1em; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    🍽️ Calcular y Comer
                </button>
            </div>
            
            <button class="modal-close" onclick="closeEatModal()">✕ Cerrar</button>
        </div>
    </div>

    <!-- Modal para dormir -->
    <div id="sleepModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">😴 Dormir</div>
                <div class="modal-subtitle">Calcula tus horas de sueño</div>
            </div>
            
            <!-- Calculadora de horas -->
            <div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #e0e7ff 0%, #fef3ff 100%); border-radius: 15px;">
                <div style="text-align: center; color: #6b4c9a; font-weight: 600; margin-bottom: 15px; font-size: 1.1em;">⏰ Calculadora de Sueño</div>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div>
                        <label style="color: #6b4c9a; font-weight: 500; display: block; margin-bottom: 5px;">🌙 Hora de dormir:</label>
                        <input type="time" id="sleepTime" style="width: 100%; padding: 10px; border-radius: 10px; border: 2px solid #a78bfa; font-size: 1em;">
                    </div>
                    <div>
                        <label style="color: #6b4c9a; font-weight: 500; display: block; margin-bottom: 5px;">☀️ Hora de despertar:</label>
                        <input type="time" id="wakeTime" style="width: 100%; padding: 10px; border-radius: 10px; border: 2px solid #a78bfa; font-size: 1em;">
                    </div>
                    <button onclick="calculateSleep()" style="background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%); border: none; border-radius: 10px; padding: 12px; color: white; font-weight: 600; cursor: pointer; font-size: 1em; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        ✨ Calcular y Aplicar
                    </button>
                </div>
            </div>
            
            <button class="modal-close" onclick="closeSleepModal()">✕ Cerrar</button>
        </div>
    </div>

    <!-- Modal para seleccionar actividad de ejercicio -->
    <div id="exerciseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">🏃 Ejercicio</div>
                <div class="modal-subtitle">Selecciona la actividad</div>
            </div>
            <div class="modal-options">
                <button class="option-button" onclick="selectActivity('🥋 Taekwondo')">
                    <span class="option-ml">🥋 Taekwondo</span>
                </button>
                <button class="option-button" onclick="selectActivity('🚶 Caminar')">
                    <span class="option-ml">🚶 Caminar</span>
                </button>
                <button class="option-button" onclick="selectActivity('🏃 Correr')">
                    <span class="option-ml">🏃 Correr</span>
                </button>
                <button class="option-button" onclick="selectActivity('⛸️ Patinar')">
                    <span class="option-ml">⛸️ Patinar</span>
                </button>
                <button class="option-button" onclick="selectActivity('🏋️ Pesas')">
                    <span class="option-ml">🏋️ Pesas</span>
                </button>
            </div>
            <button class="modal-close" onclick="closeExerciseModal()">✕ Cerrar</button>
        </div>
    </div>

    <!-- Modal para seleccionar intensidad de ejercicio -->
    <div id="intensityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="intensityTitle">🏃 Ejercicio</div>
                <div class="modal-subtitle">Ingresa la duración y selecciona la intensidad</div>
            </div>
            
            <!-- Input de duración -->
            <div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #e0e7ff 0%, #fef3ff 100%); border-radius: 15px;">
                <div style="text-align: center; color: #6b4c9a; font-weight: 600; margin-bottom: 15px; font-size: 1.1em;">⏱️ Duración del Entrenamiento</div>
                <div>
                    <label style="color: #6b4c9a; font-weight: 500; display: block; margin-bottom: 5px;">Minutos:</label>
                    <input type="number" id="taekwondoDuration" min="1" max="300" placeholder="Ej: 60" style="width: 100%; padding: 10px; border-radius: 10px; border: 2px solid #a78bfa; font-size: 1em;">
                </div>
                <button onclick="calculateIntensityEffects()" style="width: 100%; margin-top: 12px; background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%); border: none; border-radius: 10px; padding: 12px; color: white; font-weight: 600; cursor: pointer; font-size: 1em; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    ✨ Calcular Efectos
                </button>
            </div>

            <div id="intensityOptions" style="display: none;">
                <div class="modal-options">
                    <!-- Los botones se generan dinámicamente -->
                </div>
                <div style="margin: 15px 0; padding: 15px; background: linear-gradient(135deg, #e0f7fa 0%, #e1f5fe 100%); border-radius: 15px; text-align: center;">
                    <div style="color: #00796b; font-weight: 600; margin-bottom: 5px;">✨ Beneficios</div>
                    <div style="color: #00897b; font-size: 0.95em;">Salud Física +50% | Autoestima +25%</div>
                </div>
            </div>
            
            <button class="modal-close" onclick="closeIntensityModal()">✕ Cerrar</button>
        </div>
    </div>

    <!-- Modal para caminar -->
    <div id="walkModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">🚶 Caminar</div>
                <div class="modal-subtitle">Ingresa tu actividad</div>
            </div>
            
            <!-- Input de duración -->
            <div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #e0e7ff 0%, #fef3ff 100%); border-radius: 15px;">
                <div style="text-align: center; color: #6b4c9a; font-weight: 600; margin-bottom: 15px; font-size: 1.1em;">⏱️ Tu Caminata</div>
                
                <!-- Selector de unidad -->
                <div style="margin-bottom: 15px;">
                    <label style="color: #6b4c9a; font-weight: 500; display: block; margin-bottom: 5px;">Medido en:</label>
                    <select id="walkUnit" onchange="updateWalkInputLabel()" style="width: 100%; padding: 10px; border-radius: 10px; border: 2px solid #a78bfa; font-size: 1em; background: white; cursor: pointer;">
                        <option value="minutos">⏱️ Minutos</option>
                        <option value="pasos">👣 Pasos</option>
                    </select>
                </div>
                
                <div>
                    <label id="walkInputLabel" style="color: #6b4c9a; font-weight: 500; display: block; margin-bottom: 5px;">Minutos caminados:</label>
                    <input type="number" id="walkDuration" min="1" placeholder="Ej: 30" style="width: 100%; padding: 10px; border-radius: 10px; border: 2px solid #a78bfa; font-size: 1em;">
                </div>
                <button onclick="calculateWalkEffects()" style="width: 100%; margin-top: 12px; background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%); border: none; border-radius: 10px; padding: 12px; color: white; font-weight: 600; cursor: pointer; font-size: 1em; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    ✨ Calcular Efectos
                </button>
            </div>

            <div id="walkOptions" style="display: none;">
                <div class="modal-options">
                    <!-- Los botones se generan dinámicamente -->
                </div>
                <div style="margin: 15px 0; padding: 15px; background: linear-gradient(135deg, #e0f7fa 0%, #e1f5fe 100%); border-radius: 15px; text-align: center;">
                    <div style="color: #00796b; font-weight: 600; margin-bottom: 5px;">✨ Beneficios</div>
                    <div style="color: #00897b; font-size: 0.95em;">Salud Física +10% | Autoestima +5%</div>
                </div>
            </div>
            
            <button class="modal-close" onclick="closeWalkModal()">✕ Cerrar</button>
        </div>
    </div>

    <!-- Modal para correr -->
    <div id="runModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">🏃 Correr</div>
                <div class="modal-subtitle">Ingresa los detalles de tu carrera</div>
            </div>
            
            <div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #e0e7ff 0%, #fef3ff 100%); border-radius: 15px;">
                <div style="text-align: center; color: #6b4c9a; font-weight: 600; margin-bottom: 15px; font-size: 1.1em;">⏱️ Tu Carrera</div>
                
                <!-- Selector de unidad -->
                <div style="margin-bottom: 15px;">
                    <label style="color: #6b4c9a; font-weight: 500; display: block; margin-bottom: 5px;">Medido en:</label>
                    <select id="runUnit" onchange="updateRunInputLabel()" style="width: 100%; padding: 10px; border-radius: 10px; border: 2px solid #a78bfa; font-size: 1em; background: white; cursor: pointer;">
                        <option value="minutos">⏱️ Minutos</option>
                        <option value="kilometros">📏 Kilómetros</option>
                    </select>
                </div>
                
                <div>
                    <label id="runInputLabel" style="color: #6b4c9a; font-weight: 500; display: block; margin-bottom: 5px;">Minutos:</label>
                    <input type="number" id="runDuration" min="1" step="0.1" placeholder="Ej: 20" style="width: 100%; padding: 10px; border-radius: 10px; border: 2px solid #a78bfa; font-size: 1em;">
                </div>
                <button onclick="calculateRunEffects()" style="width: 100%; margin-top: 12px; background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%); border: none; border-radius: 10px; padding: 12px; color: white; font-weight: 600; cursor: pointer; font-size: 1em; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    ✨ Calcular Efectos
                </button>
            </div>

            <div id="runOptions" style="display: none;">
                <div class="modal-options">
                    <!-- Los botones se generan dinámicamente -->
                </div>
                <div style="margin: 15px 0; padding: 15px; background: linear-gradient(135deg, #e0f7fa 0%, #e1f5fe 100%); border-radius: 15px; text-align: center;">
                    <div style="color: #00796b; font-weight: 600; margin-bottom: 5px;">✨ Beneficios</div>
                    <div style="color: #00897b; font-size: 0.95em;">Salud Física +40% | Autoestima +20%</div>
                </div>
            </div>
            
            <button class="modal-close" onclick="closeRunModal()">✕ Cerrar</button>
        </div>
    </div>

    <!-- Modal para patinar -->
    <div id="skateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">⛸️ Patinar</div>
                <div class="modal-subtitle">Ingresa la duración y nivel</div>
            </div>
            
            <div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #e0e7ff 0%, #fef3ff 100%); border-radius: 15px;">
                <div style="text-align: center; color: #6b4c9a; font-weight: 600; margin-bottom: 15px; font-size: 1.1em;">⏱️ Sesión de Patinaje</div>
                <div>
                    <label style="color: #6b4c9a; font-weight: 500; display: block; margin-bottom: 5px;">Minutos:</label>
                    <input type="number" id="skateDuration" min="1" max="300" placeholder="Ej: 45" style="width: 100%; padding: 10px; border-radius: 10px; border: 2px solid #a78bfa; font-size: 1em;">
                </div>
                <button onclick="calculateSkateEffects()" style="width: 100%; margin-top: 12px; background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%); border: none; border-radius: 10px; padding: 12px; color: white; font-weight: 600; cursor: pointer; font-size: 1em; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    ✨ Calcular Efectos
                </button>
            </div>

            <div id="skateOptions" style="display: none;">
                <div class="modal-options">
                    <!-- Los botones se generan dinámicamente -->
                </div>
                <div style="margin: 15px 0; padding: 15px; background: linear-gradient(135deg, #e0f7fa 0%, #e1f5fe 100%); border-radius: 15px; text-align: center;">
                    <div style="color: #00796b; font-weight: 600; margin-bottom: 5px;">✨ Beneficios</div>
                    <div style="color: #00897b; font-size: 0.95em;">Salud Física +35% | Autoestima +15%</div>
                </div>
            </div>
            
            <button class="modal-close" onclick="closeSkateModal()">✕ Cerrar</button>
        </div>
    </div>

    <!-- Modal para pesas -->
    <div id="weightsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">🏋️ Pesas</div>
                <div class="modal-subtitle">Ingresa duración y grupo muscular</div>
            </div>
            
            <div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #e0e7ff 0%, #fef3ff 100%); border-radius: 15px;">
                <div style="text-align: center; color: #6b4c9a; font-weight: 600; margin-bottom: 15px; font-size: 1.1em;">⏱️ Entrenamiento de Fuerza</div>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div>
                        <label style="color: #6b4c9a; font-weight: 500; display: block; margin-bottom: 5px;">Minutos:</label>
                        <input type="number" id="weightsDuration" min="1" max="300" placeholder="Ej: 60" style="width: 100%; padding: 10px; border-radius: 10px; border: 2px solid #a78bfa; font-size: 1em;">
                    </div>
                    <div>
                        <label style="color: #6b4c9a; font-weight: 500; display: block; margin-bottom: 5px;">Grupo muscular principal:</label>
                        <select id="muscleGroup" style="width: 100%; padding: 10px; border-radius: 10px; border: 2px solid #a78bfa; font-size: 1em;">
                            <option value="piernas">Piernas/Glúteos (mayor gasto)</option>
                            <option value="espalda">Espalda/Pecho (gasto moderado)</option>
                            <option value="brazos">Brazos/Hombros (menor gasto)</option>
                        </select>
                    </div>
                </div>
                <button onclick="calculateWeightsEffects()" style="width: 100%; margin-top: 12px; background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%); border: none; border-radius: 10px; padding: 12px; color: white; font-weight: 600; cursor: pointer; font-size: 1em; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    ✨ Aplicar
                </button>
            </div>
            
            <button class="modal-close" onclick="closeWeightsModal()">✕ Cerrar</button>
        </div>
    </div>

    <!-- Modal de Perfil de Usuario -->
    <div id="profileModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <div class="modal-title">👤 Tu Perfil Personal</div>
                <div class="modal-subtitle">Personaliza tu experiencia</div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px;">
                <div>
                    <label style="color: #6b4c9a; font-weight: 600; display: block; margin-bottom: 8px;">🎂 Fecha de Nacimiento</label>
                    <input type="date" id="userBirthdate" max="" style="width: 100%; padding: 6px 8px; border-radius: 10px; border: 2px solid #a78bfa; font-size: 0.85em; font-family: inherit; color: #6b4c9a; background: white; box-sizing: border-box; line-height: 1.1;">
                    <div id="ageDisplay" style="margin-top: 6px; color: #ff6b9d; font-weight: 600; font-size: 0.85em; text-align: center; min-height: 18px;"></div>
                </div>
                <div>
                    <label style="color: #6b4c9a; font-weight: 600; display: block; margin-bottom: 8px;">⚧️ Género</label>
                    <select id="userGender" style="width: 100%; padding: 10px 12px; border-radius: 10px; border: 2px solid #a78bfa; font-size: 0.95em; font-family: inherit; color: #6b4c9a; background: white;">
                        <option value="femenino">Femenino</option>
                        <option value="masculino">Masculino</option>
                        <option value="otro">Otro</option>
                    </select>
                </div>
                <div>
                    <label style="color: #6b4c9a; font-weight: 600; display: block; margin-bottom: 8px;">📏 Altura (cm)</label>
                    <input type="number" id="userHeight" min="100" max="200" placeholder="Ej: 160" style="width: 100%; padding: 10px 12px; border-radius: 10px; border: 2px solid #a78bfa; font-size: 0.95em; font-family: inherit; color: #6b4c9a;">
                </div>
                <div>
                    <label style="color: #6b4c9a; font-weight: 600; display: block; margin-bottom: 8px;">⚖️ Peso (kg)</label>
                    <input type="number" id="userWeight" min="30" max="180" step="0.1" placeholder="Ej: 56" style="width: 100%; padding: 10px 12px; border-radius: 10px; border: 2px solid #a78bfa; font-size: 0.95em; font-family: inherit; color: #6b4c9a;">
                </div>
            </div>
            <button onclick="saveProfile()" style="width: 100%; background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%); border: none; border-radius: 15px; padding: 18px; font-size: 1.1em; font-weight: 600; color: white; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(167, 139, 250, 0.3);" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
                ✨ Comenzar Mi Jornada
            </button>
        </div>
    </div>

    <!-- Modal de Autoestima -->
    <div id="selfcareModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <div class="modal-title">💖 Autoestima & Bienestar</div>
                <div class="modal-subtitle">Elige una categoría</div>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <button onclick="openSelfcareCategory('microcuidados')" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%); border: none; border-radius: 12px; font-size: 1.05em; font-weight: 600; color: #6b4c9a; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(253, 203, 110, 0.3);">
                    ✨ Microcuidados
                </button>
                <button onclick="openSelfcareCategory('regulacion')" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%); border: none; border-radius: 12px; font-size: 1.05em; font-weight: 600; color: white; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(108, 92, 231, 0.3);">
                    🧘‍♀️ Regulación Emocional
                </button>
                <button onclick="openSelfcareCategory('impacto')" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%); border: none; border-radius: 12px; font-size: 1.05em; font-weight: 600; color: white; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(255, 107, 157, 0.3);">
                    💪 Acciones de Impacto Fuerte
                </button>
            </div>
            
            <button class="modal-close" onclick="closeSelfcareModal()">✕ Cerrar</button>
        </div>
    </div>

    <!-- Modal de Microcuidados -->
    <div id="microcuidadosModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <div class="modal-title">✨ Microcuidados</div>
                <div class="modal-subtitle">Pequeñas acciones, gran impacto</div>
            </div>
            <div id="microcuidadosOptions" style="display: flex; flex-direction: column; gap: 10px; max-height: 60vh; overflow-y: auto; padding-right: 5px;">
                <!-- Se generan dinámicamente -->
            </div>
            <button class="modal-close" onclick="closeMicrocuidadosModal()">← Volver</button>
        </div>
    </div>

    <!-- Modal de Regulación Emocional -->
    <div id="regulacionModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <div class="modal-title">🧘‍♀️ Regulación Emocional</div>
                <div class="modal-subtitle">Conecta con tus emociones</div>
            </div>
            <div id="regulacionOptions" style="display: flex; flex-direction: column; gap: 10px; max-height: 60vh; overflow-y: auto; padding-right: 5px;">
                <!-- Se generan dinámicamente -->
            </div>
            <button class="modal-close" onclick="closeRegulacionModal()">← Volver</button>
        </div>
    </div>

    <!-- Modal de Acciones de Impacto -->
    <div id="impactoModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <div class="modal-title">💪 Acciones de Impacto Fuerte</div>
                <div class="modal-subtitle">Grandes decisiones para tu bienestar</div>
            </div>
            <div id="impactoOptions" style="display: flex; flex-direction: column; gap: 10px; max-height: 60vh; overflow-y: auto; padding-right: 5px;">
                <!-- Se generan dinámicamente -->
            </div>
            <button class="modal-close" onclick="closeImpactoModal()">← Volver</button>
        </div>
    </div>

    <!-- Modal de Vida Social -->
    <div id="socialModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <div class="modal-title">👥 Vida Social</div>
                <div class="modal-subtitle">Elige una categoría</div>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <button onclick="openSocialCategory('familia')" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%); border: none; border-radius: 12px; font-size: 1.05em; font-weight: 600; color: #6b4c9a; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(253, 203, 110, 0.3);">
                    👨‍👩‍👧‍👦 Familia
                </button>
                <button onclick="openSocialCategory('vinculos')" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%); border: none; border-radius: 12px; font-size: 1.05em; font-weight: 600; color: white; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(108, 92, 231, 0.3);">
                    💞 Vínculos Seguros
                </button>
                <button onclick="openSocialCategory('facil')" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #55efc4 0%, #00b894 100%); border: none; border-radius: 12px; font-size: 1.05em; font-weight: 600; color: white; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0, 184, 148, 0.3);">
                    😊 Social Fácil
                </button>
            </div>
            
            <button class="modal-close" onclick="closeSocialModal()">✕ Cerrar</button>
        </div>
    </div>

    <!-- Modal de Familia -->
    <div id="familiaModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <div class="modal-title">👨‍👩‍👧‍👦 Familia</div>
                <div class="modal-subtitle">Tiempo de calidad con tu familia</div>
            </div>
            <div id="familiaOptions" style="display: flex; flex-direction: column; gap: 10px; max-height: 60vh; overflow-y: auto; padding-right: 5px;">
                <!-- Se generan dinámicamente -->
            </div>
            <button class="modal-close" onclick="closeFamiliaModal()">← Volver</button>
        </div>
    </div>

    <!-- Modal de Vínculos Seguros -->
    <div id="vinculosModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <div class="modal-title">💞 Vínculos Seguros</div>
                <div class="modal-subtitle">Conexiones profundas</div>
            </div>
            <div id="vinculosOptions" style="display: flex; flex-direction: column; gap: 10px; max-height: 60vh; overflow-y: auto; padding-right: 5px;">
                <!-- Se generan dinámicamente -->
            </div>
            <button class="modal-close" onclick="closeVinculosModal()">← Volver</button>
        </div>
    </div>

    <!-- Modal de Social Fácil -->
    <div id="facilModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <div class="modal-title">😊 Social Fácil</div>
                <div class="modal-subtitle">Interacciones cotidianas</div>
            </div>
            <div id="facilOptions" style="display: flex; flex-direction: column; gap: 10px; max-height: 60vh; overflow-y: auto; padding-right: 5px;">
                <!-- Se generan dinámicamente -->
            </div>
            <button class="modal-close" onclick="closeFacilModal()">← Volver</button>
        </div>
    </div>

    <!-- Modales de Crecimiento -->
    <!-- Modal de Idiomas -->
    <div id="idiomasModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <div class="modal-title">🌍 Idiomas</div>
                <div class="modal-subtitle">Practica y mejora tus habilidades</div>
            </div>
            <div id="idiomasOptions" style="display: flex; flex-direction: column; gap: 10px; max-height: 60vh; overflow-y: auto; padding-right: 5px;">
                <!-- Se generan dinámicamente -->
            </div>
            <button class="modal-close" onclick="closeIdiomasModal()">✕ Cerrar</button>
        </div>
    </div>

    <!-- Modal de Aprendizaje -->
    <div id="aprendizajeModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <div class="modal-title">📚 Aprendizaje</div>
                <div class="modal-subtitle">Expande tu conocimiento</div>
            </div>
            <div id="aprendizajeOptions" style="display: flex; flex-direction: column; gap: 10px; max-height: 60vh; overflow-y: auto; padding-right: 5px;">
                <!-- Se generan dinámicamente -->
            </div>
            <button class="modal-close" onclick="closeAprendizajeModal()">✕ Cerrar</button>
        </div>
    </div>

    <!-- Modal de Profesión -->
    <div id="profesionModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <div class="modal-title">👩‍⚕️ Profesión</div>
                <div class="modal-subtitle">Elige tu área de estudio</div>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <button onclick="openProfesionCategory('enfermeria')" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); border: none; border-radius: 12px; font-size: 1.05em; font-weight: 600; color: #6b4c9a; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(168, 237, 234, 0.3);">
                    💉 Enfermería
                </button>
                <button onclick="openProfesionCategory('farmacologia')" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%); border: none; border-radius: 12px; font-size: 1.05em; font-weight: 600; color: #6b4c9a; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(253, 203, 110, 0.3);">
                    💊 Farmacología
                </button>
            </div>
            
            <button class="modal-close" onclick="closeProfesionModal()">✕ Cerrar</button>
        </div>
    </div>

    <!-- Modal de Enfermería -->
    <div id="enfermeriaModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <div class="modal-title">💉 Enfermería</div>
                <div class="modal-subtitle">Estudia y refuerza conceptos</div>
            </div>
            <div id="enfermeriaOptions" style="display: flex; flex-direction: column; gap: 10px; max-height: 60vh; overflow-y: auto; padding-right: 5px;">
                <!-- Se generan dinámicamente -->
            </div>
            <button class="modal-close" onclick="closeEnfermeriaModal()">← Volver</button>
        </div>
    </div>

    <!-- Modal de Farmacología -->
    <div id="farmacologiaModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <div class="modal-title">💊 Farmacología</div>
                <div class="modal-subtitle">Domina los fármacos</div>
            </div>
            <div id="farmacologiaOptions" style="display: flex; flex-direction: column; gap: 10px; max-height: 60vh; overflow-y: auto; padding-right: 5px;">
                <!-- Se generan dinámicamente -->
            </div>
            <button class="modal-close" onclick="closeFarmacologiaModal()">← Volver</button>
        </div>
    </div>

    <script>
        // Verificar si localStorage está disponible (detectar modo privado Safari)
        function checkLocalStorageAvailable() {
            try {
                const test = '__storage_test__';
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                return true;
            } catch (e) {
                console.warn('⚠️ localStorage no disponible - posible modo privado');
                // Mostrar advertencia al usuario
                const warning = document.createElement('div');
                warning.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; background: #ff6b9d; color: white; padding: 12px; text-align: center; z-index: 99999; font-size: 0.9em; font-weight: 600;';
                warning.innerHTML = '⚠️ IMPORTANTE: Activa "Permitir cookies" en Safari para que se guarden tus datos';
                document.body.prepend(warning);
                return false;
            }
        }
        
        // Función para iniciar el juego desde la pantalla de inicio
        function startGame() {
            console.log('🎮 Iniciando juego...');
            
            // Verificar localStorage primero
            checkLocalStorageAvailable();
            
            // Verificar si ya existe perfil guardado
            const savedProfile = localStorage.getItem('userProfile');
            const splash = document.getElementById('splashScreen');
            const mainContainer = document.getElementById('mainContainer');
            
            console.log('👤 Perfil guardado:', savedProfile ? 'Sí' : 'No');
            
            if (savedProfile) {
                // Si hay perfil, saltar directamente sin animaciones
                splash.style.display = 'none';
                mainContainer.style.display = 'block';
                console.log('📦 Contenedor principal mostrado');
                init();
            } else {
                // Si no hay perfil, mostrar animación y modal
                splash.classList.add('hide');
                
                setTimeout(() => {
                    splash.style.display = 'none';
                    mainContainer.style.display = 'block';
                    document.getElementById('profileModal').classList.add('show');
                    console.log('📝 Modal de perfil mostrado');
                    
                    // Iniciar el reloj aunque no haya perfil
                    updateClock();
                    setInterval(updateClock, 1000);
                }, 800);
            }
        }

        // Perfil del usuario
        let userProfile = {
            birthdate: null, // Fecha de nacimiento
            age: null, // Se calcula automáticamente
            gender: null,
            height: null, // cm
            weight: null, // kg
            bmr: 0, // Tasa Metabólica Basal
            dailyWater: 0, // ml diarios necesarios
            dailyCalories: 0
        };
        
        // Acciones de autocuidado y su cooldown
        const SELFCARE_ACTIONS = {
            microcuidados: [
                { id: 'cabello', name: 'Arreglarse el cabello', emoji: '💇‍♀️', boost: 5, cooldown: 'daily' },
                { id: 'skincare', name: 'Skin care', emoji: '🧴', boost: 5, cooldown: 'daily' },
                { id: 'dientes', name: 'Cepillarse los dientes', emoji: '🪥', boost: 5, cooldown: 'none' },
                { id: 'crema', name: 'Crema en todo el cuerpo', emoji: '🧴', boost: 15, cooldown: 'daily' },
                { id: 'foto', name: 'Tomarse una foto', emoji: '📸', boost: 15, cooldown: 'none' },
                { id: 'limpiar', name: 'Limpiar el espacio', emoji: '🧹', boost: 15, cooldown: 'none' },
                { id: 'cejas', name: 'Depilarse las cejas', emoji: '✨', boost: 10, cooldown: 'weekly' },
                { id: 'depilar', name: 'Depilarse el cuerpo', emoji: '✨', boost: 15, cooldown: 'weekly' },
                { id: 'limpieza', name: 'Limpieza profunda del cuarto', emoji: '🧽', boost: 20, cooldown: 'weekly' }
            ],
            regulacion: [
                { id: 'emociones', name: 'Escribir las emociones', emoji: '📝', boost: 10, cooldown: 'none' },
                { id: 'duele', name: 'Escribir lo que te duele', emoji: '💔', boost: 10, cooldown: 'none' },
                { id: 'agradecer', name: 'Escribir lo que agradeces', emoji: '🙏', boost: 10, cooldown: 'none' },
                { id: 'bonito', name: 'Decirte algo bonito', emoji: '💝', boost: 10, cooldown: 'none' },
                { id: 'respirar', name: 'Respirar profundo 6 veces', emoji: '🌬️', boost: 2, cooldown: 'none' }
            ],
            impacto: [
                { id: 'decision', name: 'Mantener tu decisión firme', emoji: '💎', boost: 10, cooldown: 'none' },
                { id: 'opinion', name: 'Defender tu opinión', emoji: '🗣️', boost: 10, cooldown: 'none' },
                { id: 'gusto', name: 'Hacer algo solo porque te gusta', emoji: '🎨', boost: 10, cooldown: 'none' },
                { id: 'sol', name: 'Tomar el sol 10 min (10am)', emoji: '☀️', boost: 10, cooldown: 'daily' },
                { id: 'ejercicio_auto', name: 'Hacer ejercicio', emoji: '💪', boost: 25, cooldown: 'daily' }
            ]
        };
        
        // Estado de cooldowns
        let selfcareCooldowns = {
            daily: {},
            weekly: {},
            lastReset: { daily: Date.now(), weekly: Date.now() }
        };
        
        // Acciones sociales
        const SOCIAL_ACTIONS = {
            familia: [
                { id: 'comer-familia', name: 'Comer con tu familia', emoji: '🍽️', boost: 10, cooldown: 'daily' },
                { id: 'platicar-sin-celular', name: 'Platicar sin celular', emoji: '💬', boost: 12, cooldown: 'daily' },
                { id: 'ayudar-casa', name: 'Ayudar en algo en casa', emoji: '🏠', boost: 15, cooldown: 'daily' },
                { id: 'reir-familia', name: 'Reír con ellos', emoji: '😂', boost: 12, cooldown: 'none' },
                { id: 'pelicula-juntos', name: 'Ver una película juntos', emoji: '🎬', boost: 20, cooldown: 'weekly' },
                { id: 'llamar-familiar', name: 'Llamar a un familiar', emoji: '📞', boost: 8, cooldown: 'none' },
                { id: 'abrazar', name: 'Abrazar', emoji: '🤗', boost: 5, cooldown: 'none' },
                { id: 'beso-buenas-noches', name: 'Beso de buenas noches', emoji: '😘', boost: 5, cooldown: 'daily' }
            ],
            vinculos: [
                { id: 'platica-honesta', name: 'Plática honesta', emoji: '💭', boost: 10, cooldown: 'none' },
                { id: 'reir-amigo', name: 'Reírte', emoji: '😄', boost: 8, cooldown: 'none' },
                { id: 'tema-dificil', name: 'Platica de un tema difícil', emoji: '🗣️', boost: 50, cooldown: 'weekly' }
            ],
            facil: [
                { id: 'mensaje-casual', name: 'Mensaje casual', emoji: '💬', boost: 3, cooldown: 'none' },
                { id: 'conversacion-breve', name: 'Conversación breve', emoji: '👋', boost: 5, cooldown: 'none' },
                { id: 'saludar', name: 'Saludar', emoji: '😊', boost: 2, cooldown: 'none' }
            ]
        };
        
        // Acciones de crecimiento
        const GROWTH_ACTIONS = {
            aprendizaje: [
                { id: 'leer-libros', name: 'Leer libros', emoji: '📖', boost: 2, cooldown: 'none' },
                { id: 'videos-educativos', name: 'Ver videos educativos', emoji: '🎥', boost: 1, cooldown: 'none' },
                { id: 'investigar', name: 'Investigar temas', emoji: '🔍', boost: 3, cooldown: 'none' },
                { id: 'apuntes', name: 'Tomar apuntes', emoji: '📝', boost: 4, cooldown: 'none' },
                { id: 'aprender-nuevo', name: 'Aprender algo nuevo', emoji: '✨', boost: 4, cooldown: 'none' }
            ],
            enfermeria: [
                { id: 'repasar-temas', name: 'Repasar temas', emoji: '📖', boost: 2, cooldown: 'none' },
                { id: 'revisar-apuntes', name: 'Revisar apuntes', emoji: '📝', boost: 2, cooldown: 'none' },
                { id: 'casos-clinicos', name: 'Pensar casos clínicos', emoji: '🧠', boost: 2, cooldown: 'none' },
                { id: 'ordenar-material', name: 'Ordenar material', emoji: '📄', boost: 1, cooldown: 'none' },
                { id: 'investigar-dudas', name: 'Investigar dudas', emoji: '🔍', boost: 2, cooldown: 'none' }
            ],
            farmacologia: [
                { id: 'repasar-farmacos', name: 'Repasar fármacos', emoji: '💊', boost: 3, cooldown: 'none' },
                { id: 'estudiar-farmacos', name: 'Estudiar fármacos', emoji: '📊', boost: 5, cooldown: 'none' },
                { id: 'ver-explicacion', name: 'Ver explicación sencilla', emoji: '🎥', boost: 2, cooldown: 'none' },
                { id: 'apuntes-farma', name: 'Apuntes', emoji: '🧠', boost: 3, cooldown: 'none' }
            ],
            idiomas: [
                { id: 'leer-ingles', name: 'Leer en inglés', emoji: '📖', boost: 2, cooldown: 'none' },
                { id: 'escuchar-audio', name: 'Escuchar audio', emoji: '🎧', boost: 2, cooldown: 'none' },
                { id: 'practicar-palabras', name: 'Practicar palabras', emoji: '🗣️', boost: 2, cooldown: 'none' },
                { id: 'escribir-frases', name: 'Escribir frases', emoji: '📝', boost: 3, cooldown: 'none' },
                { id: 'ver-series', name: 'Ver series', emoji: '🎥', boost: 3, cooldown: 'none' },
                { id: 'app-idiomas', name: 'Usar app de idiomas (10 min)', emoji: '📱', boost: 2, cooldown: 'none' }
            ]
        };

        // Configuración de estadísticas
        const STATS_CONFIG = {
            hambre: {
                name: 'Hambre',
                icon: '🍽️',
                decayRate: 4.2, // % por hora
                value: 200,
                maxDaily: 0 // Se calculará con BMR
            },
            sueño: {
                name: 'Sueño',
                icon: '😴',
                decayRate: 4.2,
                value: 200,
                maxDaily: 8 // 8 horas recomendadas
            },
            hidratacion: {
                name: 'Hidratación',
                icon: '💧',
                decayRate: 4.2,
                value: 200,
                maxDaily: 0 // Se calculará con peso
            },
            ejercicio: {
                name: 'Salud Física',
                icon: '🏃',
                decayRate: 4.2,
                value: 200,
                maxDaily: 200
            },
            autoestima: {
                name: 'Autoestima',
                icon: '💖',
                decayRate: 4.2,
                value: 200,
                maxDaily: 200
            },
            vidaSocial: {
                name: 'Vida Social',
                icon: '💬',
                decayRate: 4.2,
                value: 200,
                maxDaily: 200
            },
            idiomas: {
                name: 'Idiomas',
                icon: '🌍',
                decayRate: 0, // No decae
                value: 0,
                maxDaily: 200
            },
            aprendizaje: {
                name: 'Aprendizaje',
                icon: '📚',
                decayRate: 0, // No decae
                value: 0,
                maxDaily: 200
            },
            contenido: {
                name: 'Contenido',
                icon: '🎬',
                decayRate: 0, // No decae
                value: 0,
                maxDaily: 200
            },
            profesion: {
                name: 'Profesión',
                icon: '👩‍⚕️',
                decayRate: 0, // No decae
                value: 0,
                maxDaily: 200
            }
        };

        // MET (Metabolic Equivalent of Task) para cada actividad
        const MET_VALUES = {
            taekwondo: { leve: 6.0, moderado: 8.0, intenso: 10.0 },
            caminar: { lento: 3.0, moderado: 3.5, rapido: 4.5 },
            correr: { leve: 6.5, moderado: 9.0, intenso: 12.5 },
            patinar: { recreativo: 6.0, moderado: 7.0, intenso: 9.0 },
            pesas: { brazos: 5.0, espalda: 6.0, piernas: 7.0 }
        };

        // Calcular TMB (Tasa Metabólica Basal) - Fórmula Mifflin-St Jeor
        function calculateBMR() {
            const { age, gender, height, weight } = userProfile;
            
            if (!age || !height || !weight) return 0;
            
            // BMR = (10 × peso en kg) + (6.25 × altura en cm) - (5 × edad en años) + s
            // s = +5 para hombres, -161 para mujeres
            const s = gender === 'masculino' ? 5 : (gender === 'femenino' ? -161 : -78);
            const bmr = (10 * weight) + (6.25 * height) - (5 * age) + s;
            
            return Math.round(bmr);
        }

        // Calcular hidratación diaria necesaria
        function calculateDailyWater() {
            // 30-35 ml por kg de peso corporal
            return Math.round(userProfile.weight * 32.5);
        }

        // Calcular calorías quemadas por actividad
        function calculateCaloriesBurned(met, durationMinutes) {
            // Calorías = MET × peso (kg) × duración (horas)
            const hours = durationMinutes / 60;
            return Math.round(met * userProfile.weight * hours);
        }

        // Convertir calorías a porcentaje de hambre
        function caloriesToHungerPercent(calories) {
            // Porcentaje basado en BMR
            return (calories / userProfile.bmr) * 100;
        }

        // Convertir ml a porcentaje de hidratación
        function mlToHydrationPercent(ml) {
            return (ml / userProfile.dailyWater) * 100;
        }

        // Guardar perfil y calcular valores
        function saveProfile() {
            const birthdate = document.getElementById('userBirthdate').value;
            userProfile.gender = document.getElementById('userGender').value;
            userProfile.height = parseInt(document.getElementById('userHeight').value);
            userProfile.weight = parseFloat(document.getElementById('userWeight').value);
            
            if (!birthdate || !userProfile.height || !userProfile.weight) {
                alert('⚠️ Por favor completa todos los campos');
                return;
            }
            
            // Guardar fecha de nacimiento y calcular edad
            userProfile.birthdate = birthdate;
            userProfile.age = calculateAge(birthdate);
            
            // Validar límites
            if (userProfile.age < 10) {
                alert('⚠️ Debes tener al menos 10 años para usar la app');
                return;
            }
            if (userProfile.age > 120) {
                alert('⚠️ Verifica tu fecha de nacimiento');
                return;
            }
            if (userProfile.height > 200) {
                alert('⚠️ La altura máxima es 200 cm (2 metros)');
                return;
            }
            if (userProfile.weight > 180) {
                alert('⚠️ El peso máximo es 180 kg');
                return;
            }
            
            // Calcular valores personalizados
            userProfile.bmr = calculateBMR();
            userProfile.dailyWater = calculateDailyWater();
            userProfile.dailyCalories = Math.round(userProfile.bmr * 1.2); // Factor de actividad ligera
            
            STATS_CONFIG.hambre.maxDaily = userProfile.bmr;
            STATS_CONFIG.hidratacion.maxDaily = userProfile.dailyWater;
            
            // Guardar perfil
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            
            // Cerrar modal
            document.getElementById('profileModal').classList.remove('show');
            
            // Mostrar el contenedor principal si estaba oculto
            document.getElementById('mainContainer').style.display = 'block';
            
            // Inicializar juego
            init();
            
            console.log('📊 Perfil guardado:', userProfile);
            console.log(`TMB: ${userProfile.bmr} kcal/día | Agua: ${userProfile.dailyWater}ml/día`);
        }
        
        // Calcular edad desde fecha de nacimiento
        function calculateAge(birthdate) {
            const birth = new Date(birthdate);
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            // Ajustar si aún no ha cumplido años este año
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            
            return age;
        }
        
        // Mostrar edad calculada cuando se selecciona fecha
        document.addEventListener('DOMContentLoaded', () => {
            const birthdateInput = document.getElementById('userBirthdate');
            const ageDisplay = document.getElementById('ageDisplay');
            
            // Establecer fecha máxima (hoy)
            const today = new Date().toISOString().split('T')[0];
            birthdateInput.setAttribute('max', today);
            
            birthdateInput.addEventListener('change', function() {
                if (this.value) {
                    const age = calculateAge(this.value);
                    ageDisplay.textContent = `✨ Tu edad: ${age} años`;
                } else {
                    ageDisplay.textContent = '';
                }
            });
        });
        
        // Función para resetear perfil y volver al cuestionario
        function resetProfile() {
            if (confirm('⚠️ ¿Estás seguro? Esto borrará tu perfil y podrás volver a hacer el cuestionario.')) {
                // Borrar perfil de localStorage
                localStorage.removeItem('userProfile');
                localStorage.removeItem('gameState');
                
                // Recargar la página para volver al inicio
                location.reload();
            }
        }

        // Estado del juego
        let gameState = {
            stats: {},
            lastUpdate: Date.now(),
            hydrationBreakdown: {
                agua: 0,
                azucarada: 0,
                refresco: 0,
                cafe: 0
            },
            dailyChecks: {
                bañarme: { done: false, boost: 5, emoji: '🚿', name: 'Bañarme' },
                tenderCama: { done: false, boost: 5, emoji: '🛏️', name: 'Tender la cama' },
                ropaLinda: { done: false, boost: 20, emoji: '👗', name: 'Ropa linda' },
                perfume: { done: false, boost: 3, emoji: '💐', name: 'Perfume' },
                maquillarse: { done: false, boost: 10, emoji: '💄', name: 'Maquillarse' },
                lastReset: new Date().toDateString()
            },
            completedSuggestions: [],
            favorites: [],
            ideas: {
                pendientes: [],
                guionada: [],
                grabadas: [],
                editadas: [],
                publicadas: []
            },
            wrongActivities: {
                list: [],
                lastReset: new Date().toDateString()
            },
            activities: {
                pending: [],
                completed: []
            }
        };

        // Inicializar estadísticas
        function initStats() {
            // Cargar perfil
            const savedProfile = localStorage.getItem('userProfile');
            if (savedProfile) {
                userProfile = JSON.parse(savedProfile);
                STATS_CONFIG.hambre.maxDaily = userProfile.bmr;
                STATS_CONFIG.hidratacion.maxDaily = userProfile.dailyWater;
            }
            
            // Cargar desde localStorage si existe
            const saved = localStorage.getItem('gameState');
            if (saved) {
                gameState = JSON.parse(saved);
                
                // Migrar datos antiguos sin desglose
                if (!gameState.hydrationBreakdown) {
                    gameState.hydrationBreakdown = {
                        agua: 0,
                        azucarada: 0,
                        refresco: 0,
                        cafe: 0
                    };
                }
                
                // Migrar estructura de balance general
                if (!gameState.dailyChecks) {
                    gameState.dailyChecks = {
                        hygiene: false,
                        grooming: false,
                        tidiness: false,
                        lastReset: new Date().toDateString()
                    };
                }
                
                if (!gameState.completedSuggestions) {
                    gameState.completedSuggestions = [];
                }
                
                if (!gameState.favorites) {
                    gameState.favorites = [];
                }
                
                // Migrar estructura de wrongActivities
                if (!gameState.wrongActivities) {
                    gameState.wrongActivities = {
                        list: [],
                        lastReset: new Date().toDateString()
                    };
                }
                
                // Migrar estructura de activities
                if (!gameState.activities) {
                    gameState.activities = {
                        pending: [],
                        completed: []
                    };
                }
                
                // Asegurar que todas las estadísticas existen (incluyendo nuevas)
                Object.keys(STATS_CONFIG).forEach(key => {
                    if (!gameState.stats[key]) {
                        gameState.stats[key] = { ...STATS_CONFIG[key] };
                    }
                });
                
                // Calcular tiempo transcurrido y aplicar decaimiento
                const now = Date.now();
                const hoursElapsed = (now - gameState.lastUpdate) / (1000 * 60 * 60);
                
                Object.keys(gameState.stats).forEach(key => {
                    // Excluir contenido del decaimiento (es progresivo, no decae)
                    if (key === 'contenido') return;
                    
                    const decayAmount = STATS_CONFIG[key].decayRate * hoursElapsed;
                    let newValue = gameState.stats[key].value - decayAmount;
                    
                    // Ejercicio tiene un mínimo de -100%
                    if (key === 'ejercicio') {
                        gameState.stats[key].value = Math.max(-100, newValue);
                    } else {
                        // Otras estadísticas pueden ser negativas sin límite
                        gameState.stats[key].value = newValue;
                    }
                });
                
                gameState.lastUpdate = now;
            } else {
                // Inicializar nuevo juego
                Object.keys(STATS_CONFIG).forEach(key => {
                    gameState.stats[key] = { ...STATS_CONFIG[key] };
                });
            }
            
            saveState();
        }

        // Guardar estado (mejorado para Safari)
        function saveState() {
            try {
                localStorage.setItem('gameState', JSON.stringify(gameState));
                // Guardar timestamp de última actualización
                localStorage.setItem('lastSave', new Date().toISOString());
                console.log('💾 Estado guardado');
            } catch (e) {
                console.error('⚠️ Error guardando estado:', e);
                // Si falla, intentar limpiar datos antiguos
                if (e.name === 'QuotaExceededError') {
                    console.log('🧹 Limpiando datos antiguos...');
                    localStorage.removeItem('oldData');
                    localStorage.setItem('gameState', JSON.stringify(gameState));
                }
            }
        }

        // Renderizar estadísticas
        function renderStats() {
            // Renderizar estadísticas de Existir (ahora incluye todas: hambre, sueño, hidratación, autoestima, vida social)
            const existirContainer = document.getElementById('statsExistir');
            existirContainer.innerHTML = '';
            ['hambre', 'sueño', 'hidratacion', 'autoestima', 'vidaSocial'].forEach(key => {
                if (gameState.stats[key]) {
                    existirContainer.appendChild(createStatElement(key, gameState.stats[key]));
                }
            });

            // Renderizar estadísticas de Ejercicio
            const ejercicioContainer = document.getElementById('statsEjercicio');
            if (ejercicioContainer) {
                ejercicioContainer.innerHTML = '';
                if (gameState.stats.ejercicio) {
                    ejercicioContainer.appendChild(createStatElement('ejercicio', gameState.stats.ejercicio));
                }
            }

            // Renderizar estadísticas de Crecer (idiomas, aprendizaje, profesión)
            const crecerContainer = document.getElementById('statsCrecer');
            crecerContainer.innerHTML = '';
            ['idiomas', 'aprendizaje', 'profesion'].forEach(key => {
                if (gameState.stats[key]) {
                    crecerContainer.appendChild(createStatElement(key, gameState.stats[key]));
                }
            });

            // Renderizar todas las estadísticas en Resumen
            const resumenContainer = document.getElementById('statsResumen');
            resumenContainer.innerHTML = '';
            Object.keys(gameState.stats).forEach(key => {
                resumenContainer.appendChild(createStatElement(key, gameState.stats[key]));
            });

            // Actualizar balance general
            updateBalanceGeneral();
        }

        // Crear elemento de estadística
        function createStatElement(key, stat) {
            const percentage = isNaN(stat.value) ? 0 : Math.round(stat.value);
            const isGrowthStat = ['idiomas', 'aprendizaje', 'contenido', 'profesion'].includes(key);
            
            // Determinar clase de color según porcentaje
            let barClass = 'stat-bar-high';
            if (percentage < 70 && percentage >= 40) {
                barClass = 'stat-bar-medium';
            } else if (percentage < 40) {
                barClass = 'stat-bar-low';
            }
            
            // Para estadísticas de crecimiento, usar siempre verde
            if (isGrowthStat) {
                barClass = 'stat-bar-high';
            }
            
            // Para hambre que excede 100%, usar color rojo de advertencia
            if (key === 'hambre' && percentage > 100) {
                barClass = 'stat-bar-low';
            }
            
            // Para valores negativos, usar color rojo de advertencia
            if (percentage < 0) {
                barClass = 'stat-bar-low';
            }

            // Información personalizada para hambre e hidratación
            let personalInfo = '';
            if (key === 'hambre' && userProfile.bmr > 0) {
                if (percentage > 100) {
                    const exceso = Math.round(percentage - 100);
                    personalInfo = `<div style="font-size: 0.85em; color: #ef4444; margin-top: 5px; font-weight: bold;">⚠️ ¡Exceso de ${exceso}%! Estás superando la cantidad máxima necesaria</div>`;
                } else if (percentage < 0) {
                    const deficit = Math.abs(Math.round(percentage));
                    personalInfo = `<div style="font-size: 0.85em; color: #ef4444; margin-top: 5px; font-weight: bold;">⚠️ ¡Déficit de ${deficit}%! Necesitas comer urgentemente</div>`;
                } else {
                    personalInfo = `<div style="font-size: 0.85em; color: #a78bfa; margin-top: 5px;">Meta diaria: ${userProfile.bmr} kcal</div>`;
                }
            } else if (key === 'hidratacion' && userProfile.dailyWater > 0) {
                const breakdown = gameState.hydrationBreakdown;
                const total = breakdown.agua + breakdown.azucarada + breakdown.refresco + breakdown.cafe;
                const feedback = getHydrationFeedback();
                
                personalInfo = `
                    <div style="font-size: 0.85em; color: #a78bfa; margin-top: 5px;">Meta diaria: ${userProfile.dailyWater} ml</div>
                    ${total > 0 ? `
                        <div style="font-size: 0.8em; margin-top: 8px; line-height: 1.4;">
                            <div style="color: #3b82f6;">💧 Agua natural: ${breakdown.agua} ml</div>
                            <div style="color: #f97316;">🧃 Bebidas azucaradas: ${breakdown.azucarada} ml</div>
                            <div style="color: #ef4444;">🥤 Refresco: ${breakdown.refresco} ml</div>
                            <div style="color: #8b5cf6;">☕ Café/té: ${breakdown.cafe} ml</div>
                        </div>
                        ${feedback ? `<div style="font-size: 0.85em; color: #6b4c9a; margin-top: 8px; font-weight: 600; background: rgba(167, 139, 250, 0.1); padding: 8px; border-radius: 8px;">${feedback}</div>` : ''}
                    ` : ''}`;
            }
            
            // Para estadísticas de crecimiento, mostrar que no tienen límite
            if (isGrowthStat) {
                personalInfo = `<div style="font-size: 0.75em; color: #56ab2f; margin-top: 5px;">✨ Progreso sin límite</div>`;
            }

            const statDiv = document.createElement('div');
            statDiv.className = `stat-item ${(!isGrowthStat && (percentage < 20 || percentage < 0)) || (key === 'hambre' && percentage > 100) ? 'warning' : ''}`;
            
            // Calcular ancho de barra según el tipo de estadística
            let barWidth;
            if (percentage < 0) {
                // Para valores negativos, mostrar barra en 0%
                barWidth = 0;
            } else if (isGrowthStat) {
                // Crecimiento sin límite, pero barra máxima al 100%
                barWidth = Math.min(percentage, 100);
            } else {
                // Para el resto, limitar entre 0 y 100 visualmente
                barWidth = Math.min(Math.max(percentage, 0), 100);
            }
            
            // Crear barra especial para hidratación con desglose por colores
            let barHTML = '';
            if (key === 'hidratacion' && userProfile.dailyWater > 0) {
                const breakdown = gameState.hydrationBreakdown;
                const total = breakdown.agua + breakdown.azucarada + breakdown.refresco + breakdown.cafe;
                
                if (total > 0) {
                    const aguaPct = (breakdown.agua / userProfile.dailyWater) * 100;
                    const azucaradaPct = (breakdown.azucarada / userProfile.dailyWater) * 100;
                    const refrescoPct = (breakdown.refresco / userProfile.dailyWater) * 100;
                    const cafePct = (breakdown.cafe / userProfile.dailyWater) * 100;
                    
                    // Calcular anchos reales respetando el límite visual de 100%
                    const aguaWidth = Math.min(aguaPct, 100);
                    const azucaradaWidth = Math.min(azucaradaPct, Math.max(0, 100 - aguaWidth));
                    const refrescoWidth = Math.min(refrescoPct, Math.max(0, 100 - aguaWidth - azucaradaWidth));
                    const cafeWidth = Math.min(cafePct, Math.max(0, 100 - aguaWidth - azucaradaWidth - refrescoWidth));
                    
                    barHTML = `
                        <div class="stat-bar-container">
                            ${aguaWidth > 0 ? `<div style="width: ${aguaWidth}%; height: 100%; background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); position: absolute; left: 0; border-radius: ${aguaWidth >= 100 ? '10px' : '10px 0 0 10px'};"></div>` : ''}
                            ${azucaradaWidth > 0 ? `<div style="width: ${azucaradaWidth}%; height: 100%; background: linear-gradient(135deg, #f97316 0%, #fb923c 100%); position: absolute; left: ${aguaWidth}%; border-radius: ${aguaWidth <= 0 ? '10px 0 0 10px' : '0'};"></div>` : ''}
                            ${refrescoWidth > 0 ? `<div style="width: ${refrescoWidth}%; height: 100%; background: linear-gradient(135deg, #ef4444 0%, #f87171 100%); position: absolute; left: ${aguaWidth + azucaradaWidth}%; border-radius: ${aguaWidth <= 0 && azucaradaWidth <= 0 ? '10px 0 0 10px' : '0'};"></div>` : ''}
                            ${cafeWidth > 0 ? `<div style="width: ${cafeWidth}%; height: 100%; background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%); position: absolute; left: ${aguaWidth + azucaradaWidth + refrescoWidth}%; border-radius: ${(aguaWidth + azucaradaWidth + refrescoWidth + cafeWidth) >= 100 ? '0 10px 10px 0' : '0'};"></div>` : ''}
                        </div>
                    `;
                } else {
                    // Si no hay líquidos consumidos, mostrar barra vacía
                    barHTML = `<div class="stat-bar-container"><div class="stat-bar-fill ${barClass}" style="width: 0%"></div></div>`;
                }
            } else {
                barHTML = `<div class="stat-bar-container"><div class="stat-bar-fill ${barClass}" style="width: ${barWidth}%"></div></div>`;
            }
            
            statDiv.innerHTML = `
                <div class="stat-header">
                    <div class="stat-name">
                        <span class="stat-icon">${stat.icon}</span>
                        ${stat.name}
                    </div>
                    <div class="stat-value">${percentage}%</div>
                </div>
                ${barHTML}
            `;
            
            // Agregar información personalizada si existe
            if (personalInfo) {
                const infoDiv = document.createElement('div');
                infoDiv.style.fontSize = '0.75em';
                // Color dinámico según el tipo de mensaje
                if (key === 'hambre' && percentage > 100) {
                    infoDiv.style.color = '#ef4444'; // Rojo para advertencia
                } else {
                    infoDiv.style.color = isGrowthStat ? '#56ab2f' : '#a78bfa';
                }
                infoDiv.style.marginTop = '-5px';
                infoDiv.style.textAlign = 'center';
                infoDiv.innerHTML = personalInfo.replace(/<div[^>]*>|<\/div>/g, '');
                statDiv.appendChild(infoDiv);
            }
            
            return statDiv;
        }

        // ===== SISTEMA DE BALANCE GENERAL =====
        
        // Resetear checks diarios si cambió el día
        function resetDailyChecksIfNeeded() {
            const today = new Date().toDateString();
            if (gameState.dailyChecks.lastReset !== today) {
                gameState.dailyChecks = {
                    bañarme: { done: false, boost: 5, emoji: '🚿', name: 'Bañarme' },
                    tenderCama: { done: false, boost: 5, emoji: '🛏️', name: 'Tender la cama' },
                    ropaLinda: { done: false, boost: 20, emoji: '👗', name: 'Ropa linda' },
                    perfume: { done: false, boost: 3, emoji: '💐', name: 'Perfume' },
                    maquillarse: { done: false, boost: 10, emoji: '💄', name: 'Maquillarse' },
                    lastReset: today
                };
                gameState.completedSuggestions = [];
                saveState();
                console.log('🔄 Checks diarios reseteados (nuevo día)');
            }
        }
        
        // Renderizar checks diarios
        function renderDailyChecks() {
            resetDailyChecksIfNeeded();
            const container = document.getElementById('dailyChecksContainer');
            if (!container) return;
            
            const checksOrder = ['bañarme', 'tenderCama', 'ropaLinda', 'perfume', 'maquillarse'];
            
            container.innerHTML = checksOrder.map(checkId => {
                const check = gameState.dailyChecks[checkId];
                if (!check) return '';
                
                const isChecked = check.done;
                return `
                    <div onclick="toggleDailyCheck('${checkId}')" style="
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        padding: 12px;
                        background: ${isChecked ? 'linear-gradient(135deg, #a8e063 0%, #56ab2f 100%)' : 'rgba(255, 255, 255, 0.7)'};
                        border-radius: 12px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        border: 2px solid ${isChecked ? '#56ab2f' : '#e0e0e0'};
                        box-shadow: ${isChecked ? '0 4px 12px rgba(168, 224, 99, 0.4)' : '0 2px 6px rgba(0,0,0,0.05)'};
                    ">
                        <div style="
                            width: 24px;
                            height: 24px;
                            border-radius: 50%;
                            background: ${isChecked ? '#fff' : 'transparent'};
                            border: 2px solid ${isChecked ? '#56ab2f' : '#9e9e9e'};
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 0.9em;
                            flex-shrink: 0;
                        ">
                            ${isChecked ? '✓' : ''}
                        </div>
                        <div style="font-size: 1.3em; flex-shrink: 0;">${check.emoji}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: ${isChecked ? '#fff' : '#388e3c'}; font-size: 0.95em;">${check.name}</div>
                            <div style="font-size: 0.75em; color: ${isChecked ? 'rgba(255,255,255,0.9)' : '#757575'}; margin-top: 2px;">+${check.boost}% autoestima</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Toggle check diario
        function toggleDailyCheck(checkId) {
            const check = gameState.dailyChecks[checkId];
            if (!check) return;
            
            const wasChecked = check.done;
            check.done = !wasChecked;
            
            if (!wasChecked) {
                // Completado: aumentar autoestima
                gameState.stats.autoestima.value = Math.min(200, gameState.stats.autoestima.value + check.boost);
                console.log(`✓ Check completado: ${check.name} (+${check.boost}% autoestima)`);
            } else {
                // Desmarcado: quitar autoestima
                gameState.stats.autoestima.value = Math.max(0, gameState.stats.autoestima.value - check.boost);
                console.log(`✗ Check desmarcado: ${check.name} (-${check.boost}% autoestima)`);
            }
            
            saveState();
            renderDailyChecks();
            renderStats();
        }
        
        // Mapa de acciones disponibles
        const ACTION_MAP = {
            hambre: { label: 'Comer', icon: '🍽️', action: 'openEatModal()' },
            hidratacion: { label: 'Beber', icon: '💧', action: 'openWaterModal()' },
            sueño: { label: 'Dormir', icon: '😴', action: 'openSleepModal()' },
            ejercicio: { label: 'Ejercicio', icon: '🏃', action: 'openExerciseModal()' },
            autoestima: { label: 'Autocuidado', icon: '💝', action: 'openSelfcareModal()' },
            vidaSocial: { label: 'Socializar', icon: '👥', action: 'openSocialModal()' },
            aprendizaje: { label: 'Aprender', icon: '📚', action: 'openAprendizajeModal()' },
            idiomas: { label: 'Idiomas', icon: '🌍', action: 'openIdiomasModal()' },
            profesion: { label: 'Profesión', icon: '👩‍⚕️', action: 'openProfesionModal()' }
        };
        
        // Generar sugerencias inteligentes
        function generateSmartSuggestions() {
            const stats = gameState.stats;
            const suggestions = [];
            
            // Obtener stats ordenadas por prioridad (más bajas primero)
            const sortedStats = Object.keys(stats)
                .filter(key => !['hambre'].includes(key)) // Excluir hambre de sugerencias
                .map(key => ({ key, value: stats[key].current, name: stats[key].name }))
                .sort((a, b) => a.value - b.value);
            
            // Generar 2-4 sugerencias basadas en stats más bajas
            let count = 0;
            for (const stat of sortedStats) {
                if (count >= 4) break;
                
                // Solo sugerir si está por debajo de 60% y no fue completada hoy
                if (stat.value < 60 && !gameState.completedSuggestions.includes(stat.key)) {
                    const action = ACTION_MAP[stat.key];
                    if (action) {
                        suggestions.push({
                            key: stat.key,
                            label: action.label,
                            icon: action.icon,
                            action: action.action,
                            stat: stat.name,
                            value: Math.round(stat.value)
                        });
                        count++;
                    }
                }
            }
            
            // Si no hay sugerencias críticas, agregar mantenimiento
            if (suggestions.length === 0) {
                const maintenanceActions = ['hidratacion', 'ejercicio', 'autoestima', 'aprendizaje']
                    .filter(key => !gameState.completedSuggestions.includes(key))
                    .slice(0, 2);
                
                maintenanceActions.forEach(key => {
                    const action = ACTION_MAP[key];
                    if (action) {
                        suggestions.push({
                            key,
                            label: action.label,
                            icon: action.icon,
                            action: action.action,
                            stat: stats[key].name,
                            value: Math.round(stats[key].value)
                        });
                    }
                });
            }
            
            return suggestions;
        }
        
        // Renderizar rutina sugerida
        function renderSuggestedRoutine() {
            const container = document.getElementById('suggestedRoutineContainer');
            if (!container) return;
            
            const suggestions = generateSmartSuggestions();
            
            if (suggestions.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #42a5f5; font-size: 0.9em; padding: 10px;">✨ ¡Todo en orden! Sigue así</div>';
                return;
            }
            
            container.innerHTML = suggestions.map(sugg => `
                <div onclick="executeSuggestion('${sugg.key}', '${sugg.action}')" style="
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    padding: 12px 15px;
                    background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
                    border-radius: 12px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    border: 2px solid #90caf9;
                    box-shadow: 0 2px 8px rgba(66, 165, 245, 0.2);
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(66, 165, 245, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(66, 165, 245, 0.2)'">
                    <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                        <div style="font-size: 1.5em;">${sugg.icon}</div>
                        <div>
                            <div style="font-weight: 600; color: #1565c0; font-size: 0.95em;">${sugg.label}</div>
                            <div style="font-size: 0.75em; color: #616161; margin-top: 2px;">Afecta: ${sugg.stat} (${sugg.value}%)</div>
                        </div>
                    </div>
                    <div style="background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%); color: white; padding: 6px 12px; border-radius: 8px; font-size: 0.8em; font-weight: 600;">Hacer</div>
                </div>
            `).join('');
        }
        
        // Ejecutar sugerencia
        function executeSuggestion(key, actionFn) {
            // Marcar como completada
            if (!gameState.completedSuggestions.includes(key)) {
                gameState.completedSuggestions.push(key);
                saveState();
            }
            
            // Ejecutar acción
            eval(actionFn);
            
            // Re-renderizar después de un momento
            setTimeout(() => {
                renderSuggestedRoutine();
            }, 500);
        }
        
        // Renderizar favoritos
        function renderFavorites() {
            const container = document.getElementById('favoritesContainer');
            if (!container) return;
            
            if (!gameState.favorites || gameState.favorites.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #f57c00; font-size: 0.9em; padding: 10px;">Toca "+ Elegir" para seleccionar tus acciones favoritas</div>';
                return;
            }
            
            container.innerHTML = gameState.favorites.map(key => {
                const action = ACTION_MAP[key];
                if (!action) return '';
                
                const stat = gameState.stats[key];
                const value = stat ? Math.round(stat.value) : 0;
                
                return `
                    <div onclick="${action.action}" style="
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        padding: 12px 15px;
                        background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
                        border-radius: 12px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        border: 2px solid #ffb74d;
                        box-shadow: 0 2px 8px rgba(255, 152, 0, 0.2);
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(255, 152, 0, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(255, 152, 0, 0.2)'">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="font-size: 1.5em;">${action.icon}</div>
                            <div>
                                <div style="font-weight: 600; color: #e65100; font-size: 0.95em;">${action.label}</div>
                                ${stat ? `<div style="font-size: 0.75em; color: #616161; margin-top: 2px;">${stat.name}: ${value}%</div>` : ''}
                            </div>
                        </div>
                        <div style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; padding: 6px 12px; border-radius: 8px; font-size: 0.8em; font-weight: 600;">→</div>
                    </div>
                `;
            }).join('');
        }
        
        // Abrir selector de favoritos
        function openFavoritesSelector() {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 450px;">
                    <div class="modal-header">
                        <div class="modal-title">✨ Elegir Favoritos</div>
                        <div class="modal-subtitle">Selecciona hasta 6 acciones (${gameState.favorites.length}/6)</div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 10px; max-height: 50vh; overflow-y: auto; padding: 10px 5px;">
                        ${Object.keys(ACTION_MAP).map(key => {
                            const action = ACTION_MAP[key];
                            const isSelected = gameState.favorites.includes(key);
                            return `
                                <div onclick="toggleFavorite('${key}')" id="fav-${key}" style="
                                    display: flex;
                                    align-items: center;
                                    gap: 12px;
                                    padding: 12px;
                                    background: ${isSelected ? 'linear-gradient(135deg, #ff9800 0%, #f57c00 100%)' : 'linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%)'};
                                    border-radius: 12px;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    border: 2px solid ${isSelected ? '#f57c00' : '#e0e0e0'};
                                ">
                                    <div style="
                                        width: 24px;
                                        height: 24px;
                                        border-radius: 50%;
                                        background: ${isSelected ? '#fff' : 'transparent'};
                                        border: 2px solid ${isSelected ? '#f57c00' : '#9e9e9e'};
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        font-size: 0.9em;
                                        flex-shrink: 0;
                                    ">
                                        ${isSelected ? '✓' : ''}
                                    </div>
                                    <div style="font-size: 1.3em;">${action.icon}</div>
                                    <div style="font-weight: 600; color: ${isSelected ? '#fff' : '#424242'}; flex: 1;">${action.label}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <button class="modal-close" onclick="closeFavoritesSelector()">✓ Guardar</button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Toggle favorito
        function toggleFavorite(key) {
            const index = gameState.favorites.indexOf(key);
            
            if (index > -1) {
                // Remover
                gameState.favorites.splice(index, 1);
            } else {
                // Agregar si no excede el límite
                if (gameState.favorites.length < 6) {
                    gameState.favorites.push(key);
                } else {
                    alert('⚠️ Máximo 6 favoritos. Deselecciona uno primero.');
                    return;
                }
            }
            
            saveState();
            
            // Actualizar visual del modal
            const action = ACTION_MAP[key];
            const isSelected = gameState.favorites.includes(key);
            const elem = document.getElementById(`fav-${key}`);
            if (elem) {
                elem.style.background = isSelected ? 'linear-gradient(135deg, #ff9800 0%, #f57c00 100%)' : 'linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%)';
                elem.style.borderColor = isSelected ? '#f57c00' : '#e0e0e0';
                elem.querySelector('div:nth-child(1)').style.background = isSelected ? '#fff' : 'transparent';
                elem.querySelector('div:nth-child(1)').style.borderColor = isSelected ? '#f57c00' : '#9e9e9e';
                elem.querySelector('div:nth-child(1)').textContent = isSelected ? '✓' : '';
                elem.querySelector('div:nth-child(3)').style.color = isSelected ? '#fff' : '#424242';
            }
            
            // Actualizar contador
            const subtitle = document.querySelector('.modal-subtitle');
            if (subtitle) {
                subtitle.textContent = `Selecciona hasta 6 acciones (${gameState.favorites.length}/6)`;
            }
        }
        
        // Cerrar selector de favoritos
        function closeFavoritesSelector() {
            const modal = document.querySelector('.modal.show');
            if (modal) {
                modal.remove();
                renderFavorites();
            }
        }
        
        // Actualizar todos los bloques del balance general
        function updateBalanceGeneral() {
            renderDailyChecks();
            renderSuggestedRoutine();
            renderFavorites();
        }

        // Función para cambiar de tab
        function switchTab(tabName) {
            // Remover clase active de todos los tabs y contenidos
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Agregar clase active al tab clickeado
            const tabs = document.querySelectorAll('.tab');
            const tabNames = ['existir', 'ejercicio', 'crecer', 'emocional', 'biblioteca', 'ideas', 'calendario', 'resumen'];
            const index = tabNames.indexOf(tabName);
            if (index !== -1) {
                tabs[index].classList.add('active');
            }
            
            // Mostrar contenido correspondiente
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Si es biblioteca, renderizar contenido
            if (tabName === 'biblioteca') {
                renderLibraryContent();
            }
            
            // Si es ejercicio, renderizar calendario
            if (tabName === 'ejercicio') {
                renderExerciseCalendar();
            }
            
            // Si es ideas, renderizar ideas
            if (tabName === 'ideas') {
                renderIdeas();
                updateContenidoBar();
                renderScheduledVideos();
            }
            
            // Si es calendario, renderizar calendario
            if (tabName === 'calendario') {
                renderMonthlyCalendar();
                renderActivities();
            }
            
            // Si es emocional, renderizar calendario emocional
            if (tabName === 'emocional') {
                renderEmotionalCalendar2026();
            }
        }

        // Actualizar estadísticas continuamente
        function updateStats() {
            const now = Date.now();
            const hoursElapsed = (now - gameState.lastUpdate) / (1000 * 60 * 60);
            
            if (hoursElapsed > 0) {
                Object.keys(gameState.stats).forEach(key => {
                    // Excluir contenido del decaimiento (es progresivo, no decae)
                    if (key === 'contenido') return;
                    
                    const decayAmount = STATS_CONFIG[key].decayRate * hoursElapsed;
                    let newValue = gameState.stats[key].value - decayAmount;
                    
                    // TODAS las estadísticas tienen un mínimo de -100%
                    gameState.stats[key].value = Math.max(-100, newValue);
                });
                
                // Resetear desglose de hidratación si cambió el día
                const lastUpdateDate = new Date(gameState.lastUpdate).toDateString();
                const currentDate = new Date(now).toDateString();
                if (lastUpdateDate !== currentDate) {
                    gameState.hydrationBreakdown = {
                        agua: 0,
                        azucarada: 0,
                        refresco: 0,
                        cafe: 0
                    };
                    console.log('🔄 Desglose de hidratación reseteado (nuevo día)');
                }
                
                gameState.lastUpdate = now;
                saveState();
                renderStats();
                
                console.log(`⏱️ Estadísticas actualizadas. Horas transcurridas: ${hoursElapsed.toFixed(2)}`);
            }
        }

        // Resetear estadísticas a 0 (solo Existir y Ejercicio, NO Crecimiento)
        function resetStats() {
            if (confirm('¿Estás seguro de que quieres reiniciar las estadísticas de Existir y Ejercicio a 0%?')) {
                // Solo reiniciar estadísticas de Existir y Ejercicio (NO Crecimiento)
                const statsToReset = ['hambre', 'hidratacion', 'sueño', 'autoestima', 'ejercicio', 'vidaSocial'];
                
                statsToReset.forEach(key => {
                    if (gameState.stats[key]) {
                        gameState.stats[key].value = 0;
                    }
                });
                
                gameState.lastUpdate = Date.now();
                saveState();
                renderStats();
                alert('✅ Las estadísticas de Existir y Ejercicio se han reiniciado a 0%. Las de Crecimiento no fueron afectadas.');
            }
        }

        // Actualizar reloj en tiempo real
        function updateClock() {
            const now = new Date();
            const days = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            const dayName = days[now.getDay()];
            const day = now.getDate();
            const month = months[now.getMonth()];
            const year = now.getFullYear();
            
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            const dateElement = document.getElementById('dateDisplay');
            const timeElement = document.getElementById('timeDisplay');
            
            if (dateElement) dateElement.textContent = `📅 ${dayName}, ${day} de ${month} de ${year}`;
            if (timeElement) timeElement.textContent = `⏰ ${hours}:${minutes}:${seconds}`;
        }
        
        // Funciones para calcular días vividos y días restantes
        function calculateDaysLived() {
            if (!userProfile.birthdate) return 0;
            const birth = new Date(userProfile.birthdate);
            const today = new Date();
            const diffTime = Math.abs(today - birth);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }
        
        function calculateEstimatedDaysLeft() {
            if (!userProfile.birthdate) return 0;
            const birth = new Date(userProfile.birthdate);
            const today = new Date();
            const age = calculateAge(userProfile.birthdate);
            const estimatedDeathAge = 72; // Media de esperanza de vida
            const yearsLeft = Math.max(0, estimatedDeathAge - age);
            const daysLeft = Math.floor(yearsLeft * 365.25);
            return daysLeft;
        }
        
        function toggleLifeDays() {
            const display = document.getElementById('lifeDaysDisplay');
            const deathDisplay = document.getElementById('deathDaysDisplay');
            
            if (display.classList.contains('show')) {
                display.classList.remove('show');
            } else {
                deathDisplay.classList.remove('show');
                const days = calculateDaysLived();
                display.textContent = `❤️ ${days.toLocaleString()} días vividos`;
                display.classList.add('show');
                
                // Ocultar después de 3 segundos
                setTimeout(() => display.classList.remove('show'), 3000);
            }
        }
        
        function toggleDeathDays() {
            const display = document.getElementById('deathDaysDisplay');
            const lifeDisplay = document.getElementById('lifeDaysDisplay');
            
            if (display.classList.contains('show')) {
                display.classList.remove('show');
            } else {
                lifeDisplay.classList.remove('show');
                const days = calculateEstimatedDaysLeft();
                const years = Math.floor(days / 365.25);
                display.textContent = `💀 ~${days.toLocaleString()} días (~${years} años)`;
                display.classList.add('show');
                
                // Ocultar después de 3 segundos
                setTimeout(() => display.classList.remove('show'), 3000);
            }
        }
        
        function calculateDaysUntilBirthday() {
            if (!userProfile.birthdate) return 0;
            const birth = new Date(userProfile.birthdate);
            const today = new Date();
            
            // Próximo cumpleaños
            const nextBirthday = new Date(today.getFullYear(), birth.getMonth(), birth.getDate());
            
            // Si ya pasó este año, calcular para el próximo
            if (nextBirthday < today) {
                nextBirthday.setFullYear(today.getFullYear() + 1);
            }
            
            const diffTime = nextBirthday - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }
        
        function toggleBirthday() {
            const display = document.getElementById('birthdayDisplay');
            const lifeDisplay = document.getElementById('lifeDaysDisplay');
            const deathDisplay = document.getElementById('deathDaysDisplay');
            
            if (display.classList.contains('show')) {
                display.classList.remove('show');
            } else {
                lifeDisplay.classList.remove('show');
                deathDisplay.classList.remove('show');
                const days = calculateDaysUntilBirthday();
                display.textContent = days === 0 ? '🎂 ¡Hoy es tu cumpleaños!' : `🎂 Faltan ${days} días para tu cumpleaños`;
                display.classList.add('show');
                
                // Ocultar después de 3 segundos
                setTimeout(() => display.classList.remove('show'), 3000);
            }
        }

        // Funciones del modal de comida
        function openEatModal() {
            document.getElementById('caloriesInput').value = '';
            document.getElementById('caloriesInfo').style.display = 'none';
            document.getElementById('bmrDisplay').textContent = userProfile.bmr;
            document.getElementById('eatModal').classList.add('show');
            
            // Agregar listener para actualizar en tiempo real
            document.getElementById('caloriesInput').addEventListener('input', function() {
                const calories = parseFloat(this.value);
                if (calories && calories > 0) {
                    const hungerPercent = caloriesToHungerPercent(calories);
                    document.getElementById('hungerIncrease').textContent = hungerPercent.toFixed(1);
                    document.getElementById('caloriesInfo').style.display = 'block';
                } else {
                    document.getElementById('caloriesInfo').style.display = 'none';
                }
            });
        }

        function closeEatModal() {
            document.getElementById('eatModal').classList.remove('show');
        }

        function calculateEatEffects() {
            const calories = parseFloat(document.getElementById('caloriesInput').value);
            
            if (!calories || calories < 1) {
                alert('⚠️ Por favor ingresa las calorías consumidas');
                return;
            }
            
            // Calcular porcentaje de hambre basado en BMR
            const hungerPercent = caloriesToHungerPercent(calories);
            
            // Aplicar los cambios (limitar entre 0 y 100)
            gameState.stats.hambre.value = Math.min(200, Math.max(0, gameState.stats.hambre.value + hungerPercent));
            
            // También se reduce un poco la hidratación (al comer necesitas agua)
            const hydrationDecrease = hungerPercent * 0.15; // 15% de las calorías afecta hidratación
            gameState.stats.hidratacion.value = Math.max(0, gameState.stats.hidratacion.value - hydrationDecrease);
            
            gameState.lastUpdate = Date.now();
            saveState();
            renderStats();
            closeEatModal();
            
            console.log(`¡Comiste ${calories} kcal! +${hungerPercent.toFixed(1)}% de hambre`);
        }

        // Funciones del modal de agua
        function openWaterModal() {
            document.getElementById('waterModal').classList.add('show');
            // Limpiar inputs
            document.getElementById('drinkAmount').value = '';
            document.getElementById('drinkType').value = 'agua';
        }

        function closeWaterModal() {
            document.getElementById('waterModal').classList.remove('show');
        }

        function registerDrink() {
            const ml = parseInt(document.getElementById('drinkAmount').value);
            const type = document.getElementById('drinkType').value;
            
            if (!ml || ml <= 0) {
                alert('⚠️ Por favor ingresa una cantidad válida');
                return;
            }
            
            if (ml > 2000) {
                alert('⚠️ Cantidad muy alta. Máximo 2000 ml por registro');
                return;
            }
            
            // Calcular porcentaje basado en necesidad diaria personalizada
            const percentage = mlToHydrationPercent(ml);
            
            // Aumentar hidratación total
            gameState.stats.hidratacion.value = Math.min(200, gameState.stats.hidratacion.value + percentage);
            
            // Registrar en desglose por tipo
            gameState.hydrationBreakdown[type] = (gameState.hydrationBreakdown[type] || 0) + ml;
            
            gameState.lastUpdate = Date.now();
            saveState();
            renderStats();
            closeWaterModal();
            
            // Obtener nombre del tipo
            const typeNames = {
                agua: 'agua natural',
                azucarada: 'bebida azucarada',
                refresco: 'refresco',
                cafe: 'café/té con leche'
            };
            
            console.log(`✓ Registrado: ${ml}ml de ${typeNames[type]} (+${percentage.toFixed(1)}%)`);
        }
        
        // Obtener mensaje de feedback según proporciones
        function getHydrationFeedback() {
            const breakdown = gameState.hydrationBreakdown;
            const total = breakdown.agua + breakdown.azucarada + breakdown.refresco + breakdown.cafe;
            
            if (total === 0) return '';
            
            const aguaPct = (breakdown.agua / total) * 100;
            const azucarPct = ((breakdown.azucarada + breakdown.refresco) / total) * 100;
            const refrescoPct = (breakdown.refresco / total) * 100;
            
            // Mensajes según proporciones
            if (aguaPct >= 80) {
                return '💙 ¡Excelente! Priorizaste agua natural';
            } else if (aguaPct >= 60) {
                return '👍 Buen equilibrio, priorizaste agua';
            } else if (refrescoPct >= 40) {
                return '⚠️ Mucho refresco hoy, intenta reducir mañana';
            } else if (azucarPct >= 50) {
                return '⚡ Llegaste a la meta, pero con alto consumo de azúcar';
            } else if (aguaPct >= 40) {
                return '💧 Vas bien, pero podrías tomar más agua natural';
            } else {
                return '🥤 Intenta aumentar el agua natural gradualmente';
            }
        }

        // Funciones del modal de dormir
        function openSleepModal() {
            document.getElementById('sleepModal').classList.add('show');
        }

        function closeSleepModal() {
            document.getElementById('sleepModal').classList.remove('show');
        }

        function sleep(percentage) {
            // Aumentar sueño
            gameState.stats.sueño.value = Math.min(200, gameState.stats.sueño.value + percentage);
            gameState.lastUpdate = Date.now();
            saveState();
            renderStats();
            closeSleepModal();
            
            console.log(`¡Dormiste! +${percentage}% de sueño`);
        }

        function calculateSleep() {
            const sleepTime = document.getElementById('sleepTime').value;
            const wakeTime = document.getElementById('wakeTime').value;
            
            if (!sleepTime || !wakeTime) {
                alert('⚠️ Por favor ingresa ambas horas (dormir y despertar)');
                return;
            }
            
            // Convertir las horas a minutos desde medianoche
            const [sleepHour, sleepMin] = sleepTime.split(':').map(Number);
            const [wakeHour, wakeMin] = wakeTime.split(':').map(Number);
            
            let sleepMinutes = sleepHour * 60 + sleepMin;
            let wakeMinutes = wakeHour * 60 + wakeMin;
            
            // Si la hora de despertar es menor, significa que es al día siguiente
            if (wakeMinutes <= sleepMinutes) {
                wakeMinutes += 24 * 60; // Añadir 24 horas en minutos
            }
            
            // Calcular diferencia en minutos y convertir a horas
            const totalMinutes = wakeMinutes - sleepMinutes;
            const hours = totalMinutes / 60;
            
            // Calcular porcentaje (cada hora = 11.11%)
            const percentage = hours * 11.11;
            
            // Mostrar mensaje confirmando las horas
            const hoursText = hours.toFixed(1);
            const percentageText = percentage.toFixed(2);
            
            if (confirm(`¿Dormiste ${hoursText} horas?\n\nEsto añadirá +${percentageText}% a tu sueño.`)) {
                sleep(percentage);
            }
        }

        // Variable para almacenar la actividad seleccionada
        let selectedActivity = '';

        // Funciones del modal de ejercicio
        function openExerciseModal() {
            document.getElementById('exerciseModal').classList.add('show');
        }

        function closeExerciseModal() {
            document.getElementById('exerciseModal').classList.remove('show');
        }

        function selectActivity(activity) {
            selectedActivity = activity;
            closeExerciseModal();
            
            if (activity === '🥋 Taekwondo') {
                openIntensityModal();
            } 
            else if (activity === '🚶 Caminar') {
                openWalkModal();
            }
            else if (activity === '🏃 Correr') {
                openRunModal();
            }
            else if (activity === '⛸️ Patinar') {
                openSkateModal();
            }
            else if (activity === '🏋️ Pesas') {
                openWeightsModal();
            }
        }

        function openIntensityModal() {
            document.getElementById('intensityTitle').textContent = selectedActivity;
            document.getElementById('taekwondoDuration').value = '';
            document.getElementById('intensityOptions').style.display = 'none';
            document.getElementById('intensityModal').classList.add('show');
        }

        function closeIntensityModal() {
            document.getElementById('intensityModal').classList.remove('show');
        }

        function calculateIntensityEffects() {
            const duration = parseInt(document.getElementById('taekwondoDuration').value);
            
            if (!duration || duration < 1) {
                alert('⚠️ Por favor ingresa la duración del entrenamiento en minutos');
                return;
            }
            
            // Generar botones con efectos calculados
            const intensityOptions = document.querySelector('#intensityOptions .modal-options');
            intensityOptions.innerHTML = '';
            
            const intensities = [
                { key: 'leve', icon: '😌', name: 'Leve', color: 'linear-gradient(135deg, #a8e063 0%, #56ab2f 100%)' },
                { key: 'moderado', icon: '💪', name: 'Moderado', color: 'linear-gradient(135deg, #ffd89b 0%, #f093fb 100%)' },
                { key: 'intenso', icon: '🔥', name: 'Intenso', color: 'linear-gradient(135deg, #ff6b9d 0%, #c44569 100%)' }
            ];
            
            intensities.forEach(intensity => {
                const met = MET_VALUES.taekwondo[intensity.key];
                const caloriesBurned = calculateCaloriesBurned(met, duration);
                const hungerPercent = caloriesToHungerPercent(caloriesBurned);
                const waterNeeded = caloriesBurned * 1.75;
                const hydrationPercent = mlToHydrationPercent(waterNeeded);
                
                const button = document.createElement('button');
                button.className = 'option-button';
                button.style.background = intensity.color;
                button.onclick = () => applyExercise(intensity.key, duration);
                button.innerHTML = `
                    <span style="display: flex; flex-direction: column; align-items: flex-start; gap: 5px;">
                        <span class="option-ml">${intensity.icon} ${intensity.name}</span>
                        <span style="font-size: 0.85em; opacity: 0.9;">Hambre -${hungerPercent.toFixed(1)}% | Hidratación -${hydrationPercent.toFixed(1)}%</span>
                    </span>
                `;
                intensityOptions.appendChild(button);
            });
            
            // Mostrar opciones
            document.getElementById('intensityOptions').style.display = 'block';
        }

        function applyExercise(intensity, duration) {
            const met = MET_VALUES.taekwondo[intensity];
            
            // Calcular calorías quemadas
            const caloriesBurned = calculateCaloriesBurned(met, duration);
            const hungerPercent = caloriesToHungerPercent(caloriesBurned);
            
            // Calcular hidratación necesaria (aproximadamente 150-200ml por cada 100 kcal)
            const waterNeeded = caloriesBurned * 1.75;
            const hydrationPercent = mlToHydrationPercent(waterNeeded);
            
            const effect = {
                hambre: -hungerPercent,
                hidratacion: -hydrationPercent,
                ejercicio: 50,
                autoestima: 25
            };
            
            // Aplicar los cambios a las estadísticas
            gameState.stats.hambre.value = Math.max(0, gameState.stats.hambre.value + effect.hambre);
            gameState.stats.hidratacion.value = Math.max(0, gameState.stats.hidratacion.value + effect.hidratacion);
            gameState.stats.ejercicio.value = Math.min(200, gameState.stats.ejercicio.value + effect.ejercicio);
            gameState.stats.autoestima.value = Math.min(200, gameState.stats.autoestima.value + effect.autoestima);
            
            gameState.lastUpdate = Date.now();
            saveState();
            renderStats();
            closeIntensityModal();
            
            // Mostrar mensaje de confirmación
            const intensityName = intensity.charAt(0).toUpperCase() + intensity.slice(1);
            console.log(`¡${selectedActivity} - ${intensityName} (${duration} min)! ${caloriesBurned} kcal | ${Math.round(waterNeeded)}ml`);
        }

        // Funciones del modal de caminar
        function openWalkModal() {
            document.getElementById('walkDuration').value = '';
            document.getElementById('walkUnit').value = 'minutos';
            document.getElementById('walkOptions').style.display = 'none';
            updateWalkInputLabel();
            document.getElementById('walkModal').classList.add('show');
        }

        function closeWalkModal() {
            document.getElementById('walkModal').classList.remove('show');
        }

        function updateWalkInputLabel() {
            const unit = document.getElementById('walkUnit').value;
            const label = document.getElementById('walkInputLabel');
            const input = document.getElementById('walkDuration');
            
            if (unit === 'minutos') {
                label.textContent = 'Minutos caminados:';
                input.placeholder = 'Ej: 30';
                input.max = '300';
            } else {
                label.textContent = 'Número de pasos:';
                input.placeholder = 'Ej: 5000';
                input.max = '50000';
            }
        }

        function calculateWalkEffects() {
            const unit = document.getElementById('walkUnit').value;
            const value = parseFloat(document.getElementById('walkDuration').value);
            
            if (!value || value < 1) {
                const message = unit === 'minutos' 
                    ? '⚠️ Por favor ingresa la duración de tu caminata en minutos'
                    : '⚠️ Por favor ingresa el número de pasos';
                alert(message);
                return;
            }
            
            // Convertir pasos a minutos si es necesario
            // Promedio: 100 pasos por minuto (ritmo moderado)
            let duration = value;
            if (unit === 'pasos') {
                duration = value / 100; // Convertir pasos a minutos
            }
            
            // Generar botones con efectos calculados según ritmo
            const walkOptions = document.querySelector('#walkOptions .modal-options');
            walkOptions.innerHTML = '';
            
            const paces = [
                { key: 'lento', icon: '🚶', name: 'Lento (paseo)', color: 'linear-gradient(135deg, #a8e063 0%, #56ab2f 100%)' },
                { key: 'moderado', icon: '🚶‍♂️', name: 'Moderado (caminata)', color: 'linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%)' },
                { key: 'rapido', icon: '🚶‍♀️', name: 'Rápido (power walk)', color: 'linear-gradient(135deg, #ffd89b 0%, #f093fb 100%)' }
            ];
            
            paces.forEach(pace => {
                const met = MET_VALUES.caminar[pace.key];
                const caloriesBurned = calculateCaloriesBurned(met, duration);
                const hungerPercent = caloriesToHungerPercent(caloriesBurned);
                const waterNeeded = caloriesBurned * 1.5;
                const hydrationPercent = mlToHydrationPercent(waterNeeded);
                
                const button = document.createElement('button');
                button.className = 'option-button';
                button.style.background = pace.color;
                button.onclick = () => applyWalk(pace.key, duration);
                button.innerHTML = `
                    <span style="display: flex; flex-direction: column; align-items: flex-start; gap: 5px;">
                        <span class="option-ml">${pace.icon} ${pace.name}</span>
                        <span style="font-size: 0.85em; opacity: 0.9;">Hambre -${hungerPercent.toFixed(1)}% | Hidratación -${hydrationPercent.toFixed(1)}%</span>
                    </span>
                `;
                walkOptions.appendChild(button);
            });
            
            document.getElementById('walkOptions').style.display = 'block';
        }

        function applyWalk(pace, duration) {
            const met = MET_VALUES.caminar[pace];
            const caloriesBurned = calculateCaloriesBurned(met, duration);
            const hungerPercent = caloriesToHungerPercent(caloriesBurned);
            const waterNeeded = caloriesBurned * 1.5;
            const hydrationPercent = mlToHydrationPercent(waterNeeded);
            
            gameState.stats.hambre.value = Math.max(0, gameState.stats.hambre.value - hungerPercent);
            gameState.stats.hidratacion.value = Math.max(0, gameState.stats.hidratacion.value - hydrationPercent);
            gameState.stats.ejercicio.value = Math.min(200, gameState.stats.ejercicio.value + 10);
            gameState.stats.autoestima.value = Math.min(200, gameState.stats.autoestima.value + 5);
            
            gameState.lastUpdate = Date.now();
            saveState();
            renderStats();
            closeWalkModal();
            
            console.log(`¡Caminaste ${duration} min (${pace})! ${caloriesBurned} kcal | ${Math.round(waterNeeded)}ml`);
        }

        // Funciones del modal de correr
        function openRunModal() {
            document.getElementById('runDuration').value = '';
            document.getElementById('runUnit').value = 'minutos';
            document.getElementById('runOptions').style.display = 'none';
            updateRunInputLabel();
            document.getElementById('runModal').classList.add('show');
        }

        function closeRunModal() {
            document.getElementById('runModal').classList.remove('show');
        }

        function updateRunInputLabel() {
            const unit = document.getElementById('runUnit').value;
            const label = document.getElementById('runInputLabel');
            const input = document.getElementById('runDuration');
            
            if (unit === 'minutos') {
                label.textContent = 'Minutos:';
                input.placeholder = 'Ej: 20';
                input.max = '300';
            } else {
                label.textContent = 'Kilómetros:';
                input.placeholder = 'Ej: 5';
                input.max = '50';
            }
        }

        function calculateRunEffects() {
            const unit = document.getElementById('runUnit').value;
            const value = parseFloat(document.getElementById('runDuration').value);
            
            if (!value || value < 0.1) {
                const message = unit === 'minutos' 
                    ? '⚠️ Por favor ingresa la duración de tu carrera en minutos'
                    : '⚠️ Por favor ingresa la distancia en kilómetros';
                alert(message);
                return;
            }
            
            // Convertir kilómetros a minutos si es necesario
            // Promedio: 1 km = 6 minutos (pace moderado ~10 km/h)
            let duration = value;
            if (unit === 'kilometros') {
                duration = value * 6; // Convertir km a minutos aproximados
            }
            
            // Generar botones con efectos calculados según intensidad
            const runOptions = document.querySelector('#runOptions .modal-options');
            runOptions.innerHTML = '';
            
            const intensities = [
                { key: 'leve', icon: '🏃', name: 'Leve (trote)', color: 'linear-gradient(135deg, #a8e063 0%, #56ab2f 100%)' },
                { key: 'moderado', icon: '🏃‍♂️', name: 'Moderado (ritmo constante)', color: 'linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%)' },
                { key: 'intenso', icon: '🔥', name: 'Intenso (sprint/HIIT)', color: 'linear-gradient(135deg, #ff6b9d 0%, #c44569 100%)' }
            ];
            
            intensities.forEach(intensity => {
                const met = MET_VALUES.correr[intensity.key];
                const caloriesBurned = calculateCaloriesBurned(met, duration);
                const hungerPercent = caloriesToHungerPercent(caloriesBurned);
                const waterNeeded = caloriesBurned * 2.0;
                const hydrationPercent = mlToHydrationPercent(waterNeeded);
                
                const button = document.createElement('button');
                button.className = 'option-button';
                button.style.background = intensity.color;
                button.onclick = () => applyRun(intensity.key, duration);
                button.innerHTML = `
                    <span style="display: flex; flex-direction: column; align-items: flex-start; gap: 5px;">
                        <span class="option-ml">${intensity.icon} ${intensity.name}</span>
                        <span style="font-size: 0.85em; opacity: 0.9;">Hambre -${hungerPercent.toFixed(1)}% | Hidratación -${hydrationPercent.toFixed(1)}%</span>
                    </span>
                `;
                runOptions.appendChild(button);
            });
            
            document.getElementById('runOptions').style.display = 'block';
        }

        function applyRun(intensity, duration) {
            const met = MET_VALUES.correr[intensity];
            const caloriesBurned = calculateCaloriesBurned(met, duration);
            const hungerPercent = caloriesToHungerPercent(caloriesBurned);
            const waterNeeded = caloriesBurned * 2.0;
            const hydrationPercent = mlToHydrationPercent(waterNeeded);
            
            gameState.stats.hambre.value = Math.max(0, gameState.stats.hambre.value - hungerPercent);
            gameState.stats.hidratacion.value = Math.max(0, gameState.stats.hidratacion.value - hydrationPercent);
            gameState.stats.ejercicio.value = Math.min(200, gameState.stats.ejercicio.value + 40);
            gameState.stats.autoestima.value = Math.min(200, gameState.stats.autoestima.value + 20);
            
            gameState.lastUpdate = Date.now();
            saveState();
            renderStats();
            closeRunModal();
            
            console.log(`¡Corriste ${duration.toFixed(1)} min (${intensity})! ${caloriesBurned} kcal | ${Math.round(waterNeeded)}ml`);
        }

        // Funciones del modal de patinar
        function openSkateModal() {
            document.getElementById('skateDuration').value = '';
            document.getElementById('skateOptions').style.display = 'none';
            document.getElementById('skateModal').classList.add('show');
        }

        function closeSkateModal() {
            document.getElementById('skateModal').classList.remove('show');
        }

        function calculateSkateEffects() {
            const duration = parseInt(document.getElementById('skateDuration').value);
            
            if (!duration || duration < 1) {
                alert('⚠️ Por favor ingresa la duración de tu sesión de patinaje en minutos');
                return;
            }
            
            const skateOptions = document.querySelector('#skateOptions .modal-options');
            skateOptions.innerHTML = '';
            
            const intensities = [
                { key: 'recreativo', icon: '⛸️', name: 'Recreativo', color: 'linear-gradient(135deg, #a8e063 0%, #56ab2f 100%)' },
                { key: 'moderado', icon: '⛸️', name: 'Moderado', color: 'linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%)' },
                { key: 'intenso', icon: '⛸️', name: 'Intenso', color: 'linear-gradient(135deg, #ff6b9d 0%, #c44569 100%)' }
            ];
            
            intensities.forEach(intensity => {
                const met = MET_VALUES.patinar[intensity.key];
                const caloriesBurned = calculateCaloriesBurned(met, duration);
                const hungerPercent = caloriesToHungerPercent(caloriesBurned);
                const waterNeeded = caloriesBurned * 1.6;
                const hydrationPercent = mlToHydrationPercent(waterNeeded);
                
                const button = document.createElement('button');
                button.className = 'option-button';
                button.style.background = intensity.color;
                button.onclick = () => applySkating(intensity.key, duration);
                button.innerHTML = `
                    <span style="display: flex; flex-direction: column; align-items: flex-start; gap: 5px;">
                        <span class="option-ml">${intensity.icon} ${intensity.name}</span>
                        <span style="font-size: 0.85em; opacity: 0.9;">Hambre -${hungerPercent.toFixed(1)}% | Hidratación -${hydrationPercent.toFixed(1)}%</span>
                    </span>
                `;
                skateOptions.appendChild(button);
            });
            
            document.getElementById('skateOptions').style.display = 'block';
        }

        function applySkating(intensity, duration) {
            const met = MET_VALUES.patinar[intensity];
            const caloriesBurned = calculateCaloriesBurned(met, duration);
            const hungerPercent = caloriesToHungerPercent(caloriesBurned);
            const waterNeeded = caloriesBurned * 1.6;
            const hydrationPercent = mlToHydrationPercent(waterNeeded);
            
            gameState.stats.hambre.value = Math.max(0, gameState.stats.hambre.value - hungerPercent);
            gameState.stats.hidratacion.value = Math.max(0, gameState.stats.hidratacion.value - hydrationPercent);
            gameState.stats.ejercicio.value = Math.min(200, gameState.stats.ejercicio.value + 35);
            gameState.stats.autoestima.value = Math.min(200, gameState.stats.autoestima.value + 15);
            
            gameState.lastUpdate = Date.now();
            saveState();
            renderStats();
            closeSkateModal();
            
            console.log(`¡Patinaste ${duration} min (${intensity})! ${caloriesBurned} kcal | ${Math.round(waterNeeded)}ml`);
        }

        // Funciones del modal de pesas
        function openWeightsModal() {
            document.getElementById('weightsDuration').value = '';
            document.getElementById('muscleGroup').value = 'piernas';
            document.getElementById('weightsModal').classList.add('show');
        }

        function closeWeightsModal() {
            document.getElementById('weightsModal').classList.remove('show');
        }

        function calculateWeightsEffects() {
            const duration = parseInt(document.getElementById('weightsDuration').value);
            const muscleGroup = document.getElementById('muscleGroup').value;
            
            if (!duration || duration < 1) {
                alert('⚠️ Por favor ingresa la duración de tu entrenamiento en minutos');
                return;
            }
            
            const met = MET_VALUES.pesas[muscleGroup];
            const caloriesBurned = calculateCaloriesBurned(met, duration);
            const hungerPercent = caloriesToHungerPercent(caloriesBurned);
            const waterNeeded = caloriesBurned * 1.8;
            const hydrationPercent = mlToHydrationPercent(waterNeeded);
            
            const muscleNames = {
                piernas: 'Piernas/Glúteos',
                espalda: 'Espalda/Pecho',
                brazos: 'Brazos/Hombros'
            };
            
            if (confirm(`🏋️ Pesas - ${muscleNames[muscleGroup]} - ${duration} minutos\n\nEfectos:\n- Hambre: -${hungerPercent.toFixed(1)}%\n- Hidratación: -${hydrationPercent.toFixed(1)}%\n- Salud Física: +45%\n- Autoestima: +25%\n\n¿Aplicar?`)) {
                gameState.stats.hambre.value = Math.max(0, gameState.stats.hambre.value - hungerPercent);
                gameState.stats.hidratacion.value = Math.max(0, gameState.stats.hidratacion.value - hydrationPercent);
                gameState.stats.ejercicio.value = Math.min(200, gameState.stats.ejercicio.value + 45);
                gameState.stats.autoestima.value = Math.min(200, gameState.stats.autoestima.value + 25);
                
                gameState.lastUpdate = Date.now();
                saveState();
                renderStats();
                closeWeightsModal();
                
                console.log(`¡Hiciste pesas ${duration} min (${muscleNames[muscleGroup]})! ${caloriesBurned} kcal | ${Math.round(waterNeeded)}ml`);
            }
        }
        
        // Funciones de autoestima
        function loadSelfcareCooldowns() {
            const saved = localStorage.getItem('selfcareCooldowns');
            if (saved) {
                selfcareCooldowns = JSON.parse(saved);
            }
            resetCooldownsIfNeeded();
        }
        
        function saveSelfcareCooldowns() {
            localStorage.setItem('selfcareCooldowns', JSON.stringify(selfcareCooldowns));
        }
        
        function resetCooldownsIfNeeded() {
            const now = Date.now();
            const oneDayMs = 24 * 60 * 60 * 1000;
            const oneWeekMs = 7 * oneDayMs;
            
            // Reset diarios
            if (now - selfcareCooldowns.lastReset.daily > oneDayMs) {
                selfcareCooldowns.daily = {};
                selfcareCooldowns.lastReset.daily = now;
                saveSelfcareCooldowns();
            }
            
            // Reset semanales
            if (now - selfcareCooldowns.lastReset.weekly > oneWeekMs) {
                selfcareCooldowns.weekly = {};
                selfcareCooldowns.lastReset.weekly = now;
                saveSelfcareCooldowns();
            }
        }
        
        function isActionAvailable(actionId, cooldown) {
            if (cooldown === 'none') return true;
            if (cooldown === 'daily') return !selfcareCooldowns.daily[actionId];
            if (cooldown === 'weekly') return !selfcareCooldowns.weekly[actionId];
            return true;
        }
        
        function markActionUsed(actionId, cooldown) {
            if (cooldown === 'daily') {
                selfcareCooldowns.daily[actionId] = Date.now();
            } else if (cooldown === 'weekly') {
                selfcareCooldowns.weekly[actionId] = Date.now();
            }
            saveSelfcareCooldowns();
        }
        
        function openSelfcareModal() {
            loadSelfcareCooldowns();
            document.getElementById('selfcareModal').classList.add('show');
        }
        
        function closeSelfcareModal() {
            document.getElementById('selfcareModal').classList.remove('show');
        }
        
        function openSelfcareCategory(category) {
            closeSelfcareModal();
            const actions = SELFCARE_ACTIONS[category];
            let container, modal;
            
            if (category === 'microcuidados') {
                container = document.getElementById('microcuidadosOptions');
                modal = document.getElementById('microcuidadosModal');
            } else if (category === 'regulacion') {
                container = document.getElementById('regulacionOptions');
                modal = document.getElementById('regulacionModal');
            } else {
                container = document.getElementById('impactoOptions');
                modal = document.getElementById('impactoModal');
            }
            
            container.innerHTML = '';
            
            actions.forEach(action => {
                const available = isActionAvailable(action.id, action.cooldown);
                
                // Ocultar botones que ya se usaron (no están disponibles)
                if (!available) {
                    return; // No mostrar el botón
                }
                
                const button = document.createElement('button');
                button.className = 'option-button';
                button.style.opacity = '1';
                button.style.cursor = 'pointer';
                button.style.background = 'linear-gradient(135deg, #a78bfa 0%, #c084fc 100%)';
                
                let cooldownText = '';
                if (action.cooldown === 'daily') cooldownText = ' (1x día)';
                else if (action.cooldown === 'weekly') cooldownText = ' (1x semana)';
                
                button.innerHTML = `
                    <span style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <span style="font-size: 1.05em;">${action.emoji} ${action.name}${cooldownText}</span>
                        <span style="font-size: 1.1em; font-weight: bold; color: #10b981;">+${action.boost}%</span>
                    </span>
                `;
                
                button.onclick = () => applySelfcareAction(action);
                
                container.appendChild(button);
            });
            
            modal.classList.add('show');
        }
        
        function applySelfcareAction(action) {
            gameState.stats.autoestima.value = Math.min(200, gameState.stats.autoestima.value + action.boost);
            markActionUsed(action.id, action.cooldown);
            saveState();
            renderStats();
            
            // Cerrar el modal correspondiente
            document.getElementById('microcuidadosModal').classList.remove('show');
            document.getElementById('regulacionModal').classList.remove('show');
            document.getElementById('impactoModal').classList.remove('show');
            
            console.log(`${action.emoji} ${action.name}: Autoestima +${action.boost}%`);
        }
        
        function closeMicrocuidadosModal() {
            document.getElementById('microcuidadosModal').classList.remove('show');
            openSelfcareModal();
        }
        
        function closeRegulacionModal() {
            document.getElementById('regulacionModal').classList.remove('show');
            openSelfcareModal();
        }
        
        function closeImpactoModal() {
            document.getElementById('impactoModal').classList.remove('show');
            openSelfcareModal();
        }
        
        // Funciones de Vida Social
        function openSocialModal() {
            document.getElementById('socialModal').classList.add('show');
        }
        
        function closeSocialModal() {
            document.getElementById('socialModal').classList.remove('show');
        }
        
        function openSocialCategory(category) {
            closeSocialModal();
            
            const actions = SOCIAL_ACTIONS[category];
            let modalId, optionsId;
            
            if (category === 'familia') {
                modalId = 'familiaModal';
                optionsId = 'familiaOptions';
            } else if (category === 'vinculos') {
                modalId = 'vinculosModal';
                optionsId = 'vinculosOptions';
            } else if (category === 'facil') {
                modalId = 'facilModal';
                optionsId = 'facilOptions';
            }
            
            const container = document.getElementById(optionsId);
            container.innerHTML = '';
            
            actions.forEach(action => {
                const button = document.createElement('button');
                button.style.cssText = 'width: 100%; padding: 12px 15px; background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%); border: none; border-radius: 12px; font-size: 1em; font-weight: 600; color: white; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(161, 196, 253, 0.3); display: flex; justify-content: space-between; align-items: center;';
                
                button.innerHTML = `
                    <span style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.3em;">${action.emoji}</span>
                        <span>${action.name}</span>
                    </span>
                    <span style="background: rgba(255, 255, 255, 0.3); padding: 5px 12px; border-radius: 10px; font-size: 0.9em;">+${action.boost}%</span>
                `;
                
                button.onclick = () => applySocialAction(action);
                container.appendChild(button);
            });
            
            document.getElementById(modalId).classList.add('show');
        }
        
        function applySocialAction(action) {
            // Aumentar vida social
            gameState.stats.vidaSocial.value = Math.min(200, gameState.stats.vidaSocial.value + action.boost);
            
            gameState.lastUpdate = Date.now();
            saveState();
            renderStats();
            
            // Cerrar todos los modales sociales
            document.getElementById('familiaModal').classList.remove('show');
            document.getElementById('vinculosModal').classList.remove('show');
            document.getElementById('facilModal').classList.remove('show');
            
            console.log(`${action.emoji} ${action.name}: +${action.boost}% vida social`);
        }
        
        function closeFamiliaModal() {
            document.getElementById('familiaModal').classList.remove('show');
            openSocialModal();
        }
        
        function closeVinculosModal() {
            document.getElementById('vinculosModal').classList.remove('show');
            openSocialModal();
        }
        
        function closeFacilModal() {
            document.getElementById('facilModal').classList.remove('show');
            openSocialModal();
        }
        
        // Funciones de Crecimiento
        function openIdiomasModal() {
            const actions = GROWTH_ACTIONS.idiomas;
            const container = document.getElementById('idiomasOptions');
            container.innerHTML = '';
            
            actions.forEach(action => {
                const button = createGrowthButton(action, 'idiomas');
                container.appendChild(button);
            });
            
            document.getElementById('idiomasModal').classList.add('show');
        }
        
        function closeIdiomasModal() {
            document.getElementById('idiomasModal').classList.remove('show');
        }
        
        function openAprendizajeModal() {
            const actions = GROWTH_ACTIONS.aprendizaje;
            const container = document.getElementById('aprendizajeOptions');
            container.innerHTML = '';
            
            actions.forEach(action => {
                const button = createGrowthButton(action, 'aprendizaje');
                container.appendChild(button);
            });
            
            document.getElementById('aprendizajeModal').classList.add('show');
        }
        
        function closeAprendizajeModal() {
            document.getElementById('aprendizajeModal').classList.remove('show');
        }
        
        function openProfesionModal() {
            document.getElementById('profesionModal').classList.add('show');
        }
        
        function closeProfesionModal() {
            document.getElementById('profesionModal').classList.remove('show');
        }
        
        function openProfesionCategory(category) {
            closeProfesionModal();
            
            const actions = GROWTH_ACTIONS[category];
            let modalId, optionsId;
            
            if (category === 'enfermeria') {
                modalId = 'enfermeriaModal';
                optionsId = 'enfermeriaOptions';
            } else if (category === 'farmacologia') {
                modalId = 'farmacologiaModal';
                optionsId = 'farmacologiaOptions';
            }
            
            const container = document.getElementById(optionsId);
            container.innerHTML = '';
            
            actions.forEach(action => {
                const button = createGrowthButton(action, 'profesion');
                container.appendChild(button);
            });
            
            document.getElementById(modalId).classList.add('show');
        }
        
        function closeEnfermeriaModal() {
            document.getElementById('enfermeriaModal').classList.remove('show');
            openProfesionModal();
        }
        
        function closeFarmacologiaModal() {
            document.getElementById('farmacologiaModal').classList.remove('show');
            openProfesionModal();
        }
        
        function createGrowthButton(action, statKey) {
            const button = document.createElement('button');
            button.style.cssText = 'width: 100%; padding: 12px 15px; background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%); border: none; border-radius: 12px; font-size: 1em; font-weight: 600; color: white; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(161, 196, 253, 0.3); display: flex; justify-content: space-between; align-items: center;';
            
            button.innerHTML = `
                <span style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.3em;">${action.emoji}</span>
                    <span>${action.name}</span>
                </span>
                <span style="background: rgba(255, 255, 255, 0.3); padding: 5px 12px; border-radius: 10px; font-size: 0.9em;">+${action.boost}%</span>
            `;
            
            button.onclick = () => applyGrowthAction(action, statKey);
            return button;
        }
        
        function applyGrowthAction(action, statKey) {
            // Aumentar estadística de crecimiento (sin límite de 100%)
            if (!gameState.stats[statKey]) {
                gameState.stats[statKey] = { ...STATS_CONFIG[statKey] };
            }
            // Sin límite máximo para estadísticas de crecimiento, pero sí mínimo de 0
            gameState.stats[statKey].value = Math.max(0, gameState.stats[statKey].value + action.boost);
            
            gameState.lastUpdate = Date.now();
            saveState();
            renderStats();
            
            // Cerrar todos los modales de crecimiento
            document.getElementById('idiomasModal').classList.remove('show');
            document.getElementById('aprendizajeModal').classList.remove('show');
            document.getElementById('contenidoModal').classList.remove('show');
            document.getElementById('enfermeriaModal').classList.remove('show');
            document.getElementById('farmacologiaModal').classList.remove('show');
            
            console.log(`${action.emoji} ${action.name}: ${STATS_CONFIG[statKey].name} +${action.boost}% (Total: ${Math.round(gameState.stats[statKey].value)}%)`);
        }

        // Efectos de botones (preparados para futuras funciones)
        function setupButtons() {
            document.getElementById('btnEat').addEventListener('click', () => {
                openEatModal();
            });

            document.getElementById('btnDrink').addEventListener('click', () => {
                openWaterModal();
            });

            document.getElementById('btnSleep').addEventListener('click', () => {
                openSleepModal();
            });

            document.getElementById('btnExercise').addEventListener('click', () => {
                openExerciseModal();
            });

            document.getElementById('btnSelfcare').addEventListener('click', () => {
                openSelfcareModal();
            });

            document.getElementById('btnSocial').addEventListener('click', () => {
                openSocialModal();
            });
            
            // Botones de Crecer
            document.getElementById('btnIdiomas').addEventListener('click', () => {
                openIdiomasModal();
            });
            
            document.getElementById('btnAprendizaje').addEventListener('click', () => {
                openAprendizajeModal();
            });
            
            document.getElementById('btnProfesion').addEventListener('click', () => {
                openProfesionModal();
            });

            document.getElementById('btnReset').addEventListener('click', resetStats);
        }

        // Inicializar aplicación
        function init() {
            // Verificar si existe perfil
            const savedProfile = localStorage.getItem('userProfile');
            if (!savedProfile) {
                // Mostrar modal de perfil
                document.getElementById('profileModal').classList.add('show');
                return;
            }
            
            initStats();
            renderStats();
            setupButtons();
            loadSelfcareCooldowns();
            resetDailyChecksIfNeeded();
            renderDailyChecks();
            
            // Cargar y renderizar ideas
            loadIdeas();
            migrateIdeasToNewStructure();
            renderIdeas();
            
            // Renderizar actividades del calendario
            renderActivities();
            renderMonthlyCalendar();
            renderWrongActivities();
            
            // Pre-llenar fecha de hoy en el input de actividad
            const activityDateInput = document.getElementById('activityDate');
            if (activityDateInput) {
                const today = new Date().toISOString().split('T')[0];
                activityDateInput.value = today;
                console.log('📅 Fecha de hoy pre-llenada:', today);
            }
            
            // Inicializar y actualizar reloj cada segundo
            updateClock();
            setInterval(updateClock, 1000);
            
            // Actualizar estadísticas cada 10 segundos
            setInterval(updateStats, 10000);
            
            // Verificar medianoche cada minuto para resetear checks
            setInterval(() => {
                resetDailyChecksIfNeeded();
                renderDailyChecks();
            }, 60000);
            
            // Actualizar balance general
            updateBalanceGeneral();
            
            // Actualizar también cuando la página recupera el foco
            window.addEventListener('focus', () => {
                updateStats();
                resetDailyChecksIfNeeded();
                renderDailyChecks();
            });
            
            console.log('✅ Juego inicializado correctamente');
            console.log('⏰ Reloj activado');
        }

        // ===== SISTEMA DE BIBLIOTECA =====
        
        // IMPORTANTE: NO inicializar library aquí, se carga desde localStorage
        let library = null;
        
        let currentLibraryCategory = 'libros';
        let libraryFilters = {
            search: '',
            letter: '',
            rating: 0,
            folder: ''
        };
        
        // Obtener todas las carpetas únicas de flashcards (incluyendo carpetas vacías)
        function getFlashcardFolders() {
            if (!library || !library.flashcards) return ['General'];
            const folders = [...new Set(library.flashcards.map(f => f.folder || 'General'))];
            // Agregar carpetas creadas manualmente desde localStorage
            const manualFolders = JSON.parse(localStorage.getItem('flashcardFolders') || '[]');
            const allFolders = [...new Set([...folders, ...manualFolders])];
            return allFolders.sort();
        }
        
        // Filtrar por carpeta
        function filterByFolder(folder) {
            libraryFilters.folder = folder;
            renderLibraryContent();
        }
        
        // Abrir modal para crear carpeta
        function openCreateFolderModal() {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3>➕ Nueva Carpeta</h3>
                    </div>
                    <div class="modal-body">
                        <label style="display: block; margin-bottom: 8px; color: #667eea; font-weight: bold;">Nombre de la carpeta:</label>
                        <input type="text" id="newFolderName" placeholder="Ej: Matemáticas, Historia..." style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 0.95em;">
                        <p style="color: #9ca3af; font-size: 0.85em; margin-top: 10px;">💡 Puedes crear carpetas para organizar tus flashcards por temas</p>
                    </div>
                    <div style="display: flex; gap: 10px; padding: 20px;">
                        <button onclick="createFolder()" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 15px; font-size: 1.1em; font-weight: bold; cursor: pointer;">Crear</button>
                        <button onclick="closeFolderModal()" style="padding: 15px 20px; background: #e5e7eb; color: #6b7280; border: none; border-radius: 15px; cursor: pointer;">Cancelar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            setTimeout(() => document.getElementById('newFolderName').focus(), 100);
        }
        
        // Crear carpeta y guardarla en localStorage
        function createFolder() {
            const folderName = document.getElementById('newFolderName').value.trim();
            if (!folderName) {
                alert('⚠️ Por favor ingresa un nombre para la carpeta');
                return;
            }
            
            // Verificar si ya existe
            const existingFolders = getFlashcardFolders();
            if (existingFolders.includes(folderName)) {
                alert('⚠️ Esta carpeta ya existe');
                return;
            }
            
            // Guardar carpeta en localStorage
            const manualFolders = JSON.parse(localStorage.getItem('flashcardFolders') || '[]');
            manualFolders.push(folderName);
            localStorage.setItem('flashcardFolders', JSON.stringify(manualFolders));
            
            // Filtrar por la nueva carpeta
            libraryFilters.folder = folderName;
            closeFolderModal();
            renderLibraryContent();
            
            // Mostrar mensaje
            setTimeout(() => {
                alert(`✅ Carpeta "${folderName}" creada. Ahora puedes agregar flashcards a esta carpeta.`);
            }, 100);
        }
        
        // Cerrar modal de carpeta
        function closeFolderModal() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (modal.querySelector('#newFolderName')) {
                    modal.remove();
                }
            });
        }
        
        // Cargar biblioteca desde localStorage
        function loadLibrary() {
            const saved = localStorage.getItem('library');
            if (saved) {
                try {
                    const loadedLibrary = JSON.parse(saved);
                    // Solo cargar si hay datos válidos
                    if (loadedLibrary && typeof loadedLibrary === 'object') {
                        library = loadedLibrary;
                        console.log('📚 Biblioteca cargada:', library);
                        return;
                    }
                } catch (error) {
                    console.error('❌ Error al cargar biblioteca:', error);
                    // Intentar recuperar del backup
                    const backup = localStorage.getItem('library_backup');
                    if (backup) {
                        try {
                            library = JSON.parse(backup);
                            console.log('⚠️ Biblioteca recuperada del backup');
                            // Guardar el backup como versión actual
                            saveLibrary();
                            return;
                        } catch (backupError) {
                            console.error('❌ Error al recuperar backup:', backupError);
                        }
                    }
                }
            }
            
            // Solo si no hay datos guardados, inicializar vacío
            if (!library) {
                library = {
                    libros: [],
                    peliculas: [],
                    series: [],
                    flashcards: [],
                    apuntes: []
                };
                console.log('🆕 Biblioteca inicializada vacía');
            }
            
            // Asegurar que flashcards y apuntes existan en bibliotecas antiguas
            if (!library.flashcards) {
                library.flashcards = [];
            }
            if (!library.apuntes) {
                library.apuntes = [];
            }
        }
        
        // Guardar biblioteca en localStorage
        function saveLibrary() {
            try {
                // Crear backup antes de guardar
                const currentLibrary = localStorage.getItem('library');
                if (currentLibrary) {
                    localStorage.setItem('library_backup', currentLibrary);
                }
                
                // Guardar nueva versión
                localStorage.setItem('library', JSON.stringify(library));
                console.log('💾 Biblioteca guardada correctamente');
                
                // Marcar cambio pendiente para sincronización
                if (typeof marcarCambioPendiente === 'function') {
                    marcarCambioPendiente();
                }
                
                // Mostrar indicador visual
                showSaveIndicator('Biblioteca guardada ✓');
            } catch (error) {
                console.error('❌ Error al guardar biblioteca:', error);
                alert('⚠️ Error al guardar. Tus cambios pueden no haberse guardado.');
            }
        }
        
        // Abrir categoría de biblioteca
        function openLibraryCategory(category) {
            currentLibraryCategory = category;
            libraryFilters = { search: '', letter: '', rating: 0 };
            
            // Si es apuntes, renderizar con función simple
            if (category === 'apuntes') {
                renderApuntes();
                return;
            }
            
            renderLibraryContent();
        }
        
        // Renderizar apuntes con carpetas
        function renderApuntes() {
            const c = document.getElementById('libraryContent');
            
            if (!window.library) window.library = {};
            if (!library.apuntes) library.apuntes = [];
            if (!library.carpetasApuntes) library.carpetasApuntes = ['General'];
            if (!window.carpetaApuntesActual) window.carpetaApuntesActual = 'General';
            
            let html = `
                <div style="text-align: center; margin-bottom: 25px;">
                    <h2 style="color: #6b4c9a; margin-bottom: 15px;">📝 Apuntes</h2>
                    <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 15px;">
                        <button onclick="agregarApunte()" style="padding: 12px 25px; background: linear-gradient(135deg, #ffa751 0%, #ffe259 100%); color: white; border: none; border-radius: 15px; font-size: 1em; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(255, 167, 81, 0.3);">
                            ➕ Nuevo Apunte
                        </button>
                        <button onclick="crearCarpetaApuntes()" style="padding: 12px 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 15px; font-size: 1em; font-weight: 600; cursor: pointer;">
                            📁 Nueva Carpeta
                        </button>
                    </div>
                    <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-bottom: 20px;">
                        ${library.carpetasApuntes.map(carpeta => `
                            <button onclick="cambiarCarpetaApuntes('${carpeta}')" style="padding: 8px 16px; background: ${carpetaApuntesActual === carpeta ? 'linear-gradient(135deg, #ffa751 0%, #ffe259 100%)' : '#f3f4f6'}; color: ${carpetaApuntesActual === carpeta ? 'white' : '#6b7280'}; border: none; border-radius: 10px; cursor: pointer; font-weight: ${carpetaApuntesActual === carpeta ? '600' : '500'};">
                                📁 ${carpeta}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
            
            const apuntesFiltrados = library.apuntes.filter(a => (a.carpeta || 'General') === carpetaApuntesActual);
            
            if (apuntesFiltrados.length === 0) {
                html += `
                    <div style="text-align: center; padding: 60px 20px; color: #9ca3af;">
                        <div style="font-size: 4em; margin-bottom: 20px;">📝</div>
                        <p style="font-size: 1.2em; font-weight: 600; margin-bottom: 10px; color: #6b7280;">No hay apuntes en esta carpeta</p>
                        <p style="font-size: 1em; color: #9ca3af;">Agrega uno para comenzar</p>
                    </div>
                `;
            } else {
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;">';
                
                library.apuntes.forEach((apunte, index) => {
                    if ((apunte.carpeta || 'General') !== carpetaApuntesActual) return;
                    
                    const fecha = apunte.fecha ? new Date(apunte.fecha).toLocaleDateString('es-ES') : 'Sin fecha';
                    const preview = apunte.contenido ? apunte.contenido.replace(/<[^>]*>/g, '').substring(0, 120) + '...' : '';
                    const hasImage = apunte.imagen ? `<img src="${apunte.imagen}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 10px; margin-bottom: 12px;">` : '';
                    
                    html += `
                        <div style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: transform 0.2s; hover: transform: translateY(-2px);">
                            ${hasImage}
                            <h3 style="color: #ffa751; margin-bottom: 10px; font-size: 1.2em;">${apunte.titulo || 'Sin título'}</h3>
                            <p style="color: #6b7280; font-size: 0.85em; margin-bottom: 10px;">📅 ${fecha}</p>
                            ${preview ? `<p style="color: #9ca3af; font-size: 0.9em; margin-bottom: 15px; line-height: 1.5;">${preview}</p>` : ''}
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <button onclick="generarFlashcardsDeApunte(${index})" style="width: 100%; padding: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);">
                                    🧠 Crear Flashcards con IA
                                </button>
                                <div style="display: flex; gap: 8px;">
                                    <button onclick="verApunte(${index})" style="flex: 1; padding: 8px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                        👁️ Ver
                                    </button>
                                    <button onclick="editarApunte(${index})" style="flex: 1; padding: 8px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                        ✏️ Editar
                                    </button>
                                    <button onclick="borrarApunte(${index})" style="flex: 1; padding: 8px; background: #ff6b9d; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                        🗑️ Borrar
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            c.innerHTML = html;
        }
        
        // Funciones de carpetas
        function cambiarCarpetaApuntes(carpeta) {
            window.carpetaApuntesActual = carpeta;
            renderApuntes();
        }
        
        function crearCarpetaApuntes() {
            const nombre = prompt('Nombre de la carpeta:');
            if (!nombre || nombre.trim() === '') return;
            
            if (library.carpetasApuntes.includes(nombre)) {
                alert('❌ Ya existe una carpeta con ese nombre');
                return;
            }
            
            library.carpetasApuntes.push(nombre);
            saveLibrary();
            renderApuntes();
        }
        
        // Ver apunte completo
        function verApunte(index) {
            const apunte = library.apuntes[index];
            window.apunteEditandoIndex = index;
            window.apunteEditandoModo = 'ver';
            mostrarModalApunte(apunte, 'ver');
        }
        
        // Agregar nuevo apunte
        function agregarApunte() {
            window.apunteEditandoIndex = -1;
            window.apunteEditandoModo = 'nuevo';
            mostrarModalApunte(null, 'nuevo');
        }
        
        // Editar apunte existente
        function editarApunte(index) {
            const apunte = library.apuntes[index];
            window.apunteEditandoIndex = index;
            window.apunteEditandoModo = 'editar';
            mostrarModalApunte(apunte, 'editar');
        }
        
        // Modal estilo Word para apuntes
        function mostrarModalApunte(apunte, modo) {
            const modal = document.createElement('div');
            modal.id = 'modalApunte';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px;';
            
            const readOnly = modo === 'ver';
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 20px; max-width: 900px; width: 100%; max-height: 90vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3); display: flex; flex-direction: column;">
                    <div style="background: linear-gradient(135deg, #ffa751 0%, #ffe259 100%); padding: 20px; display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="color: white; margin: 0; font-size: 1.5em;">${modo === 'ver' ? '👁️ Ver Apunte' : modo === 'nuevo' ? '➕ Nuevo Apunte' : '✏️ Editar Apunte'}</h2>
                        <button onclick="cerrarModalApunte()" style="background: rgba(255,255,255,0.3); border: none; color: white; font-size: 1.5em; cursor: pointer; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">✕</button>
                    </div>
                    <div style="padding: 30px; overflow-y: auto; flex: 1;">
                        <input type="text" id="apunteTitulo" placeholder="Título del apunte..." value="${apunte?.titulo || ''}" ${readOnly ? 'readonly' : ''} style="width: 100%; padding: 15px; border: ${readOnly ? 'none' : '2px solid #e5e7eb'}; border-radius: 10px; font-size: 1.3em; font-weight: 600; margin-bottom: 20px; color: #1f2937; background: ${readOnly ? 'transparent' : 'white'};">
                        
                        ${!readOnly ? `
                        <div style="background: #f9fafb; padding: 12px; border-radius: 10px; margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="formatoTexto('bold')" style="padding: 8px 12px; background: white; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer; font-weight: bold;">B</button>
                            <button onclick="formatoTexto('italic')" style="padding: 8px 12px; background: white; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer; font-style: italic;">I</button>
                            <button onclick="formatoTexto('underline')" style="padding: 8px 12px; background: white; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer; text-decoration: underline;">U</button>
                            <button onclick="insertarImagenApunte()" style="padding: 8px 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">🖼️ Imagen</button>
                        </div>
                        ` : ''}
                        
                        <div id="apunteContenido" contenteditable="${!readOnly}" style="min-height: 300px; padding: 20px; border: ${readOnly ? 'none' : '2px solid #e5e7eb'}; border-radius: 10px; font-size: 1.05em; line-height: 1.8; color: #374151; background: white; outline: none; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">${apunte?.contenido || ''}</div>
                        
                        ${!readOnly ? `
                        <div style="margin-top: 20px;">
                            <label style="display: block; color: #6b7280; font-size: 0.9em; margin-bottom: 8px; font-weight: 600;">📁 Carpeta:</label>
                            <select id="apunteCarpeta" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1em;">
                                ${library.carpetasApuntes.map(c => `<option value="${c}" ${(apunte?.carpeta || 'General') === c ? 'selected' : ''}>${c}</option>`).join('')}
                            </select>
                        </div>
                        ` : ''}
                    </div>
                    <div style="padding: 20px; background: #f9fafb; display: flex; gap: 10px; justify-content: flex-end;">
                        ${!readOnly ? `<button onclick="guardarApunte()" style="padding: 12px 30px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 10px; font-size: 1em; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">💾 Guardar</button>` : ''}
                        <button onclick="cerrarModalApunte()" style="padding: 12px 30px; background: #e5e7eb; color: #374151; border: none; border-radius: 10px; font-size: 1em; font-weight: 600; cursor: pointer;">${readOnly ? 'Cerrar' : 'Cancelar'}</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            if (!readOnly) {
                document.getElementById('apunteTitulo').focus();
            }
        }
        
        function formatoTexto(comando) {
            document.execCommand(comando, false, null);
            document.getElementById('apunteContenido').focus();
        }
        
        function insertarImagenApunte() {
            const url = prompt('URL de la imagen:');
            if (!url) return;
            
            const img = `<img src="${url}" style="max-width: 100%; height: auto; border-radius: 10px; margin: 15px 0;">`;            document.execCommand('insertHTML', false, img);
        }
        
        function guardarApunte() {
            const titulo = document.getElementById('apunteTitulo').value.trim();
            const contenido = document.getElementById('apunteContenido').innerHTML;
            const carpeta = document.getElementById('apunteCarpeta')?.value || carpetaApuntesActual;
            
            if (!titulo) {
                alert('⚠️ El título es obligatorio');
                return;
            }
            
            const apunteData = {
                id: apunteEditandoIndex >= 0 ? library.apuntes[apunteEditandoIndex].id : Date.now(),
                titulo: titulo,
                contenido: contenido,
                carpeta: carpeta,
                fecha: Date.now()
            };
            
            if (apunteEditandoModo === 'nuevo') {
                library.apuntes.push(apunteData);
            } else {
                library.apuntes[apunteEditandoIndex] = apunteData;
            }
            
            saveLibrary();
            cerrarModalApunte();
            renderApuntes();
        }
        
        function cerrarModalApunte() {
            const modal = document.getElementById('modalApunte');
            if (modal) modal.remove();
        }
        
        // Generar flashcards con IA de un apunte
        function generarFlashcardsDeApunte(index) {
            const apunte = library.apuntes[index];
            
            if (!apunte.contenido || apunte.contenido.trim() === '') {
                alert('⚠️ El apunte está vacío. Agrega contenido primero.');
                return;
            }
            
            const confirmacion = confirm(`🧠 ¿Generar flashcards del apunte "${apunte.titulo}"?\n\nLa IA creará tarjetas de estudio basadas en el contenido.`);
            if (!confirmacion) return;
            
            // Mostrar indicador de carga
            alert('⏳ Generando flashcards con IA... (esto puede tardar unos segundos)');
            
            // Llamar a la función de generación de flashcards con IA
            generateFlashcardsWithAI(apunte.contenido.replace(/<[^>]*>/g, ''), apunte.titulo)
                .then(() => {
                    alert('✅ Flashcards generadas correctamente. Ve a la sección Flashcards para repasarlas.');
                })
                .catch(error => {
                    console.error('Error generando flashcards:', error);
                    alert('❌ Error al generar flashcards. Verifica tu configuración de IA en AI_SETUP.md');
                });
        }
        
        // Borrar apunte
        function borrarApunte(index) {
            if (!confirm('¿Estás seguro de que deseas eliminar este apunte?')) return;
            
            library.apuntes.splice(index, 1);
            saveLibrary();
            renderApuntes();
            alert('✅ Apunte eliminado correctamente');
        }
        
        // Renderizar contenido de biblioteca
        function renderLibraryContent() {
            const container = document.getElementById('libraryContent');
            const items = library[currentLibraryCategory] || [];
            
            // Calcular totales y horas
            const totalMovies = library.peliculas?.length || 0;
            const totalSeries = library.series?.length || 0;
            const totalBooks = library.libros?.length || 0;
            const totalFlashcards = library.flashcards?.length || 0;
            
            const totalMovieHours = library.peliculas?.reduce((sum, movie) => {
                const duration = movie.duration || 0;
                const times = movie.timesWatched || 1;
                return sum + (duration * times / 60);
            }, 0) || 0;
            
            const totalSeriesHours = library.series?.reduce((sum, series) => {
                const duration = series.duration || 0;
                const times = series.timesWatched || 1;
                return sum + (duration * times / 60);
            }, 0) || 0;
            
            const totalBookHours = library.libros?.reduce((sum, book) => {
                const pages = book.pages || 0;
                const timePerPage = 1.5; // minutos por página
                return sum + (pages * timePerPage / 60);
            }, 0) || 0;
            
            // Filtrar items
            let filteredItems = items.filter(item => {
                let matchSearch = true;
                let matchLetter = true;
                let matchRating = true;
                let matchFolder = true;
                
                if (libraryFilters.search) {
                    const search = libraryFilters.search.toLowerCase();
                    matchSearch = item.title.toLowerCase().includes(search) || 
                                 (item.author && item.author.toLowerCase().includes(search));
                }
                
                if (libraryFilters.letter) {
                    matchLetter = item.title.toLowerCase().startsWith(libraryFilters.letter.toLowerCase());
                }
                
                if (libraryFilters.rating > 0) {
                    matchRating = item.rating === libraryFilters.rating;
                }
                
                if (currentLibraryCategory === 'flashcards' && libraryFilters.folder) {
                    matchFolder = (item.folder || 'General') === libraryFilters.folder;
                }
                
                return matchSearch && matchLetter && matchRating && matchFolder;
            });
            
            // Ordenar por título
            filteredItems.sort((a, b) => a.title.localeCompare(b.title));
            
            const categoryNames = {
                libros: 'Libros',
                peliculas: 'Películas',
                series: 'Series',
                flashcards: 'Flashcards'
            };
            
            let html = `
                <!-- Contador de totales - Versión mini -->
                <div style="background: linear-gradient(135deg, #fef3ff 0%, #ffe5f3 100%); padding: 8px 12px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(255, 107, 157, 0.1); display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <span style="font-size: 0.9em;">🎬</span>
                        <span style="font-weight: bold; color: #667eea; font-size: 0.85em;">${totalMovies}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <span style="font-size: 0.9em;">📺</span>
                        <span style="font-weight: bold; color: #667eea; font-size: 0.85em;">${totalSeries}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <span style="font-size: 0.9em;">📚</span>
                        <span style="font-weight: bold; color: #667eea; font-size: 0.85em;">${totalBooks}</span>
                    </div>
                    ${(totalMovieHours + totalSeriesHours + totalBookHours) > 0 ? `
                        <div style="border-left: 2px solid rgba(102, 126, 234, 0.3); padding-left: 12px; display: flex; align-items: center; gap: 4px;">
                            <span style="font-size: 0.8em;">⏱️</span>
                            <span style="color: #667eea; font-weight: 600; font-size: 0.75em;">${(totalMovieHours + totalSeriesHours + totalBookHours).toFixed(1)}h</span>
                        </div>
                    ` : ''}
                </div>
                
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 20px; margin-bottom: 20px; color: white;">
                    <h3 style="margin-bottom: 15px;">📚 ${categoryNames[currentLibraryCategory]}</h3>
                    
                    ${currentLibraryCategory === 'flashcards' ? `
                        <!-- Selector de carpetas para flashcards -->
                        <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
                            <select id="folderFilter" onchange="filterByFolder(this.value)" style="flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 0.95em;">
                                <option value="">📂 Todas las carpetas</option>
                                ${getFlashcardFolders().map(folder => 
                                    `<option value="${folder}" ${libraryFilters.folder === folder ? 'selected' : ''}>📁 ${folder}</option>`
                                ).join('')}
                            </select>
                            <button onclick="openCreateFolderModal()" style="padding: 12px 20px; background: rgba(255,255,255,0.3); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; white-space: nowrap;">➕ Carpeta</button>
                        </div>
                    ` : ''}
                    
                    <!-- Barra de búsqueda -->
                    <input type="text" id="librarySearch" placeholder="🔍 Buscar por título o autor..." 
                           style="width: 100%; padding: 12px; border: none; border-radius: 10px; font-size: 0.95em; margin-bottom: 15px;"
                           value="${libraryFilters.search}" oninput="updateLibrarySearch(this.value)">
                    
                    <!-- Filtros alfabéticos -->
                    ${currentLibraryCategory !== 'flashcards' ? `<div style="margin-bottom: 15px; overflow-x: auto; white-space: nowrap; padding: 10px 0;">
                        <button onclick="filterByLetter('')" style="padding: 8px 12px; margin: 0 5px; background: ${libraryFilters.letter === '' ? 'white' : 'rgba(255,255,255,0.3)'}; color: ${libraryFilters.letter === '' ? '#667eea' : 'white'}; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">Todas</button>
                        ${'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').map(letter => 
                            `<button onclick="filterByLetter('${letter}')" style="padding: 8px 12px; margin: 0 3px; background: ${libraryFilters.letter === letter ? 'white' : 'rgba(255,255,255,0.3)'}; color: ${libraryFilters.letter === letter ? '#667eea' : 'white'}; border: none; border-radius: 8px; cursor: pointer;">${letter}</button>`
                        ).join('')}
                    </div>` : ''}
                    
                    <!-- Filtros por rating -->
                    ${currentLibraryCategory !== 'flashcards' ? `<div style="margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;">
                        <button onclick="filterByRating(0)" style="padding: 10px 15px; background: ${libraryFilters.rating === 0 ? 'white' : 'rgba(255,255,255,0.3)'}; color: ${libraryFilters.rating === 0 ? '#667eea' : 'white'}; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; min-width: 90px;">Todas ⭐</button>
                        ${[5,4,3,2,1].map(rating => 
                            `<button onclick="filterByRating(${rating})" style="padding: 10px 15px; background: ${libraryFilters.rating === rating ? 'white' : 'rgba(255,255,255,0.3)'}; color: ${libraryFilters.rating === rating ? '#667eea' : 'white'}; border: none; border-radius: 8px; cursor: pointer; min-width: 80px;">${'⭐'.repeat(rating)}</button>`
                        ).join('')}
                    </div>` : ''}
                </div>
                
                <!-- Botón de agregar abajo -->
                <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                    <button onclick="openAddItemModal()" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 15px; font-size: 1.1em; font-weight: bold; cursor: pointer; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">
                        ➕ Agregar ${currentLibraryCategory === 'libros' ? 'Libro' : currentLibraryCategory === 'peliculas' ? 'Película' : currentLibraryCategory === 'series' ? 'Serie' : 'Flashcard'}
                    </button>
                    ${currentLibraryCategory === 'flashcards' ? `<button onclick="startFlashcardReview()" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #ff6b9d 0%, #ffa8c5 100%); color: white; border: none; border-radius: 15px; font-size: 1.1em; font-weight: bold; cursor: pointer; box-shadow: 0 4px 12px rgba(255, 107, 157, 0.3);">🧠 Repasar</button>` : ''}
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px;">
            `;
            
            if (filteredItems.length === 0) {
                html += '<p style="text-align: center; color: #a78bfa; grid-column: 1/-1; padding: 40px;">No hay elementos que mostrar. ¡Agrega uno!</p>';
            } else {
                filteredItems.forEach((item, index) => {
                    html += `
                        <div style="background: white; border-radius: 12px; padding: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; flex-direction: column; height: 100%;">
                            ${item.imageUrl ? `<img src="${item.imageUrl}" style="width: 100%; height: 140px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;">` : '<div style="width: 100%; height: 140px; background: linear-gradient(135deg, #e0e7ff, #f3e8ff); border-radius: 8px; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; color: #a78bfa;">No hay imagen</div>'}
                            <h4 style="color: #667eea; margin-bottom: 4px; font-size: 0.85em; line-height: 1.2; flex-grow: 1;">${item.title}</h4>
                            ${item.author ? `<p style="color: #a78bfa; font-size: 0.75em; margin-bottom: 6px;">por ${item.author}</p>` : ''}
                            ${currentLibraryCategory !== 'flashcards' ? `<div style="color: #fbbf24; font-size: 0.8em; margin-bottom: 6px;">${'⭐'.repeat(item.rating || 0)}${'☆'.repeat(5 - (item.rating || 0))}</div>` : ''}
                            ${currentLibraryCategory === 'peliculas' && item.duration ? `<p style="color: #6b4c9a; font-size: 0.75em; margin-bottom: 6px;">⏱️ ${item.duration}m | 👁️ ${item.timesWatched || 1}x</p>` : ''}
                            ${currentLibraryCategory === 'series' ? `
                                <div style="color: #6b4c9a; font-size: 0.75em; margin-bottom: 6px;">
                                    ${item.seasons ? `📺 S${item.seasons}` : ''}
                                    ${item.duration ? `⏱️ ${item.duration}m` : ''}
                                    ${item.timesWatched ? `👁️ ${item.timesWatched}x` : ''}
                                </div>
                            ` : ''}
                            ${currentLibraryCategory === 'libros' && item.pages ? `<p style="color: #6b4c9a; font-size: 0.75em; margin-bottom: 6px;">📄 ${item.pages}p</p>` : ''}
                            ${currentLibraryCategory === 'flashcards' && item.folder ? `<p style="color: #ff6b9d; font-size: 0.75em; margin-bottom: 6px;">📁 ${item.folder}</p>` : ''}
                            <div style="display: flex; gap: 6px; margin-top: auto;">
                                ${currentLibraryCategory === 'flashcards' ? `
                                    <button onclick="reviewSingleFlashcard(${index})" style="flex: 1; padding: 6px; background: linear-gradient(135deg, #ff6b9d 0%, #ffa8c5 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75em;">🧠</button>
                                ` : `<button onclick="viewLibraryItem(${index})" style="flex: 1; padding: 6px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75em;">👁️</button>`}
                                <button onclick="editLibraryItem(${index})" style="padding: 6px 8px; background: #a78bfa; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75em;">✏️</button>
                                <button onclick="deleteLibraryItem(${index})" style="padding: 6px 8px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75em;">🗑️</button>
                            </div>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Actualizar búsqueda
        function updateLibrarySearch(value) {
            libraryFilters.search = value;
            renderLibraryContent();
        }
        
        // Filtrar por letra
        function filterByLetter(letter) {
            libraryFilters.letter = letter;
            renderLibraryContent();
        }
        
        // Filtrar por rating
        function filterByRating(rating) {
            libraryFilters.rating = rating;
            renderLibraryContent();
        }
        
        // Abrir modal para agregar item
        function openAddItemModal(editIndex = null) {
            // Limpiar modal anterior si existe
            const existingModal = document.querySelector('.modal.show');
            if (existingModal) {
                existingModal.remove();
            }
            
            const isEditing = editIndex !== null;
            const item = isEditing ? library[currentLibraryCategory][editIndex] : null;
            const categoryName = currentLibraryCategory === 'libros' ? 'Libro' : currentLibraryCategory === 'peliculas' ? 'Película' : currentLibraryCategory === 'series' ? 'Serie' : 'Flashcard';
            
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.id = 'libraryEditModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>${isEditing ? '✏️ Editar' : '➕ Agregar'} ${categoryName}</h3>
                    </div>
                    <div class="modal-body">
                        <input type="text" id="itemTitle" placeholder="${currentLibraryCategory === 'flashcards' ? 'Pregunta *' : 'Título *'}" value="${isEditing && item ? (item.title || '') : ''}" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 15px; font-size: 0.95em;">
                        ${currentLibraryCategory === 'libros' ? `<input type="text" id="itemAuthor" placeholder="Autor *" value="${isEditing && item ? (item.author || '') : ''}" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 15px; font-size: 0.95em;">` : ''}
                        ${currentLibraryCategory === 'flashcards' ? `<textarea id="flashcardAnswer" placeholder="Respuesta *" rows="3" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 15px; font-size: 0.95em; resize: vertical;">${isEditing && item ? (item.answer || '') : ''}</textarea>` : ''}
                        ${currentLibraryCategory === 'flashcards' ? `
                            <select id="flashcardFolder" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 15px; font-size: 0.95em; background: white;">
                                ${getFlashcardFolders().length === 0 ? '<option value="General">General</option>' : getFlashcardFolders().map(folder => `<option value="${folder}" ${isEditing && item && (item.folder || 'General') === folder ? 'selected' : ''}>${folder}</option>`).join('')}
                            </select>
                        ` : ''}
                        ${currentLibraryCategory === 'flashcards' ? `<input type="url" id="flashcardImage" placeholder="URL de imagen (opcional)" value="${isEditing && item ? (item.imageUrl || '') : ''}" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 15px; font-size: 0.95em;">` : ''}
                        ${currentLibraryCategory === 'peliculas' || currentLibraryCategory === 'series' ? `<input type="url" id="itemImageUrl" placeholder="URL de imagen (opcional)" value="${isEditing && item ? (item.imageUrl || '') : ''}" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 15px; font-size: 0.95em;">` : ''}
                        ${currentLibraryCategory === 'peliculas' ? `<input type="number" id="movieDuration" placeholder="Duración en minutos" value="${isEditing && item ? (item.duration || '') : ''}" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 15px; font-size: 0.95em;">` : ''}
                        ${currentLibraryCategory === 'peliculas' ? `<input type="number" id="movieTimesWatched" placeholder="Veces vista" value="${isEditing && item ? (item.timesWatched || 1) : 1}" min="1" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 15px; font-size: 0.95em;">` : ''}
                        ${currentLibraryCategory === 'series' ? `<input type="number" id="movieDuration" placeholder="Duración en minutos" value="${isEditing && item ? (item.duration || '') : ''}" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 15px; font-size: 0.95em;">` : ''}
                        ${currentLibraryCategory === 'series' ? `<input type="number" id="seriesSeasons" placeholder="Temporada" value="${isEditing && item ? (item.seasons || 1) : 1}" min="1" max="20" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 15px; font-size: 0.95em;">` : ''}
                        ${currentLibraryCategory === 'series' ? `<input type="number" id="movieTimesWatched" placeholder="Veces vista" value="${isEditing && item ? (item.timesWatched || 1) : 1}" min="1" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 15px; font-size: 0.95em;">` : ''}
                        ${currentLibraryCategory === 'libros' ? `<input type="url" id="itemImageUrl" placeholder="URL de imagen (opcional)" value="${isEditing && item ? (item.imageUrl || '') : ''}" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 15px; font-size: 0.95em;">` : ''}
                        ${currentLibraryCategory === 'libros' ? `<input type="number" id="bookPages" placeholder="Número de páginas" value="${isEditing && item ? (item.pages || '') : ''}" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 15px; font-size: 0.95em;">` : ''}
                        ${currentLibraryCategory !== 'flashcards' ? `<textarea id="itemDescription" placeholder="Descripción breve" rows="4" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 15px; font-size: 0.95em; resize: vertical;">${isEditing && item ? (item.description || '') : ''}</textarea>` : ''}
                        ${currentLibraryCategory !== 'flashcards' ? `<div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #667eea; font-weight: bold;">Rating:</label>
                            <div id="ratingSelector" style="font-size: 2em; cursor: pointer;">
                                ${'<span onclick="selectRating(1)">☆</span><span onclick="selectRating(2)">☆</span><span onclick="selectRating(3)">☆</span><span onclick="selectRating(4)">☆</span><span onclick="selectRating(5)">☆</span>'}
                            </div>
                        </div>` : ''}
                    </div>
                    <div style="display: flex; gap: 10px; padding: 20px;">
                        <button onclick="saveLibraryItem(${editIndex})" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 15px; font-size: 1.1em; font-weight: bold; cursor: pointer;">Guardar</button>
                        <button onclick="closeLibraryModal()" style="padding: 15px 20px; background: #e5e7eb; color: #6b7280; border: none; border-radius: 15px; cursor: pointer;">Cancelar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            window.currentItemRating = isEditing && item ? (item.rating || 0) : 0;
            
            // Si estamos editando, mostrar las estrellas correctamente
            if (isEditing && item && item.rating) {
                setTimeout(() => selectRating(item.rating), 50);
            }
        }
        
        // Seleccionar rating
        function selectRating(rating) {
            window.currentItemRating = rating;
            const stars = document.querySelectorAll('#ratingSelector span');
            stars.forEach((star, index) => {
                star.textContent = index < rating ? '⭐' : '☆';
            });
        }
        
        // Guardar item de biblioteca
        function saveLibraryItem(editIndex = null) {
            const title = document.getElementById('itemTitle').value.trim();
            const author = document.getElementById('itemAuthor')?.value.trim() || '';
            const imageUrl = document.getElementById('itemImageUrl')?.value.trim() || '';
            const description = document.getElementById('itemDescription')?.value.trim() || '';
            const answer = document.getElementById('flashcardAnswer')?.value.trim() || '';
            const folder = document.getElementById('flashcardFolder')?.value.trim() || 'General';
            const flashcardImage = document.getElementById('flashcardImage')?.value.trim() || '';
            const duration = document.getElementById('movieDuration')?.value || 0;
            const timesWatched = document.getElementById('movieTimesWatched')?.value || 1;
            const pages = document.getElementById('bookPages')?.value || 0;
            const seasons = document.getElementById('seriesSeasons')?.value || 1;
            const rating = window.currentItemRating || 0;
            
            console.log('💾 Guardando item en categoría:', currentLibraryCategory);
            console.log('📝 Título:', title);
            console.log('📝 Respuesta:', answer);
            console.log('📝 Carpeta:', folder);
            
            if (!title) {
                alert('⚠️ Por favor ingresa ' + (currentLibraryCategory === 'flashcards' ? 'una pregunta' : 'un título'));
                return;
            }
            
            if (currentLibraryCategory === 'libros' && !author) {
                alert('⚠️ Por favor ingresa el autor del libro');
                return;
            }
            
            if (currentLibraryCategory === 'flashcards' && !answer) {
                alert('⚠️ Por favor ingresa la respuesta');
                return;
            }
            
            // Asegurar que la categoría existe
            if (!library[currentLibraryCategory]) {
                library[currentLibraryCategory] = [];
                console.log('🆕 Creando categoría:', currentLibraryCategory);
            }
            
            const item = {
                title,
                author,
                imageUrl: currentLibraryCategory === 'flashcards' ? flashcardImage : imageUrl,
                description,
                answer,
                folder,
                duration: parseInt(duration) || 0,
                timesWatched: parseInt(timesWatched) || 1,
                pages: parseInt(pages) || 0,
                seasons: parseInt(seasons) || 1,
                rating,
                dateAdded: editIndex !== null ? library[currentLibraryCategory][editIndex].dateAdded : new Date().toISOString(),
                // Sistema de repetición espaciada para flashcards
                nextReview: currentLibraryCategory === 'flashcards' ? (editIndex !== null ? library[currentLibraryCategory][editIndex].nextReview : new Date().toISOString()) : null,
                interval: currentLibraryCategory === 'flashcards' ? (editIndex !== null ? library[currentLibraryCategory][editIndex].interval : 0) : null,
                easeFactor: currentLibraryCategory === 'flashcards' ? (editIndex !== null ? library[currentLibraryCategory][editIndex].easeFactor : 2.5) : null
            };
            
            if (editIndex !== null) {
                // Editar item existente
                library[currentLibraryCategory][editIndex] = item;
                console.log('✏️ Item editado');
            } else {
                // Agregar nuevo item
                library[currentLibraryCategory].push(item);
                console.log('➕ Item agregado. Total:', library[currentLibraryCategory].length);
            }
            
            saveLibrary();
            closeLibraryModal();
            renderLibraryContent();
            console.log('✅ Item guardado exitosamente');
        }
        
        // Editar item de biblioteca
        function editLibraryItem(index) {
            openAddItemModal(index);
        }
        
        // Ver detalle de item
        function viewLibraryItem(index) {
            const item = library[currentLibraryCategory][index];
            
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>${item.title}</h3>
                    </div>
                    <div class="modal-body">
                        ${item.imageUrl ? `<img src="${item.imageUrl}" style="width: 100%; max-height: 300px; object-fit: cover; border-radius: 10px; margin-bottom: 15px;">` : ''}
                        ${item.author ? `<p style="color: #a78bfa; font-size: 1.1em; margin-bottom: 10px;"><strong>Autor:</strong> ${item.author}</p>` : ''}
                        <div style="color: #fbbf24; font-size: 1.5em; margin-bottom: 15px;">${'⭐'.repeat(item.rating || 0)}${'☆'.repeat(5 - (item.rating || 0))}</div>
                        ${item.description ? `<p style="color: #4b5563; line-height: 1.6; margin-bottom: 15px;">${item.description}</p>` : ''}
                        <p style="color: #9ca3af; font-size: 0.85em;">Agregado el ${new Date(item.dateAdded).toLocaleDateString()}</p>
                    </div>
                    <button onclick="closeLibraryModal()" class="modal-close">✕ Cerrar</button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Eliminar item
        function deleteLibraryItem(index) {
            if (confirm('¿Estás seguro de eliminar este elemento?')) {
                library[currentLibraryCategory].splice(index, 1);
                saveLibrary();
                renderLibraryContent();
            }
        }
        
        // Cerrar modal de biblioteca
        function closeLibraryModal() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (modal.querySelector('#itemTitle') || modal.querySelector('.modal-header h3')) {
                    modal.remove();
                }
            });
        }

        // ===== CALENDARIO DE EJERCICIO SEMANAL =====
        
        // Cargar plan de ejercicios desde localStorage
        let exercisePlan = JSON.parse(localStorage.getItem('exercisePlan')) || {
            0: { muscle: 'Glúteo', icon: '🍑', color: '#ff6b9d', exercises: [] },
            1: { muscle: 'Lunes', icon: '💪', color: '#667eea', exercises: [] },
            2: { muscle: 'Martes', icon: '💪', color: '#4facfe', exercises: [] },
            3: { muscle: 'Miércoles', icon: '💪', color: '#f093fb', exercises: [] },
            4: { muscle: 'Jueves', icon: '💪', color: '#ffd89b', exercises: [] },
            5: { muscle: 'Viernes', icon: '💪', color: '#a8edea', exercises: [] },
            6: { muscle: 'Sábado', icon: '💪', color: '#ffeaa7', exercises: [] }
        };
        
        // Historial de entrenamientos
        let workoutHistory = JSON.parse(localStorage.getItem('workoutHistory')) || {};
        
        function saveExercisePlan() {
            localStorage.setItem('exercisePlan', JSON.stringify(exercisePlan));
            localStorage.setItem('workoutHistory', JSON.stringify(workoutHistory));
        }
        
        function renderExerciseCalendar() {
            const container = document.getElementById('exerciseCalendar');
            const todayMuscleDiv = document.getElementById('todayMuscle');
            const today = new Date().getDay(); // 0 = Domingo
            
            // Actualizar el texto de "Hoy te toca"
            if (todayMuscleDiv) {
                todayMuscleDiv.textContent = `${exercisePlan[today].muscle} ${exercisePlan[today].icon}`;
            }
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px;">';
            
            const days = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
            
            for (let i = 0; i < 7; i++) {
                const plan = exercisePlan[i];
                const isToday = i === today;
                const exerciseCount = plan.exercises?.length || 0;
                
                html += `
                    <div style="
                        background: ${isToday ? `linear-gradient(135deg, ${plan.color} 0%, ${plan.color}dd 100%)` : 'linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%)'};
                        padding: 15px;
                        border-radius: 15px;
                        text-align: center;
                        box-shadow: ${isToday ? '0 8px 20px rgba(0,0,0,0.2)' : '0 2px 5px rgba(0,0,0,0.1)'};
                        transform: ${isToday ? 'scale(1.05)' : 'scale(1)'};
                        transition: all 0.3s ease;
                        border: ${isToday ? '3px solid white' : 'none'};
                        cursor: pointer;
                    " onclick="openDayExercises(${i})">
                        <div style="font-size: 2em; margin-bottom: 8px;">${plan.icon}</div>
                        <div style="font-weight: bold; font-size: 1em; color: ${isToday ? 'white' : '#6b7280'}; margin-bottom: 5px;">${days[i]}</div>
                        <div style="font-size: 1.1em; font-weight: 700; color: ${isToday ? 'white' : plan.color}; margin-bottom: 8px;">${plan.muscle}</div>
                        <div style="font-size: 0.85em; color: ${isToday ? 'rgba(255,255,255,0.9)' : '#9ca3af'}; margin-bottom: 8px;">${exerciseCount} ejercicio${exerciseCount !== 1 ? 's' : ''}</div>
                        <button onclick="event.stopPropagation(); editDayMuscle(${i})" style="background: rgba(255,255,255,${isToday ? '0.3' : '0.5'}); border: none; border-radius: 8px; padding: 5px 10px; font-size: 0.8em; color: ${isToday ? 'white' : '#6b7280'}; cursor: pointer; font-weight: 600;">✏️ Editar</button>
                        ${isToday ? '<div style="margin-top: 8px; padding: 6px; background: rgba(255,255,255,0.3); border-radius: 8px; color: white; font-weight: 600; font-size: 0.85em;">¡HOY!</div>' : ''}
                    </div>
                `;
            }
            
            html += '</div>';
            
            // Mensaje motivacional
            html += `
                <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #fef3ff 0%, #ffe5f3 100%); border-radius: 15px; text-align: center;">
                    <p style="color: #ff6b9d; font-weight: 600; margin: 0;">💪 ${exercisePlan[today].muscle} hoy - ¡Tú puedes!</p>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // Editar músculo del día
        function editDayMuscle(dayIndex) {
            const day = exercisePlan[dayIndex];
            const dayNames = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
            
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3>✏️ Editar ${dayNames[dayIndex]}</h3>
                    </div>
                    <div class="modal-body">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Grupo muscular:</label>
                        <input type="text" id="muscleName" value="${day.muscle}" placeholder="Ej: Glúteo, Pierna, Pecho..." style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 15px; font-size: 1em;">
                        
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Icono:</label>
                        <select id="muscleIcon" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 15px; font-size: 1.5em; background: white;">
                            <option value="🍑" ${day.icon === '🍑' ? 'selected' : ''}>🍑 Glúteo</option>
                            <option value="🦵" ${day.icon === '🦵' ? 'selected' : ''}>🦵 Pierna</option>
                            <option value="💪" ${day.icon === '💪' ? 'selected' : ''}>💪 Brazo</option>
                            <option value="🏋️" ${day.icon === '🏋️' ? 'selected' : ''}>🏋️ Pecho</option>
                            <option value="🔙" ${day.icon === '🔙' ? 'selected' : ''}>🔙 Espalda</option>
                            <option value="🤸" ${day.icon === '🤸' ? 'selected' : ''}>🤸 Core</option>
                            <option value="🧘" ${day.icon === '🧘' ? 'selected' : ''}>🧘 Flexibilidad</option>
                            <option value="🏃" ${day.icon === '🏃' ? 'selected' : ''}>🏃 Cardio</option>
                            <option value="🚴" ${day.icon === '🚴' ? 'selected' : ''}>🚴 Ciclismo</option>
                            <option value="🏊" ${day.icon === '🏊' ? 'selected' : ''}>🏊 Natación</option>
                        </select>
                        
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Color:</label>
                        <input type="color" id="muscleColor" value="${day.color}" style="width: 100%; height: 50px; border: 2px solid #e5e7eb; border-radius: 10px; cursor: pointer;">
                    </div>
                    <div style="display: flex; gap: 10px; padding: 20px;">
                        <button onclick="saveDayMuscle(${dayIndex})" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 15px; font-size: 1.1em; font-weight: bold; cursor: pointer;">Guardar</button>
                        <button onclick="closeDayMuscleModal()" style="padding: 15px 20px; background: #e5e7eb; color: #6b7280; border: none; border-radius: 15px; cursor: pointer;">Cancelar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function saveDayMuscle(dayIndex) {
            const muscle = document.getElementById('muscleName').value.trim();
            const icon = document.getElementById('muscleIcon').value;
            const color = document.getElementById('muscleColor').value;
            
            if (!muscle) {
                alert('⚠️ Por favor ingresa el grupo muscular');
                return;
            }
            
            exercisePlan[dayIndex].muscle = muscle;
            exercisePlan[dayIndex].icon = icon;
            exercisePlan[dayIndex].color = color;
            
            saveExercisePlan();
            renderExerciseCalendar();
            closeDayMuscleModal();
        }
        
        function closeDayMuscleModal() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (modal.querySelector('#muscleName')) {
                    modal.remove();
                }
            });
        }
        
        // Abrir vista de ejercicios del día
        function openDayExercises(dayIndex) {
            const day = exercisePlan[dayIndex];
            const dayNames = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
            const today = new Date().getDay();
            const isToday = dayIndex === today;
            
            if (!day.exercises) day.exercises = [];
            
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.style.zIndex = '10000';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 650px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header" style="background: linear-gradient(135deg, ${day.color} 0%, ${day.color}dd 100%); color: white;">
                        <h3>${day.icon} ${dayNames[dayIndex]} - ${day.muscle}</h3>
                        ${isToday ? '<div style="background: rgba(255,255,255,0.3); padding: 5px 12px; border-radius: 20px; font-size: 0.9em; margin-top: 8px;">📅 Hoy</div>' : ''}
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 20px;">
                            <button onclick="addExerciseToDay(${dayIndex})" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 15px; font-size: 1em; font-weight: bold; cursor: pointer;">➕ Agregar Ejercicio</button>
                        </div>
                        
                        <div id="exercisesList${dayIndex}"></div>
                        
                        ${day.exercises.length === 0 ? `
                            <div style="text-align: center; padding: 40px 20px; color: #9ca3af;">
                                <div style="font-size: 3em; margin-bottom: 10px;">🏋️</div>
                                <p>No hay ejercicios programados</p>
                                <p style="font-size: 0.9em;">Agrega ejercicios para este día</p>
                            </div>
                        ` : ''}
                    </div>
                    <div style="padding: 20px;">
                        <button onclick="closeDayExercisesModal()" style="width: 100%; padding: 15px; background: #e5e7eb; color: #6b7280; border: none; border-radius: 15px; font-size: 1em; cursor: pointer;">Cerrar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            renderDayExercises(dayIndex);
        }
        
        function renderDayExercises(dayIndex) {
            const container = document.getElementById(`exercisesList${dayIndex}`);
            if (!container) return;
            
            const day = exercisePlan[dayIndex];
            const exercises = day.exercises || [];
            
            if (exercises.length === 0) return;
            
            let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';
            
            exercises.forEach((exercise, index) => {
                const history = workoutHistory[`${dayIndex}-${index}`] || [];
                const lastWorkout = history.length > 0 ? history[history.length - 1] : null;
                
                // Calcular si debe aumentar peso (3 semanas = 21 días)
                let shouldIncreaseWeight = false;
                if (lastWorkout) {
                    const daysSinceLastIncrease = Math.floor((Date.now() - (lastWorkout.lastWeightIncrease || lastWorkout.date)) / (1000 * 60 * 60 * 24));
                    shouldIncreaseWeight = daysSinceLastIncrease >= 21;
                }
                
                html += `
                    <div style="background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); padding: 15px; border-radius: 12px; border-left: 4px solid ${day.color};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <div style="font-weight: bold; font-size: 1.1em; color: #1f2937; margin-bottom: 5px;">${exercise.name}</div>
                                ${exercise.notes ? `<div style="font-size: 0.9em; color: #6b7280; margin-bottom: 8px;">📝 ${exercise.notes}</div>` : ''}
                                <div style="display: flex; gap: 15px; flex-wrap: wrap; font-size: 0.95em;">
                                    <span style="color: #667eea;">🔢 ${exercise.sets} sets</span>
                                    <span style="color: #4facfe;">🔁 ${exercise.reps} reps</span>
                                    <span style="color: #f093fb;">⚖️ ${exercise.weight} kg</span>
                                </div>
                                ${lastWorkout ? `
                                    <div style="margin-top: 8px; padding: 8px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; font-size: 0.85em; color: #667eea;">
                                        📅 Última vez: ${new Date(lastWorkout.date).toLocaleDateString()} - ${lastWorkout.weight}kg
                                    </div>
                                ` : ''}
                                ${shouldIncreaseWeight ? `
                                    <div style="margin-top: 8px; padding: 8px; background: linear-gradient(135deg, #ffd89b 0%, #f093fb 100%); border-radius: 8px; font-size: 0.85em; color: white; font-weight: 600;">
                                        🔥 ¡Han pasado 3 semanas! Es hora de aumentar el peso
                                    </div>
                                ` : ''}
                            </div>
                            <div style="display: flex; gap: 5px; flex-shrink: 0;">
                                <button onclick="editExercise(${dayIndex}, ${index})" style="background: #f3f4f6; border: none; border-radius: 8px; padding: 8px 12px; cursor: pointer; font-size: 0.9em;">✏️</button>
                                <button onclick="deleteExercise(${dayIndex}, ${index})" style="background: #fee2e2; border: none; border-radius: 8px; padding: 8px 12px; cursor: pointer; font-size: 0.9em;">🗑️</button>
                            </div>
                        </div>
                        <button onclick="logWorkout(${dayIndex}, ${index})" style="width: 100%; padding: 10px; background: linear-gradient(135deg, ${day.color} 0%, ${day.color}dd 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 0.95em;">✅ Registrar realizado hoy</button>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function closeDayExercisesModal() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (modal.querySelector('[id^="exercisesList"]')) {
                    modal.remove();
                }
            });
        }
        
        // Agregar ejercicio
        function addExerciseToDay(dayIndex) {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.style.zIndex = '10001';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 450px;">
                    <div class="modal-header">
                        <h3>➕ Nuevo Ejercicio</h3>
                    </div>
                    <div class="modal-body">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Nombre del ejercicio:</label>
                        <input type="text" id="exerciseName" placeholder="Ej: Sentadilla búlgara" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 15px; font-size: 1em;">
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 0.9em;">Sets:</label>
                                <input type="number" id="exerciseSets" value="3" min="1" max="10" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1em; text-align: center;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 0.9em;">Reps:</label>
                                <input type="number" id="exerciseReps" value="12" min="1" max="50" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1em; text-align: center;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 0.9em;">Peso (kg):</label>
                                <input type="number" id="exerciseWeight" value="0" min="0" step="2.5" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1em; text-align: center;">
                            </div>
                        </div>
                        
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Notas (opcional):</label>
                        <textarea id="exerciseNotes" placeholder="Técnica, ajustes, recordatorios..." rows="3" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 0.95em; resize: vertical;"></textarea>
                    </div>
                    <div style="display: flex; gap: 10px; padding: 20px;">
                        <button onclick="saveExercise(${dayIndex}, null)" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 15px; font-size: 1.1em; font-weight: bold; cursor: pointer;">Guardar</button>
                        <button onclick="closeDynamicExerciseModal()" style="padding: 15px 20px; background: #e5e7eb; color: #6b7280; border: none; border-radius: 15px; cursor: pointer;">Cancelar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Editar ejercicio
        function editExercise(dayIndex, exerciseIndex) {
            const exercise = exercisePlan[dayIndex].exercises[exerciseIndex];
            
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.style.zIndex = '10001';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 450px;">
                    <div class="modal-header">
                        <h3>✏️ Editar Ejercicio</h3>
                    </div>
                    <div class="modal-body">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Nombre del ejercicio:</label>
                        <input type="text" id="exerciseName" value="${exercise.name}" placeholder="Ej: Sentadilla búlgara" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 15px; font-size: 1em;">
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 0.9em;">Sets:</label>
                                <input type="number" id="exerciseSets" value="${exercise.sets}" min="1" max="10" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1em; text-align: center;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 0.9em;">Reps:</label>
                                <input type="number" id="exerciseReps" value="${exercise.reps}" min="1" max="50" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1em; text-align: center;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 0.9em;">Peso (kg):</label>
                                <input type="number" id="exerciseWeight" value="${exercise.weight}" min="0" step="2.5" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1em; text-align: center;">
                            </div>
                        </div>
                        
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Notas (opcional):</label>
                        <textarea id="exerciseNotes" placeholder="Técnica, ajustes, recordatorios..." rows="3" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 0.95em; resize: vertical;">${exercise.notes || ''}</textarea>
                    </div>
                    <div style="display: flex; gap: 10px; padding: 20px;">
                        <button onclick="saveExercise(${dayIndex}, ${exerciseIndex})" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 15px; font-size: 1.1em; font-weight: bold; cursor: pointer;">Guardar</button>
                        <button onclick="closeDynamicExerciseModal()" style="padding: 15px 20px; background: #e5e7eb; color: #6b7280; border: none; border-radius: 15px; cursor: pointer;">Cancelar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function saveExercise(dayIndex, exerciseIndex) {
            const name = document.getElementById('exerciseName').value.trim();
            const sets = parseInt(document.getElementById('exerciseSets').value);
            const reps = parseInt(document.getElementById('exerciseReps').value);
            const weight = parseFloat(document.getElementById('exerciseWeight').value);
            const notes = document.getElementById('exerciseNotes').value.trim();
            
            if (!name) {
                alert('⚠️ Por favor ingresa el nombre del ejercicio');
                return;
            }
            
            const exercise = { name, sets, reps, weight, notes };
            
            if (exerciseIndex === null) {
                // Nuevo ejercicio
                if (!exercisePlan[dayIndex].exercises) exercisePlan[dayIndex].exercises = [];
                exercisePlan[dayIndex].exercises.push(exercise);
            } else {
                // Editar ejercicio existente
                exercisePlan[dayIndex].exercises[exerciseIndex] = exercise;
            }
            
            saveExercisePlan();
            renderDayExercises(dayIndex);
            renderExerciseCalendar();
            closeDynamicExerciseModal();
        }
        
        function deleteExercise(dayIndex, exerciseIndex) {
            if (confirm('¿Eliminar este ejercicio?')) {
                exercisePlan[dayIndex].exercises.splice(exerciseIndex, 1);
                saveExercisePlan();
                renderDayExercises(dayIndex);
                renderExerciseCalendar();
            }
        }
        
        function closeDynamicExerciseModal() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (modal.querySelector('#exerciseName')) {
                    modal.remove();
                }
            });
        }
        
        // Registrar entrenamiento realizado
        function logWorkout(dayIndex, exerciseIndex) {
            const exercise = exercisePlan[dayIndex].exercises[exerciseIndex];
            const key = `${dayIndex}-${exerciseIndex}`;
            
            if (!workoutHistory[key]) workoutHistory[key] = [];
            
            const lastWorkout = workoutHistory[key].length > 0 ? workoutHistory[key][workoutHistory[key].length - 1] : null;
            
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.style.zIndex = '10002';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3>✅ Registrar Entrenamiento</h3>
                        <div style="font-size: 0.9em; margin-top: 5px; opacity: 0.9;">${exercise.name}</div>
                    </div>
                    <div class="modal-body">
                        ${lastWorkout ? `
                            <div style="background: rgba(102, 126, 234, 0.1); padding: 12px; border-radius: 10px; margin-bottom: 15px;">
                                <div style="font-weight: 600; color: #667eea; margin-bottom: 5px;">📊 Última vez:</div>
                                <div style="font-size: 0.95em; color: #6b7280;">Peso: ${lastWorkout.weight}kg</div>
                            </div>
                        ` : ''}
                        
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">¿Qué peso usaste hoy?</label>
                        <input type="number" id="workoutWeight" value="${exercise.weight}" min="0" step="2.5" style="width: 100%; padding: 15px; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 15px; font-size: 1.2em; text-align: center;">
                        
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Notas de esta sesión (opcional):</label>
                        <textarea id="workoutNotes" placeholder="¿Cómo te sentiste? ¿Algún ajuste?" rows="3" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 0.95em; resize: vertical;"></textarea>
                    </div>
                    <div style="display: flex; gap: 10px; padding: 20px;">
                        <button onclick="saveWorkoutLog(${dayIndex}, ${exerciseIndex})" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%); color: white; border: none; border-radius: 15px; font-size: 1.1em; font-weight: bold; cursor: pointer;">💪 Registrar</button>
                        <button onclick="closeWorkoutModal()" style="padding: 15px 20px; background: #e5e7eb; color: #6b7280; border: none; border-radius: 15px; cursor: pointer;">Cancelar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function saveWorkoutLog(dayIndex, exerciseIndex) {
            const weight = parseFloat(document.getElementById('workoutWeight').value);
            const notes = document.getElementById('workoutNotes').value.trim();
            const key = `${dayIndex}-${exerciseIndex}`;
            
            if (!workoutHistory[key]) workoutHistory[key] = [];
            
            const lastWorkout = workoutHistory[key].length > 0 ? workoutHistory[key][workoutHistory[key].length - 1] : null;
            
            // Si el peso aumentó, actualizar fecha de último aumento
            let lastWeightIncrease = lastWorkout?.lastWeightIncrease || Date.now();
            if (!lastWorkout || weight > lastWorkout.weight) {
                lastWeightIncrease = Date.now();
            }
            
            workoutHistory[key].push({
                date: Date.now(),
                weight: weight,
                notes: notes,
                lastWeightIncrease: lastWeightIncrease
            });
            
            // Actualizar el peso del ejercicio con el último usado
            exercisePlan[dayIndex].exercises[exerciseIndex].weight = weight;
            
            saveExercisePlan();
            renderDayExercises(dayIndex);
            closeWorkoutModal();
            
            alert('✅ ¡Entrenamiento registrado! 💪');
        }
        
        function closeWorkoutModal() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (modal.querySelector('#workoutWeight')) {
                    modal.remove();
                }
            });
        }

        // ===== SISTEMA DE GESTIÓN DE IDEAS =====
        
        // Estado actual de la vista de ideas
        let currentIdeaState = 'pendientes';
        
        // Cargar ideas
        function loadIdeas() {
            const saved = localStorage.getItem('ideas');
            if (saved) {
                try {
                    const loadedIdeas = JSON.parse(saved);
                    if (loadedIdeas && typeof loadedIdeas === 'object') {
                        gameState.ideas = loadedIdeas;
                        console.log('💡 Ideas cargadas:', gameState.ideas);
                    }
                } catch (error) {
                    console.error('❌ Error al cargar ideas:', error);
                }
            }
        }
        
        // Guardar ideas
        function saveIdeas() {
            try {
                // Backup antes de guardar
                const currentIdeas = localStorage.getItem('ideas');
                if (currentIdeas) {
                    localStorage.setItem('ideas_backup', currentIdeas);
                }
                
                localStorage.setItem('ideas', JSON.stringify(gameState.ideas));
                console.log('💾 Ideas guardadas correctamente');
            } catch (error) {
                console.error('❌ Error al guardar ideas:', error);
            }
        }
        
        // Actualizar barra de contenido
        function updateContenidoBar() {
            // Asegurar que la estadística de contenido existe
            if (!gameState.stats.contenido) {
                gameState.stats.contenido = { ...STATS_CONFIG.contenido };
            }
            
            const contenidoValue = isNaN(gameState.stats.contenido.value) ? 0 : gameState.stats.contenido.value;
            const bar = document.getElementById('contenidoBar');
            const value = document.getElementById('contenidoValue');
            
            if (bar && value) {
                const displayValue = Math.round(contenidoValue);
                value.textContent = `${displayValue}%`;
                bar.style.width = `${Math.max(0, Math.min(200, contenidoValue))}%`;
                
                // Cambiar color según nivel
                if (contenidoValue >= 70) {
                    bar.className = 'stat-bar-fill stat-bar-high';
                } else if (contenidoValue >= 40) {
                    bar.className = 'stat-bar-fill stat-bar-medium';
                } else {
                    bar.className = 'stat-bar-fill stat-bar-low';
                }
            }
        }
        
        // Cambiar entre estados de ideas
        function switchIdeaState(state) {
            currentIdeaState = state;
            
            // Actualizar estilos de las pestañas
            document.querySelectorAll('.idea-state-tab').forEach((tab, index) => {
                const states = ['pendientes', 'guionada', 'grabadas', 'editadas', 'publicadas'];
                if (states[index] === state) {
                    tab.style.background = 'linear-gradient(135deg, #ffd89b 0%, #f093fb 100%)';
                    tab.style.color = 'white';
                    tab.style.boxShadow = '0 4px 15px rgba(255, 107, 157, 0.3)';
                    tab.classList.add('active');
                } else {
                    tab.style.background = 'linear-gradient(135deg, #e0e7ff 0%, #fef3ff 100%)';
                    tab.style.color = '#6b4c9a';
                    tab.style.boxShadow = '0 2px 8px rgba(167, 139, 250, 0.2)';
                    tab.classList.remove('active');
                }
            });
            
            // Renderizar ideas del estado seleccionado
            renderCurrentIdeaState();
        }
        
        // Agregar nueva idea
        function addNewIdea() {
            const input = document.getElementById('newIdeaInput');
            const percentageSelect = document.getElementById('ideaPercentage');
            const text = input.value.trim();
            const percentage = parseInt(percentageSelect.value);
            
            if (text === '') {
                alert('✏️ Por favor escribe tu idea');
                return;
            }
            
            // Asegurar que gameState.ideas existe
            if (!gameState.ideas) {
                gameState.ideas = {
                    pendientes: [],
                    guionada: [],
                    grabadas: [],
                    editadas: [],
                    publicadas: []
                };
            }
            
            // Asegurar que guionada existe en estados antiguos
            if (!gameState.ideas.guionada) {
                gameState.ideas.guionada = [];
            }
            
            const idea = {
                id: Date.now(),
                text: text,
                texto_bruto: text,
                titulo: '',
                categoria: '',
                subcategoria: '',
                sujeto: '',
                faceta: '',
                mecanismo: '',
                rareza: 1,
                tags: [],
                clasificacion_status: 'sin_clasificar',
                fingerprint: '',
                duplicada: false,
                urls_investigacion: [],
                urls_imagenes: [],
                percentage: percentage,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                status: 'pendiente'
            };
            
            gameState.ideas.pendientes.push(idea);
            
            // Asegurar que la estadística de contenido existe
            if (!gameState.stats.contenido) {
                gameState.stats.contenido = { ...STATS_CONFIG.contenido };
            }
            
            // Sumar porcentaje a la barra de contenido
            gameState.stats.contenido.value = Math.min(200, (gameState.stats.contenido.value || 0) + percentage);
            
            input.value = '';
            saveIdeas();
            saveState();
            updateContenidoBar();
            renderIdeas();
            // No llamar renderStats aquí para evitar sobrescribir contenido
            
            // Feedback visual
            alert(`✨ Idea agregada! +${percentage}% a Contenido`);
        }
        
        // Renderizar todas las ideas (actualiza la vista actual)
        function renderIdeas() {
            updateContenidoBar();
            renderCurrentIdeaState();
        }
        
        // Renderizar el estado actual de ideas
        function renderCurrentIdeaState() {
            const container = document.getElementById('ideasContainer');
            if (!container) return;
            
            container.innerHTML = '';
            let ideas = gameState.ideas[currentIdeaState] || [];
            
            if (ideas.length === 0) {
                const emptyMessages = {
                    pendientes: '💭 No hay ideas pendientes. ¡Agrega una nueva arriba!',
                    guionada: '📝 No hay ideas con guion escrito. Escribe el guion de tus ideas pendientes.',
                    grabadas: '🎥 No hay ideas grabadas aún. Graba tus ideas con guion.',
                    editadas: '✂️ No hay ideas editadas. Edita tus videos grabados.',
                    publicadas: '📤 No hay ideas publicadas. Programa tus videos editados.'
                };
                container.innerHTML = `<p style="color: #a78bfa; text-align: center; padding: 40px; font-style: italic; font-size: 1.1em;">${emptyMessages[currentIdeaState]}</p>`;
                return;
            }
            
            // Obtener orden seleccionado
            const sortOrder = document.getElementById('ideaSortOrder')?.value || 'newest';
            
            // Crear copia y ordenar según selección
            ideas = [...ideas];
            if (sortOrder === 'oldest') {
                // Más antiguas primero (orden original, las primeras son las más antiguas)
                // No hacer nada, mantener orden original
            } else {
                // Más recientes primero (invertir)
                ideas.reverse();
            }
            
            ideas.forEach((idea, displayIndex) => {
                // Calcular el índice original basado en el ordenamiento
                const originalIndex = sortOrder === 'oldest' ? displayIndex : (gameState.ideas[currentIdeaState].length - 1 - displayIndex);
                const ideaCard = createIdeaCard(idea, currentIdeaState, originalIndex);
                container.appendChild(ideaCard);
            });
        }
        
        // Crear tarjeta de idea
        function createIdeaCard(idea, section, index) {
            const card = document.createElement('div');
            card.style.cssText = `
                background: linear-gradient(135deg, #ffffff 0%, #fef3ff 100%);
                padding: 15px;
                border-radius: 15px;
                box-shadow: 0 4px 15px rgba(255, 107, 157, 0.15);
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 15px;
                transition: transform 0.3s ease;
            `;
            
            card.addEventListener('mouseenter', () => card.style.transform = 'translateY(-2px)');
            card.addEventListener('mouseleave', () => card.style.transform = 'translateY(0)');
            
            // Contenido de la idea
            const content = document.createElement('div');
            content.style.cssText = 'flex: 1; min-width: 0;';
            
            const text = document.createElement('div');
            text.textContent = idea.titulo || idea.texto_bruto || idea.text;
            text.style.cssText = 'color: #6b4c9a; font-weight: 600; margin-bottom: 5px; word-wrap: break-word;';
            
            const meta = document.createElement('div');
            meta.style.cssText = 'display: flex; gap: 10px; flex-wrap: wrap; font-size: 0.85em;';
            
            const percentage = document.createElement('span');
            percentage.textContent = `+${idea.percentage}%`;
            percentage.style.cssText = 'background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%); color: white; padding: 3px 8px; border-radius: 8px; font-weight: 600;';
            
            const date = document.createElement('span');
            date.textContent = new Date(idea.createdAt).toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
            date.style.cssText = 'color: #a78bfa;';
            
            meta.appendChild(percentage);
            meta.appendChild(date);
            
            // Badge de clasificación
            const clasificacionStatus = idea.clasificacion_status || 'sin_clasificar';
            const badgeClasificacion = document.createElement('span');
            
            if (clasificacionStatus === 'sin_clasificar') {
                badgeClasificacion.textContent = 'SIN CLASIFICAR';
                badgeClasificacion.style.cssText = 'background: #f3f4f6; color: #6b7280; padding: 3px 8px; border-radius: 8px; font-weight: 600; font-size: 0.75em;';
            } else if (clasificacionStatus === 'sugerida') {
                badgeClasificacion.textContent = 'SUGERIDA';
                badgeClasificacion.style.cssText = 'background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white; padding: 3px 8px; border-radius: 8px; font-weight: 600; font-size: 0.75em;';
            } else if (clasificacionStatus === 'confirmada') {
                badgeClasificacion.textContent = 'CONFIRMADA';
                badgeClasificacion.style.cssText = 'background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 3px 8px; border-radius: 8px; font-weight: 600; font-size: 0.75em;';
            }
            meta.appendChild(badgeClasificacion);
            
            // Badge de duplicada
            if (idea.duplicada) {
                const badgeDuplicada = document.createElement('span');
                badgeDuplicada.textContent = 'DUPLICADA';
                badgeDuplicada.style.cssText = 'background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 3px 8px; border-radius: 8px; font-weight: 600; font-size: 0.75em; animation: pulse 2s infinite;';
                meta.appendChild(badgeDuplicada);
            }
            
            // Si está editada, mostrar fecha de publicación
            if (section === 'editadas' && idea.publishDate) {
                const publishInfo = document.createElement('span');
                const pDate = new Date(idea.publishDate);
                publishInfo.textContent = `📅 ${pDate.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' })} ${pDate.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}`;
                publishInfo.style.cssText = 'color: #ff6b9d; font-weight: 600;';
                meta.appendChild(publishInfo);
            }
            
            content.appendChild(text);
            content.appendChild(meta);
            
            // Botones de acción
            const actions = document.createElement('div');
            actions.style.cssText = 'display: flex; gap: 8px; flex-shrink: 0; flex-wrap: wrap;';
            
            // Botón de clasificar (siempre disponible)
            const classifyBtn = createActionButton('🎯', () => openClassificationModal(section, index));
            classifyBtn.style.background = 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)';
            actions.appendChild(classifyBtn);
            
            // Botón de acción principal según estado
            if (section === 'pendientes') {
                const guionBtn = createActionButton('📝', () => openClassificationModal(section, index));
                actions.appendChild(guionBtn);
            } else if (section === 'guionada') {
                // Botón para VER el guion
                const viewGuionBtn = createActionButton('👁️', () => viewGuion(section, index));
                viewGuionBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                actions.appendChild(viewGuionBtn);
                
                // Botón para EDITAR el guion
                const editGuionBtn = createActionButton('✏️', () => openClassificationModal(section, index));
                actions.appendChild(editGuionBtn);
                
                // Botón para mover a grabadas
                const recordBtn = createActionButton('🎥', () => moveIdea(section, index, 'grabadas', idea.percentage));
                actions.appendChild(recordBtn);
            } else if (section === 'grabadas') {
                const editBtn = createActionButton('✂️', () => moveIdea(section, index, 'editadas', idea.percentage));
                actions.appendChild(editBtn);
            } else if (section === 'editadas') {
                const scheduleBtn = createActionButton('📅', () => scheduleIdea(section, index));
                actions.appendChild(scheduleBtn);
            }
            
            // Botón de eliminar
            const deleteBtn = createActionButton('🗑️', () => deleteIdea(section, index, idea.percentage));
            deleteBtn.style.background = 'linear-gradient(135deg, #ff6b9d 0%, #c44569 100%)';
            actions.appendChild(deleteBtn);
            
            card.appendChild(content);
            card.appendChild(actions);
            
            return card;
        }
        
        // Crear botón de acción
        function createActionButton(emoji, onClick) {
            const btn = document.createElement('button');
            btn.textContent = emoji;
            btn.style.cssText = `
                background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%);
                border: none;
                border-radius: 10px;
                width: 40px;
                height: 40px;
                font-size: 1.2em;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(167, 139, 250, 0.3);
                transition: all 0.3s ease;
            `;
            
            btn.addEventListener('mouseenter', () => {
                btn.style.transform = 'scale(1.1)';
                btn.style.boxShadow = '0 6px 20px rgba(167, 139, 250, 0.5)';
            });
            
            btn.addEventListener('mouseleave', () => {
                btn.style.transform = 'scale(1)';
                btn.style.boxShadow = '0 4px 15px rgba(167, 139, 250, 0.3)';
            });
            
            btn.addEventListener('click', onClick);
            
            return btn;
        }
        
        // Abrir modal para escribir/editar guion
        function openGuionModal(section, index) {
            const idea = gameState.ideas[section][index];
            const isEditing = idea.guion !== undefined;
            
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>📝 ${isEditing ? 'Editar' : 'Escribir'} Guion e Investigación</h3>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #667eea; font-weight: bold;">Idea:</label>
                            <p style="background: #f3f4f6; padding: 12px; border-radius: 10px; color: #6b7280;">${idea.text}</p>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #667eea; font-weight: bold;">Guion / Notas:</label>
                            <textarea id="guionText" rows="8" placeholder="Escribe tu guion aquí..." style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 0.95em; resize: vertical; font-family: inherit;">${idea.guion?.text || ''}</textarea>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #667eea; font-weight: bold;">URLs de Investigación (una por línea):</label>
                            <textarea id="guionUrls" rows="4" placeholder="https://ejemplo.com&#10;https://otro-sitio.com" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 0.95em; resize: vertical; font-family: monospace;">${idea.guion?.urls?.join('\n') || ''}</textarea>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #667eea; font-weight: bold;">URLs de Imágenes (una por línea):</label>
                            <textarea id="guionImages" rows="3" placeholder="https://imagen1.jpg&#10;https://imagen2.png" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 0.95em; resize: vertical; font-family: monospace;">${idea.guion?.images?.join('\n') || ''}</textarea>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #fef3ff 0%, #ffe5f3 100%); padding: 15px; border-radius: 10px;">
                            <p style="color: #6b4c9a; font-size: 0.9em; margin: 0;">💡 <strong>Tip:</strong> Usa este espacio para escribir tu guion completo, agregar links de investigación e imágenes que vas a usar.</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; padding: 20px;">
                        <button onclick="saveGuion('${section}', ${index})" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 15px; font-size: 1.1em; font-weight: bold; cursor: pointer;">💾 Guardar y Mover a Guionada</button>
                        <button onclick="closeGuionModal()" style="padding: 15px 20px; background: #e5e7eb; color: #6b7280; border: none; border-radius: 15px; cursor: pointer;">Cancelar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Guardar guion y mover a guionada
        function saveGuion(section, index) {
            const guionText = document.getElementById('guionText').value.trim();
            const guionUrls = document.getElementById('guionUrls').value.trim();
            const guionImages = document.getElementById('guionImages').value.trim();
            
            if (!guionText) {
                alert('⚠️ Por favor escribe al menos algo en el guion');
                return;
            }
            
            const idea = gameState.ideas[section][index];
            
            // Agregar información del guion
            idea.guion = {
                text: guionText,
                urls: guionUrls ? guionUrls.split('\n').filter(url => url.trim()) : [],
                images: guionImages ? guionImages.split('\n').filter(img => img.trim()) : [],
                updatedAt: new Date().toISOString()
            };
            
            // Si está en pendientes, moverla a guionada
            if (section === 'pendientes') {
                gameState.ideas[section].splice(index, 1);
                gameState.ideas.guionada.push(idea);
            }
            
            saveIdeas();
            closeGuionModal();
            renderCurrentIdeaState();
        }
        
        // Cerrar modal del guion
        function closeGuionModal() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (modal.querySelector('#guionText')) {
                    modal.remove();
                }
            });
        }
        
        // Ver guion como documento (estilo Word con imágenes intercaladas)
        function viewGuion(section, index) {
            const idea = gameState.ideas[section][index];
            
            if (!idea.guion) {
                alert('⚠️ Esta idea no tiene guion aún');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal show';
            
            // Procesar el texto y crear el documento
            let guionHTML = '';
            const textParts = idea.guion.text.split('\n');
            const images = idea.guion.images || [];
            
            // Crear documento con texto e imágenes intercaladas
            // Distribuir imágenes a lo largo del texto
            const imageInterval = Math.ceil(textParts.length / (images.length + 1));
            let imageIndex = 0;
            
            textParts.forEach((paragraph, i) => {
                if (paragraph.trim()) {
                    guionHTML += `<p style="margin-bottom: 15px; color: #374151; line-height: 1.8; text-align: justify;">${paragraph}</p>`;
                }
                
                // Insertar imagen cada cierto número de párrafos
                if (imageIndex < images.length && (i + 1) % imageInterval === 0) {
                    guionHTML += `
                        <div style="margin: 20px 0; text-align: center;">
                            <img src="${images[imageIndex]}" style="max-width: 100%; height: auto; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);" onerror="this.style.display='none'" />
                        </div>
                    `;
                    imageIndex++;
                }
            });
            
            // Agregar imágenes restantes al final
            while (imageIndex < images.length) {
                guionHTML += `
                    <div style="margin: 20px 0; text-align: center;">
                        <img src="${images[imageIndex]}" style="max-width: 100%; height: auto; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);" onerror="this.style.display='none'" />
                    </div>
                `;
                imageIndex++;
            }
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; margin: -20px -20px 20px -20px; border-radius: 20px 20px 0 0;">
                        <h3 style="margin: 0; color: white;">📝 ${idea.text}</h3>
                        <p style="margin: 10px 0 0 0; opacity: 0.9; font-size: 0.9em;">Última actualización: ${new Date(idea.guion.updatedAt).toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>
                    </div>
                    
                    <div class="modal-body" style="padding: 20px; background: white; font-family: 'Georgia', 'Times New Roman', serif;">
                        ${guionHTML}
                        
                        ${idea.guion.urls && idea.guion.urls.length > 0 ? `
                            <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #fef3ff 0%, #ffe5f3 100%); border-radius: 15px; border-left: 4px solid #ff6b9d;">
                                <h4 style="color: #6b4c9a; margin-bottom: 15px; font-size: 1.1em;">🔗 Enlaces de Investigación</h4>
                                ${idea.guion.urls.map(url => `
                                    <div style="margin-bottom: 10px;">
                                        <a href="${url}" target="_blank" style="color: #667eea; text-decoration: none; word-break: break-all; display: block; padding: 8px; background: white; border-radius: 8px; transition: all 0.2s;" onmouseover="this.style.background='#e0e7ff'" onmouseout="this.style.background='white'">
                                            🌐 ${url}
                                        </a>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div style="display: flex; gap: 10px; padding: 20px; background: #f9fafb; margin: 0 -20px -20px -20px; border-radius: 0 0 20px 20px;">
                        <button onclick="openGuionModal('${section}', ${index})" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;">✏️ Editar</button>
                        <button onclick="closeGuionViewModal()" style="padding: 12px 20px; background: #e5e7eb; color: #6b7280; border: none; border-radius: 12px; cursor: pointer; font-weight: 600;">Cerrar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Cerrar modal de vista del guion
        function closeGuionViewModal() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (modal.innerHTML.includes('Enlaces de Investigación') || modal.innerHTML.includes('Última actualización')) {
                    modal.remove();
                }
            });
        }
        
        // Mover idea de una sección a otra
        function moveIdea(fromSection, index, toSection, percentage) {
            const idea = gameState.ideas[fromSection][index];
            gameState.ideas[fromSection].splice(index, 1);
            gameState.ideas[toSection].push(idea);
            
            // Asegurar que la estadística de contenido existe
            if (!gameState.stats.contenido) {
                gameState.stats.contenido = { ...STATS_CONFIG.contenido };
            }
            
            // Sumar porcentaje adicional a la barra
            gameState.stats.contenido.value = Math.min(200, (gameState.stats.contenido.value || 0) + percentage);
            
            saveIdeas();
            saveState();
            updateContenidoBar();
            renderIdeas();
            // No llamar renderStats aquí para evitar sobrescribir contenido
            
            // Feedback
            const messages = {
                grabadas: '🎥 Idea marcada como grabada!',
                editadas: '✂️ Idea marcada como editada!',
                publicadas: '📤 Idea publicada!'
            };
            
            alert(`${messages[toSection]} +${percentage}% a Contenido`);
        }
        
        // Programar idea para publicación
        function scheduleIdea(section, index) {
            const idea = gameState.ideas[section][index];
            
            // Crear modal para programar
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.style.cssText = 'display: flex; justify-content: center; align-items: center;';
            
            const content = document.createElement('div');
            content.className = 'modal-content';
            content.style.cssText = 'max-width: 400px;';
            
            content.innerHTML = `
                <div class="modal-header">
                    <h3 class="modal-title">📅 Programar Publicación</h3>
                    <p class="modal-subtitle">${idea.text}</p>
                </div>
                <div style="margin: 20px 0;">
                    <label style="display: block; color: #6b4c9a; font-weight: 600; margin-bottom: 8px;">Fecha y hora de publicación:</label>
                    <input type="datetime-local" id="publishDateTime" style="width: 100%; padding: 12px; border: 2px solid #e0e7ff; border-radius: 12px; font-size: 1em;">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="confirmSchedule(${index})" style="flex: 1; background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%); border: none; border-radius: 12px; padding: 15px; font-size: 1em; font-weight: 600; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(167, 139, 250, 0.3);">✔️ Programar</button>
                    <button onclick="cancelSchedule()" style="flex: 1; background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%); border: none; border-radius: 12px; padding: 15px; font-size: 1em; font-weight: 600; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(255, 107, 157, 0.3);">✖️ Cancelar</button>
                </div>
            `;
            
            // Establecer fecha mínima (ahora)
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            const dateInput = content.querySelector('#publishDateTime');
            setTimeout(() => {
                const input = document.getElementById('publishDateTime');
                if (input) {
                    input.min = now.toISOString().slice(0, 16);
                    input.value = now.toISOString().slice(0, 16);
                }
            }, 100);
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Guardar referencia para las funciones globales
            window.currentSchedulingIndex = index;
        }
        
        // Confirmar programación
        function confirmSchedule(index) {
            const dateInput = document.getElementById('publishDateTime');
            const publishDate = dateInput.value;
            
            if (!publishDate) {
                alert('⚠️ Por favor selecciona una fecha y hora');
                return;
            }
            
            const idea = gameState.ideas.editadas[index];
            idea.publishDate = new Date(publishDate).toISOString();
            
            // Mover a publicadas
            gameState.ideas.editadas.splice(index, 1);
            gameState.ideas.publicadas.push(idea);
            
            // Asegurar que la estadística de contenido existe
            if (!gameState.stats.contenido) {
                gameState.stats.contenido = { ...STATS_CONFIG.contenido };
            }
            
            // Sumar porcentaje
            gameState.stats.contenido.value = Math.min(200, (gameState.stats.contenido.value || 0) + idea.percentage);
            
            saveIdeas();
            saveState();
            updateContenidoBar();
            renderIdeas();
            // No llamar renderStats aquí para evitar sobrescribir contenido
            
            cancelSchedule();
            alert(`🎉 Idea programada para publicarse! +${idea.percentage}% a Contenido`);
        }
        
        // Cancelar programación
        function cancelSchedule() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (modal.querySelector('#publishDateTime')) {
                    modal.remove();
                }
            });
        }
        
        // Eliminar idea
        function deleteIdea(section, index, percentage) {
            if (!confirm('⚠️ ¿Estás seguro de eliminar esta idea?')) {
                return;
            }
            
            gameState.ideas[section].splice(index, 1);
            
            // Asegurar que la estadística de contenido existe
            if (!gameState.stats.contenido) {
                gameState.stats.contenido = { ...STATS_CONFIG.contenido };
            }
            
            // Restar porcentaje de la barra (solo si no está en 0)
            const currentValue = gameState.stats.contenido.value || 0;
            gameState.stats.contenido.value = Math.max(0, currentValue - percentage);
            
            saveIdeas();
            saveState();
            updateContenidoBar();
            renderIdeas();
            // No llamar renderStats aquí para evitar sobrescribir contenido
            
            alert(`🗑️ Idea eliminada. -${percentage}% de Contenido`);
        }

        // ===== SISTEMA DE CLASIFICACIÓN Y IA =====
        
        // Normalizar texto para fingerprint
        function normalizeForFingerprint(str) {
            if (!str) return '';
            return str.toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // quitar acentos
                .trim()
                .replace(/\s+/g, '_');
        }
        
        // Generar fingerprint único
        function generateFingerprint(sujeto, faceta, mecanismo) {
            return `${normalizeForFingerprint(sujeto)}|${normalizeForFingerprint(faceta)}|${normalizeForFingerprint(mecanismo)}`;
        }
        
        // Verificar duplicados
        function checkDuplicate(fingerprint, currentId) {
            const allIdeas = [
                ...(gameState.ideas.pendientes || []),
                ...(gameState.ideas.guionada || []),
                ...(gameState.ideas.grabadas || []),
                ...(gameState.ideas.editadas || []),
                ...(gameState.ideas.publicadas || [])
            ];
            
            return allIdeas.find(idea => 
                idea.fingerprint === fingerprint && 
                idea.id !== currentId
            );
        }
        
        // Migrar ideas antiguas a nueva estructura
        function migrateIdeasToNewStructure() {
            let migrated = false;
            const allSections = ['pendientes', 'guionada', 'grabadas', 'editadas', 'publicadas'];
            
            allSections.forEach(section => {
                if (!gameState.ideas[section]) gameState.ideas[section] = [];
                
                gameState.ideas[section].forEach(idea => {
                    if (!idea.clasificacion_status) {
                        idea.clasificacion_status = 'sin_clasificar';
                        idea.categoria = '';
                        idea.subcategoria = '';
                        idea.sujeto = '';
                        idea.faceta = '';
                        idea.mecanismo = '';
                        idea.rareza = 1;
                        idea.tags = [];
                        idea.titulo = '';
                        idea.fingerprint = '';
                        idea.duplicada = false;
                        idea.texto_bruto = idea.text || '';
                        idea.urls_investigacion = idea.guion?.urls || [];
                        idea.urls_imagenes = idea.guion?.images || [];
                        idea.updatedAt = idea.createdAt;
                        migrated = true;
                    }
                });
            });
            
            if (migrated) {
                saveIdeas();
                console.log('✅ Ideas migradas a nueva estructura');
            }
        }
        
        // Abrir modal de clasificación (modificado del modal de guion)
        function openClassificationModal(section, index) {
            const idea = gameState.ideas[section][index];
            
            const facetasOpciones = [
                'historia_origen', 'funcionamiento_interno', 'casos_uso', 'comparacion',
                'tutorial_basico', 'tutorial_avanzado', 'errores_comunes', 'optimizacion',
                'curiosidades', 'impacto_social', 'evolucion_temporal', 'futuro',
                'detras_escenas', 'controversia', 'mitos_realidades', 'best_practices',
                'herramientas', 'recursos', 'comunidad', 'entrevista', 'otro'
            ];
            
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.id = 'classificationModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>🎯 Clasificar Idea</h3>
                        <p style="margin-top: 8px; opacity: 0.8; font-size: 0.9em;">${idea.texto_bruto}</p>
                    </div>
                    <div class="modal-body">
                        ${idea.clasificacion_status === 'confirmada' && idea.fingerprint ? `
                            <div style="background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%); padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
                                <div style="color: #1e40af; font-weight: 600; margin-bottom: 5px;">🔑 Fingerprint</div>
                                <code style="background: white; padding: 8px; border-radius: 5px; display: block; color: #374151; font-size: 0.85em;">${idea.fingerprint}</code>
                                ${idea.duplicada ? '<div style="color: #dc2626; font-weight: 600; margin-top: 8px;">⚠️ DUPLICADA - Ya existe una idea similar</div>' : ''}
                            </div>
                        ` : ''}
                        
                        <div style="background: linear-gradient(135deg, #fef3ff 0%, #ffe5f3 100%); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                            <h4 style="color: #6b4c9a; margin-bottom: 15px; font-size: 1.1em;">📋 Clasificación</h4>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; color: #667eea; font-weight: 600;">Categoría *</label>
                                    <input type="text" id="ideaCategoria" value="${idea.categoria || ''}" placeholder="Ej: Educación, Entretenimiento" style="width: 100%; padding: 10px; border: 2px solid #e0e7ff; border-radius: 8px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; color: #667eea; font-weight: 600;">Subcategoría</label>
                                    <input type="text" id="ideaSubcategoria" value="${idea.subcategoria || ''}" placeholder="Opcional" style="width: 100%; padding: 10px; border: 2px solid #e0e7ff; border-radius: 8px;">
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: #667eea; font-weight: 600;">Título</label>
                                <input type="text" id="ideaTitulo" value="${idea.titulo || ''}" placeholder="Título descriptivo de la idea" style="width: 100%; padding: 10px; border: 2px solid #e0e7ff; border-radius: 8px;">
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: #667eea; font-weight: 600;">Sujeto / Tema Principal *</label>
                                <input type="text" id="ideaSujeto" value="${idea.sujeto || ''}" placeholder="Ej: JavaScript, Historia de Roma, Gatos" style="width: 100%; padding: 10px; border: 2px solid #e0e7ff; border-radius: 8px;">
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; color: #667eea; font-weight: 600;">Faceta / Aspecto *</label>
                                    <select id="ideaFaceta" style="width: 100%; padding: 10px; border: 2px solid #e0e7ff; border-radius: 8px;">
                                        <option value="">Selecciona una faceta</option>
                                        ${facetasOpciones.map(f => `<option value="${f}" ${idea.faceta === f ? 'selected' : ''}>${f.replace(/_/g, ' ')}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; color: #667eea; font-weight: 600;">Rareza *</label>
                                    <select id="ideaRareza" style="width: 100%; padding: 10px; border: 2px solid #e0e7ff; border-radius: 8px;">
                                        <option value="1" ${idea.rareza === 1 ? 'selected' : ''}>1 - Común</option>
                                        <option value="2" ${idea.rareza === 2 ? 'selected' : ''}>2 - Poco común</option>
                                        <option value="3" ${idea.rareza === 3 ? 'selected' : ''}>3 - Interesante</option>
                                        <option value="4" ${idea.rareza === 4 ? 'selected' : ''}>4 - Raro</option>
                                        <option value="5" ${idea.rareza === 5 ? 'selected' : ''}>5 - Único</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: #667eea; font-weight: 600;">Mecanismo / Formato *</label>
                                <input type="text" id="ideaMecanismo" value="${idea.mecanismo || ''}" placeholder="Ej: tutorial_interactivo, storytelling, documental" style="width: 100%; padding: 10px; border: 2px solid #e0e7ff; border-radius: 8px;">
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: #667eea; font-weight: 600;">Tags (separados por coma)</label>
                                <input type="text" id="ideaTags" value="${(idea.tags || []).join(', ')}" placeholder="Ej: programación, web, principiantes" style="width: 100%; padding: 10px; border: 2px solid #e0e7ff; border-radius: 8px;">
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-top: 15px;">
                                <button onclick="suggestClassification('${section}', ${index})" style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 10px; padding: 12px; font-weight: 600; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">🤖 Sugerir Clasificación (IA)</button>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #667eea; font-weight: bold;">📝 Guion / Notas:</label>
                            <textarea id="guionText" rows="8" placeholder="Escribe tu guion aquí..." style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 0.95em; resize: vertical; font-family: inherit;">${idea.guion?.text || ''}</textarea>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #667eea; font-weight: bold;">🔗 URLs de Investigación (una por línea):</label>
                            <textarea id="guionUrls" rows="4" placeholder="https://ejemplo.com&#10;https://otro-sitio.com" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 0.95em; resize: vertical; font-family: monospace;">${(idea.urls_investigacion || idea.guion?.urls || []).join('\n')}</textarea>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #667eea; font-weight: bold;">🖼️ URLs de Imágenes (una por línea):</label>
                            <textarea id="guionImages" rows="3" placeholder="https://imagen1.jpg&#10;https://imagen2.png" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 0.95em; resize: vertical; font-family: monospace;">${(idea.urls_imagenes || idea.guion?.images || []).join('\n')}</textarea>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; padding: 20px;">
                        <button onclick="saveClassification('${section}', ${index}, false)" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%); color: white; border: none; border-radius: 15px; font-size: 1em; font-weight: bold; cursor: pointer;">💾 Guardar</button>
                        <button onclick="saveClassification('${section}', ${index}, true)" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 15px; font-size: 1em; font-weight: bold; cursor: pointer;">✅ Confirmar Clasificación</button>
                        <button onclick="closeClassificationModal()" style="padding: 15px 20px; background: #e5e7eb; color: #6b7280; border: none; border-radius: 15px; cursor: pointer;">Cancelar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Guardar clasificación
        function saveClassification(section, index, confirm) {
            const idea = gameState.ideas[section][index];
            
            // Obtener valores del formulario
            const categoria = document.getElementById('ideaCategoria').value.trim();
            const subcategoria = document.getElementById('ideaSubcategoria').value.trim();
            const titulo = document.getElementById('ideaTitulo').value.trim();
            const sujeto = document.getElementById('ideaSujeto').value.trim();
            const faceta = document.getElementById('ideaFaceta').value;
            const mecanismo = document.getElementById('ideaMecanismo').value.trim();
            const rareza = parseInt(document.getElementById('ideaRareza').value);
            const tagsText = document.getElementById('ideaTags').value.trim();
            const tags = tagsText ? tagsText.split(',').map(t => t.trim()).filter(t => t) : [];
            const guionText = document.getElementById('guionText').value.trim();
            const guionUrls = document.getElementById('guionUrls').value.trim();
            const guionImages = document.getElementById('guionImages').value.trim();
            
            // Validar campos requeridos solo si se confirma
            if (confirm) {
                if (!categoria || !sujeto || !faceta || !mecanismo) {
                    alert('⚠️ Por favor completa todos los campos marcados con * antes de confirmar');
                    return;
                }
                
                // Generar fingerprint
                const fingerprint = generateFingerprint(sujeto, faceta, mecanismo);
                
                // Verificar duplicados
                const duplicate = checkDuplicate(fingerprint, idea.id);
                if (duplicate) {
                    const continuar = confirm(`⚠️ YA EXISTE UNA IDEA SIMILAR:\n\nTítulo: ${duplicate.titulo || duplicate.texto_bruto}\nSujeto: ${duplicate.sujeto}\nFaceta: ${duplicate.faceta}\nMecanismo: ${duplicate.mecanismo}\n\n¿Deseas marcar esta idea como duplicada y continuar?`);
                    
                    if (!continuar) return;
                    idea.duplicada = true;
                } else {
                    idea.duplicada = false;
                }
                
                idea.fingerprint = fingerprint;
                idea.clasificacion_status = 'confirmada';
            } else {
                idea.clasificacion_status = sujeto && faceta && mecanismo ? 'sugerida' : 'sin_clasificar';
            }
            
            // Actualizar idea
            idea.categoria = categoria;
            idea.subcategoria = subcategoria;
            idea.titulo = titulo;
            idea.sujeto = sujeto;
            idea.faceta = faceta;
            idea.mecanismo = mecanismo;
            idea.rareza = rareza;
            idea.tags = tags;
            idea.updatedAt = new Date().toISOString();
            idea.urls_investigacion = guionUrls ? guionUrls.split('\n').filter(url => url.trim()) : [];
            idea.urls_imagenes = guionImages ? guionImages.split('\n').filter(img => img.trim()) : [];
            
            // Actualizar guion
            if (guionText) {
                idea.guion = {
                    text: guionText,
                    urls: idea.urls_investigacion,
                    images: idea.urls_imagenes,
                    updatedAt: new Date().toISOString()
                };
                
                // Si está en pendientes y tiene guion, moverla a guionada
                if (section === 'pendientes') {
                    gameState.ideas[section].splice(index, 1);
                    gameState.ideas.guionada.push(idea);
                }
            }
            
            saveIdeas();
            closeClassificationModal();
            renderCurrentIdeaState();
            
            if (confirm) {
                alert('✅ Clasificación confirmada' + (idea.duplicada ? ' (marcada como duplicada)' : ''));
            }
        }
        
        // Cerrar modal de clasificación
        function closeClassificationModal() {
            const modal = document.getElementById('classificationModal');
            if (modal) modal.remove();
        }
        
        // Sugerir clasificación con IA (stub simulado)
        async function suggestClassification(section, index) {
            const idea = gameState.ideas[section][index];
            const button = event.target;
            button.disabled = true;
            button.textContent = '🤖 Analizando...';
            
            try {
                // Simular llamada a API (stub)
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Respuesta simulada
                const suggestion = {
                    categoria: idea.texto_bruto.toLowerCase().includes('javascript') || idea.texto_bruto.toLowerCase().includes('código') ? 'Educación' : 'Entretenimiento',
                    subcategoria: 'Tutorial',
                    sujeto: idea.texto_bruto.split(' ').slice(0, 3).join(' '),
                    faceta: 'tutorial_basico',
                    mecanismo: 'video_explicativo',
                    rareza: 3,
                    tags: ['video', 'tutorial', 'educación'],
                    titulo: 'Cómo ' + idea.texto_bruto.toLowerCase().substring(0, 50)
                };
                
                // Llenar formulario
                document.getElementById('ideaCategoria').value = suggestion.categoria;
                document.getElementById('ideaSubcategoria').value = suggestion.subcategoria;
                document.getElementById('ideaTitulo').value = suggestion.titulo;
                document.getElementById('ideaSujeto').value = suggestion.sujeto;
                document.getElementById('ideaFaceta').value = suggestion.faceta;
                document.getElementById('ideaMecanismo').value = suggestion.mecanismo;
                document.getElementById('ideaRareza').value = suggestion.rareza;
                document.getElementById('ideaTags').value = suggestion.tags.join(', ');
                
                alert('✨ Clasificación sugerida por IA. Revisa y ajusta si es necesario.');
            } catch (error) {
                alert('❌ Error al obtener sugerencia: ' + error.message);
            } finally {
                button.disabled = false;
                button.textContent = '🤖 Sugerir Clasificación (IA)';
            }
        }
        
        // Abrir modal de generación de ideas
        function openGenerateIdeasModal() {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.id = 'generateIdeasModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>🤖 Generar Ideas con IA</h3>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #667eea; font-weight: 600;">Categoría Objetivo *</label>
                            <input type="text" id="genCategoria" placeholder="Ej: Educación, Entretenimiento" style="width: 100%; padding: 10px; border: 2px solid #e0e7ff; border-radius: 8px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #667eea; font-weight: 600;">Sujeto Específico (opcional)</label>
                            <input type="text" id="genSujeto" placeholder="Deja vacío para ideas variadas" style="width: 100%; padding: 10px; border: 2px solid #e0e7ff; border-radius: 8px;">
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #667eea; font-weight: 600;">Cantidad</label>
                                <select id="genCantidad" style="width: 100%; padding: 10px; border: 2px solid #e0e7ff; border-radius: 8px;">
                                    <option value="5">5 ideas</option>
                                    <option value="10" selected>10 ideas</option>
                                    <option value="20">20 ideas</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #667eea; font-weight: 600;">Rareza Mínima</label>
                                <select id="genRareza" style="width: 100%; padding: 10px; border: 2px solid #e0e7ff; border-radius: 8px;">
                                    <option value="1">1 - Cualquiera</option>
                                    <option value="2">2 - Poco común</option>
                                    <option value="3" selected>3 - Interesante</option>
                                    <option value="4">4 - Raro</option>
                                    <option value="5">5 - Único</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="genEvitarRepeticion" checked style="width: 20px; height: 20px; cursor: pointer;">
                                <span style="color: #667eea; font-weight: 600;">No repetir facetas/mecanismos ya usados</span>
                            </label>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #fef3ff 0%, #ffe5f3 100%); padding: 15px; border-radius: 10px;">
                            <p style="color: #6b4c9a; font-size: 0.9em; margin: 0;">💡 <strong>Tip:</strong> La IA analizará tu base de ideas existentes para evitar duplicados y sugerir contenido original.</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; padding: 20px;">
                        <button onclick="generateIdeasAI()" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 15px; font-size: 1.1em; font-weight: bold; cursor: pointer;">✨ Generar Ideas</button>
                        <button onclick="closeGenerateIdeasModal()" style="padding: 15px 20px; background: #e5e7eb; color: #6b7280; border: none; border-radius: 15px; cursor: pointer;">Cancelar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Cerrar modal de generación
        function closeGenerateIdeasModal() {
            const modal = document.getElementById('generateIdeasModal');
            if (modal) modal.remove();
        }
        
        // Generar ideas con IA (stub simulado)
        async function generateIdeasAI() {
            const categoria = document.getElementById('genCategoria').value.trim();
            const sujeto = document.getElementById('genSujeto').value.trim();
            const cantidad = parseInt(document.getElementById('genCantidad').value);
            const rarezaMinima = parseInt(document.getElementById('genRareza').value);
            const evitarRepeticion = document.getElementById('genEvitarRepeticion').checked;
            
            if (!categoria) {
                alert('⚠️ Por favor ingresa una categoría');
                return;
            }
            
            const button = event.target;
            button.disabled = true;
            button.textContent = '🤖 Generando...';
            
            try {
                // Construir contexto anti-repetición
                const contexto = buildAntiRepetitionContext(categoria, sujeto, evitarRepeticion);
                
                // Simular llamada a API
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // Generar ideas simuladas
                const ideasGeneradas = [];
                for (let i = 0; i < cantidad; i++) {
                    const ideaSample = {
                        sujeto: sujeto || `Tema ${i + 1} de ${categoria}`,
                        faceta: ['tutorial_basico', 'historia_origen', 'casos_uso', 'curiosidades'][i % 4],
                        mecanismo: ['video_explicativo', 'storytelling', 'infografia', 'documental'][i % 4],
                        idea_resumen: `Idea interesante sobre ${sujeto || categoria} - aspecto ${i + 1}`,
                        categoria: categoria,
                        subcategoria: '',
                        rareza: Math.max(rarezaMinima, Math.floor(Math.random() * 3) + 2),
                        tags: [categoria.toLowerCase(), 'ia', 'generado'],
                        titulo: `${sujeto || categoria}: Aspecto ${i + 1}`
                    };
                    ideasGeneradas.push(ideaSample);
                }
                
                // Guardar ideas generadas
                let ideasGuardadas = 0;
                ideasGeneradas.forEach(ideaData => {
                    const fingerprint = generateFingerprint(ideaData.sujeto, ideaData.faceta, ideaData.mecanismo);
                    const isDuplicate = checkDuplicate(fingerprint, null);
                    
                    const nuevaIdea = {
                        id: Date.now() + Math.random(),
                        texto_bruto: ideaData.idea_resumen,
                        titulo: ideaData.titulo,
                        categoria: ideaData.categoria,
                        subcategoria: ideaData.subcategoria,
                        sujeto: ideaData.sujeto,
                        faceta: ideaData.faceta,
                        mecanismo: ideaData.mecanismo,
                        rareza: ideaData.rareza,
                        tags: ideaData.tags,
                        clasificacion_status: 'sugerida',
                        fingerprint: fingerprint,
                        duplicada: isDuplicate ? true : false,
                        percentage: 2,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        urls_investigacion: [],
                        urls_imagenes: [],
                        status: 'pendiente'
                    };
                    
                    gameState.ideas.pendientes.push(nuevaIdea);
                    ideasGuardadas++;
                });
                
                saveIdeas();
                closeGenerateIdeasModal();
                renderCurrentIdeaState();
                
                alert(`✨ ${ideasGuardadas} ideas generadas exitosamente!\n${ideasGeneradas.filter((_, i) => gameState.ideas.pendientes[gameState.ideas.pendientes.length - cantidad + i].duplicada).length} ideas marcadas como posibles duplicadas.`);
                
            } catch (error) {
                alert('❌ Error al generar ideas: ' + error.message);
            } finally {
                button.disabled = false;
                button.textContent = '✨ Generar Ideas';
            }
        }
        
        // Construir contexto anti-repetición
        function buildAntiRepetitionContext(categoria, sujeto, evitarRepeticion) {
            if (!evitarRepeticion) return null;
            
            const allIdeas = [
                ...(gameState.ideas.pendientes || []),
                ...(gameState.ideas.guionada || []),
                ...(gameState.ideas.grabadas || []),
                ...(gameState.ideas.editadas || []),
                ...(gameState.ideas.publicadas || [])
            ].filter(idea => idea.clasificacion_status === 'confirmada');
            
            const contexto = {
                por_sujeto: {},
                por_categoria: {}
            };
            
            // Si hay sujeto específico, recopilar sus facetas y mecanismos
            if (sujeto) {
                const ideasDelSujeto = allIdeas.filter(idea => 
                    normalizeForFingerprint(idea.sujeto) === normalizeForFingerprint(sujeto)
                );
                
                contexto.por_sujeto[sujeto] = {
                    facetas_usadas: [...new Set(ideasDelSujeto.map(i => i.faceta).filter(Boolean))],
                    mecanismos_usados: [...new Set(ideasDelSujeto.map(i => i.mecanismo).filter(Boolean))]
                };
            } else {
                // Resumir por categoría
                const ideasDeCategoria = allIdeas.filter(idea => 
                    normalizeForFingerprint(idea.categoria) === normalizeForFingerprint(categoria)
                );
                
                contexto.por_categoria[categoria] = {
                    sujetos_comunes: [...new Set(ideasDeCategoria.map(i => i.sujeto).filter(Boolean))].slice(0, 20),
                    facetas_comunes: [...new Set(ideasDeCategoria.map(i => i.faceta).filter(Boolean))].slice(0, 15)
                };
            }
            
            return contexto;
        }
        
        // ===== SISTEMA DE EXPORTACIÓN =====
        
        // Abrir menú de exportación
        function openExportMenu() {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.id = 'exportModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>📊 Exportar Ideas</h3>
                    </div>
                    <div class="modal-body">
                        <button onclick="exportCSV()" style="width: 100%; margin-bottom: 10px; padding: 15px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none; border-radius: 12px; color: white; font-weight: 600; cursor: pointer; text-align: left; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5em;">📄</span>
                            <div>
                                <div style="font-size: 1.1em;">CSV Completo</div>
                                <div style="font-size: 0.85em; opacity: 0.9;">Todas las ideas con todos los campos</div>
                            </div>
                        </button>
                        
                        <button onclick="exportResumenAntiRepeticion()" style="width: 100%; margin-bottom: 10px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 12px; color: white; font-weight: 600; cursor: pointer; text-align: left; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5em;">📋</span>
                            <div>
                                <div style="font-size: 1.1em;">Resumen Anti-Repetición</div>
                                <div style="font-size: 0.85em; opacity: 0.9;">Por categoría/sujeto → faceta+mecanismo</div>
                            </div>
                        </button>
                        
                        <button onclick="openBanlistSelector()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%); border: none; border-radius: 12px; color: white; font-weight: 600; cursor: pointer; text-align: left; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5em;">🚫</span>
                            <div>
                                <div style="font-size: 1.1em;">Banlist por Sujeto</div>
                                <div style="font-size: 0.85em; opacity: 0.9;">Combinaciones ya usadas de un tema</div>
                            </div>
                        </button>
                    </div>
                    <div style="padding: 20px;">
                        <button onclick="closeExportMenu()" style="width: 100%; padding: 12px; background: #e5e7eb; color: #6b7280; border: none; border-radius: 12px; cursor: pointer; font-weight: 600;">Cerrar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Cerrar menú de exportación
        function closeExportMenu() {
            const modal = document.getElementById('exportModal');
            if (modal) modal.remove();
        }
        
        // Exportar CSV completo
        function exportCSV() {
            const allIdeas = [
                ...gameState.ideas.pendientes.map(i => ({ ...i, estado: 'pendiente' })),
                ...gameState.ideas.guionada.map(i => ({ ...i, estado: 'guionada' })),
                ...gameState.ideas.grabadas.map(i => ({ ...i, estado: 'grabada' })),
                ...gameState.ideas.editadas.map(i => ({ ...i, estado: 'editada' })),
                ...gameState.ideas.publicadas.map(i => ({ ...i, estado: 'publicada' }))
            ];
            
            if (allIdeas.length === 0) {
                alert('⚠️ No hay ideas para exportar');
                return;
            }
            
            // Crear CSV
            const headers = ['id', 'titulo', 'texto_bruto', 'categoria', 'subcategoria', 'sujeto', 'faceta', 'mecanismo', 'rareza', 'tags', 'estado', 'clasificacion_status', 'duplicada', 'fingerprint', 'percentage', 'created_at', 'updated_at'];
            let csv = headers.join(',') + '\n';
            
            allIdeas.forEach(idea => {
                const row = [
                    idea.id,
                    `"${(idea.titulo || '').replace(/"/g, '""')}"`,
                    `"${(idea.texto_bruto || idea.text || '').replace(/"/g, '""')}"`,
                    idea.categoria || '',
                    idea.subcategoria || '',
                    idea.sujeto || '',
                    idea.faceta || '',
                    idea.mecanismo || '',
                    idea.rareza || 1,
                    `"${(idea.tags || []).join('; ')}"`,
                    idea.estado,
                    idea.clasificacion_status || 'sin_clasificar',
                    idea.duplicada || false,
                    idea.fingerprint || '',
                    idea.percentage || 0,
                    idea.createdAt || '',
                    idea.updatedAt || ''
                ];
                csv += row.join(',') + '\n';
            });
            
            // Descargar
            downloadFile(csv, `ideas-completo-${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
            alert(`✅ ${allIdeas.length} ideas exportadas a CSV`);
        }
        
        // Exportar resumen anti-repetición
        function exportResumenAntiRepeticion() {
            const allIdeas = [
                ...gameState.ideas.pendientes,
                ...gameState.ideas.guionada,
                ...gameState.ideas.grabadas,
                ...gameState.ideas.editadas,
                ...gameState.ideas.publicadas
            ].filter(idea => idea.clasificacion_status === 'confirmada');
            
            if (allIdeas.length === 0) {
                alert('⚠️ No hay ideas confirmadas para exportar');
                return;
            }
            
            // Agrupar por categoría y sujeto
            const porCategoria = {};
            
            allIdeas.forEach(idea => {
                const cat = idea.categoria || 'Sin Categoría';
                const suj = idea.sujeto || 'Sin Sujeto';
                
                if (!porCategoria[cat]) porCategoria[cat] = {};
                if (!porCategoria[cat][suj]) porCategoria[cat][suj] = {
                    facetas: new Set(),
                    mecanismos: new Set(),
                    combinaciones: new Set()
                };
                
                porCategoria[cat][suj].facetas.add(idea.faceta);
                porCategoria[cat][suj].mecanismos.add(idea.mecanismo);
                porCategoria[cat][suj].combinaciones.add(`${idea.faceta} + ${idea.mecanismo}`);
            });
            
            // Generar texto
            let texto = '═══════════════════════════════════════════════\n';
            texto += '  RESUMEN ANTI-REPETICIÓN DE IDEAS\n';
            texto += `  Generado: ${new Date().toLocaleString('es-ES')}\n`;
            texto += '═══════════════════════════════════════════════\n\n';
            
            Object.keys(porCategoria).sort().forEach(categoria => {
                texto += `\n📁 CATEGORÍA: ${categoria}\n`;
                texto += '─────────────────────────────────────────────\n';
                
                Object.keys(porCategoria[categoria]).sort().forEach(sujeto => {
                    const data = porCategoria[categoria][sujeto];
                    texto += `\n  🎯 SUJETO: ${sujeto}\n`;
                    texto += `     Facetas (${data.facetas.size}): ${[...data.facetas].join(', ')}\n`;
                    texto += `     Mecanismos (${data.mecanismos.size}): ${[...data.mecanismos].join(', ')}\n`;
                    texto += `     Combinaciones usadas (${data.combinaciones.size}):\n`;
                    [...data.combinaciones].forEach(comb => {
                        texto += `       • ${comb}\n`;
                    });
                });
            });
            
            texto += '\n═══════════════════════════════════════════════\n';
            texto += `Total de ideas confirmadas: ${allIdeas.length}\n`;
            texto += '═══════════════════════════════════════════════\n';
            
            downloadFile(texto, `resumen-anti-repeticion-${new Date().toISOString().split('T')[0]}.txt`, 'text/plain');
            alert('✅ Resumen anti-repetición exportado');
        }
        
        // Abrir selector de sujeto para banlist
        function openBanlistSelector() {
            const allIdeas = [
                ...gameState.ideas.pendientes,
                ...gameState.ideas.guionada,
                ...gameState.ideas.grabadas,
                ...gameState.ideas.editadas,
                ...gameState.ideas.publicadas
            ].filter(idea => idea.clasificacion_status === 'confirmada' && idea.sujeto);
            
            if (allIdeas.length === 0) {
                alert('⚠️ No hay ideas confirmadas con sujeto');
                return;
            }
            
            const sujetos = [...new Set(allIdeas.map(i => i.sujeto))].sort();
            
            closeExportMenu();
            
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.id = 'banlistSelectorModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>🚫 Seleccionar Sujeto para Banlist</h3>
                    </div>
                    <div class="modal-body">
                        <label style="display: block; margin-bottom: 10px; color: #667eea; font-weight: 600;">Sujeto:</label>
                        <select id="banlistSujeto" style="width: 100%; padding: 12px; border: 2px solid #e0e7ff; border-radius: 10px; font-size: 1em; margin-bottom: 20px;">
                            ${sujetos.map(s => `<option value="${s}">${s}</option>`).join('')}
                        </select>
                        
                        <p style="color: #6b7280; font-size: 0.9em;">Se exportarán todas las combinaciones de faceta + mecanismo usadas para este sujeto.</p>
                    </div>
                    <div style="display: flex; gap: 10px; padding: 20px;">
                        <button onclick="exportBanlistPorSujeto()" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;">📥 Exportar</button>
                        <button onclick="closeBanlistSelector()" style="padding: 15px 20px; background: #e5e7eb; color: #6b7280; border: none; border-radius: 12px; cursor: pointer;">Cancelar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Cerrar selector de banlist
        function closeBanlistSelector() {
            const modal = document.getElementById('banlistSelectorModal');
            if (modal) modal.remove();
        }
        
        // Exportar banlist por sujeto
        function exportBanlistPorSujeto() {
            const sujetoSeleccionado = document.getElementById('banlistSujeto').value;
            
            const ideasDelSujeto = [
                ...gameState.ideas.pendientes,
                ...gameState.ideas.guionada,
                ...gameState.ideas.grabadas,
                ...gameState.ideas.editadas,
                ...gameState.ideas.publicadas
            ].filter(idea => 
                idea.clasificacion_status === 'confirmada' && 
                idea.sujeto === sujetoSeleccionado
            );
            
            if (ideasDelSujeto.length === 0) {
                alert('⚠️ No hay ideas para este sujeto');
                return;
            }
            
            let texto = '═══════════════════════════════════════════════\n';
            texto += `  BANLIST: ${sujetoSeleccionado}\n`;
            texto += `  Generado: ${new Date().toLocaleString('es-ES')}\n`;
            texto += '═══════════════════════════════════════════════\n\n';
            texto += 'COMBINACIONES YA USADAS (EVITAR):\n';
            texto += '─────────────────────────────────────────────\n\n';
            
            const combinaciones = new Set();
            ideasDelSujeto.forEach(idea => {
                combinaciones.add(`${idea.faceta} + ${idea.mecanismo}`);
            });
            
            [...combinaciones].sort().forEach((comb, index) => {
                texto += `${index + 1}. ${comb}\n`;
            });
            
            texto += '\n═══════════════════════════════════════════════\n';
            texto += `Total de combinaciones: ${combinaciones.size}\n`;
            texto += `Total de ideas del sujeto: ${ideasDelSujeto.length}\n`;
            
            // Sugerir facetas y mecanismos no usados
            const todasFacetas = ['historia_origen', 'funcionamiento_interno', 'casos_uso', 'comparacion', 'tutorial_basico', 'tutorial_avanzado', 'errores_comunes', 'optimizacion', 'curiosidades', 'impacto_social', 'evolucion_temporal', 'futuro', 'detras_escenas', 'controversia', 'mitos_realidades', 'best_practices', 'herramientas', 'recursos', 'comunidad', 'entrevista'];
            const facetasUsadas = new Set(ideasDelSujeto.map(i => i.faceta));
            const facetasNoUsadas = todasFacetas.filter(f => !facetasUsadas.has(f));
            
            if (facetasNoUsadas.length > 0) {
                texto += `\n💡 FACETAS AÚN NO EXPLORADAS (${facetasNoUsadas.length}):\n`;
                facetasNoUsadas.forEach(f => {
                    texto += `   • ${f.replace(/_/g, ' ')}\n`;
                });
            }
            
            texto += '═══════════════════════════════════════════════\n';
            
            downloadFile(texto, `banlist-${sujetoSeleccionado.toLowerCase().replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.txt`, 'text/plain');
            closeBanlistSelector();
            alert(`✅ Banlist exportada para "${sujetoSeleccionado}"`);
        }
        
        // Función auxiliar para descargar archivos
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        // ===== SISTEMA DE BACKUP Y PERSISTENCIA =====
        
        // Exportar backup como archivo descargable
        function exportBackup() {
            const backup = {
                version: '2.0',
                date: new Date().toISOString(),
                userProfile: localStorage.getItem('userProfile'),
                gameState: localStorage.getItem('gameState'),
                selfcareCooldowns: localStorage.getItem('selfcareCooldowns'),
                library: localStorage.getItem('library'),
                exercisePlan: localStorage.getItem('exercisePlan'),
                workoutHistory: localStorage.getItem('workoutHistory'),
                emotionalData: localStorage.getItem('emotionalData')
            };
            
            const dataStr = JSON.stringify(backup, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `mi-vida-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            
            alert('✅ Backup descargado exitosamente. Guárdalo en un lugar seguro.');
            console.log('📥 Backup exportado');
        }
        
        // Importar backup desde archivo
        function importBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const backup = JSON.parse(event.target.result);
                        
                        if (!backup.version || !backup.userProfile) {
                            alert('❌ Archivo de backup inválido');
                            return;
                        }
                        
                        if (!confirm('⚠️ ¿Estás segura? Esto reemplazará todos tus datos actuales con el backup.')) {
                            return;
                        }
                        
                        // Restaurar datos
                        if (backup.userProfile) localStorage.setItem('userProfile', backup.userProfile);
                        if (backup.gameState) localStorage.setItem('gameState', backup.gameState);
                        if (backup.selfcareCooldowns) localStorage.setItem('selfcareCooldowns', backup.selfcareCooldowns);
                        if (backup.library) localStorage.setItem('library', backup.library);
                        if (backup.exercisePlan) localStorage.setItem('exercisePlan', backup.exercisePlan);
                        if (backup.workoutHistory) localStorage.setItem('workoutHistory', backup.workoutHistory);
                        if (backup.emotionalData) localStorage.setItem('emotionalData', backup.emotionalData);
                        
                        alert('✅ Backup restaurado exitosamente (incluye ejercicios y emociones). La página se recargará.');
                        location.reload();
                        
                    } catch (error) {
                        alert('❌ Error al leer el archivo de backup: ' + error.message);
                        console.error('Error al restaurar backup:', error);
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        // Recuperar desde backup automático
        function recoverFromAutoBackup() {
            const libraryBackup = localStorage.getItem('library_backup');
            const ideasBackup = localStorage.getItem('ideas_backup');
            
            if (!libraryBackup && !ideasBackup) {
                alert('❌ No hay backups automáticos disponibles');
                return;
            }
            
            let message = '🔄 Backups disponibles:\n\n';
            if (libraryBackup) message += '✓ Biblioteca\n';
            if (ideasBackup) message += '✓ Ideas\n';
            message += '\n¿Quieres recuperar estos datos? Esto reemplazará los datos actuales.';
            
            if (!confirm(message)) {
                return;
            }
            
            try {
                let recovered = false;
                
                // Recuperar biblioteca
                if (libraryBackup) {
                    localStorage.setItem('library', libraryBackup);
                    recovered = true;
                    console.log('✅ Biblioteca recuperada del backup');
                }
                
                // Recuperar ideas
                if (ideasBackup) {
                    localStorage.setItem('ideas', ideasBackup);
                    recovered = true;
                    console.log('✅ Ideas recuperadas del backup');
                }
                
                if (recovered) {
                    alert('✅ Datos recuperados exitosamente. La página se recargará.');
                    location.reload();
                } else {
                    alert('⚠️ No se pudo recuperar ningún dato');
                }
            } catch (error) {
                alert('❌ Error al recuperar datos: ' + error.message);
                console.error('Error en recuperación:', error);
            }
        }
        
        // Mostrar diagnóstico de datos
        function showDiagnostics() {
            const library = localStorage.getItem('library');
            const libraryBackup = localStorage.getItem('library_backup');
            const ideas = localStorage.getItem('ideas');
            const gameState = localStorage.getItem('gameState');
            
            let html = `
                <div class="modal show" style="z-index: 10000;">
                    <div class="modal-content" style="max-width: 700px; max-height: 80vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h3>🔍 Diagnóstico de Datos</h3>
                        </div>
                        <div class="modal-body" style="text-align: left;">
            `;
            
            // Biblioteca
            html += '<h4 style="color: #667eea; margin-top: 20px;">📚 Biblioteca</h4>';
            if (library) {
                const lib = JSON.parse(library);
                html += `<p><strong>Libros:</strong> ${lib.libros?.length || 0}</p>`;
                html += `<p><strong>Películas:</strong> ${lib.peliculas?.length || 0}</p>`;
                html += `<p><strong>Series:</strong> ${lib.series?.length || 0}</p>`;
                
                if (lib.peliculas && lib.peliculas.length > 0) {
                    html += '<details style="margin-top: 10px;"><summary style="cursor: pointer; color: #667eea; font-weight: 600;">Ver películas guardadas</summary>';
                    html += '<div style="margin-top: 10px; background: #f5f5f5; padding: 10px; border-radius: 8px; max-height: 200px; overflow-y: auto;">';
                    lib.peliculas.forEach((movie, i) => {
                        html += `<div style="margin-bottom: 10px; padding: 10px; background: white; border-radius: 5px;">
                            <strong>${i + 1}. ${movie.title}</strong><br>
                            <small>Rating: ${'⭐'.repeat(movie.rating || 0)}</small><br>
                            ${movie.description ? `<small style="color: #666;">${movie.description.substring(0, 100)}${movie.description.length > 100 ? '...' : ''}</small>` : ''}
                        </div>`;
                    });
                    html += '</div></details>';
                }
            } else {
                html += '<p style="color: red;">❌ No hay datos de biblioteca</p>';
            }
            
            // Backup de biblioteca
            html += '<h4 style="color: #ff9800; margin-top: 20px;">💾 Backup Automático de Biblioteca</h4>';
            if (libraryBackup) {
                const libBackup = JSON.parse(libraryBackup);
                html += `<p>✅ Backup disponible</p>`;
                html += `<p><strong>Películas en backup:</strong> ${libBackup.peliculas?.length || 0}</p>`;
                
                if (libBackup.peliculas && libBackup.peliculas.length > 0) {
                    html += '<details style="margin-top: 10px;"><summary style="cursor: pointer; color: #ff9800; font-weight: 600;">Ver películas en backup</summary>';
                    html += '<div style="margin-top: 10px; background: #fff3e0; padding: 10px; border-radius: 8px; max-height: 200px; overflow-y: auto;">';
                    libBackup.peliculas.forEach((movie, i) => {
                        html += `<div style="margin-bottom: 10px; padding: 10px; background: white; border-radius: 5px;">
                            <strong>${i + 1}. ${movie.title}</strong><br>
                            <small>Rating: ${'⭐'.repeat(movie.rating || 0)}</small><br>
                            ${movie.description ? `<small style="color: #666;">${movie.description.substring(0, 100)}${movie.description.length > 100 ? '...' : ''}</small>` : ''}
                        </div>`;
                    });
                    html += '</div></details>';
                }
            } else {
                html += '<p style="color: #999;">⚠️ No hay backup automático aún</p>';
            }
            
            // Ideas
            html += '<h4 style="color: #ff6b9d; margin-top: 20px;">💡 Ideas</h4>';
            if (ideas) {
                const id = JSON.parse(ideas);
                const total = (id.pendientes?.length || 0) + (id.guionada?.length || 0) + (id.grabadas?.length || 0) + (id.editadas?.length || 0) + (id.publicadas?.length || 0);
                html += `<p>Total: ${total} ideas</p>`;
            } else {
                html += '<p style="color: #999;">Sin ideas guardadas</p>';
            }
            
            html += `
                        </div>
                        <button onclick="closeDiagnostics()" style="width: 100%; margin-top: 20px; padding: 15px; background: #667eea; color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600;">✕ Cerrar</button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function closeDiagnostics() {
            const modal = document.querySelector('.modal.show');
            if (modal) modal.remove();
        }
        
        // ===================================
        // 📅 CALENDARIO
        // ===================================
        
        // Inicializar actividades si no existen
        if (!gameState.activities) {
            gameState.activities = { pending: [], completed: [] };
        }
        
        function switchCalendarView(view) {
            // Actualizar botones
            document.querySelectorAll('.calendar-view-btn').forEach(btn => {
                btn.classList.remove('active');
                if (view === 'actividades' && btn.textContent.includes('Actividades')) {
                    btn.classList.add('active');
                    btn.style.background = 'linear-gradient(135deg, #ff6b9d 0%, #ffa8c5 100%)';
                    btn.style.color = 'white';
                    btn.style.boxShadow = '0 4px 15px rgba(255, 107, 157, 0.3)';
                } else if (view === 'videos' && btn.textContent.includes('Videos')) {
                    btn.classList.add('active');
                    btn.style.background = 'linear-gradient(135deg, #ff6b9d 0%, #ffa8c5 100%)';
                    btn.style.color = 'white';
                    btn.style.boxShadow = '0 4px 15px rgba(255, 107, 157, 0.3)';
                } else {
                    btn.style.background = 'linear-gradient(135deg, #e0e7ff 0%, #fef3ff 100%)';
                    btn.style.color = '#6b4c9a';
                    btn.style.boxShadow = '0 2px 8px rgba(167, 139, 250, 0.2)';
                }
            });
            
            // Mostrar vista correspondiente
            document.getElementById('calendar-actividades').style.display = view === 'actividades' ? 'block' : 'none';
            document.getElementById('calendar-videos').style.display = view === 'videos' ? 'block' : 'none';
        }
        
        function addActivity() {
            const input = document.getElementById('newActivityInput');
            const hoursInput = document.getElementById('activityHours');
            const minutesInput = document.getElementById('activityMinutes');
            const categoryInput = document.getElementById('activityCategory');
            const dateFromInput = document.getElementById('activityDateFrom');
            const dateToInput = document.getElementById('activityDateTo');
            const importanceInput = document.getElementById('activityImportance');
            const statEffectInput = document.getElementById('activityStatEffect');
            const statPercentageInput = document.getElementById('activityStatPercentage');
            const recurrenceInput = document.getElementById('activityRecurrence');
            const activity = input.value.trim();
            const hours = hoursInput.value || '20';
            const minutes = minutesInput.value || '00';
            const time = `${hours}:${minutes}`;
            const category = categoryInput.value;
            const dateFrom = dateFromInput.value;
            const dateTo = dateToInput.value;
            const importance = parseInt(importanceInput.value);
            const statEffect = statEffectInput.value;
            const statPercentage = statEffect !== 'none' ? parseInt(statPercentageInput.value) : 0;
            const recurrence = recurrenceInput ? recurrenceInput.value : 'none';
            
            if (activity === '') {
                alert('⚠️ Por favor escribe una actividad');
                return;
            }
            
            // Usar dateFrom o hoy si no se especificó
            let finalDateFrom = dateFrom;
            if (finalDateFrom === '') {
                const today = new Date();
                finalDateFrom = today.toISOString().split('T')[0];
            }
            
            // dateTo puede ser vacío (indefinido)
            const finalDateTo = dateTo || 'indefinido';
            
            // Si hay recurrencia, crear múltiples instancias de la actividad
            if (recurrence && recurrence !== 'none') {
                createRecurringActivities({
                    text: activity,
                    dateFrom: finalDateFrom,
                    dateTo: finalDateTo,
                    time: time || '20:00',
                    category: category || 'personal',
                    importance: importance,
                    statEffect: statEffect !== 'none' ? `${statEffect},${statPercentage}` : 'none',
                    recurrence: recurrence
                });
                console.log('✅ Actividades recurrentes creadas');
            } else {
                // Actividad única (comportamiento original)
                const newActivity = {
                    id: Date.now(),
                    text: activity,
                    dateFrom: finalDateFrom,
                    dateTo: finalDateTo,
                    time: time || '20:00',
                    category: category || 'personal',
                    importance: importance,
                    statEffect: statEffect !== 'none' ? `${statEffect},${statPercentage}` : 'none',
                    completed: false
                };
                
                gameState.activities.pending.push(newActivity);
                console.log('✅ Actividad agregada:', newActivity);
            }
            saveState();
            
            console.log('📊 Total actividades ahora:', gameState.activities.pending.length);
            
            input.value = '';
            dateFromInput.value = '';
            dateToInput.value = '';
            hoursInput.value = '';
            minutesInput.value = '';
            categoryInput.value = 'personal';
            importanceInput.value = '2';
            statEffectInput.value = 'none';
            statPercentageInput.value = '15';
            if (recurrenceInput) {
                recurrenceInput.value = 'none';
                const recurrenceInfo = document.getElementById('recurrenceInfo');
                if (recurrenceInfo) recurrenceInfo.style.display = 'none';
            }
            const statPercentageContainer = document.getElementById('statPercentageContainer');
            if (statPercentageContainer) statPercentageContainer.style.display = 'none';
            
            console.log('🔄 Llamando a renderActivities()...');
            renderActivities();
            renderMonthlyCalendar();
            renderWrongActivities();
            
            // CAMBIAR A LA PESTAÑA DE CALENDARIO para que el usuario VEA la actividad
            switchTab('calendario');
            
            // Confirmación visual
            const recurrenceText = recurrence !== 'none' ? `\n🔄 Recurrencia: ${recurrence === 'weekly' ? 'Semanal' : recurrence === 'biweekly' ? 'Quincenal' : 'Mensual'}` : '';
            alert(`✅ Actividad "${activity}" agregada exitosamente!\n📅 Fecha inicio: ${finalDateFrom}\n⏰ Hora: ${time || '20:00'}${recurrenceText}`);
            
            // Scroll al contenedor de actividades para que el usuario vea la actividad
            setTimeout(() => {
                const container = document.getElementById('activitiesPending');
                if (container) {
                    container.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
        }
        
        function toggleActivity(id) {
            const activity = gameState.activities.pending.find(a => a.id === id);
            if (activity) {
                // Inicializar completedDates si no existe
                if (!activity.completedDates) {
                    activity.completedDates = [];
                }
                
                // Obtener fecha actual seleccionada
                const currentDateStr = selectedDate.getFullYear() + '-' + 
                                      String(selectedDate.getMonth() + 1).padStart(2, '0') + '-' + 
                                      String(selectedDate.getDate()).padStart(2, '0');
                
                // Verificar si ya está completada en esta fecha
                const index = activity.completedDates.indexOf(currentDateStr);
                
                if (index > -1) {
                    // Ya está completada, desmarcar
                    activity.completedDates.splice(index, 1);
                } else {
                    // No está completada, marcar
                    activity.completedDates.push(currentDateStr);
                    
                    // Aplicar efecto de estadística
                    if (activity.statEffect && activity.statEffect !== 'none') {
                        const [statName, statValue] = activity.statEffect.split(',');
                        const boost = parseInt(statValue);
                        
                        if (gameState.stats[statName]) {
                            gameState.stats[statName].value = Math.min(200, gameState.stats[statName].value + boost);
                            renderStats();
                            console.log(`✅ Actividad completada! +${boost}% a ${statName}`);
                        }
                    }
                }
                
                saveState();
                renderActivities();
                renderMonthlyCalendar();
            }
        }
        
        function markActivityNotDone(id) {
            const activity = gameState.activities.pending.find(a => a.id === id);
            if (activity) {
                // Confirmar acción
                if (!confirm('¿Confirmas que NO hiciste esta actividad?')) {
                    return;
                }
                
                gameState.activities.pending = gameState.activities.pending.filter(a => a.id !== id);
                activity.completed = false;
                gameState.activities.completed.push(activity);
                
                // Agregar a wrongActivities para poder corregir
                gameState.wrongActivities.list.push({...activity});
                
                // Solo aplicar penalización si es IMPORTANTE (3 estrellas)
                if ((activity.importance || 2) === 3 && activity.statEffect && activity.statEffect !== 'none') {
                    const [statName, statValue] = activity.statEffect.split(',');
                    const penalty = parseInt(statValue);
                    
                    // Restar el porcentaje que hubiera sumado
                    if (gameState.stats[statName]) {
                        gameState.stats[statName].value = Math.max(0, gameState.stats[statName].value - penalty);
                        renderStats();
                        
                        // Mostrar notificación
                        alert(`❌ Actividad importante no realizada: -${penalty}% a ${statName}`);
                        console.log(`❌ Actividad no realizada: -${penalty}% a ${statName}`);
                    }
                }
                
                saveState();
                renderActivities();
                renderWrongActivities();
            }
        }
        
        function renderWrongActivities() {
            const container = document.getElementById('wrongActivitiesList');
            if (!container) return;
            
            // Verificar si necesitamos resetear (cambio de día)
            const today = new Date().toDateString();
            if (gameState.wrongActivities.lastReset !== today) {
                gameState.wrongActivities.list = [];
                gameState.wrongActivities.lastReset = today;
                saveState();
            }
            
            // Obtener solo la ÚLTIMA actividad marcada hoy
            const todayActivities = gameState.wrongActivities.list;
            
            if (todayActivities.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; font-size: 0.9em; margin: 10px 0;">No hay actividades marcadas hoy</p>';
                return;
            }
            
            // Mostrar solo la última actividad
            const lastActivity = todayActivities[todayActivities.length - 1];
            const activitiesToShow = [lastActivity];
            
            const categories = {
                work: { icon: '💼', name: 'Trabajo', bg: '#fef3c7', text: '#92400e', border: '#fbbf24' },
                personal: { icon: '🏠', name: 'Personal', bg: '#dbeafe', text: '#1e40af', border: '#3b82f6' },
                health: { icon: '❤️', name: 'Salud', bg: '#fecaca', text: '#991b1b', border: '#ef4444' },
                social: { icon: '👥', name: 'Social', bg: '#d1fae5', text: '#065f46', border: '#10b981' },
                learning: { icon: '📚', name: 'Aprendizaje', bg: '#e9d5ff', text: '#6b21a8', border: '#a855f7' }
            };
            
            container.innerHTML = activitiesToShow.map(activity => {
                const cat = categories[activity.category || 'personal'];
                const activityDate = new Date(activity.date);
                const formattedDate = activityDate.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
                const formattedTime = activity.time || '00:00';
                
                const stars = '⭐'.repeat(activity.importance || 2);
                
                let statInfo = '';
                if (activity.statEffect && activity.statEffect !== 'none') {
                    const [statName, statValue] = activity.statEffect.split(',');
                    const statIcons = {
                        ejercicio: '💪',
                        autoestima: '✨',
                        vidaSocial: '👥',
                        idiomas: '🗣️',
                        aprendizaje: '📚',
                        contenido: '🎬'
                    };
                    statInfo = `<p style="margin: 5px 0 0 0; font-size: 0.85em; color: #666;">${statIcons[statName]} ${activity.completed ? '+' : '-'}${statValue}%</p>`;
                }
                
                const statusBadge = activity.completed 
                    ? '<span style="background: #10b981; color: white; padding: 3px 8px; border-radius: 6px; font-size: 0.8em; font-weight: 600;">✅ Hecha</span>'
                    : '<span style="background: #ef4444; color: white; padding: 3px 8px; border-radius: 6px; font-size: 0.8em; font-weight: 600;">❌ No hecha</span>';
                
                return `
                    <div style="background: ${cat.bg}; padding: 15px; border-radius: 12px; border-left: 4px solid ${cat.border}; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 5px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                    <p style="margin: 0; font-weight: 600; color: #333;"><span style="margin-right: 5px;">${cat.icon}</span>${activity.text}</p>
                                    ${statusBadge}
                                </div>
                                <p style="margin: 5px 0 0 0; font-size: 0.85em; color: ${cat.text};">📅 ${formattedDate} ${formattedTime !== '00:00' ? `⏰ ${formattedTime}` : ''} ${stars}</p>
                                ${statInfo}
                            </div>
                            <button onclick="restoreActivity(${activity.id})" style="padding: 8px 16px; background: linear-gradient(135deg, #f97316 0%, #fb923c 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; white-space: nowrap; margin-left: 10px;">↩️ Restaurar</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function restoreActivity(id) {
            // Buscar la actividad en la lista de actividades mal clasificadas
            const activityIndex = gameState.wrongActivities.list.findIndex(a => a.id === id);
            if (activityIndex === -1) return;
            
            const activity = gameState.wrongActivities.list[activityIndex];
            
            // Revertir el efecto de estadística si existe
            if (activity.statEffect && activity.statEffect !== 'none') {
                const [statName, statValue] = activity.statEffect.split(',');
                const value = parseInt(statValue);
                
                if (gameState.stats[statName]) {
                    if (activity.completed) {
                        // Si estaba marcada como hecha, restar el boost
                        gameState.stats[statName].value = Math.max(0, gameState.stats[statName].value - value);
                    } else {
                        // Si estaba marcada como no hecha (y era importante), devolver la penalización
                        if ((activity.importance || 2) === 3) {
                            gameState.stats[statName].value = Math.min(200, gameState.stats[statName].value + value);
                        }
                    }
                    renderStats();
                }
            }
            
            // Remover de completed y wrongActivities
            gameState.activities.completed = gameState.activities.completed.filter(a => a.id !== id);
            gameState.wrongActivities.list.splice(activityIndex, 1);
            
            // Restaurar a pending
            activity.completed = false;
            gameState.activities.pending.push(activity);
            
            saveState();
            renderActivities();
            renderWrongActivities();
        }
        
        function deleteActivity(id, completed = false) {
            if (confirm('¿Estás seguro de eliminar esta actividad?')) {
                if (completed) {
                    gameState.activities.completed = gameState.activities.completed.filter(a => a.id !== id);
                } else {
                    gameState.activities.pending = gameState.activities.pending.filter(a => a.id !== id);
                }
                saveState();
                renderActivities();
                renderMonthlyCalendar();
            }
        }
        
        let editingActivityId = null;
        
        function editActivity(id) {
            const activity = gameState.activities.pending.find(a => a.id === id);
            if (!activity) return;
            
            editingActivityId = id;
            
            // Llenar el formulario con los datos actuales
            document.getElementById('editActivityText').value = activity.text;
            document.getElementById('editActivityDateFrom').value = activity.dateFrom || '';
            document.getElementById('editActivityDateTo').value = activity.dateTo === 'indefinido' ? '' : activity.dateTo;
            document.getElementById('editActivityTime').value = activity.time || '20:00';
            document.getElementById('editActivityCategory').value = activity.category || 'personal';
            document.getElementById('editActivityImportance').value = activity.importance || 2;
            
            // Mostrar modal
            const modal = document.getElementById('editActivityModal');
            modal.style.display = 'flex';
        }
        
        function closeEditModal() {
            document.getElementById('editActivityModal').style.display = 'none';
            editingActivityId = null;
        }
        
        function saveActivityEdit() {
            if (!editingActivityId) return;
            
            const activity = gameState.activities.pending.find(a => a.id === editingActivityId);
            if (!activity) return;
            
            // Actualizar los datos
            activity.text = document.getElementById('editActivityText').value.trim();
            activity.dateFrom = document.getElementById('editActivityDateFrom').value || new Date().toISOString().split('T')[0];
            activity.dateTo = document.getElementById('editActivityDateTo').value || 'indefinido';
            activity.time = document.getElementById('editActivityTime').value || '20:00';
            activity.category = document.getElementById('editActivityCategory').value;
            activity.importance = parseInt(document.getElementById('editActivityImportance').value);
            
            saveState();
            renderActivities();
            renderMonthlyCalendar();
            closeEditModal();
            
            alert('✅ Actividad actualizada correctamente');
        }
        
        // Variable para el mes actual del calendario
        let currentCalendarMonth = new Date();
        
        // Variable para la fecha seleccionada en el calendario
        let selectedDate = new Date();
        
        // Variable para el orden de actividades (por defecto: por horario)
        let activitiesSortOrder = 'time';
        
        // Función para cambiar el orden de las actividades
        function changeActivitiesSortOrder() {
            const selector = document.getElementById('activitiesSortOrder');
            if (selector) {
                activitiesSortOrder = selector.value;
                renderActivities();
            }
        }
        
        // Función para seleccionar un día en el calendario
        function selectCalendarDay(year, month, day) {
            selectedDate = new Date(year, month, day);
            console.log('🗓️ Día seleccionado:', selectedDate.toLocaleDateString('es-ES'));
            renderActivities();
            renderMonthlyCalendar();
        }
        
        // Mostrar/ocultar campo de porcentaje según la estadística seleccionada
        function toggleStatPercentage(statValue) {
            const container = document.getElementById('statPercentageContainer');
            if (statValue && statValue !== 'none') {
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }
        
        // Mostrar/ocultar información de recurrencia
        function toggleRecurrenceOptions(recurrence) {
            const info = document.getElementById('recurrenceInfo');
            if (recurrence && recurrence !== 'none') {
                info.style.display = 'block';
            } else {
                info.style.display = 'none';
            }
        }
        
        function changeMonth(delta) {
            currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + delta);
            renderMonthlyCalendar();
            renderActivities();
        }
        
        // Crear actividades recurrentes
        function createRecurringActivities(activityTemplate) {
            const startDate = new Date(activityTemplate.dateFrom);
            const endDate = activityTemplate.dateTo !== 'indefinido' ? new Date(activityTemplate.dateTo) : null;
            
            // Definir el límite: si no hay fecha fin, crear para los próximos 6 meses
            const maxDate = endDate || new Date(startDate.getTime() + (180 * 24 * 60 * 60 * 1000)); // 6 meses
            
            // Calcular el intervalo en días según la recurrencia
            let intervalDays = 0;
            switch(activityTemplate.recurrence) {
                case 'weekly':
                    intervalDays = 7;
                    break;
                case 'biweekly':
                    intervalDays = 14;
                    break;
                case 'monthly':
                    intervalDays = 30;
                    break;
            }
            
            let currentDate = new Date(startDate);
            let instanceCount = 0;
            const maxInstances = 52; // Máximo 52 instancias (1 año si es semanal)
            
            while (currentDate <= maxDate && instanceCount < maxInstances) {
                const newActivity = {
                    id: Date.now() + instanceCount, // ID único para cada instancia
                    text: activityTemplate.text,
                    dateFrom: currentDate.toISOString().split('T')[0],
                    dateTo: currentDate.toISOString().split('T')[0],
                    time: activityTemplate.time,
                    category: activityTemplate.category,
                    importance: activityTemplate.importance,
                    statEffect: activityTemplate.statEffect,
                    completed: false,
                    recurrence: activityTemplate.recurrence // Marcar que es parte de una recurrencia
                };
                
                gameState.activities.pending.push(newActivity);
                instanceCount++;
                
                // Avanzar a la siguiente fecha
                if (activityTemplate.recurrence === 'monthly') {
                    // Para mensual, mantener el mismo día del mes
                    currentDate.setMonth(currentDate.getMonth() + 1);
                } else {
                    currentDate.setDate(currentDate.getDate() + intervalDays);
                }
            }
            
            console.log(`✅ Se crearon ${instanceCount} instancias de la actividad recurrente`);
        }
        
        // Colores por categoría
        const categoryColors = {
            personal: { bg: '#fef3ff', border: '#ff6b9d', text: '#ff6b9d', icon: '🌸' },
            escuela: { bg: '#e0f2fe', border: '#3b82f6', text: '#3b82f6', icon: '📚' },
            trabajo: { bg: '#f0fdf4', border: '#10b981', text: '#10b981', icon: '💼' },
            ejercicio: { bg: '#fff7ed', border: '#f97316', text: '#f97316', icon: '💪' },
            salud: { bg: '#fef2f2', border: '#ef4444', text: '#ef4444', icon: '❤️' },
            social: { bg: '#faf5ff', border: '#a855f7', text: '#a855f7', icon: '👥' }
        };
        
        function renderMonthlyCalendar() {
            const container = document.getElementById('monthlyCalendar');
            if (!container) return;
            
            const year = currentCalendarMonth.getFullYear();
            const month = currentCalendarMonth.getMonth();
            
            // Actualizar label del mes
            const monthLabel = document.getElementById('currentMonthLabel');
            if (monthLabel) {
                const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                monthLabel.textContent = `${monthNames[month]} ${year}`;
            }
            
            // Obtener primer día del mes y total de días
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay(); // 0 = domingo
            
            // Crear HTML del calendario
            let html = '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; margin: 0 auto; max-width: 100%;">';
            
            // Encabezados de días
            const dayNames = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
            dayNames.forEach(day => {
                html += `<div style="text-align: center; font-weight: 600; color: #ff6b9d; padding: 5px; font-size: 0.75em;">${day}</div>`;
            });
            
            // Espacios vacíos antes del primer día
            for (let i = 0; i < startingDayOfWeek; i++) {
                html += '<div></div>';
            }
            
            // Días del mes
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = isCurrentMonth && day === today.getDate();
                
                // Obtener actividades del día
                const dayActivities = gameState.activities.pending.filter(a => a.date === dateStr);
                
                // Obtener colores de las categorías presentes
                const categoriesInDay = [...new Set(dayActivities.map(a => a.category || 'personal'))];
                const dayColor = categoriesInDay.length === 1 ? categoryColors[categoriesInDay[0]] : null;
                
                html += `
                    <div onclick="selectCalendarDay(${year}, ${month}, ${day})" style="
                        min-height: 50px;
                        padding: 4px;
                        background: ${isToday ? 'linear-gradient(135deg, #ff6b9d 0%, #ffa8c5 100%)' : (dayColor ? dayColor.bg : '#fff')};
                        border: 2px solid ${isToday ? '#ff6b9d' : (dayColor ? dayColor.border : '#ffe5f3')};
                        border-radius: 8px;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        cursor: pointer;
                        transition: all 0.2s;
                        box-shadow: ${isToday ? '0 4px 15px rgba(255, 107, 157, 0.3)' : '0 2px 5px rgba(0,0,0,0.05)'};
                    " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        <div style="font-weight: 600; color: ${isToday ? 'white' : '#333'}; margin-bottom: 2px; font-size: 0.9em;">${day}</div>
                        ${dayActivities.length > 0 ? `
                            <div style="display: flex; gap: 2px; flex-wrap: wrap; justify-content: center;">
                                ${categoriesInDay.slice(0, 3).map(cat => `
                                    <div style="width: 8px; height: 8px; border-radius: 50%; background: ${categoryColors[cat].border};"></div>
                                `).join('')}
                                ${categoriesInDay.length > 3 ? `<div style="font-size: 0.6em; color: ${isToday ? 'white' : '#666'};">+${categoriesInDay.length - 3}</div>` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function renderActivities() {
            const pendingContainer = document.getElementById('activitiesPending');
            const titleElement = document.getElementById('activitiesTitle');
            
            if (!pendingContainer) {
                console.error('❌ No se encontró el contenedor activitiesPending');
                return;
            }
            
            // Usar la fecha seleccionada (por defecto es hoy)
            const selectedStr = selectedDate.getFullYear() + '-' + 
                              String(selectedDate.getMonth() + 1).padStart(2, '0') + '-' + 
                              String(selectedDate.getDate()).padStart(2, '0');
            
            const today = new Date();
            const todayStr = today.getFullYear() + '-' + 
                           String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                           String(today.getDate()).padStart(2, '0');
            
            // Actualizar título según si es hoy u otro día
            const isToday = selectedStr === todayStr;
            const formattedDate = selectedDate.toLocaleDateString('es-ES', { 
                weekday: 'long', 
                day: 'numeric', 
                month: 'long' 
            });
            
            if (titleElement) {
                titleElement.innerHTML = isToday ? '📅 Actividades de Hoy' : `📅 Actividades del ${formattedDate}`;
            }
            
            console.log('📅 Mostrando actividades de:', selectedStr);
            console.log('📋 Total actividades pendientes:', gameState.activities.pending.length);
            
            // MOSTRAR TODAS LAS ACTIVIDADES CON SU RECURRENCIA
            gameState.activities.pending.forEach(act => {
                console.log('🔍 Actividad:', act.text, '| Fecha:', act.date, '| Recurrencia:', act.recurrence);
            });
            
            // Filtrar actividades que estén en el rango de fechas
            const selectedActivities = gameState.activities.pending.filter(activity => {
                // Compatibilidad con actividades viejas (con date y recurrence)
                if (activity.date && activity.recurrence) {
                    if (activity.date === selectedStr) return true;
                    if (activity.recurrence === 'daily') return true;
                    return false;
                }
                
                // Actividades nuevas con dateFrom/dateTo
                if (!activity.dateFrom) return false;
                
                const activityFrom = new Date(activity.dateFrom + 'T00:00:00');
                const selectedDateObj = new Date(selectedStr + 'T00:00:00');
                
                // Verificar si la fecha seleccionada es >= fecha de inicio
                if (selectedDateObj < activityFrom) return false;
                
                // Si dateTo es indefinido, mostrar siempre después de dateFrom
                if (activity.dateTo === 'indefinido') {
                    console.log('🔁 Actividad indefinida:', activity.text);
                    return true;
                }
                
                // Si hay dateTo, verificar que esté en el rango
                const activityTo = new Date(activity.dateTo + 'T00:00:00');
                if (selectedDateObj <= activityTo) {
                    console.log('✅ Actividad en rango:', activity.text, 'De', activity.dateFrom, 'a', activity.dateTo);
                    return true;
                }
                
                return false;
            });
            
            console.log('✅ Actividades encontradas:', selectedActivities.length);
            console.log('🔧 Ordenamiento actual:', activitiesSortOrder || 'time');
            
            // FUNCIÓN SIMPLE Y DIRECTA PARA CONVERTIR HORA A NÚMERO COMPARABLE
            function horaANumero(horaStr) {
                if (!horaStr || typeof horaStr !== 'string') return 99999;
                
                const match = horaStr.match(/^(\d{1,2}):(\d{2})$/);
                if (!match) {
                    console.error(`❌ Formato de hora inválido: "${horaStr}" - debería ser HH:MM`);
                    return 99999;
                }
                
                let h = parseInt(match[1], 10);
                let m = parseInt(match[2], 10);
                
                // 3 AM es el inicio, así que 0-2 AM van al final
                if (h < 3) h += 24;
                
                const valor = h * 100 + m;
                console.log(`  📍 horaANumero("${horaStr}") = ${valor}`);
                return valor;
            }
            
            // Crear array con pre-cálculo de valores
            const activitiesConHora = selectedActivities.map(act => ({
                ...act,
                _hora: horaANumero(act.time),
                _completada: act.completedDates && act.completedDates.includes(selectedStr)
            }));
            
            console.log('🎯 Array de actividades ANTES de ordenar:');
            activitiesConHora.forEach((act, idx) => {
                console.log(`  ${idx}. "${act.text}" - ${act.time}`);
            });
            
            // ORDENAR DE FORMA SIMPLE Y CLARA
            const sortedPending = activitiesConHora.sort((a, b) => {
                // Incompletas primero
                const aCompleted = a._completada ? 1 : 0;
                const bCompleted = b._completada ? 1 : 0;
                if (aCompleted !== bCompleted) {
                    return aCompleted - bCompleted;
                }
                
                // Luego por hora
                if (activitiesSortOrder === 'importance') {
                    const aImportance = b.importance || 2;
                    const bImportance = a.importance || 2;
                    if (aImportance !== bImportance) {
                        return aImportance - bImportance;
                    }
                }
                
                // Por horario
                const horaComparison = a._hora - b._hora;
                console.log(`🔍 Comparando "${a.text}" (${a.time} = ${a._hora}) vs "${b.text}" (${b.time} = ${b._hora}) = ${horaComparison}`);
                return horaComparison;
            });
            
            console.log('📊 Actividades ordenadas:');
            sortedPending.forEach((act, idx) => {
                console.log(`  ${idx + 1}. ${act.text} - ${act.time} (valor: ${act._hora})`);
            });
            
            if (sortedPending.length === 0) {
                pendingContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <p style="color: #a78bfa; margin-bottom: 10px; font-size: 1.1em;">🌸 No hay actividades para este día</p>
                        <p style="color: #999; font-size: 0.85em;">${isToday ? 'Hoy' : formattedDate}</p>
                        <p style="color: #999; font-size: 0.85em;">Total en sistema: ${gameState.activities.pending.length} actividades</p>
                    </div>
                `;
            } else {
                pendingContainer.innerHTML = sortedPending.map(activity => {
                    const cat = categoryColors[activity.category || 'personal'];
                    const importance = activity.importance || 2;
                    const stars = '⭐'.repeat(importance);
                    const isCompleted = activity._completada;
                    
                    return `
                        <div style="background: ${isCompleted ? '#f3f4f6' : cat.bg}; padding: 15px; border-radius: 15px; border-left: 4px solid ${isCompleted ? '#9ca3af' : cat.border}; box-shadow: 0 2px 8px rgba(0,0,0,${isCompleted ? '0.05' : '0.1'}); display: flex; gap: 12px; align-items: center; transition: all 0.3s;">
                            <div onclick="toggleActivity(${activity.id})" style="width: 28px; height: 28px; border: 3px solid ${isCompleted ? '#9ca3af' : cat.border}; border-radius: 50%; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; background: ${isCompleted ? '#9ca3af' : 'white'}; transition: all 0.2s;">
                                ${isCompleted ? '<span style="color: white; font-size: 16px; font-weight: bold;">✓</span>' : ''}
                            </div>
                            <div style="flex: 1;">
                                <p style="margin: 0; font-weight: 600; color: ${isCompleted ? '#6b7280' : '#333'}; text-decoration: ${isCompleted ? 'line-through' : 'none'};"><span style="margin-right: 5px;">${cat.icon}</span>${activity.text}</p>
                                <p style="margin: 5px 0 0 0; font-size: 0.85em; color: ${isCompleted ? '#9ca3af' : cat.text};">⏰ ${activity.time || '20:00'} ${stars}</p>
                            </div>
                            <div style="display: flex; gap: 5px;">
                                ${!isCompleted ? `<button onclick="event.stopPropagation(); editActivity(${activity.id})" style="padding: 8px 12px; background: #3b82f6; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 0.85em;">✏️</button>` : ''}
                                ${!isCompleted ? `<button onclick="event.stopPropagation(); deleteActivity(${activity.id})" style="padding: 8px 12px; background: #ef4444; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 0.85em;">🗑️</button>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }
        
        function renderScheduledVideos() {
            const container = document.getElementById('scheduledVideos');
            if (!container) return;
            
            // Obtener videos programados de las ideas
            const scheduledVideos = gameState.ideas.publicadas.filter(idea => idea.scheduledDate);
            
            if (scheduledVideos.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            const sortedVideos = [...scheduledVideos].sort((a, b) => {
                return new Date(a.scheduledDate) - new Date(b.scheduledDate);
            });
            
            container.innerHTML = sortedVideos.map(video => {
                const videoDate = new Date(video.scheduledDate);
                const formattedDate = videoDate.toLocaleDateString('es-ES', { 
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'long',
                    year: 'numeric'
                });
                
                return `
                    <div style="background: linear-gradient(135deg, #fef3ff 0%, #ffe5f3 100%); padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(255,107,157,0.15);">
                        <p style="margin: 0; font-weight: 600; color: #ff6b9d;">🎬 ${video.text}</p>
                        <p style="margin: 5px 0 0 0; font-size: 0.85em; color: #a78bfa;">📅 ${formattedDate}</p>
                    </div>
                `;
            }).join('');
        }
        
        // ===================================
        // 🧠 SISTEMA DE REPETICIÓN ESPACIADA (FLASHCARDS)
        // ===================================
        
        function startFlashcardReview() {
            const today = new Date();
            const flashcardsToReview = library.flashcards.filter(card => {
                if (!card.nextReview) return true; // Nueva flashcard
                return new Date(card.nextReview) <= today;
            });
            
            if (flashcardsToReview.length === 0) {
                alert('🎉 ¡No hay flashcards para repasar hoy! Vuelve mañana.');
                return;
            }
            
            // Iniciar sesión de repaso
            window.currentReviewSession = {
                cards: flashcardsToReview,
                currentIndex: 0,
                showingAnswer: false
            };
            
            showReviewModal();
        }
        
        function showReviewModal() {
            const session = window.currentReviewSession;
            const card = session.cards[session.currentIndex];
            
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.id = 'reviewModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>🧠 Repaso de Flashcards</h3>
                        <p style="color: #a78bfa; font-size: 0.9em;">${session.currentIndex + 1} / ${session.cards.length}</p>
                    </div>
                    <div class="modal-body" style="min-height: 300px; display: flex; flex-direction: column; justify-content: center;">
                        ${card.folder ? `<div style="background: #fef3ff; padding: 8px 15px; border-radius: 8px; margin-bottom: 15px; text-align: center; color: #ff6b9d; font-weight: 600;">📁 ${card.folder}</div>` : ''}
                        
                        <div id="flashcardContent" style="text-align: center; padding: 20px;">
                            <h2 style="color: #667eea; margin-bottom: 20px; font-size: 1.5em;">${card.title}</h2>
                            ${card.imageUrl ? `<img src="${card.imageUrl}" style="max-width: 100%; max-height: 200px; border-radius: 10px; margin-bottom: 20px;">` : ''}
                            
                            ${!session.showingAnswer ? `
                                <button onclick="showAnswer()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%); color: white; border: none; border-radius: 15px; font-size: 1.1em; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(167, 139, 250, 0.3);">
                                    👁️ Ver Respuesta
                                </button>
                            ` : `
                                <div style="background: linear-gradient(135deg, #fef3ff 0%, #ffe5f3 100%); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                                    <p style="color: #6b4c9a; font-size: 1.2em; line-height: 1.6;">${card.answer}</p>
                                </div>
                                
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <button onclick="rateFlashcard('hard')" style="flex: 1; min-width: 120px; padding: 15px; background: #ef4444; color: white; border: none; border-radius: 15px; font-weight: 600; cursor: pointer;">
                                        ❌ Difícil<br><small>Repetir pronto</small>
                                    </button>
                                    <button onclick="rateFlashcard('good')" style="flex: 1; min-width: 120px; padding: 15px; background: #f59e0b; color: white; border: none; border-radius: 15px; font-weight: 600; cursor: pointer;">
                                        🤔 Regular<br><small>Necesito repaso</small>
                                    </button>
                                    <button onclick="rateFlashcard('easy')" style="flex: 1; min-width: 120px; padding: 15px; background: #10b981; color: white; border: none; border-radius: 15px; font-weight: 600; cursor: pointer;">
                                        ✅ Fácil<br><small>La recordé bien</small>
                                    </button>
                                </div>
                            `}
                        </div>
                    </div>
                    <button onclick="closeReviewModal()" style="width: 100%; margin-top: 15px; padding: 12px; background: #e5e7eb; color: #6b7280; border: none; border-radius: 12px; cursor: pointer;">Cerrar Sesión</button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function showAnswer() {
            window.currentReviewSession.showingAnswer = true;
            document.getElementById('reviewModal').remove();
            showReviewModal();
        }
        
        function rateFlashcard(difficulty) {
            const session = window.currentReviewSession;
            const card = session.cards[session.currentIndex];
            
            // Encontrar el índice de la card en la biblioteca
            const cardIndex = library.flashcards.findIndex(c => c.title === card.title && c.answer === card.answer);
            
            if (cardIndex !== -1) {
                const now = new Date();
                let interval = library.flashcards[cardIndex].interval || 0;
                
                // Algoritmo de repetición espaciada
                if (difficulty === 'hard') {
                    interval = 0; // Repetir hoy
                } else if (difficulty === 'good') {
                    if (interval === 0) interval = 1; // 1 día
                    else interval = Math.ceil(interval * 1.5); // Aumentar 50%
                } else if (difficulty === 'easy') {
                    if (interval === 0) interval = 1; // 1 día
                    else if (interval === 1) interval = 3; // 3 días
                    else if (interval === 3) interval = 7; // 1 semana
                    else if (interval === 7) interval = 14; // 2 semanas
                    else if (interval === 14) interval = 30; // 1 mes
                    else if (interval === 30) interval = 90; // 3 meses
                    else if (interval === 90) interval = 180; // 6 meses
                    else if (interval === 180) interval = 365; // 1 año
                    else interval = Math.ceil(interval * 2); // Duplicar
                }
                
                const nextReview = new Date(now.getTime() + interval * 24 * 60 * 60 * 1000);
                library.flashcards[cardIndex].interval = interval;
                library.flashcards[cardIndex].nextReview = nextReview.toISOString();
                
                saveLibrary();
            }
            
            // Siguiente tarjeta
            session.currentIndex++;
            session.showingAnswer = false;
            
            if (session.currentIndex < session.cards.length) {
                document.getElementById('reviewModal').remove();
                showReviewModal();
            } else {
                document.getElementById('reviewModal').remove();
                alert(`🎉 ¡Sesión completada! Repasaste ${session.cards.length} flashcard${session.cards.length > 1 ? 's' : ''}.`);
                renderLibraryContent();
            }
        }
        
        function closeReviewModal() {
            const modal = document.getElementById('reviewModal');
            if (modal) modal.remove();
            window.currentReviewSession = null;
        }
        
        function reviewSingleFlashcard(index) {
            window.currentReviewSession = {
                cards: [library.flashcards[index]],
                currentIndex: 0,
                showingAnswer: false
            };
            showReviewModal();
        }
        
        // Guardar todo antes de cerrar o cambiar de pestaña
        function saveBeforeExit() {
            saveState();
            saveSelfcareCooldowns();
            saveLibrary();
            
            // Marcar cambio pendiente para sincronización
            if (typeof marcarCambioPendiente === 'function') {
                marcarCambioPendiente();
            }
            
            console.log('💾 Datos guardados automáticamente');
        }
        
        // Indicador visual de guardado
        function showSaveIndicator(message = 'Guardado ✓') {
            // Remover indicador anterior si existe
            const oldIndicator = document.getElementById('saveIndicator');
            if (oldIndicator) oldIndicator.remove();
            
            const indicator = document.createElement('div');
            indicator.id = 'saveIndicator';
            indicator.textContent = message;
            indicator.style.cssText = `
                position: fixed;
                bottom: 80px;
                right: 20px;
                background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
                color: white;
                padding: 12px 20px;
                border-radius: 25px;
                font-weight: 600;
                font-size: 0.9em;
                box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
                z-index: 10000;
                animation: slideIn 0.3s ease-out, slideOut 0.3s ease-in 2.7s;
                pointer-events: none;
            `;
            
            document.body.appendChild(indicator);
            
            setTimeout(() => {
                indicator.remove();
            }, 3000);
        }
        
        // Agregar estilos de animación si no existen
        if (!document.getElementById('saveIndicatorStyles')) {
            const style = document.createElement('style');
            style.id = 'saveIndicatorStyles';
            style.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateX(400px);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
                @keyframes slideOut {
                    from {
                        transform: translateX(0);
                        opacity: 1;
                    }
                    to {
                        transform: translateX(400px);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(style);
        }
        
        // Registrar service worker y detectar actualizaciones
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('✅ Service Worker registrado');
                        
                        // Verificar actualizaciones cada 30 segundos (más frecuente)
                        setInterval(() => {
                            registration.update();
                        }, 30 * 1000);
                        
                        // Detectar cuando hay actualización disponible
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // Hay actualización disponible
                                    mostrarBotonActualizar();
                                }
                            });
                        });
                        
                        // Recargar cuando se activa un nuevo service worker
                        let refreshing = false;
                        navigator.serviceWorker.addEventListener('controllerchange', () => {
                            if (!refreshing) {
                                refreshing = true;
                                console.log('🔄 Recargando con nueva versión...');
                                window.location.reload();
                            }
                        });
                    })
                    .catch(err => {
                        console.log('❌ Error al registrar Service Worker:', err);
                    });
            });
        }
        
        // Mostrar botón de actualización
        function mostrarBotonActualizar() {
            const boton = document.createElement('div');
            boton.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.6); cursor: pointer; z-index: 99999; font-weight: 700; animation: pulse 2s infinite; max-width: 90%; text-align: center; font-size: 1.1em;';
            boton.innerHTML = '🎉 ¡NUEVA VERSIÓN! Se agregaron Flashcards 🧠<br><span style="font-size: 0.9em; opacity: 0.9;">Toca aquí para actualizar ahora</span>';
            boton.onclick = () => {
                // Forzar actualización
                if (navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({ type: 'SKIP_WAITING' });
                }
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            };
            document.body.appendChild(boton);
        }
        
        // ========================================
        // CALENDARIO EMOCIONAL 2026
        // ========================================
        
        // Datos del calendario emocional
        let emotionalData = {};
        let selectedEmotion = null;
        
        // Colores pastel para cada emoción
        const EMOTION_COLORS = {
            'feliz': { bg: '#ffeb99', border: '#ffd700', emoji: '😊', name: 'Feliz' },
            'motivada': { bg: '#c8e6c9', border: '#81c784', emoji: '💪', name: 'Motivada' },
            'triste': { bg: '#b3d9ff', border: '#64b5f6', emoji: '😢', name: 'Triste' },
            'cansada': { bg: '#d1c4e9', border: '#9575cd', emoji: '😴', name: 'Cansada' },
            'enojada': { bg: '#ffccbc', border: '#ff8a65', emoji: '😠', name: 'Enojada' },
            'estresada': { bg: '#f8bbd0', border: '#f48fb1', emoji: '😰', name: 'Estresada' },
            'enferma': { bg: '#ffcccc', border: '#ef9a9a', emoji: '🤒', name: 'Enferma' },
            'normal': { bg: '#e0e0e0', border: '#bdbdbd', emoji: '😐', name: 'Normal' }
        };
        
        // Días de cada mes en 2026
        const DAYS_IN_MONTH_2026 = {
            1: 31,  // Enero
            2: 28,  // Febrero (2026 no es bisiesto)
            3: 31,  // Marzo
            4: 30,  // Abril
            5: 31,  // Mayo
            6: 30,  // Junio
            7: 31,  // Julio
            8: 31,  // Agosto
            9: 30,  // Septiembre
            10: 31, // Octubre
            11: 30, // Noviembre
            12: 31  // Diciembre
        };
        
        const MONTH_NAMES = [
            'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
            'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
        ];
        
        // Cargar datos emocionales
        function loadEmotionalData() {
            const saved = localStorage.getItem('emotionalData2026');
            if (saved) {
                emotionalData = JSON.parse(saved);
            }
        }
        
        // Guardar datos emocionales
        function saveEmotionalData() {
            localStorage.setItem('emotionalData2026', JSON.stringify(emotionalData));
        }
        
        // Seleccionar emoción
        function selectEmotion(emotion) {
            selectedEmotion = emotion;
            
            // Actualizar botones
            document.querySelectorAll('#emotionSelector button').forEach(btn => {
                btn.style.transform = 'scale(1)';
                const emotionName = btn.textContent.trim().split(' ')[1].toLowerCase();
                if (EMOTION_COLORS[emotionName]) {
                    btn.style.boxShadow = `0 4px 12px ${EMOTION_COLORS[emotionName].border}33`;
                }
            });
            
            // Destacar el botón seleccionado
            event.target.style.transform = 'scale(1.05)';
            event.target.style.boxShadow = `0 6px 20px ${EMOTION_COLORS[emotion].border}66`;
            
            // Actualizar texto
            document.getElementById('selectedEmotionText').textContent = 
                `${EMOTION_COLORS[emotion].emoji} Has seleccionado: ${emotion.charAt(0).toUpperCase() + emotion.slice(1)} - Haz clic en los días para marcarlos`;
        }
        
        // Marcar día con emoción
        function markDayEmotion(month, day) {
            if (!selectedEmotion) {
                alert('⚠️ Primero selecciona una emoción');
                return;
            }
            
            const dateKey = `2026-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
            
            // Inicializar si no existe
            if (!emotionalData[dateKey]) {
                emotionalData[dateKey] = [];
            }
            
            // Si ya tiene esta emoción, quitarla (toggle)
            const index = emotionalData[dateKey].indexOf(selectedEmotion);
            if (index > -1) {
                emotionalData[dateKey].splice(index, 1);
                // Si no quedan emociones, eliminar el día
                if (emotionalData[dateKey].length === 0) {
                    delete emotionalData[dateKey];
                }
            } else {
                // Añadir la emoción (máximo 4 emociones por día para los cuadrantes)
                if (emotionalData[dateKey].length < 4) {
                    emotionalData[dateKey].push(selectedEmotion);
                } else {
                    alert('⚠️ Ya tienes 4 emociones en este día (límite de cuadrantes)');
                    return;
                }
            }
            
            saveEmotionalData();
            renderEmotionalCalendar2026();
        }
        
        // Renderizar calendario emocional 2026
        function renderEmotionalCalendar2026() {
            const container = document.getElementById('emotionalCalendar2026');
            if (!container) return;
            
            let html = '<table style="width: 100%; border-collapse: separate; border-spacing: 2px; min-width: 800px;">';
            
            // Encabezado con números de días
            html += '<tr><th style="padding: 8px; background: linear-gradient(135deg, #ff6b9d 0%, #ffa8c5 100%); color: white; border-radius: 8px; font-weight: 600; min-width: 80px;">Mes</th>';
            for (let day = 1; day <= 31; day++) {
                html += `<th style="padding: 6px 4px; background: linear-gradient(135deg, #fef3ff 0%, #ffe5f3 100%); color: #6b4c9a; border-radius: 6px; font-size: 0.85em; font-weight: 600; min-width: 28px;">${day}</th>`;
            }
            html += '</tr>';
            
            // Filas de meses
            for (let month = 1; month <= 12; month++) {
                const daysInMonth = DAYS_IN_MONTH_2026[month];
                html += '<tr>';
                html += `<td style="padding: 8px; background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%); color: white; font-weight: 600; border-radius: 8px; text-align: center; font-size: 0.9em;">${MONTH_NAMES[month - 1]}</td>`;
                
                for (let day = 1; day <= 31; day++) {
                    if (day <= daysInMonth) {
                        const dateKey = `2026-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                        const emotions = emotionalData[dateKey] || [];
                        
                        // Determinar el estilo según las emociones
                        let cellContent = '';
                        let cellStyle = 'padding: 4px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; min-height: 40px; position: relative; background: white; border: 2px solid #e0e0e0;';
                        
                        if (emotions.length === 0) {
                            // Sin emociones
                            cellStyle += 'background: white;';
                        } else if (emotions.length === 1) {
                            // Una emoción - todo el cuadro
                            const emotion = emotions[0];
                            const color = EMOTION_COLORS[emotion];
                            cellStyle += `background: ${color.bg}; border: 2px solid ${color.border};`;
                            cellContent = `<div style="font-size: 1.2em;">${color.emoji}</div>`;
                        } else if (emotions.length === 2) {
                            // Dos emociones - dividir horizontalmente
                            cellStyle += 'padding: 0;';
                            cellContent = '<div style="display: flex; height: 40px;">';
                            
                            for (let i = 0; i < 2; i++) {
                                const emotion = emotions[i];
                                const color = EMOTION_COLORS[emotion];
                                cellContent += `<div style="background: ${color.bg}; border: 1px solid ${color.border}; flex: 1; display: flex; align-items: center; justify-content: center; font-size: 0.95em;">${color.emoji}</div>`;
                            }
                            
                            cellContent += '</div>';
                        } else if (emotions.length === 3) {
                            // Tres emociones - layout especial (2 arriba, 1 abajo)
                            cellStyle += 'padding: 0;';
                            cellContent = '<div style="display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; height: 40px;">';
                            
                            // Primera emoción (mitad superior)
                            const color0 = EMOTION_COLORS[emotions[0]];
                            cellContent += `<div style="background: ${color0.bg}; border: 1px solid ${color0.border}; grid-column: 1 / 3; display: flex; align-items: center; justify-content: center; font-size: 0.9em;">${color0.emoji}</div>`;
                            
                            // Segunda y tercera emoción (mitad inferior dividida)
                            const color1 = EMOTION_COLORS[emotions[1]];
                            cellContent += `<div style="background: ${color1.bg}; border: 1px solid ${color1.border}; display: flex; align-items: center; justify-content: center; font-size: 0.85em;">${color1.emoji}</div>`;
                            
                            const color2 = EMOTION_COLORS[emotions[2]];
                            cellContent += `<div style="background: ${color2.bg}; border: 1px solid ${color2.border}; display: flex; align-items: center; justify-content: center; font-size: 0.85em;">${color2.emoji}</div>`;
                            
                            cellContent += '</div>';
                        } else {
                            // Cuatro emociones - grid 2x2
                            cellStyle += 'padding: 0;';
                            cellContent = '<div style="display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; height: 40px;">';
                            
                            for (let i = 0; i < 4; i++) {
                                const emotion = emotions[i];
                                const color = EMOTION_COLORS[emotion];
                                cellContent += `<div style="background: ${color.bg}; border: 1px solid ${color.border}; display: flex; align-items: center; justify-content: center; font-size: 0.85em;">${color.emoji}</div>`;
                            }
                            
                            cellContent += '</div>';
                        }
                        
                        html += `<td onclick="markDayEmotion(${month}, ${day})" style="${cellStyle}" onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 12px rgba(167, 139, 250, 0.4)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">${cellContent}</td>`;
                    } else {
                        // Día no válido (mes con menos de 31 días)
                        html += '<td style="background: #f5f5f5; border-radius: 8px;"></td>';
                    }
                }
                html += '</tr>';
            }
            
            html += '</table>';
            container.innerHTML = html;
            
            // Actualizar el resumen mensual
            updateMonthlyEmotionSummary();
        }
        
        // Actualizar resumen mensual de emociones
        function updateMonthlyEmotionSummary() {
            const container = document.getElementById('emotionStatsContainer');
            if (!container) return;
            
            // Obtener el mes actual
            const now = new Date();
            const currentMonth = now.getMonth() + 1; // 1-12
            const currentYear = 2026;
            
            // Contar emociones del mes actual
            const emotionCounts = {};
            
            // Inicializar contadores
            Object.keys(EMOTION_COLORS).forEach(emotion => {
                emotionCounts[emotion] = 0;
            });
            
            // Contar emociones en el mes actual
            Object.keys(emotionalData).forEach(dateKey => {
                const [year, month, day] = dateKey.split('-').map(Number);
                
                if (year === currentYear && month === currentMonth) {
                    const emotions = emotionalData[dateKey];
                    emotions.forEach(emotion => {
                        if (emotionCounts[emotion] !== undefined) {
                            emotionCounts[emotion]++;
                        }
                    });
                }
            });
            
            // Crear tarjetas de estadísticas
            let html = '';
            
            Object.keys(EMOTION_COLORS).forEach(emotion => {
                const color = EMOTION_COLORS[emotion];
                const count = emotionCounts[emotion];
                
                html += `
                    <div style="background: linear-gradient(135deg, ${color.bg} 0%, white 100%); 
                         padding: 8px; 
                         border-radius: 10px; 
                         border: 2px solid ${color.border}; 
                         text-align: center;
                         box-shadow: 0 2px 6px rgba(0,0,0,0.08);
                         transition: all 0.3s ease;"
                         onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 3px 10px rgba(0,0,0,0.12)';"
                         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(0,0,0,0.08)';">
                        <div style="font-size: 1.5em; margin-bottom: 3px;">${color.emoji}</div>
                        <div style="font-weight: 600; color: #6b4c9a; font-size: 0.75em; margin-bottom: 2px;">${color.name}</div>
                        <div style="font-size: 1.2em; font-weight: 700; color: ${color.border};">${count}</div>
                        <div style="font-size: 0.65em; color: #888; margin-top: 1px;">veces</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Mostrar indicador de auto-guardado
        function showAutoSaveIndicator() {
            const indicator = document.createElement('div');
            indicator.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 10px 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); z-index: 9999; font-weight: 600; font-size: 0.9em; opacity: 0; transition: opacity 0.3s ease;';
            indicator.innerHTML = '💾 Guardado automático';
            document.body.appendChild(indicator);
            
            // Fade in
            setTimeout(() => {
                indicator.style.opacity = '1';
            }, 10);
            
            // Fade out después de 2 segundos
            setTimeout(() => {
                indicator.style.opacity = '0';
                setTimeout(() => {
                    indicator.remove();
                }, 300);
            }, 2000);
        }

        // ===================================
        // 📝 SISTEMA DE APUNTES
        // ===================================
        
        // Estado de apuntes
        let notes = [];
        let noteFolders = [];
        let currentNoteCategory = 'all';
        
        // Cargar apuntes desde localStorage o Supabase
        function loadNotes() {
            if (supabaseClient && supabaseUser) {
                // Cargar desde Supabase
                loadNotesFromSupabase();
            } else {
                // Cargar desde localStorage
                const saved = localStorage.getItem('notes');
                if (saved) {
                    try {
                        notes = JSON.parse(saved);
                    } catch (error) {
                        console.error('Error al cargar apuntes:', error);
                        notes = [];
                    }
                }
                
                const savedFolders = localStorage.getItem('noteFolders');
                if (savedFolders) {
                    try {
                        noteFolders = JSON.parse(savedFolders);
                    } catch (error) {
                        console.error('Error al cargar carpetas de apuntes:', error);
                        noteFolders = ['General'];
                    }
                } else {
                    noteFolders = ['General'];
                }
            }
        }
        
        // Guardar apuntes
        function saveNotes() {
            if (supabaseClient && supabaseUser) {
                syncNotesToSupabase();
            } else {
                localStorage.setItem('notes', JSON.stringify(notes));
                localStorage.setItem('noteFolders', JSON.stringify(noteFolders));
                showSaveIndicator('Apuntes guardados ✓');
            }
        }
        
        // Renderizar contenido de apuntes
        function renderNotesContent() {
            const container = document.getElementById('notesContainer');
            if (!container) return;
            
            // Filtrar apuntes
            let filteredNotes = notes;
            if (currentNoteCategory !== 'all') {
                filteredNotes = notes.filter(note => note.folder === currentNoteCategory);
            }
            
            let html = `
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                    <select id="notesFolderSelect" onchange="filterNotesByFolder(this.value)" style="flex: 1; min-width: 150px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 1em; background: white;">
                        <option value="all">📂 Todas las carpetas</option>
                        ${noteFolders.map(folder => `<option value="${folder}" ${currentNoteCategory === folder ? 'selected' : ''}>${folder}</option>`).join('')}
                    </select>
                    <button onclick="openCreateNoteFolderModal()" style="padding: 12px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer;">
                        ➕ Carpeta
                    </button>
                    <button onclick="openNoteModal()" style="flex: 1; min-width: 150px; padding: 12px 20px; background: linear-gradient(135deg, #ffa751 0%, #ffe259 100%); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 1.1em;">
                        ➕ Nuevo Apunte
                    </button>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;">
            `;
            
            if (filteredNotes.length === 0) {
                html += `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #9ca3af;">
                        <div style="font-size: 3em; margin-bottom: 15px;">📝</div>
                        <p style="font-size: 1.1em; font-weight: 600; margin-bottom: 10px;">No hay apuntes aún</p>
                        <p style="font-size: 0.95em;">Crea tu primer apunte para comenzar</p>
                    </div>
                `;
            } else {
                filteredNotes.forEach((note, index) => {
                    const actualIndex = notes.findIndex(n => n.id === note.id);
                    const preview = note.content.substring(0, 100) + (note.content.length > 100 ? '...' : '');
                    const date = new Date(note.updatedAt || note.createdAt).toLocaleDateString('es-ES', { 
                        day: '2-digit', 
                        month: 'short', 
                        year: 'numeric' 
                    });
                    
                    html += `
                        <div style="background: white; border-radius: 15px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: all 0.3s ease; cursor: pointer;" 
                             onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.15)';" 
                             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)';">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <h3 style="color: #6b4c9a; font-size: 1.1em; margin: 0; flex: 1;">${note.title}</h3>
                                <div style="display: flex; gap: 5px;">
                                    <button onclick="editNote(${actualIndex}); event.stopPropagation();" style="background: #667eea; color: white; border: none; border-radius: 8px; padding: 6px 10px; cursor: pointer; font-size: 0.85em;">✏️</button>
                                    <button onclick="deleteNote(${actualIndex}); event.stopPropagation();" style="background: #ff6b9d; color: white; border: none; border-radius: 8px; padding: 6px 10px; cursor: pointer; font-size: 0.85em;">🗑️</button>
                                </div>
                            </div>
                            
                            <div style="background: #f3f4f6; padding: 8px 10px; border-radius: 8px; margin-bottom: 10px;">
                                <span style="color: #6b7280; font-size: 0.85em;">📁 ${note.folder}</span>
                            </div>
                            
                            <p style="color: #6b7280; font-size: 0.9em; line-height: 1.5; margin-bottom: 10px;">${preview}</p>
                            
                            ${note.tags && note.tags.length > 0 ? `
                                <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px;">
                                    ${note.tags.map(tag => `<span style="background: #e5e7eb; color: #6b7280; padding: 3px 8px; border-radius: 6px; font-size: 0.8em;">#${tag}</span>`).join('')}
                                </div>
                            ` : ''}
                            
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                                <span style="color: #9ca3af; font-size: 0.8em;">📅 ${date}</span>
                                <button onclick="generateFlashcardsFromNote(${actualIndex}); event.stopPropagation();" 
                                        style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; border: none; border-radius: 10px; padding: 8px 15px; cursor: pointer; font-weight: bold; font-size: 0.9em;">
                                    🧠 Generar Flashcards
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Filtrar apuntes por carpeta
        function filterNotesByFolder(folder) {
            currentNoteCategory = folder;
            renderNotesContent();
        }
        
        // Abrir modal para crear/editar apunte
        function openNoteModal(editIndex = null) {
            const isEdit = editIndex !== null;
            const note = isEdit ? notes[editIndex] : null;
            
            const modal = document.createElement('div');
            modal.id = 'noteModal';
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3 style="color: #ffa751; margin-bottom: 10px;">${isEdit ? '✏️ Editar Apunte' : '📝 Nuevo Apunte'}</h3>
                    </div>
                    
                    <div style="padding: 20px;">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #6b4c9a; font-weight: bold;">Título</label>
                            <input type="text" id="noteTitle" value="${isEdit ? note.title : ''}" 
                                   placeholder="Título del apunte" 
                                   style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1em;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #6b4c9a; font-weight: bold;">Carpeta</label>
                            <select id="noteFolder" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1em;">
                                ${noteFolders.map(folder => `<option value="${folder}" ${isEdit && note.folder === folder ? 'selected' : ''}>${folder}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #6b4c9a; font-weight: bold;">Contenido</label>
                            <textarea id="noteContent" rows="12" 
                                      placeholder="Escribe aquí el contenido de tu apunte..." 
                                      style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 0.95em; font-family: inherit; resize: vertical;">${isEdit ? note.content : ''}</textarea>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #6b4c9a; font-weight: bold;">Tags (opcional, separados por coma)</label>
                            <input type="text" id="noteTags" value="${isEdit && note.tags ? note.tags.join(', ') : ''}" 
                                   placeholder="Ejemplo: matemáticas, álgebra, examen" 
                                   style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1em;">
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button onclick="saveNote(${editIndex})" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #ffa751 0%, #ffe259 100%); color: white; border: none; border-radius: 12px; font-size: 1.1em; font-weight: bold; cursor: pointer;">
                                💾 Guardar
                            </button>
                            ${isEdit ? `
                                <button onclick="generateFlashcardsFromNote(${editIndex}); closeNoteModal();" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; border: none; border-radius: 12px; font-size: 1.1em; font-weight: bold; cursor: pointer;">
                                    🧠 Generar Flashcards
                                </button>
                            ` : ''}
                            <button onclick="closeNoteModal()" style="padding: 15px 25px; background: #e5e7eb; color: #6b7280; border: none; border-radius: 12px; cursor: pointer; font-weight: bold;">
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            setTimeout(() => document.getElementById('noteTitle').focus(), 100);
        }
        
        // Guardar apunte
        function saveNote(editIndex = null) {
            const title = document.getElementById('noteTitle').value.trim();
            const folder = document.getElementById('noteFolder').value;
            const content = document.getElementById('noteContent').value.trim();
            const tagsInput = document.getElementById('noteTags').value.trim();
            
            if (!title) {
                alert('⚠️ Por favor ingresa un título para el apunte');
                return;
            }
            
            if (!content) {
                alert('⚠️ Por favor escribe el contenido del apunte');
                return;
            }
            
            const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];
            
            const noteData = {
                id: editIndex !== null ? notes[editIndex].id : Date.now(),
                title,
                folder,
                content,
                tags,
                createdAt: editIndex !== null ? notes[editIndex].createdAt : Date.now(),
                updatedAt: Date.now()
            };
            
            if (editIndex !== null) {
                notes[editIndex] = noteData;
            } else {
                notes.push(noteData);
            }
            
            saveNotes();
            renderNotesContent();
            closeNoteModal();
            
            alert(`✅ Apunte ${editIndex !== null ? 'actualizado' : 'creado'} correctamente`);
        }
        
        // Editar apunte
        function editNote(index) {
            openNoteModal(index);
        }
        
        // Eliminar apunte
        function deleteNote(index) {
            if (confirm('¿Estás seguro de que deseas eliminar este apunte?')) {
                notes.splice(index, 1);
                saveNotes();
                renderNotesContent();
                alert('✅ Apunte eliminado');
            }
        }
        
        // Cerrar modal de apunte
        function closeNoteModal() {
            const modal = document.getElementById('noteModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Crear carpeta de apuntes
        function openCreateNoteFolderModal() {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3>➕ Nueva Carpeta de Apuntes</h3>
                    </div>
                    <div class="modal-body">
                        <label style="display: block; margin-bottom: 8px; color: #667eea; font-weight: bold;">Nombre de la carpeta:</label>
                        <input type="text" id="newNoteFolderName" placeholder="Ej: Matemáticas, Historia..." 
                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 0.95em;">
                    </div>
                    <div style="display: flex; gap: 10px; padding: 20px;">
                        <button onclick="createNoteFolder()" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 15px; font-size: 1.1em; font-weight: bold; cursor: pointer;">Crear</button>
                        <button onclick="closeNoteFolderModal()" style="padding: 15px 20px; background: #e5e7eb; color: #6b7280; border: none; border-radius: 15px; cursor: pointer;">Cancelar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            setTimeout(() => document.getElementById('newNoteFolderName').focus(), 100);
        }
        
        function createNoteFolder() {
            const folderName = document.getElementById('newNoteFolderName').value.trim();
            if (!folderName) {
                alert('⚠️ Por favor ingresa un nombre para la carpeta');
                return;
            }
            
            if (noteFolders.includes(folderName)) {
                alert('⚠️ Esta carpeta ya existe');
                return;
            }
            
            noteFolders.push(folderName);
            saveNotes();
            closeNoteFolderModal();
            renderNotesContent();
            alert(`✅ Carpeta "${folderName}" creada correctamente`);
        }
        
        function closeNoteFolderModal() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (modal.querySelector('#newNoteFolderName')) {
                    modal.remove();
                }
            });
        }
        
        // ===================================
        // 🤖 GENERACIÓN DE FLASHCARDS CON IA
        // ===================================
        
        // Generar flashcards desde un apunte usando IA
        async function generateFlashcardsFromNote(noteIndex) {
            const note = notes[noteIndex];
            
            if (!note || !note.content) {
                alert('⚠️ El apunte no tiene contenido para generar flashcards');
                return;
            }
            
            // Mostrar loading
            const loadingModal = document.createElement('div');
            loadingModal.className = 'modal show';
            loadingModal.innerHTML = `
                <div class="modal-content" style="max-width: 400px; text-align: center;">
                    <div style="font-size: 3em; margin-bottom: 15px;">🤖</div>
                    <h3 style="color: #6b4c9a; margin-bottom: 10px;">Generando Flashcards con IA</h3>
                    <p style="color: #6b7280; margin-bottom: 20px;">Analizando tu apunte...</p>
                    <div style="width: 100%; height: 8px; background: #e5e7eb; border-radius: 10px; overflow: hidden;">
                        <div style="width: 0%; height: 100%; background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%); animation: loading 2s infinite;"></div>
                    </div>
                </div>
            `;
            document.body.appendChild(loadingModal);
            
            try {
                // Simular llamada a API de IA (aquí irá la integración real)
                const flashcards = await generateFlashcardsWithAI(note.content, note.title);
                
                // Cerrar loading
                loadingModal.remove();
                
                if (!flashcards || flashcards.length === 0) {
                    alert('⚠️ No se pudieron generar flashcards. Intenta con un apunte más largo o detallado.');
                    return;
                }
                
                // Crear deck
                const deckName = `${note.title} (Auto)`;
                const deckId = Date.now();
                
                // Agregar flashcards a biblioteca
                flashcards.forEach(card => {
                    library.flashcards.push({
                        id: Date.now() + Math.random(),
                        folder: note.folder,
                        deck: deckName,
                        deckId: deckId,
                        front: card.front,
                        back: card.back,
                        type: card.type || 'qa',
                        difficulty: card.difficulty || 3,
                        sourceNoteId: note.id,
                        nextReview: Date.now(),
                        interval: 1,
                        easeFactor: 2.5,
                        reviews: 0
                    });
                });
                
                saveLibrary();
                
                // Mostrar resultado
                alert(`✅ Se generaron ${flashcards.length} flashcards automáticamente!\n\nDeck: "${deckName}"\nCarpeta: ${note.folder}`);
                
                // Cambiar a pestaña de flashcards
                openLibraryCategory('flashcards');
                libraryFilters.folder = note.folder;
                renderLibraryContent();
                
            } catch (error) {
                loadingModal.remove();
                console.error('Error al generar flashcards:', error);
                alert('❌ Error al generar flashcards. Por favor intenta nuevamente.');
            }
        }
        
        // Función de IA simulada (reemplazar con API real)
        async function generateFlashcardsWithAI(content, title) {
            // Simular delay de API
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // AQUÍ IRÁ LA INTEGRACIÓN CON OPENAI/ANTHROPIC
            // Por ahora, generación básica automática
            
            const sentences = content.split(/[.!?]+/).filter(s => s.trim().length > 20);
            const flashcards = [];
            
            // Generar entre 10-20 tarjetas
            const numCards = Math.min(20, Math.max(10, Math.floor(sentences.length / 2)));
            
            for (let i = 0; i < numCards && i < sentences.length; i++) {
                const sentence = sentences[i].trim();
                if (sentence.length < 20) continue;
                
                // Detectar conceptos clave (palabras importantes)
                const words = sentence.split(' ').filter(w => w.length > 5);
                if (words.length === 0) continue;
                
                const keyword = words[Math.floor(Math.random() * words.length)];
                
                // Generar pregunta tipo cloze
                const front = sentence.replace(keyword, '______');
                const back = keyword;
                
                flashcards.push({
                    front: `¿Qué palabra falta?\n\n${front}`,
                    back: back,
                    type: 'cloze',
                    difficulty: 3
                });
            }
            
            return flashcards;
        }
        
        // ===================================
        // 🔄 SINCRONIZACIÓN CON SUPABASE
        // ===================================
        
        let supabaseClient = null;
        let supabaseUser = null;
        
        // Inicializar Supabase
        function initSupabase() {
            // CONFIGURACIÓN DE SUPABASE
            const SUPABASE_URL = 'https://viqvznakyrwvhxnmzmyt.supabase.co';
            const SUPABASE_KEY = 'sb_publishable_y_xdR7tqCSviwBKlHO3x_g_yIQ7RrQJ';
            
            try {
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log('✅ Supabase conectado correctamente');
                
                // Verificar si hay una sesión activa
                supabaseClient.auth.getSession().then(({ data: { session } }) => {
                    if (session) {
                        supabaseUser = session.user;
                        console.log('✅ Usuario autenticado:', supabaseUser.email);
                        if (document.getElementById('syncStatus')) {
                            document.getElementById('syncStatus').textContent = '✅ Sincronizado: ' + supabaseUser.email;
                            document.getElementById('syncStatus').style.color = '#2d5016';
                        }
                        if (document.getElementById('syncButtons')) {
                            document.getElementById('syncButtons').style.display = 'flex';
                        }
                    }
                });
                
                // Escuchar cambios de autenticación
                supabaseClient.auth.onAuthStateChange(async (event, session) => {
                    if (event === 'SIGNED_IN' && session) {
                        supabaseUser = session.user;
                        console.log('✅ Sesión iniciada:', supabaseUser.email);
                        if (document.getElementById('syncStatus')) {
                            document.getElementById('syncStatus').textContent = '✅ Sincronizado: ' + supabaseUser.email;
                            document.getElementById('syncStatus').style.color = '#2d5016';
                        }
                        if (document.getElementById('syncInfo')) {
                            document.getElementById('syncInfo').style.display = 'block';
                        }
                        if (document.getElementById('syncButtons')) {
                            document.getElementById('syncButtons').style.display = 'flex';
                        }
                        
                        // Sincronizar datos al iniciar sesión
                        await resolverConflictosDatos();
                    } else if (event === 'SIGNED_OUT') {
                        supabaseUser = null;
                        if (document.getElementById('syncStatus')) {
                            document.getElementById('syncStatus').textContent = 'localStorage activo';
                            document.getElementById('syncStatus').style.color = '#4a7c59';
                        }
                        if (document.getElementById('syncInfo')) {
                            document.getElementById('syncInfo').style.display = 'none';
                        }
                        if (document.getElementById('syncButtons')) {
                            document.getElementById('syncButtons').style.display = 'none';
                        }
                    }
                });
            } catch (error) {
                console.error('❌ Error al conectar Supabase:', error);
                console.log('💡 Usando localStorage como fallback.');
            }
        }
        
        // Login con Supabase
        async function loginSupabase(email, password) {
            if (!supabaseClient) return false;
            
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) throw error;
                
                supabaseUser = data.user;
                await syncFromSupabase();
                return true;
            } catch (error) {
                console.error('Error al iniciar sesión:', error);
                return false;
            }
        }
        
        // Sincronizar desde Supabase
        async function syncFromSupabase() {
            if (!supabaseClient || !supabaseUser) return;
            
            try {
                // Cargar apuntes
                const { data: notesData } = await supabaseClient
                    .from('notes')
                    .select('*')
                    .eq('user_id', supabaseUser.id);
                
                if (notesData) {
                    notes = notesData;
                }
                
                // Cargar flashcards
                const { data: flashcardsData } = await supabaseClient
                    .from('flashcards')
                    .select('*')
                    .eq('user_id', supabaseUser.id);
                
                if (flashcardsData) {
                    library.flashcards = flashcardsData;
                }
                
                console.log('✅ Datos sincronizados desde Supabase');
            } catch (error) {
                console.error('Error al sincronizar desde Supabase:', error);
            }
        }
        
        // Resolver conflictos entre localStorage y Supabase
        async function resolverConflictosDatos(forzarPregunta = false) {
            if (!supabaseClient || !supabaseUser) return;
            
            try {
                // Obtener datos de Supabase
                const { data: datosNube } = await supabaseClient
                    .from('user_data')
                    .select('*')
                    .eq('user_id', supabaseUser.id)
                    .single();
                
                // Obtener datos locales
                const datosLocales = {
                    stats: window.stats || {},
                    library: window.library || {},
                    ideas: JSON.parse(localStorage.getItem('ideas') || '[]'),
                    emotionalData: JSON.parse(localStorage.getItem('emotionalData') || '{}'),
                    notes: window.notes || []
                };
                
                const hayDatosLocales = Object.keys(datosLocales.stats).length > 0 || 
                                       datosLocales.library.apuntes?.length > 0 ||
                                       datosLocales.ideas.length > 0;
                
                const hayDatosNube = datosNube && datosNube.data;
                
                if ((hayDatosLocales && hayDatosNube) || forzarPregunta) {
                    // HAY CONFLICTO O SE FORZÓ LA PREGUNTA
                    const respuesta = confirm(
                        '🔄 SINCRONIZACIÓN DE DATOS\n\n' +
                        'Elige qué datos quieres mantener:\n\n' +
                        '📱 ESTE DISPOSITIVO:\n' +
                        `- ${datosLocales.library.apuntes?.length || 0} apuntes\n` +
                        `- ${datosLocales.ideas.length || 0} ideas\n` +
                        `- ${datosLocales.library.libros?.length || 0} libros\n` +
                        `- ${datosLocales.library.peliculas?.length || 0} películas\n\n` +
                        '☁️ EN LA NUBE:\n' +
                        `- ${datosNube?.data?.library?.apuntes?.length || 0} apuntes\n` +
                        `- ${datosNube?.data?.ideas?.length || 0} ideas\n` +
                        `- ${datosNube?.data?.library?.libros?.length || 0} libros\n` +
                        `- ${datosNube?.data?.library?.peliculas?.length || 0} películas\n\n` +
                        '¿Qué datos quieres mantener?\n\n' +
                        '✅ OK = Usar datos de ESTE DISPOSITIVO (sobreescribir nube)\n' +
                        '❌ CANCELAR = Usar datos de LA NUBE (sobreescribir este dispositivo)'
                    );
                    
                    if (respuesta) {
                        // Usuario eligió datos locales - Subir a la nube
                        await subirTodoALaNube();
                        alert('✅ Datos de este dispositivo subidos a la nube');
                    } else {
                        // Usuario eligió datos de la nube - Descargar
                        await descargarTodoDeNube();
                        alert('✅ Datos de la nube descargados a este dispositivo');
                    }
                } else if (hayDatosNube) {
                    // Solo hay datos en la nube - Descargar
                    await descargarTodoDeNube();
                    console.log('✅ Datos descargados de la nube');
                } else if (hayDatosLocales) {
                    // Solo hay datos locales - Subir
                    await subirTodoALaNube();
                    console.log('✅ Datos locales subidos a la nube');
                }
                
                // Activar sincronización automática
                iniciarSyncAutomatico();
                
            } catch (error) {
                console.error('Error al resolver conflictos:', error);
                console.log('💡 Continuando con datos locales');
            }
        }
        
        // Subir todos los datos a la nube
        async function subirTodoALaNube() {
            if (!supabaseClient || !supabaseUser) return;
            
            const timestamp = new Date().toISOString();
            
            // Recopilar TODOS los datos de TODAS las fuentes
            const todosLosDatos = {
                user_id: supabaseUser.id,
                data: {
                    stats: window.stats || {},
                    library: window.library || {},
                    ideas: JSON.parse(localStorage.getItem('ideas') || '[]'),
                    emotionalData: JSON.parse(localStorage.getItem('emotionalData') || '{}'),
                    notes: window.notes || [],
                    profile: JSON.parse(localStorage.getItem('userProfile') || '{}'),
                    dailyActivities: JSON.parse(localStorage.getItem('dailyActivities') || '[]'),
                    favoritesOrder: JSON.parse(localStorage.getItem('favoritesOrder') || '[]'),
                    selfcareCooldowns: JSON.parse(localStorage.getItem('selfcareCooldowns') || '{}')
                },
                updated_at: timestamp
            };
            
            console.log('📤 Subiendo datos:', todosLosDatos);
            
            await supabaseClient
                .from('user_data')
                .upsert(todosLosDatos);
            
            // Actualizar timestamp local
            localStorage.setItem('lastSyncTimestamp', timestamp);
            
            console.log('✅ Todos los datos subidos a la nube');
        }
        
        // Descargar todos los datos de la nube
        async function descargarTodoDeNube() {
            if (!supabaseClient || !supabaseUser) return;
            
            try {
                console.log('📥 Descargando datos de la nube...');
                
                const { data, error } = await supabaseClient
                    .from('user_data')
                    .select('*')
                    .eq('user_id', supabaseUser.id)
                    .single();
                
                if (error && error.code !== 'PGRST116') {
                    console.error('Error al descargar:', error);
                    alert('❌ Error al descargar: ' + error.message);
                    return;
                }
                
                if (data && data.data) {
                    console.log('📥 Datos recibidos de la nube:', data.data);
                    
                    // ACTUALIZAR TODAS LAS VARIABLES GLOBALES
                    window.stats = data.data.stats || {};
                    window.library = data.data.library || {};
                    window.notes = data.data.notes || [];
                    
                    // GUARDAR TODO EN LOCALSTORAGE
                    localStorage.setItem('stats', JSON.stringify(data.data.stats || {}));
                    localStorage.setItem('library', JSON.stringify(data.data.library || {}));
                    localStorage.setItem('ideas', JSON.stringify(data.data.ideas || []));
                    localStorage.setItem('emotionalData', JSON.stringify(data.data.emotionalData || {}));
                    localStorage.setItem('userProfile', JSON.stringify(data.data.profile || {}));
                    localStorage.setItem('dailyActivities', JSON.stringify(data.data.dailyActivities || []));
                    localStorage.setItem('favoritesOrder', JSON.stringify(data.data.favoritesOrder || []));
                    localStorage.setItem('selfcareCooldowns', JSON.stringify(data.data.selfcareCooldowns || {}));
                    localStorage.setItem('lastSyncTimestamp', data.updated_at || new Date().toISOString());
                    
                    // RECARGAR LA PÁGINA COMPLETA para aplicar todos los cambios
                    console.log('✅ Datos descargados - Recargando página...');
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                } else {
                    console.log('⚠️ No hay datos en la nube');
                    alert('⚠️ No hay datos en la nube para este usuario');
                }
            } catch (error) {
                console.error('Error en descargarTodoDeNube:', error);
                alert('❌ Error: ' + error.message);
            }
        }
        
        // Actualizar toda la interfaz después de sincronizar
        function actualizarInterfazCompleta() {
            try {
                // Recargar apuntes si estamos en esa vista
                if (typeof renderApuntes === 'function' && currentLibraryCategory === 'apuntes') {
                    renderApuntes();
                }
                
                // Recargar ideas
                if (typeof renderIdeas === 'function') {
                    renderIdeas();
                }
                
                // Recargar stats
                if (typeof updateStatsDisplay === 'function') {
                    updateStatsDisplay();
                }
                
                // Recargar biblioteca si está abierta
                if (typeof renderLibraryContent === 'function' && currentLibraryCategory) {
                    renderLibraryContent();
                }
                
                console.log('🔄 Interfaz actualizada');
            } catch (error) {
                console.error('Error al actualizar interfaz:', error);
            }
        }
        
        // Sincronización automática BIDIRECCIONAL en tiempo real
        let syncInterval = null;
        let isOnline = navigator.onLine;
        let pendingChanges = false;
        
        function iniciarSyncAutomatico() {
            if (syncInterval) clearInterval(syncInterval);
            
            // Sincronización cada 5 segundos (en tiempo real)
            syncInterval = setInterval(async () => {
                if (supabaseClient && supabaseUser && isOnline) {
                    await sincronizacionBidireccional();
                }
            }, 5000); // Cada 5 segundos
            
            console.log('✅ Sincronización automática iniciada (cada 5 segundos)');
        }
        
        // Sincronización bidireccional inteligente
        async function sincronizacionBidireccional() {
            if (!supabaseClient || !supabaseUser) return;
            
            try {
                // Indicador visual de sincronización
                const syncIcon = document.getElementById('syncIcon');
                if (syncIcon) syncIcon.textContent = '🔄';
                
                // 1. Obtener datos de la nube
                const { data: datosNube } = await supabaseClient
                    .from('user_data')
                    .select('*')
                    .eq('user_id', supabaseUser.id)
                    .single();
                
                // 2. Obtener timestamp local
                const timestampLocal = localStorage.getItem('lastSyncTimestamp') || new Date(0).toISOString();
                const timestampNube = datosNube?.updated_at || new Date(0).toISOString();
                
                // 3. Comparar timestamps para determinar qué hacer
                if (new Date(timestampNube) > new Date(timestampLocal)) {
                    // La nube tiene datos más recientes - DESCARGAR
                    console.log('☁️ Descargando cambios de la nube...');
                    await descargarTodoDeNube();
                    pendingChanges = false;
                    if (syncIcon) syncIcon.textContent = '📥';
                    setTimeout(() => { if (syncIcon) syncIcon.textContent = '✅'; }, 500);
                } else if (pendingChanges) {
                    // Hay cambios locales pendientes - SUBIR
                    console.log('📤 Subiendo cambios locales...');
                    await subirTodoALaNube();
                    pendingChanges = false;
                    if (syncIcon) syncIcon.textContent = '📤';
                    setTimeout(() => { if (syncIcon) syncIcon.textContent = '✅'; }, 500);
                } else {
                    // Todo sincronizado
                    if (syncIcon) syncIcon.textContent = '✅';
                }
                
            } catch (error) {
                const syncIcon = document.getElementById('syncIcon');
                if (syncIcon) syncIcon.textContent = '⚠️';
                if (error.code !== 'PGRST116') { // Ignorar "no rows"
                    console.error('Error en sincronización:', error);
                }
            }
        }
        
        // Marcar que hay cambios pendientes cada vez que se modifica algo
        function marcarCambioPendiente() {
            pendingChanges = true;
            localStorage.setItem('lastSyncTimestamp', new Date().toISOString());
        }
        
        // Detectar conexión/desconexión
        window.addEventListener('online', () => {
            isOnline = true;
            console.log('✅ Conexión restaurada - Sincronizando...');
            if (supabaseClient && supabaseUser && pendingChanges) {
                sincronizacionBidireccional();
            }
        });
        
        window.addEventListener('offline', () => {
            isOnline = false;
            console.log('⚠️ Sin conexión - Los cambios se guardarán localmente');
        });
        
        // Sincronizar hacia Supabase
        async function syncToSupabase() {
            if (!supabaseClient || !supabaseUser) return;
            
            try {
                // Guardar apuntes
                await supabaseClient
                    .from('notes')
                    .upsert(notes.map(note => ({
                        ...note,
                        user_id: supabaseUser.id
                    })));
                
                // Guardar flashcards
                await supabaseClient
                    .from('flashcards')
                    .upsert(library.flashcards.map(card => ({
                        ...card,
                        user_id: supabaseUser.id
                    })));
                
                console.log('✅ Datos sincronizados hacia Supabase');
            } catch (error) {
                console.error('Error al sincronizar hacia Supabase:', error);
            }
        }
        
        // Cargar apuntes desde Supabase
        async function loadNotesFromSupabase() {
            await syncFromSupabase();
        }
        
        // Sincronizar apuntes a Supabase
        async function syncNotesToSupabase() {
            await syncToSupabase();
        }

        // Iniciar cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', () => {
            // PRIMERO: Cargar todos los datos guardados
            loadLibrary();
            loadIdeas();
            loadEmotionalData();  // Cargar datos emocionales
            loadNotes(); // Cargar apuntes
            
            // Inicializar Supabase
            initSupabase();
            
            // Iniciar el reloj INMEDIATAMENTE
            updateClock();
            setInterval(updateClock, 1000);
            
            // Siempre iniciar el juego (startGame verifica si hay perfil)
            startGame();
            
            // ===== GUARDADO AUTOMÁTICO MEJORADO =====
            
            // Guardar antes de cerrar la pestaña
            window.addEventListener('beforeunload', (e) => {
                saveBeforeExit();
            });
            
            // Guardar cuando la pestaña pierde visibilidad (cambias de app en móvil)
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    saveBeforeExit();
                }
            });
            
            // Guardar cuando la página pierde el foco
            window.addEventListener('blur', () => {
                saveBeforeExit();
            });
            
            // Guardar periódicamente cada 10 segundos (más frecuente)
            setInterval(() => {
                saveBeforeExit();
                showAutoSaveIndicator();
            }, 10000);
            
            // Inicializar Supabase al cargar
            initSupabase();
            
            // Registrar Service Worker para funcionalidad offline
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('✅ Service Worker registrado:', registration.scope);
                    })
                    .catch(error => {
                        console.log('❌ Error al registrar Service Worker:', error);
                    });
            }
        });
        
        // Función para activar/desactivar sincronización
        async function toggleSupabaseSync() {
            if (!supabaseClient) {
                alert('⚠️ Supabase no está disponible. Verifica tu conexión a internet.');
                return;
            }
            
            // Mostrar opciones de autenticación
            const opcion = confirm('🔐 Autenticación\n\n✅ OK = Iniciar sesión con Google\n❌ Cancelar = Iniciar sesión con Email');
            
            if (opcion) {
                // Login con Google
                try {
                    const { data, error } = await supabaseClient.auth.signInWithOAuth({
                        provider: 'google',
                        options: {
                            redirectTo: window.location.href
                        }
                    });
                    
                    if (error) {
                        alert('❌ Error: ' + error.message + '\n\n💡 Configura Google OAuth en Supabase:\n1. Authentication > Providers > Google\n2. Activa Google\n3. Agrega tus credenciales de Google Cloud');
                    } else {
                        alert('✅ Redirigiendo a Google...');
                    }
                } catch (error) {
                    alert('❌ Error al conectar con Google. Verifica la configuración en Supabase.');
                    console.error(error);
                }
            } else {
                // Login con Email y contraseña
                const email = prompt('📧 Email:');
                if (!email) return;
                
                const password = prompt('🔑 Contraseña:');
                if (!password) return;
                
                loginSupabase(email, password).then(success => {
                    if (success) {
                        document.getElementById('syncStatus').textContent = '✅ Sincronizado: ' + email;
                        document.getElementById('syncStatus').style.color = '#2d5016';
                        document.getElementById('syncButtons').style.display = 'flex';
                        alert('✅ Sincronización activada. Tus datos se guardarán en la nube.');
                    } else {
                        alert('❌ Error al iniciar sesión.\n\n💡 Primero crea una cuenta:\n1. Ve a tu proyecto Supabase\n2. Authentication > Users\n3. Add user > Create new user');
                    }
                });
            }
        }
        
        // Función para elegir manualmente qué datos usar
        async function elegirDatos() {
            if (!supabaseClient || !supabaseUser) {
                alert('⚠️ Debes iniciar sesión primero');
                return;
            }
            
            await resolverConflictosDatos(true); // true = forzar pregunta
        }
        
        // Forzar subida de datos locales a la nube
        async function forzarSubida() {
            if (!supabaseClient || !supabaseUser) {
                alert('⚠️ Debes iniciar sesión primero');
                return;
            }
            
            const confirmacion = confirm('☁️ ¿Subir TODOS los datos de este dispositivo a la nube?\n\nEsto sobrescribirá los datos en la nube.');
            if (!confirmacion) return;
            
            try {
                await subirTodoALaNube();
                alert('✅ Datos subidos correctamente a la nube.\n\nAhora ve al otro dispositivo y dale "📥 Descargar Todo".');
            } catch (error) {
                alert('❌ Error al subir datos: ' + error.message);
                console.error(error);
            }
        }
        
        // Forzar descarga de datos de la nube
        async function forzarDescarga() {
            if (!supabaseClient || !supabaseUser) {
                alert('⚠️ Debes iniciar sesión primero');
                return;
            }
            
            const confirmacion = confirm('📥 ¿Descargar TODOS los datos de la nube?\n\nEsto sobrescribirá los datos de este dispositivo.\n\nLa página se recargará automáticamente.');
            if (!confirmacion) return;
            
            try {
                await descargarTodoDeNube();
                // La función descargarTodoDeNube ya recarga la página automáticamente
            } catch (error) {
                alert('❌ Error al descargar datos: ' + error.message);
                console.error(error);
            }
        }
    </script>
</body>
</html>


